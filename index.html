<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sistema de Gestão Financeira - Advocacia</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<style>
		/* [SEÇÃO 1: Estilos Gerais] */
		body {
			font-family: 'Inter', sans-serif;
			position: relative;
			background-color: #0f172a;
			color: #d1d5db;
			overflow-y: hidden; /* Evita scroll na página principal */
		}
		/* Efeito de fundo com imagem */
		body::after {
			content: '';
			position: fixed;
			z-index: -2; /* Garante que fique atrás de todo o conteúdo */
			top: 0; left: 0; right: 0; bottom: 0;
			background-image: url('https://i.postimg.cc/x81V8QJg/Imagem-do-Whats-App-de-2025-10-27-a-s-09-49-28-f966cd35.jpg');
			background-repeat: no-repeat;
			background-size: cover;
			background-position: center center;
			opacity: 0.12; /* Ajuste a opacidade conforme desejado */
		}
		/* Estilos para modais */
		.modal-backdrop {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.7);
			z-index: 9000;
		}
		.modal-backdrop.active {
			display: block;
		}
		.modal-container {
			display: none;
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background-color: #1e293b;
			border-radius: 12px;
			padding: 2rem;
			z-index: 9001;
			max-width: 600px;
			width: 90%;
			max-height: 85vh; /* Limita a altura do modal */
			overflow-y: auto; /* Adiciona scroll se o conteúdo for maior */
			box-shadow: 0 20px 50px rgba(0,0,0,0.5);
		}
		.modal-container.active {
			display: block;
		}
		/* Transições para sidebar e área de conteúdo */
		.sidebar {
			transition: transform 0.3s ease-in-out;
		}
		.sidebar.hidden {
			transform: translateX(-100%);
		}
		.content-area {
			transition: margin-left 0.3s ease-in-out;
		}
		.content-area.expanded {
			margin-left: 0;
		}
		/* Responsividade da sidebar */
		@media (max-width: 768px) {
			.sidebar {
				position: fixed;
				z-index: 1000;
				height: 100vh;
			}
			.content-area {
				margin-left: 0 !important;
			}
		}
		/* Efeitos de hover */
		.hover-scale {
			transition: transform 0.2s;
		}
		.hover-scale:hover {
			transform: scale(1.02);
		}
		/* Estilos de cards com gradiente */
		.card-gradient {
			background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
			border: 1px solid #475569;
		}
		/* Botão primário com gradiente */
		.btn-primary {
			background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
			transition: all 0.3s;
		}
		.btn-primary:hover {
			background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
			transform: translateY(-2px);
			box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
		}
		/* Badges de status */
		.status-badge {
			padding: 0.25rem 0.75rem;
			border-radius: 9999px;
			font-size: 0.75rem;
			font-weight: 600;
			text-transform: uppercase;
		}
		.status-ativo { background-color: #10b981; color: white; }
		.status-pendente { background-color: #f59e0b; color: white; }
		.status-vencido { background-color: #ef4444; color: white; }
		.status-pago { background-color: #06b6d4; color: white; }
		/* Estilos para inputs e selects */
		input, select, textarea {
			background-color: #334155 !important;
			border: 1px solid #475569 !important;
			color: #f1f5f9 !important;
			transition: all 0.3s;
		}
		input:focus, select:focus, textarea:focus {
			outline: none !important;
			border-color: #3b82f6 !important;
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
		}
		/* Estilos de tabela */
		.table-header {
			background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
			border-bottom: 2px solid #3b82f6;
		}
		.table-row {
			border-bottom: 1px solid #334155;
			transition: background-color 0.2s;
		}
		.table-row:hover {
			background-color: #1e293b;
		}
		/* Botões de ação */
		.btn-action {
			transition: all 0.2s;
		}
		.btn-action:hover {
			transform: scale(1.1);
		}
		/* Gráficos */
		.chart-container {
			position: relative;
			height: 300px;
			margin-bottom: 2rem;
		}
		/* Cards de estatísticas */
		.stat-card {
			background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
			border-left: 4px solid #3b82f6;
			transition: all 0.3s;
		}
		.stat-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
		}
		/* Spinner de carregamento */
		.loading-spinner {
			border: 3px solid #334155;
			border-top: 3px solid #3b82f6;
			border-radius: 50%;
			width: 40px;
			height: 40px;
			animation: spin 1s linear infinite;
		}
		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}
		/* Notificações */
		.notification {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 1rem 1.5rem;
			border-radius: 8px;
			color: white;
			font-weight: 500;
			z-index: 10000;
			display: none;
			animation: slideIn 0.3s ease-out;
		}
		@keyframes slideIn {
			from {
				transform: translateX(400px);
				opacity: 0;
			}
			to {
				transform: translateX(0);
				opacity: 1;
			}
		}
		.notification.success { background-color: #10b981; }
		.notification.error { background-color: #ef4444; }
		.notification.warning { background-color: #f59e0b; }
		.notification.info { background-color: #3b82f6; }
		/* Scrollbar customizada para mainContent */
		#mainContent {
			overflow-y: auto;
			height: calc(100vh - 80px); /* Ajuste conforme a altura do header */
		}
		#mainContent::-webkit-scrollbar {
			width: 8px;
		}
		#mainContent::-webkit-scrollbar-track {
			background: #1e293b;
		}
		#mainContent::-webkit-scrollbar-thumb {
			background: #475569;
			border-radius: 4px;
		}
		#mainContent::-webkit-scrollbar-thumb:hover {
			background: #64748b;
		}
		/* Scrollbar customizada para modais */
		.modal-container::-webkit-scrollbar {
			width: 6px;
		}
		.modal-container::-webkit-scrollbar-track {
			background: #1e293b;
		}
		.modal-container::-webkit-scrollbar-thumb {
			background: #475569;
			border-radius: 3px;
		}
		/* Estilos para itens de parcela */
		.parcel-item {
			background: #1e293b;
			border: 1px solid #334155;
			border-radius: 8px;
			padding: 1rem;
			margin-bottom: 0.75rem;
			transition: all 0.2s;
		}
		.parcel-item:hover {
			border-color: #3b82f6;
			box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
		}
		.parcel-paid { border-left: 4px solid #10b981; }
		.parcel-pending { border-left: 4px solid #f59e0b; }
		.parcel-overdue { border-left: 4px solid #ef4444; }
	</style>
</head>
<body>
	<div id="notification" class="notification"></div>
	<div class="modal-backdrop" id="modalBackdrop"></div>

	<!-- SIDEBAR -->
	<div id="sidebar" class="sidebar fixed top-0 left-0 h-full w-64 bg-gradient-to-b from-slate-800 to-slate-900 shadow-2xl z-50">
		<div class="p-6 border-b border-slate-700">
			<div class="flex items-center space-x-3">
				<i class="fas fa-balance-scale text-blue-500 text-3xl"></i>
				<div>
					<h1 class="text-xl font-bold text-white">Sistema Financeiro</h1>
					<p class="text-xs text-slate-400">Advocacia</p>
				</div>
			</div>
		</div>

		<nav class="p-4 space-y-2">
			<a href="#" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors active" data-section="dashboard">
				<i class="fas fa-home text-blue-400"></i>
				<span class="text-slate-200">Dashboard</span>
			</a>
			<a href="#" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors" data-section="clients">
				<i class="fas fa-users text-green-400"></i>
				<span class="text-slate-200">Clientes</span>
			</a>
			<a href="#" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors" data-section="contracts">
				<i class="fas fa-file-contract text-purple-400"></i>
				<span class="text-slate-200">Contratos</span>
			</a>
			<a href="#" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors" data-section="payments">
				<i class="fas fa-money-bill-wave text-yellow-400"></i>
				<span class="text-slate-200">Pagamentos</span>
			</a>
			<a href="#" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors" data-section="reports">
				<i class="fas fa-chart-bar text-red-400"></i>
				<span class="text-slate-200">Relatórios</span>
			</a>
			<a href="#" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors" data-section="analytics">
				<i class="fas fa-chart-pie text-orange-400"></i>
				<span class="text-slate-200">Análises</span>
			</a>
			<a href="#" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors" data-section="settings">
				<i class="fas fa-cog text-gray-400"></i>
				<span class="text-slate-200">Configurações</span>
			</a>
		</nav>

		<div class="absolute bottom-0 left-0 right-0 p-4 border-t border-slate-700">
			<button id="logoutBtn" class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
				<i class="fas fa-sign-out-alt"></i>
				<span>Sair</span>
			</button>
		</div>
	</div>

	<!-- BOTÃO TOGGLE SIDEBAR (MOBILE) -->
	<button id="toggleSidebar" class="fixed top-4 left-4 z-40 md:hidden bg-slate-800 text-white p-3 rounded-lg shadow-lg">
		<i class="fas fa-bars"></i>
	</button>

	<!-- ÁREA DE CONTEÚDO -->
	<div id="contentArea" class="content-area ml-64 p-8">
		<!-- HEADER -->
		<div class="mb-8 flex justify-between items-center">
			<div>
				<h2 id="pageTitle" class="text-3xl font-bold text-white">Dashboard</h2>
				<p id="pageSubtitle" class="text-slate-400 mt-1">Visão geral do sistema</p>
			</div>
			<div class="text-right">
				<p class="text-sm text-slate-400">Bem-vindo,</p>
				<p id="userEmail" class="text-lg font-semibold text-white"></p>
			</div>
		</div>

		<!-- CONTEÚDO PRINCIPAL -->
		<div id="mainContent">
			<!-- Conteúdo dinâmico será carregado aqui -->
		</div>
	</div>

	<!-- MODAL: ADICIONAR/EDITAR CLIENTE -->
	<div id="clientModal" class="modal-container">
		<div class="flex justify-between items-center mb-6">
			<h3 class="text-2xl font-bold text-white">
				<i class="fas fa-user-plus text-blue-500 mr-2"></i>
				<span id="clientModalTitle">Novo Cliente</span>
			</h3>
			<button class="close-modal text-slate-400 hover:text-white text-2xl">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<form id="clientForm" class="space-y-4">
			<input type="hidden" id="clientId">
			<div>
				<label class="block text-sm font-medium text-slate-300 mb-2">Nome Completo *</label>
				<input type="text" id="clientName" required class="w-full px-4 py-2 rounded-lg" placeholder="Digite o nome completo">
			</div>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<div>
					<label class="block text-sm font-medium text-slate-300 mb-2">CPF/CNPJ *</label>
					<input type="text" id="clientCpf" required class="w-full px-4 py-2 rounded-lg" placeholder="000.000.000-00">
				</div>
				<div>
					<label class="block text-sm font-medium text-slate-300 mb-2">Telefone *</label>
					<input type="tel" id="clientPhone" required class="w-full px-4 py-2 rounded-lg" placeholder="(00) 00000-0000">
				</div>
			</div>
			<div>
				<label class="block text-sm font-medium text-slate-300 mb-2">E-mail</label>
				<input type="email" id="clientEmail" class="w-full px-4 py-2 rounded-lg" placeholder="cliente@email.com">
			</div>
			<div>
				<label class="block text-sm font-medium text-slate-300 mb-2">Endereço</label>
				<textarea id="clientAddress" rows="3" class="w-full px-4 py-2 rounded-lg" placeholder="Rua, número, bairro, cidade, estado"></textarea>
			</div>
			<div class="flex space-x-3 pt-4">
				<button type="submit" class="flex-1 btn-primary text-white py-3 rounded-lg font-semibold">
					<i class="fas fa-save mr-2"></i>Salvar Cliente
				</button>
				<button type="button" class="close-modal px-6 py-3 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-semibold transition-colors">
					Cancelar
				</button>
			</div>
		</form>
	</div>

	<!-- MODAL: ADICIONAR/EDITAR CONTRATO -->
	<div id="contractModal" class="modal-container">
		<div class="flex justify-between items-center mb-6">
			<h3 class="text-2xl font-bold text-white">
				<i class="fas fa-file-contract text-purple-500 mr-2"></i>
				<span id="contractModalTitle">Novo Contrato</span>
			</h3>
			<button class="close-modal text-slate-400 hover:text-white text-2xl">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<form id="contractForm" class="space-y-4">
			<input type="hidden" id="contractId">
			<div>
				<label class="block text-sm font-medium text-slate-300 mb-2">Cliente *</label>
				<select id="contractClient" required class="w-full px-4 py-2 rounded-lg">
					<option value="">Selecione um cliente</option>
				</select>
			</div>
			<div>
				<label class="block text-sm font-medium text-slate-300 mb-2">Descrição do Contrato *</label>
				<textarea id="contractDescription" rows="3" required class="w-full px-4 py-2 rounded-lg" placeholder="Descrição dos serviços prestados"></textarea>
			</div>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<div>
					<label class="block text-sm font-medium text-slate-300 mb-2">Valor Total (R$) *</label>
					<input type="number" id="contractValue" required step="0.01" min="0" class="w-full px-4 py-2 rounded-lg" placeholder="0.00">
				</div>
				<div>
					<label class="block text-sm font-medium text-slate-300 mb-2">Data de Início *</label>
					<input type="date" id="contractStartDate" required class="w-full px-4 py-2 rounded-lg">
				</div>
			</div>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<div>
					<label class="block text-sm font-medium text-slate-300 mb-2">Data de Término</label>
					<input type="date" id="contractEndDate" class="w-full px-4 py-2 rounded-lg">
				</div>
				<div>
					<label class="block text-sm font-medium text-slate-300 mb-2">Status *</label>
					<select id="contractStatus" required class="w-full px-4 py-2 rounded-lg">
						<option value="Ativo">Ativo</option>
						<option value="Concluído">Concluído</option>
						<option value="Cancelado">Cancelado</option>
					</select>
				</div>
			</div>
			<div class="border-t border-slate-600 pt-4">
				<h4 class="text-lg font-semibold text-white mb-4">
					<i class="fas fa-calendar-alt text-blue-400 mr-2"></i>
					Parcelamento
				</h4>
				<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
					<div>
						<label class="block text-sm font-medium text-slate-300 mb-2">Número de Parcelas *</label>
						<input type="number" id="contractParcels" required min="1" value="1" class="w-full px-4 py-2 rounded-lg">
					</div>
					<div>
						<label class="block text-sm font-medium text-slate-300 mb-2">Dia do Vencimento *</label>
						<input type="number" id="contractDueDay" required min="1" max="31" value="10" class="w-full px-4 py-2 rounded-lg">
					</div>
					<div>
						<label class="block text-sm font-medium text-slate-300 mb-2">Primeira Parcela *</label>
						<input type="date" id="contractFirstParcel" required class="w-full px-4 py-2 rounded-lg">
					</div>
				</div>
			</div>
			<div class="flex space-x-3 pt-4">
				<button type="submit" class="flex-1 btn-primary text-white py-3 rounded-lg font-semibold">
					<i class="fas fa-save mr-2"></i>Salvar Contrato
				</button>
				<button type="button" class="close-modal px-6 py-3 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-semibold transition-colors">
					Cancelar
				</button>
			</div>
		</form>
	</div>

	<!-- MODAL: DETALHES DO CONTRATO -->
	<div id="contractDetailsModal" class="modal-container">
		<div class="flex justify-between items-center mb-6">
			<h3 class="text-2xl font-bold text-white">
				<i class="fas fa-file-invoice text-purple-500 mr-2"></i>
				Detalhes do Contrato
			</h3>
			<button class="close-modal text-slate-400 hover:text-white text-2xl">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div id="contractDetailsContent" class="space-y-4">
			<!-- Conteúdo será carregado dinamicamente -->
		</div>
	</div>

	<!-- MODAL: REGISTRAR PAGAMENTO -->
	<div id="paymentModal" class="modal-container">
		<div class="flex justify-between items-center mb-6">
			<h3 class="text-2xl font-bold text-white">
				<i class="fas fa-money-check text-green-500 mr-2"></i>
				Registrar Pagamento
			</h3>
			<button class="close-modal text-slate-400 hover:text-white text-2xl">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<form id="paymentForm" class="space-y-4">
			<input type="hidden" id="paymentContractId">
			<input type="hidden" id="paymentParcelIndex">
			<div id="paymentInfo" class="bg-slate-700 p-4 rounded-lg mb-4">
				<!-- Informações da parcela serão carregadas aqui -->
			</div>
			<div>
				<label class="block text-sm font-medium text-slate-300 mb-2">Data do Pagamento *</label>
				<input type="date" id="paymentDate" required class="w-full px-4 py-2 rounded-lg">
			</div>
			<div>
				<label class="block text-sm font-medium text-slate-300 mb-2">Valor Pago (R$) *</label>
				<input type="number" id="paymentAmount" required step="0.01" min="0" class="w-full px-4 py-2 rounded-lg">
			</div>
			<div>
				<label class="block text-sm font-medium text-slate-300 mb-2">Método de Pagamento *</label>
				<select id="paymentMethod" required class="w-full px-4 py-2 rounded-lg">
					<option value="">Selecione um método</option>
					<option value="Dinheiro">Dinheiro</option>
					<option value="PIX">PIX</option>
					<option value="Transferência">Transferência Bancária</option>
					<option value="Cartão de Crédito">Cartão de Crédito</option>
					<option value="Cartão de Débito">Cartão de Débito</option>
					<option value="Boleto">Boleto</option>
					<option value="Cheque">Cheque</option>
				</select>
			</div>
			<div>
				<label class="block text-sm font-medium text-slate-300 mb-2">Observações</label>
				<textarea id="paymentNotes" rows="3" class="w-full px-4 py-2 rounded-lg" placeholder="Observações sobre o pagamento (opcional)"></textarea>
			</div>
			<div class="flex space-x-3 pt-4">
				<button type="submit" class="flex-1 btn-primary text-white py-3 rounded-lg font-semibold">
					<i class="fas fa-check mr-2"></i>Confirmar Pagamento
				</button>
				<button type="button" class="close-modal px-6 py-3 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-semibold transition-colors">
					Cancelar
				</button>
			</div>
		</form>
	</div>

	<!-- MODAL: RELATÓRIO -->
	<div id="reportModal" class="modal-container" style="max-width: 900px;">
		<div class="flex justify-between items-center mb-6">
			<h3 class="text-2xl font-bold text-white">
				<i class="fas fa-file-pdf text-red-500 mr-2"></i>
				Relatório Mensal
			</h3>
			<button class="close-modal text-slate-400 hover:text-white text-2xl">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div id="reportContent" class="space-y-4">
			<!-- Conteúdo do relatório será carregado aqui -->
		</div>
		<div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-slate-600">
			<button id="downloadPdfBtn" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors">
				<i class="fas fa-file-pdf mr-2"></i>Baixar PDF
			</button>
			<button class="close-modal px-6 py-3 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-semibold transition-colors">
				Fechar
			</button>
		</div>
	</div>

	<!-- MODAL: LIXEIRA -->
	<div id="trashModal" class="modal-container" style="max-width: 900px;">
		<div class="flex justify-between items-center mb-6">
			<h3 class="text-2xl font-bold text-white">
				<i class="fas fa-trash-alt text-gray-500 mr-2"></i>
				Lixeira
			</h3>
			<button class="close-modal text-slate-400 hover:text-white text-2xl">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div id="trashContent" class="space-y-4">
			<!-- Conteúdo da lixeira será carregado aqui -->
		</div>
	</div>

	<!-- MODAL: WORKSHOP -->
	<div id="workshopModal" class="modal-container" style="max-width: 900px;">
		<div class="flex justify-between items-center mb-6">
			<h3 class="text-2xl font-bold text-white">
				<i class="fas fa-tools text-yellow-500 mr-2"></i>
				Workshop de Correções
			</h3>
			<button class="close-modal text-slate-400 hover:text-white text-2xl">
				<i class="fas fa-times"></i>
			</button>
		</div>
		<div id="workshopContent" class="space-y-4">
			<!-- Conteúdo do workshop será carregado aqui -->
		</div>
	</div>

	<!-- FIREBASE E JAVASCRIPT -->
	<script type="module">
		import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
		import { 
			getAuth, 
			onAuthStateChanged, 
			signOut 
		} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
		import { 
			getFirestore, 
			collection, 
			addDoc, 
			getDocs, 
			doc, 
			updateDoc, 
			deleteDoc, 
			query, 
			where,
			orderBy,
			limit,
			startAfter
		} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

		// Configuração do Firebase
		const firebaseConfig = {
			apiKey: "AIzaSyD7fo76dtPorium8rMSXGKiKV3P6MX70Gg",
			authDomain: "financeiro-6cfbb.firebaseapp.com",
			projectId: "financeiro-6cfbb",
			storageBucket: "financeiro-6cfbb.firebasestorage.app",
			messagingSenderId: "962798985393",
			appId: "1:962798985393:web:81e28e3c4535e855bb8e38"
		};

		const app = initializeApp(firebaseConfig);
		const auth = getAuth(app);
		const db = getFirestore(app);

		// Estado Global
		let currentUser = null;
		let clients = [];
		let contracts = [];
		let currentSection = 'dashboard';
		let lastVisibleClient = null;
		let lastVisibleContract = null;
		const PAGE_SIZE = 10; // Número de itens por página

		// Utilitários
		const showNotification = (message, type = 'info') => {
			const notification = document.getElementById('notification');
			notification.textContent = message;
			notification.className = `notification ${type}`;
			notification.style.display = 'block';
			setTimeout(() => {
				notification.style.display = 'none';
			}, 4000);
		};

		const formatCurrency = (value) => {
			return new Intl.NumberFormat('pt-BR', { 
				style: 'currency', 
				currency: 'BRL' 
			}).format(value);
		};

		const formatDate = (dateString) => {
			if (!dateString) return '-';
			const date = new Date(dateString);
			return date.toLocaleDateString('pt-BR');
		};

		const openModal = (modalId) => {
			document.getElementById(modalId).classList.add('active');
			document.getElementById('modalBackdrop').classList.add('active');
		};

		const closeModal = () => {
			document.querySelectorAll('.modal-container').forEach(modal => {
				modal.classList.remove('active');
			});
			document.getElementById('modalBackdrop').classList.remove('active');
		};

		// Verificação de autenticação
		onAuthStateChanged(auth, (user) => {
			if (user) {
				currentUser = user;
				document.getElementById('userEmail').textContent = user.email;
				loadClients();
				loadContracts();
				renderSection(currentSection);
			} else {
				window.location.href = 'index.html';
			}
		});

		// Logout
		document.getElementById('logoutBtn').addEventListener('click', async () => {
			try {
				await signOut(auth);
				window.location.href = 'index.html';
			} catch (error) {
				showNotification('Erro ao sair: ' + error.message, 'error');
			}
		});

		// Navegação
		document.querySelectorAll('.nav-link').forEach(link => {
			link.addEventListener('click', (e) => {
				e.preventDefault();
				document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
				link.classList.add('active');
				currentSection = link.getAttribute('data-section');
				renderSection(currentSection);
			});
		});

		// Toggle Sidebar (Mobile)
		document.getElementById('toggleSidebar').addEventListener('click', () => {
			const sidebar = document.getElementById('sidebar');
			sidebar.classList.toggle('hidden');
		});

		// Fechar modais
		document.querySelectorAll('.close-modal').forEach(btn => {
			btn.addEventListener('click', closeModal);
		});

		document.getElementById('modalBackdrop').addEventListener('click', closeModal);

		// 
		// CLIENTES
		// 

		const loadClients = async (next = false) => {
			try {
				let clientQuery = query(collection(db, 'clients'), orderBy('name'), limit(PAGE_SIZE));
				if (next && lastVisibleClient) {
					clientQuery = query(collection(db, 'clients'), orderBy('name'), startAfter(lastVisibleClient), limit(PAGE_SIZE));
				}
				const querySnapshot = await getDocs(clientQuery);
				clients = [];
				querySnapshot.forEach((doc) => {
					clients.push({ id: doc.id, ...doc.data() });
				});
				lastVisibleClient = querySnapshot.docs[querySnapshot.docs.length - 1];
				updateClientSelects();
			} catch (error) {
				showNotification('Erro ao carregar clientes: ' + error.message, 'error');
			}
		};

		const updateClientSelects = () => {
			const select = document.getElementById('contractClient');
			select.innerHTML = '<option value="">Selecione um cliente</option>';
			clients.forEach(client => {
				select.innerHTML += `<option value="${client.id}">${client.name}</option>`;
			});
		};

		document.getElementById('clientForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const clientId = document.getElementById('clientId').value;
			const clientData = {
				name: document.getElementById('clientName').value,
				cpf: document.getElementById('clientCpf').value,
				phone: document.getElementById('clientPhone').value,
				email: document.getElementById('clientEmail').value,
				address: document.getElementById('clientAddress').value,
				createdAt: clientId ? undefined : new Date().toISOString(),
				updatedAt: new Date().toISOString()
			};

			try {
				if (clientId) {
					await updateDoc(doc(db, 'clients', clientId), clientData);
					showNotification('Cliente atualizado com sucesso!', 'success');
				} else {
					await addDoc(collection(db, 'clients'), clientData);
					showNotification('Cliente adicionado com sucesso!', 'success');
				}
				closeModal();
				document.getElementById('clientForm').reset();
				await loadClients();
				if (currentSection === 'clients') renderClientsSection();
			} catch (error) {
				showNotification('Erro ao salvar cliente: ' + error.message, 'error');
			}
		});

		const editClient = (clientId) => {
			const client = clients.find(c => c.id === clientId);
			if (!client) return;

			document.getElementById('clientModalTitle').textContent = 'Editar Cliente';
			document.getElementById('clientId').value = client.id;
			document.getElementById('clientName').value = client.name;
			document.getElementById('clientCpf').value = client.cpf;
			document.getElementById('clientPhone').value = client.phone;
			document.getElementById('clientEmail').value = client.email || '';
			document.getElementById('clientAddress').value = client.address || '';
			openModal('clientModal');
		};

		const deleteClient = async (clientId) => {
			if (!confirm('Tem certeza que deseja excluir este cliente?')) return;

			try {
				await deleteDoc(doc(db, 'clients', clientId));
				showNotification('Cliente excluído com sucesso!', 'success');
				await loadClients();
				if (currentSection === 'clients') renderClientsSection();
			} catch (error) {
				showNotification('Erro ao excluir cliente: ' + error.message, 'error');
			}
		};

		// 
		// CONTRATOS
		// 

		const loadContracts = async (next = false) => {
			try {
				let contractQuery = query(collection(db, 'contracts'), orderBy('startDate', 'desc'), limit(PAGE_SIZE));
				if (next && lastVisibleContract) {
					contractQuery = query(collection(db, 'contracts'), orderBy('startDate', 'desc'), startAfter(lastVisibleContract), limit(PAGE_SIZE));
				}
				const querySnapshot = await getDocs(contractQuery);
				contracts = [];
				querySnapshot.forEach((doc) => {
					contracts.push({ id: doc.id, ...doc.data() });
				});
				lastVisibleContract = querySnapshot.docs[querySnapshot.docs.length - 1];
			} catch (error) {
				showNotification('Erro ao carregar contratos: ' + error.message, 'error');
			}
		};

		const generateParcels = (numParcels, totalValue, firstParcelDate, dueDay) => {
			const parcels = [];
			const parcelValue = totalValue / numParcels;
			const baseDate = new Date(firstParcelDate + 'T12:00:00'); // Garante que a data base seja UTC para consistência

			for (let i = 0; i < numParcels; i++) {
				const dueDate = new Date(baseDate);
				dueDate.setMonth(dueDate.getMonth() + i);
				dueDate.setDate(dueDay);

				parcels.push({
					number: i + 1,
					value: parcelValue,
					dueDate: dueDate.toISOString().split('T')[0], // Salva apenas a data (YYYY-MM-DD)
					status: 'Pendente',
					paymentDate: null,
					paymentAmount: null,
					paymentMethod: null,
					notes: null
				});
			}
			return parcels;
		};

		document.getElementById('contractForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const contractId = document.getElementById('contractId').value;
			const clientId = document.getElementById('contractClient').value;
			const totalValue = parseFloat(document.getElementById('contractValue').value);
			const numParcels = parseInt(document.getElementById('contractParcels').value);
			const dueDay = parseInt(document.getElementById('contractDueDay').value);
			const firstParcelDate = document.getElementById('contractFirstParcel').value;

			const contractData = {
				clientId: clientId,
				description: document.getElementById('contractDescription').value,
				value: totalValue,
				startDate: document.getElementById('contractStartDate').value,
				endDate: document.getElementById('contractEndDate').value || null,
				status: document.getElementById('contractStatus').value,
				parcels: contractId ? undefined : generateParcels(numParcels, totalValue, firstParcelDate, dueDay),
				createdAt: contractId ? undefined : new Date().toISOString(),
				updatedAt: new Date().toISOString()
			};

			try {
				if (contractId) {
					await updateDoc(doc(db, 'contracts', contractId), contractData);
					showNotification('Contrato atualizado com sucesso!', 'success');
				} else {
					await addDoc(collection(db, 'contracts'), contractData);
					showNotification('Contrato criado com sucesso!', 'success');
				}
				closeModal();
				document.getElementById('contractForm').reset();
				await loadContracts();
				if (currentSection === 'contracts') renderContractsSection();
			} catch (error) {
				showNotification('Erro ao salvar contrato: ' + error.message, 'error');
			}
		});

		const editContract = (contractId) => {
			const contract = contracts.find(c => c.id === contractId);
			if (!contract) return;

			document.getElementById('contractModalTitle').textContent = 'Editar Contrato';
			document.getElementById('contractId').value = contract.id;
			document.getElementById('contractClient').value = contract.clientId;
			document.getElementById('contractDescription').value = contract.description;
			document.getElementById('contractValue').value = contract.value;
			document.getElementById('contractStartDate').value = contract.startDate;
			document.getElementById('contractEndDate').value = contract.endDate || '';
			document.getElementById('contractStatus').value = contract.status;
			// Para edição, não geramos novas parcelas, apenas exibimos os dados existentes
			document.getElementById('contractParcels').value = contract.parcels ? contract.parcels.length : 1;
			document.getElementById('contractDueDay').value = contract.parcels && contract.parcels.length > 0 ? new Date(contract.parcels[0].dueDate).getDate() : 10;
			document.getElementById('contractFirstParcel').value = contract.parcels && contract.parcels.length > 0 ? contract.parcels[0].dueDate : new Date().toISOString().split('T')[0];

			openModal('contractModal');
		};

		const deleteContract = async (contractId) => {
			if (!confirm('Tem certeza que deseja excluir este contrato?')) return;

			try {
				await deleteDoc(doc(db, 'contracts', contractId));
				showNotification('Contrato excluído com sucesso!', 'success');
				await loadContracts();
				if (currentSection === 'contracts') renderContractsSection();
			} catch (error) {
				showNotification('Erro ao excluir contrato: ' + error.message, 'error');
			}
		};

		const viewContractDetails = (contractId) => {
			const contract = contracts.find(c => c.id === contractId);
			if (!contract) return;

			const client = clients.find(c => c.id === contract.clientId);
			const parcels = contract.parcels || [];
			const paidParcels = parcels.filter(p => p.status === 'Paga').length;
			const totalPaid = parcels.filter(p => p.status === 'Paga').reduce((sum, p) => sum + (p.paymentAmount || p.value), 0);

			let html = `
				<div class="bg-slate-700 p-4 rounded-lg mb-4">
					<h4 class="font-semibold text-white mb-2">Informações do Cliente</h4>
					<p class="text-slate-300"><strong>Nome:</strong> ${client ? client.name : 'N/A'}</p>
					<p class="text-slate-300"><strong>CPF/CNPJ:</strong> ${client ? client.cpf : 'N/A'}</p>
					<p class="text-slate-300"><strong>Telefone:</strong> ${client ? client.phone : 'N/A'}</p>
				</div>
				<div class="bg-slate-700 p-4 rounded-lg mb-4">
					<h4 class="font-semibold text-white mb-2">Informações do Contrato</h4>
					<p class="text-slate-300"><strong>Descrição:</strong> ${contract.description}</p>
					<p class="text-slate-300"><strong>Valor Total:</strong> ${formatCurrency(contract.value)}</p>
					<p class="text-slate-300"><strong>Período:</strong> ${formatDate(contract.startDate)} até ${formatDate(contract.endDate)}</p>
					<p class="text-slate-300"><strong>Status:</strong> <span class="status-badge status-${contract.status.toLowerCase()}">${contract.status}</span></p>
					<p class="text-slate-300"><strong>Parcelas Pagas:</strong> ${paidParcels} de ${parcels.length}</p>
					<p class="text-slate-300"><strong>Total Recebido:</strong> ${formatCurrency(totalPaid)}</p>
				</div>
				<div class="bg-slate-700 p-4 rounded-lg">
					<h4 class="font-semibold text-white mb-3">Parcelas</h4>
					<div class="space-y-2">
			`;

			parcels.forEach((parcel, index) => {
				const statusClass = parcel.status === 'Paga' ? 'parcel-paid' : 
								   (new Date(parcel.dueDate) < new Date() && parcel.status !== 'Paga' ? 'parcel-overdue' : 'parcel-pending');
				
				html += `
					<div class="parcel-item ${statusClass}">
						<div class="flex justify-between items-center">
							<div>
								<p class="font-semibold text-white">Parcela ${parcel.number}</p>
								<p class="text-sm text-slate-400">Vencimento: ${formatDate(parcel.dueDate)}</p>
								<p class="text-sm text-slate-400">Valor: ${formatCurrency(parcel.value)}</p>
								${parcel.status === 'Paga' ? `
									<p class="text-sm text-green-400">Pago em: ${formatDate(parcel.paymentDate)}</p>
									<p class="text-sm text-slate-400">Valor Pago: ${formatCurrency(parcel.paymentAmount)}</p>
									<p class="text-sm text-slate-400">Método: ${parcel.paymentMethod}</p>
								` : ''}
							</div>
							<div>
								<span class="status-badge status-${parcel.status === 'Paga' ? 'pago' : (new Date(parcel.dueDate) < new Date() && parcel.status !== 'Paga' ? 'vencido' : 'pendente')}">
									${parcel.status === 'Paga' ? 'Paga' : (new Date(parcel.dueDate) < new Date() && parcel.status !== 'Paga' ? 'Vencida' : 'Pendente')}
								</span>
								${parcel.status !== 'Paga' ? `
									<button onclick="window.openPaymentModal('${contractId}', ${index})" 
											class="ml-2 px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm">
										<i class="fas fa-dollar-sign"></i> Pagar
									</button>
								` : ''}
							</div>
						</div>
					</div>
				`;
			});

			html += `
					</div>
				</div>
			`;

			document.getElementById('contractDetailsContent').innerHTML = html;
			openModal('contractDetailsModal');
		};

		// 
		// PAGAMENTOS
		// 

		window.openPaymentModal = (contractId, parcelIndex) => {
			const contract = contracts.find(c => c.id === contractId);
			if (!contract) return;

			const parcel = contract.parcels[parcelIndex];
			const client = clients.find(c => c.id === contract.clientId);

			document.getElementById('paymentContractId').value = contractId;
			document.getElementById('paymentParcelIndex').value = parcelIndex;
			document.getElementById('paymentAmount').value = parcel.value.toFixed(2);
			
			// Define data atual como padrão
			const today = new Date().toISOString().split('T')[0];
			document.getElementById('paymentDate').value = today;

			document.getElementById('paymentInfo').innerHTML = `
				<h4 class="font-semibold text-white mb-2">Detalhes do Pagamento</h4>
				<p class="text-slate-300"><strong>Cliente:</strong> ${client ? client.name : 'N/A'}</p>
				<p class="text-slate-300"><strong>Contrato:</strong> ${contract.description}</p>
				<p class="text-slate-300"><strong>Parcela:</strong> ${parcel.number} de ${contract.parcels.length}</p>
				<p class="text-slate-300"><strong>Vencimento:</strong> ${formatDate(parcel.dueDate)}</p>
				<p class="text-slate-300"><strong>Valor:</strong> ${formatCurrency(parcel.value)}</p>
			`;

			openModal('paymentModal');
		};

		document.getElementById('paymentForm').addEventListener('submit', async (e) => {
			e.preventDefault();

			const contractId = document.getElementById('paymentContractId').value;
			const parcelIndex = parseInt(document.getElementById('paymentParcelIndex').value);
			const paymentDate = document.getElementById('paymentDate').value;
			const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
			const paymentMethod = document.getElementById('paymentMethod').value;
			const notes = document.getElementById('paymentNotes').value;

			try {
				const contract = contracts.find(c => c.id === contractId);
				if (!contract) throw new Error('Contrato não encontrado');

				// ⚠️ CORREÇÃO APLICADA: Converte data para UTC mantendo o dia correto
				const [year, month, day] = paymentDate.split('-');
				const utcDate = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day), 12, 0, 0));
				
				contract.parcels[parcelIndex].status = 'Paga';
				contract.parcels[parcelIndex].paymentDate = utcDate.toISOString();
				contract.parcels[parcelIndex].paymentAmount = paymentAmount;
				contract.parcels[parcelIndex].paymentMethod = paymentMethod;
				contract.parcels[parcelIndex].notes = notes;

				await updateDoc(doc(db, 'contracts', contractId), {
					parcels: contract.parcels,
					updatedAt: new Date().toISOString()
				});

				showNotification('Pagamento registrado com sucesso!', 'success');
				closeModal();
				document.getElementById('paymentForm').reset();
				await loadContracts();
				
				if (currentSection === 'contracts') renderContractsSection();
				if (currentSection === 'payments') renderPaymentsSection();
			} catch (error) {
				showNotification('Erro ao registrar pagamento: ' + error.message, 'error');
			}
		});

		// 
		// RELATÓRIOS
		// 

		class ReportHandler {
			calculateMonthlyIncome(month, year) {
				const startDate = new Date(year, month - 1, 1);
				const endDate = new Date(year, month, 0, 23, 59, 59);
				
				let totalReceived = 0;
				let totalPending = 0;
				const payments = [];
				const defaulters = []; // ⚠️ NOVO: Array para inadimplentes

				contracts.forEach(contract => {
					const client = clients.find(c => c.id === contract.clientId);
					
					(contract.parcels || []).forEach(parcel => {
						// ⚠️ CORREÇÃO: Usa Date.UTC para garantir interpretação correta da data
						if (parcel.status === 'Paga' && parcel.paymentDate) {
							const paymentDateObj = new Date(parcel.paymentDate);
							const paymentYear = paymentDateObj.getUTCFullYear();
							const paymentMonth = paymentDateObj.getUTCMonth() + 1;
							
							// Verifica se o pagamento ocorreu no mês/ano do relatório
							if (paymentYear === year && paymentMonth === month) {
								totalReceived += parcel.paymentAmount || parcel.value;
								payments.push({
									clientName: client ? client.name : 'Cliente não encontrado',
									contractDescription: contract.description,
									parcelNumber: parcel.number,
									value: parcel.paymentAmount || parcel.value,
									paymentDate: parcel.paymentDate,
									paymentMethod: parcel.paymentMethod
								});
							}
						}
						
						// ⚠️ NOVO: Detecta inadimplentes (parcelas pendentes ou vencidas no período)
						if (parcel.status !== 'Paga') {
							const dueDate = new Date(parcel.dueDate + 'T12:00:00');
							const dueYear = dueDate.getFullYear();
							const dueMonth = dueDate.getMonth() + 1;
							
							// Se a parcela venceu no mês do relatório E não foi paga
							if (dueYear === year && dueMonth === month) {
								totalPending += parcel.value;
								
								const daysOverdue = Math.floor((new Date() - dueDate) / (1000 * 60 * 60 * 24));
								
								defaulters.push({
									clientName: client ? client.name : 'Cliente não encontrado',
									clientPhone: client ? client.phone : 'N/A',
									contractDescription: contract.description,
									parcelNumber: parcel.number,
									totalParcels: contract.parcels.length,
									value: parcel.value,
									dueDate: parcel.dueDate,
									daysOverdue: daysOverdue > 0 ? daysOverdue : 0,
									status: daysOverdue > 0 ? 'Vencida' : 'A vencer'
								});
							}
						}
					});
				});

				return { 
					totalReceived, 
					totalPending,
					payments, 
					defaulters // ⚠️ NOVO: Retorna lista de inadimplentes
				};
			}

			generateMonthlyReport(month, year) {
				const { totalReceived, totalPending, payments, defaulters } = this.calculateMonthlyIncome(month, year);
				const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
								   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

				let html = `
					<div class="bg-slate-700 p-6 rounded-lg mb-6">
						<h3 class="text-2xl font-bold text-white mb-4">
							Relatório de ${monthNames[month - 1]} de ${year}
						</h3>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div class="bg-green-900/30 border border-green-600 p-4 rounded-lg">
								<p class="text-green-400 text-sm font-semibold mb-1">TOTAL RECEBIDO</p>
								<p class="text-3xl font-bold text-white mt-2">${formatCurrency(totalReceived)}</p>
								<p class="text-sm text-slate-400 mt-1">${payments.length} pagamento(s) recebido(s)</p>
							</div>
							<div class="bg-red-900/30 border border-red-600 p-4 rounded-lg">
								<p class="text-red-400 text-sm font-semibold mb-1">TOTAL PENDENTE</p>
								<p class="text-3xl font-bold text-white mt-2">${formatCurrency(totalPending)}</p>
								<p class="text-sm text-slate-400 mt-1">${defaulters.length} cliente(s) inadimplente(s)</p>
							</div>
						</div>
					</div>

					<div class="bg-slate-700 p-6 rounded-lg mb-6">
						<h4 class="text-xl font-semibold text-white mb-4">
							<i class="fas fa-check-circle text-green-400 mr-2"></i>
							Pagamentos Recebidos
						</h4>
				`;

				if (payments.length === 0) {
					html += '<p class="text-slate-400 text-center py-4">Nenhum pagamento registrado neste período.</p>';
				} else {
					html += '<div class="overflow-x-auto"><table class="w-full">';
					html += `
						<thead class="table-header">
							<tr>
								<th class="px-4 py-3 text-left text-white">Cliente</th>
								<th class="px-4 py-3 text-left text-white">Contrato</th>
								<th class="px-4 py-3 text-center text-white">Parcela</th>
								<th class="px-4 py-3 text-center text-white">Data Pgto</th>
								<th class="px-4 py-3 text-center text-white">Método</th>
								<th class="px-4 py-3 text-right text-white">Valor</th>
							</tr>
						</thead>
						<tbody>
					`;

					payments.forEach(payment => {
						html += `
							<tr class="table-row">
								<td class="px-4 py-3 text-slate-300">${payment.clientName}</td>
								<td class="px-4 py-3 text-slate-300">${payment.contractDescription}</td>
								<td class="px-4 py-3 text-center text-slate-300">${payment.parcelNumber}</td>
								<td class="px-4 py-3 text-center text-slate-300">${formatDate(payment.paymentDate)}</td>
								<td class="px-4 py-3 text-center text-slate-300">${payment.paymentMethod}</td>
								<td class="px-4 py-3 text-right text-green-400 font-semibold">${formatCurrency(payment.value)}</td>
							</tr>
						`;
					});

					html += '</tbody></table></div>';
				}

				html += '</div>';

				// ⚠️ NOVO: SEÇÃO DE INADIMPLENTES
				html += `
					<div class="bg-red-900/20 border-2 border-red-600 p-6 rounded-lg">
						<h4 class="text-xl font-semibold text-white mb-4">
							<i class="fas fa-exclamation-triangle text-red-400 mr-2"></i>
							Clientes Inadimplentes
						</h4>
				`;

				if (defaulters.length === 0) {
					html += '<p class="text-slate-400 text-center py-4">✅ Nenhum cliente inadimplente neste período!</p>';
				} else {
					html += '<div class="overflow-x-auto"><table class="w-full">';
					html += `
						<thead class="bg-red-800">
							<tr>
								<th class="px-4 py-3 text-left text-white">Cliente</th>
								<th class="px-4 py-3 text-left text-white">Telefone</th>
								<th class="px-4 py-3 text-left text-white">Contrato</th>
								<th class="px-4 py-3 text-center text-white">Parcela</th>
								<th class="px-4 py-3 text-center text-white">Vencimento</th>
								<th class="px-4 py-3 text-center text-white">Dias Atraso</th>
								<th class="px-4 py-3 text-right text-white">Valor</th>
							</tr>
						</thead>
						<tbody>
					`;

					defaulters.forEach(defaulter => {
						const rowClass = defaulter.daysOverdue > 0 ? 'bg-red-900/30' : 'bg-yellow-900/30';
						html += `
							<tr class="table-row ${rowClass}">
								<td class="px-4 py-3 text-white font-semibold">${defaulter.clientName}</td>
								<td class="px-4 py-3 text-slate-300">${defaulter.clientPhone}</td>
								<td class="px-4 py-3 text-slate-300">${defaulter.contractDescription}</td>
								<td class="px-4 py-3 text-center text-slate-300">${defaulter.parcelNumber}/${defaulter.totalParcels}</td>
								<td class="px-4 py-3 text-center text-slate-300">${formatDate(defaulter.dueDate)}</td>
								<td class="px-4 py-3 text-center ${defaulter.daysOverdue > 0 ? 'text-red-400 font-bold' : 'text-yellow-400'}">
									${defaulter.daysOverdue > 0 ? defaulter.daysOverdue + ' dias' : 'No prazo'}
								</td>
								<td class="px-4 py-3 text-right text-red-400 font-semibold">${formatCurrency(defaulter.value)}</td>
							</tr>
						`;
					});

					html += '</tbody></table></div>';
				}

				html += '</div>';

				return html;
			}
		}

		const reportHandler = new ReportHandler();

		const generateAndShowReport = () => {
			const month = parseInt(document.getElementById('reportMonth').value);
			const year = parseInt(document.getElementById('reportYear').value);
			
			const reportContent = reportHandler.generateMonthlyReport(month, year);
			document.getElementById('reportContent').innerHTML = reportContent;
			
			openModal('reportModal');
		};

		document.getElementById('downloadPdfBtn').addEventListener('click', () => {
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF();
			
			const month = parseInt(document.getElementById('reportMonth').value);
			const year = parseInt(document.getElementById('reportYear').value);
			const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
								'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
			const reportTitle = `Relatório Mensal - ${monthNames[month - 1]} de ${year}`;

			doc.setFontSize(18);
			doc.text(reportTitle, 14, 22);

			const { totalReceived, totalPending, payments, defaulters } = reportHandler.calculateMonthlyIncome(month, year);

			doc.setFontSize(12);
			doc.text(`Total Recebido: ${formatCurrency(totalReceived)}`, 14, 35);
			doc.text(`Total Pendente: ${formatCurrency(totalPending)}`, 14, 42);

			let y = 55;

			doc.setFontSize(14);
			doc.text('Pagamentos Recebidos:', 14, y);
			y += 10;

			if (payments.length === 0) {
				doc.setFontSize(10);
				doc.text('Nenhum pagamento registrado neste período.', 14, y);
				y += 10;
			} else {
				const headers = [['Cliente', 'Contrato', 'Parcela', 'Data Pgto', 'Método', 'Valor']];
				const data = payments.map(p => [
					p.clientName,
					p.contractDescription,
					p.parcelNumber,
					formatDate(p.paymentDate),
					p.paymentMethod,
					formatCurrency(p.value)
				]);
				doc.autoTable({
					startY: y,
					head: headers,
					body: data,
					theme: 'grid',
					styles: { fontSize: 8, cellPadding: 2, fillColor: [30, 41, 59] },
					headStyles: { fillColor: [51, 65, 85], textColor: [255, 255, 255] },
					alternateRowStyles: { fillColor: [24, 33, 48] },
					margin: { left: 14, right: 14 },
					didDrawPage: function (data) {
						// Footer
						let str = 'Página ' + doc.internal.getNumberOfPages();
						doc.setFontSize(10);
						doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
					}
				});
				y = doc.autoTable.previous.finalY + 10;
			}

			doc.setFontSize(14);
			doc.text('Clientes Inadimplentes:', 14, y);
			y += 10;

			if (defaulters.length === 0) {
				doc.setFontSize(10);
				doc.text('Nenhum cliente inadimplente neste período.', 14, y);
				y += 10;
			} else {
				const headers = [['Cliente', 'Telefone', 'Contrato', 'Parcela', 'Vencimento', 'Atraso', 'Valor']];
				const data = defaulters.map(d => [
					d.clientName,
					d.clientPhone,
					d.contractDescription,
					`${d.parcelNumber}/${d.totalParcels}`,
					formatDate(d.dueDate),
					d.daysOverdue > 0 ? `${d.daysOverdue} dias` : 'No prazo',
					formatCurrency(d.value)
				]);
				doc.autoTable({
					startY: y,
					head: headers,
					body: data,
					theme: 'grid',
					styles: { fontSize: 8, cellPadding: 2, fillColor: [30, 41, 59] },
					headStyles: { fillColor: [153, 27, 27], textColor: [255, 255, 255] },
					alternateRowStyles: { fillColor: [24, 33, 48] },
					margin: { left: 14, right: 14 },
					didDrawPage: function (data) {
						// Footer
						let str = 'Página ' + doc.internal.getNumberOfPages();
						doc.setFontSize(10);
						doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
					}
				});
				y = doc.autoTable.previous.finalY + 10;
			}

			doc.save(`Relatorio_Mensal_${monthNames[month - 1]}_${year}.pdf`);
		});

		// 
		// RENDERIZAÇÃO DAS SEÇÕES
		// 

		const renderSection = (section) => {
			const mainContent = document.getElementById('mainContent');
			
			switch(section) {
				case 'dashboard':
					renderDashboard();
					document.getElementById('pageTitle').textContent = 'Dashboard';
					document.getElementById('pageSubtitle').textContent = 'Visão geral do sistema';
					break;
				case 'clients':
					renderClientsSection();
					document.getElementById('pageTitle').textContent = 'Clientes';
					document.getElementById('pageSubtitle').textContent = 'Gerencie seus clientes';
					break;
				case 'contracts':
					renderContractsSection();
					document.getElementById('pageTitle').textContent = 'Contratos';
					document.getElementById('pageSubtitle').textContent = 'Gerencie os contratos';
					break;
				case 'payments':
					renderPaymentsSection();
					document.getElementById('pageTitle').textContent = 'Pagamentos';
					document.getElementById('pageSubtitle').textContent = 'Controle de pagamentos';
					break;
				case 'reports':
					renderReportsSection();
					document.getElementById('pageTitle').textContent = 'Relatórios';
					document.getElementById('pageSubtitle').textContent = 'Relatórios financeiros';
					break;
				case 'analytics':
					renderAnalyticsSection();
					document.getElementById('pageTitle').textContent = 'Análises';
					document.getElementById('pageSubtitle').textContent = 'Gráficos e insights';
					break;
				case 'settings':
					renderSettingsSection();
					document.getElementById('pageTitle').textContent = 'Configurações';
					document.getElementById('pageSubtitle').textContent = 'Ajustes do sistema';
					break;
			}
		};

		const renderDashboard = () => {
			const totalClients = clients.length;
			const activeContracts = contracts.filter(c => c.status === 'Ativo').length;
			
			let totalRevenue = 0;
			let pendingPayments = 0;
			
			contracts.forEach(contract => {
				(contract.parcels || []).forEach(parcel => {
					if (parcel.status === 'Paga') {
						totalRevenue += parcel.paymentAmount || parcel.value;
					} else {
						pendingPayments += parcel.value;
					}
				});
			});

			document.getElementById('mainContent').innerHTML = `
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
					<div class="stat-card p-6 rounded-lg">
						<div class="flex items-center justify-between">
							<div>
								<p class="text-slate-400 text-sm font-medium">Total de Clientes</p>
								<p class="text-3xl font-bold text-white mt-2">${totalClients}</p>
							</div>
							<div class="bg-blue-500/20 p-4 rounded-full">
								<i class="fas fa-users text-blue-400 text-2xl"></i>
							</div>
						</div>
					</div>

					<div class="stat-card p-6 rounded-lg">
						<div class="flex items-center justify-between">
							<div>
								<p class="text-slate-400 text-sm font-medium">Contratos Ativos</p>
								<p class="text-3xl font-bold text-white mt-2">${activeContracts}</p>
							</div>
							<div class="bg-green-500/20 p-4 rounded-full">
								<i class="fas fa-file-contract text-green-400 text-2xl"></i>
							</div>
						</div>
					</div>

					<div class="stat-card p-6 rounded-lg">
						<div class="flex items-center justify-between">
							<div>
								<p class="text-slate-400 text-sm font-medium">Receita Total</p>
								<p class="text-2xl font-bold text-white mt-2">${formatCurrency(totalRevenue)}</p>
							</div>
							<div class="bg-purple-500/20 p-4 rounded-full">
								<i class="fas fa-dollar-sign text-purple-400 text-2xl"></i>
							</div>
						</div>
					</div>

					<div class="stat-card p-6 rounded-lg">
						<div class="flex items-center justify-between">
							<div>
								<p class="text-slate-400 text-sm font-medium">A Receber</p>
								<p class="text-2xl font-bold text-white mt-2">${formatCurrency(pendingPayments)}</p>
							</div>
							<div class="bg-yellow-500/20 p-4 rounded-full">
								<i class="fas fa-clock text-yellow-400 text-2xl"></i>
							</div>
						</div>
					</div>
				</div>

				<div class="card-gradient p-6 rounded-lg">
					<h3 class="text-xl font-bold text-white mb-4">Bem-vindo ao Sistema de Gestão Financeira</h3>
					<p class="text-slate-300">Utilize o menu lateral para navegar entre as seções e gerenciar clientes, contratos, pagamentos e relatórios.</p>
				</div>
			`;
		};

		const renderClientsSection = () => {
			let html = `
				<div class="mb-6 flex justify-between items-center">
					<button onclick="window.openClientModal()" class="btn-primary px-6 py-3 rounded-lg text-white font-semibold">
						<i class="fas fa-plus mr-2"></i>Novo Cliente
					</button>
					<div class="flex space-x-2">
						<button onclick="loadClients(false)" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg">Anterior</button>
						<button onclick="loadClients(true)" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg">Próximo</button>
					</div>
				</div>

				<div class="card-gradient rounded-lg overflow-hidden">
					<div class="overflow-x-auto">
						<table class="w-full">
							<thead class="table-header">
								<tr>
									<th class="px-6 py-4 text-left text-white">Nome</th>
									<th class="px-6 py-4 text-left text-white">CPF/CNPJ</th>
									<th class="px-6 py-4 text-left text-white">Telefone</th>
									<th class="px-6 py-4 text-left text-white">E-mail</th>
									<th class="px-6 py-4 text-center text-white">Ações</th>
								</tr>
							</thead>
							<tbody>
			`;

			if (clients.length === 0) {
				html += `
					<tr>
						<td colspan="5" class="px-6 py-8 text-center text-slate-400">
							<i class="fas fa-inbox text-4xl mb-2"></i>
							<p>Nenhum cliente cadastrado</p>
						</td>
					</tr>
				`;
			} else {
				clients.forEach(client => {
					html += `
						<tr class="table-row">
							<td class="px-6 py-4 text-slate-200 font-medium">${client.name}</td>
							<td class="px-6 py-4 text-slate-300">${client.cpf}</td>
							<td class="px-6 py-4 text-slate-300">${client.phone}</td>
							<td class="px-6 py-4 text-slate-300">${client.email || '-'}</td>
							<td class="px-6 py-4 text-center">
								<button onclick="window.editClient('${client.id}')" class="btn-action text-blue-400 hover:text-blue-300 mx-1">
									<i class="fas fa-edit"></i>
								</button>
								<button onclick="window.deleteClient('${client.id}')" class="btn-action text-red-400 hover:text-red-300 mx-1">
									<i class="fas fa-trash"></i>
								</button>
							</td>
						</tr>
					`;
				});
			}

			html += `
							</tbody>
						</table>
					</div>
				</div>
			`;

			document.getElementById('mainContent').innerHTML = html;
		};

		const renderContractsSection = () => {
			let html = `
				<div class="mb-6 flex justify-between items-center">
					<button onclick="window.openContractModal()" class="btn-primary px-6 py-3 rounded-lg text-white font-semibold">
						<i class="fas fa-plus mr-2"></i>Novo Contrato
					</button>
					<div class="flex space-x-2">
						<button onclick="loadContracts(false)" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg">Anterior</button>
						<button onclick="loadContracts(true)" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg">Próximo</button>
					</div>
				</div>

				<div class="card-gradient rounded-lg overflow-hidden">
					<div class="overflow-x-auto">
						<table class="w-full">
							<thead class="table-header">
								<tr>
									<th class="px-6 py-4 text-left text-white">Cliente</th>
									<th class="px-6 py-4 text-left text-white">Descrição</th>
									<th class="px-6 py-4 text-center text-white">Valor</th>
									<th class="px-6 py-4 text-center text-white">Status</th>
									<th class="px-6 py-4 text-center text-white">Ações</th>
								</tr>
							</thead>
							<tbody>
			`;

			if (contracts.length === 0) {
				html += `
					<tr>
						<td colspan="5" class="px-6 py-8 text-center text-slate-400">
							<i class="fas fa-inbox text-4xl mb-2"></i>
							<p>Nenhum contrato cadastrado</p>
						</td>
					</tr>
				`;
			} else {
				contracts.forEach(contract => {
					const client = clients.find(c => c.id === contract.clientId);
					html += `
						<tr class="table-row">
							<td class="px-6 py-4 text-slate-200 font-medium">${client ? client.name : 'N/A'}</td>
							<td class="px-6 py-4 text-slate-300">${contract.description}</td>
							<td class="px-6 py-4 text-center text-slate-300">${formatCurrency(contract.value)}</td>
							<td class="px-6 py-4 text-center">
								<span class="status-badge status-${contract.status.toLowerCase()}">${contract.status}</span>
							</td>
							<td class="px-6 py-4 text-center">
								<button onclick="window.viewContractDetails('${contract.id}')" class="btn-action text-purple-400 hover:text-purple-300 mx-1" title="Ver Detalhes">
									<i class="fas fa-eye"></i>
								</button>
								<button onclick="window.editContract('${contract.id}')" class="btn-action text-blue-400 hover:text-blue-300 mx-1" title="Editar">
									<i class="fas fa-edit"></i>
								</button>
								<button onclick="window.deleteContract('${contract.id}')" class="btn-action text-red-400 hover:text-red-300 mx-1" title="Excluir">
									<i class="fas fa-trash"></i>
								</button>
							</td>
						</tr>
					`;
				});
			}

			html += `
							</tbody>
						</table>
					</div>
				</div>
			`;

			document.getElementById('mainContent').innerHTML = html;
		};

		const renderPaymentsSection = () => {
			let allParcels = [];
			
			contracts.forEach(contract => {
				const client = clients.find(c => c.id === contract.clientId);
				(contract.parcels || []).forEach((parcel, index) => {
					allParcels.push({
						contractId: contract.id,
						parcelIndex: index,
						clientName: client ? client.name : 'N/A',
						contractDescription: contract.description,
						...parcel
					});
				});
			});

			allParcels.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

			let html = `
				<div class="card-gradient rounded-lg overflow-hidden">
					<div class="overflow-x-auto">
						<table class="w-full">
							<thead class="table-header">
								<tr>
									<th class="px-6 py-4 text-left text-white">Cliente</th>
									<th class="px-6 py-4 text-left text-white">Contrato</th>
									<th class="px-6 py-4 text-center text-white">Parcela</th>
									<th class="px-6 py-4 text-center text-white">Vencimento</th>
									<th class="px-6 py-4 text-center text-white">Valor</th>
									<th class="px-6 py-4 text-center text-white">Status</th>
									<th class="px-6 py-4 text-center text-white">Ação</th>
								</tr>
							</thead>
							<tbody>
			`;

			if (allParcels.length === 0) {
				html += `
					<tr>
						<td colspan="7" class="px-6 py-8 text-center text-slate-400">
							<i class="fas fa-inbox text-4xl mb-2"></i>
							<p>Nenhuma parcela encontrada</p>
						</td>
					</tr>
				`;
			} else {
				allParcels.forEach(parcel => {
					const isOverdue = new Date(parcel.dueDate) < new Date() && parcel.status !== 'Paga';
					html += `
						<tr class="table-row">
							<td class="px-6 py-4 text-slate-200 font-medium">${parcel.clientName}</td>
							<td class="px-6 py-4 text-slate-300">${parcel.contractDescription}</td>
							<td class="px-6 py-4 text-center text-slate-300">${parcel.number}</td>
							<td class="px-6 py-4 text-center text-slate-300">${formatDate(parcel.dueDate)}</td>
							<td class="px-6 py-4 text-center text-slate-300">${formatCurrency(parcel.value)}</td>
							<td class="px-6 py-4 text-center">
								<span class="status-badge status-${parcel.status === 'Paga' ? 'pago' : (isOverdue ? 'vencido' : 'pendente')}">
									${parcel.status === 'Paga' ? 'Paga' : (isOverdue ? 'Vencida' : 'Pendente')}
								</span>
							</td>
							<td class="px-6 py-4 text-center">
								${parcel.status !== 'Paga' ? `
									<button onclick="window.openPaymentModal('${parcel.contractId}', ${parcel.parcelIndex})" 
											class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-semibold">
										<i class="fas fa-dollar-sign mr-1"></i>Pagar
									</button>
								` : `
									<span class="text-green-400"><i class="fas fa-check-circle"></i> Pago</span>
								`}
							</td>
						</tr>
					`;
				});
			}

			html += `
							</tbody>
						</table>
					</div>
				</div>
			`;

			document.getElementById('mainContent').innerHTML = html;
		};

		const renderReportsSection = () => {
			const currentDate = new Date();
			const currentMonth = currentDate.getMonth() + 1;
			const currentYear = currentDate.getFullYear();

			let monthOptions = '';
			const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
							   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
			
			monthNames.forEach((name, index) => {
				const value = index + 1;
				monthOptions += `<option value="${value}" ${value === currentMonth ? 'selected' : ''}>${name}</option>`;
			});

			let yearOptions = '';
			for (let y = currentYear - 2; y <= currentYear + 1; y++) {
				yearOptions += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`;
			}

			document.getElementById('mainContent').innerHTML = `
				<div class="card-gradient p-8 rounded-lg max-w-2xl">
					<h3 class="text-2xl font-bold text-white mb-6">
						<i class="fas fa-chart-line text-blue-400 mr-2"></i>
						Gerar Relatório Mensal
					</h3>
					
					<div class="space-y-4">
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								<label class="block text-sm font-medium text-slate-300 mb-2">Mês</label>
								<select id="reportMonth" class="w-full px-4 py-3 rounded-lg">
									${monthOptions}
								</select>
							</div>
							<div>
								<label class="block text-sm font-medium text-slate-300 mb-2">Ano</label>
								<select id="reportYear" class="w-full px-4 py-3 rounded-lg">
									${yearOptions}
								</select>
							</div>
						</div>

						<button onclick="window.generateAndShowReport()" class="w-full btn-primary py-4 rounded-lg text-white font-semibold text-lg">
							<i class="fas fa-file-invoice mr-2"></i>Gerar Relatório
						</button>
					</div>

					<div class="mt-6 p-4 bg-blue-900/20 border border-blue-600 rounded-lg">
						<p class="text-sm text-slate-300">
							<i class="fas fa-info-circle text-blue-400 mr-2"></i>
							<strong>Informação:</strong> O relatório exibirá todos os pagamentos recebidos e clientes inadimplentes no período selecionado.
						</p>
					</div>
				</div>
			`;
		};

		const renderAnalyticsSection = () => {
			document.getElementById('mainContent').innerHTML = `
				<div class="card-gradient p-8 rounded-lg">
					<h3 class="text-2xl font-bold text-white mb-6">
						<i class="fas fa-chart-pie text-orange-400 mr-2"></i>
						Análises Financeiras
					</h3>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div>
							<h4 class="text-xl font-semibold text-white mb-4">Receita por Mês</h4>
							<div class="chart-container">
								<canvas id="revenueChart"></canvas>
							</div>
						</div>
						<div>
							<h4 class="text-xl font-semibold text-white mb-4">Status dos Contratos</h4>
							<div class="chart-container">
								<canvas id="contractStatusChart"></canvas>
							</div>
						</div>
					</div>
				</div>
			`;
			renderCharts();
		};

		const renderCharts = () => {
			const monthlyRevenue = {};
			const contractStatusCounts = {
				'Ativo': 0,
				'Concluído': 0,
				'Cancelado': 0
			};

			contracts.forEach(contract => {
				contractStatusCounts[contract.status] = (contractStatusCounts[contract.status] || 0) + 1;
				(contract.parcels || []).forEach(parcel => {
					if (parcel.status === 'Paga' && parcel.paymentDate) {
						const date = new Date(parcel.paymentDate);
						const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
						monthlyRevenue[monthYear] = (monthlyRevenue[monthYear] || 0) + (parcel.paymentAmount || parcel.value);
					}
				});
			});

			// Ordenar meses para o gráfico de receita
			const sortedMonths = Object.keys(monthlyRevenue).sort();
			const revenueData = sortedMonths.map(month => monthlyRevenue[month]);

			new Chart(document.getElementById('revenueChart'), {
				type: 'line',
				data: {
					labels: sortedMonths,
					datasets: [{
						label: 'Receita Mensal (BRL)',
						data: revenueData,
						borderColor: '#3b82f6',
						backgroundColor: 'rgba(59, 130, 246, 0.2)',
						fill: true,
						tension: 0.3
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					scales: {
						y: {
							beginAtZero: true,
							ticks: {
								color: '#cbd5e1',
								callback: function(value) { return formatCurrency(value); }
							},
							grid: { color: '#475569' }
						},
						x: {
							ticks: { color: '#cbd5e1' },
							grid: { color: '#475569' }
						}
					},
					plugins: {
						legend: {
							labels: { color: '#cbd5e1' }
						}
					}
				}
			});

			new Chart(document.getElementById('contractStatusChart'), {
				type: 'pie',
				data: {
					labels: Object.keys(contractStatusCounts),
					datasets: [{
						data: Object.values(contractStatusCounts),
						backgroundColor: ['#10b981', '#06b6d4', '#ef4444'],
						hoverOffset: 4
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: {
							labels: { color: '#cbd5e1' }
						}
					}
				}
			});
		};

		const renderSettingsSection = () => {
			document.getElementById('mainContent').innerHTML = `
				<div class="card-gradient p-8 rounded-lg">
					<h3 class="text-2xl font-bold text-white mb-6">
						<i class="fas fa-cog text-gray-400 mr-2"></i>
						Configurações do Sistema
					</h3>
					<div class="space-y-4">
						<div class="bg-slate-700 p-4 rounded-lg">
							<h4 class="font-semibold text-white mb-2">Informações da Conta</h4>
							<p class="text-slate-300"><strong>E-mail:</strong> ${currentUser ? currentUser.email : 'N/A'}</p>
							<button class="mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Alterar Senha</button>
						</div>
						<div class="bg-slate-700 p-4 rounded-lg">
							<h4 class="font-semibold text-white mb-2">Gerenciamento de Dados</h4>
							<p class="text-slate-300">Opções para backup e restauração de dados.</p>
							<button class="mt-3 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg">Fazer Backup</button>
						</div>
						<div class="bg-slate-700 p-4 rounded-lg">
							<h4 class="font-semibold text-white mb-2">Lixeira</h4>
							<p class="text-slate-300">Visualize e restaure itens excluídos.</p>
							<button onclick="window.openTrashModal()" class="mt-3 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Abrir Lixeira</button>
						</div>
						<div class="bg-slate-700 p-4 rounded-lg">
							<h4 class="font-semibold text-white mb-2">Workshop de Correções</h4>
							<p class="text-slate-300">Ferramentas para corrigir inconsistências nos dados.</p>
							<button onclick="window.openWorkshopModal()" class="mt-3 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">Abrir Workshop</button>
						</div>
					</div>
				</div>
			`;
		};

		// 
		// WORKSHOP DE CORREÇÕES (Exemplo de funcionalidade avançada)
		// 

		class CorrectionCalculator {
			constructor(contracts, clients) {
				this.contracts = contracts;
				this.clients = clients;
			}

			// Verifica e corrige parcelas sem paymentAmount (para compatibilidade retroativa)
			checkAndFixPaymentAmounts() {
				let corrections = [];
				this.contracts.forEach(contract => {
					(contract.parcels || []).forEach(parcel => {
						if (parcel.status === 'Paga' && parcel.paymentDate && parcel.paymentAmount === undefined) {
							corrections.push({
								type: 'Missing Payment Amount',
								contractId: contract.id,
								parcelNumber: parcel.number,
								oldValue: 'undefined',
								newValue: parcel.value,
								description: `Parcela ${parcel.number} do contrato ${contract.description} paga, mas sem 'paymentAmount'. Definindo como 'value'.`
							});
							parcel.paymentAmount = parcel.value; // Define o valor pago como o valor da parcela
						}
					});
				});
				return corrections;
			}

			// Verifica se todos os contratos têm um cliente válido
			checkInvalidClients() {
				let invalidClientContracts = [];
				this.contracts.forEach(contract => {
					const clientExists = this.clients.some(c => c.id === contract.clientId);
					if (!clientExists) {
						invalidClientContracts.push({
							contractId: contract.id,
							contractDescription: contract.description,
							clientId: contract.clientId,
							description: `Contrato '${contract.description}' (${contract.id}) referencia um cliente inexistente (${contract.clientId}).`
						});
					}
				});
				return invalidClientContracts;
			}

			// Aplica as correções e salva no Firestore
			async applyCorrections(corrections) {
				const batch = [];
				const updatedContractIds = new Set();

				corrections.forEach(correction => {
					if (correction.type === 'Missing Payment Amount') {
						const contract = this.contracts.find(c => c.id === correction.contractId);
						if (contract) {
							const parcel = contract.parcels.find(p => p.number === correction.parcelNumber);
							if (parcel) {
								parcel.paymentAmount = correction.newValue;
								updatedContractIds.add(contract.id);
							}
						}
					}
					// Adicionar outras lógicas de correção aqui
				});

				for (const contractId of updatedContractIds) {
					const contract = this.contracts.find(c => c.id === contractId);
					if (contract) {
						batch.push(updateDoc(doc(db, 'contracts', contractId), {
							parcels: contract.parcels,
							updatedAt: new Date().toISOString()
						}));
					}
				}

				if (batch.length > 0) {
					await Promise.all(batch); // Executa todas as atualizações em paralelo
					showNotification(`${batch.length} contratos atualizados com sucesso!`, 'success');
					await loadContracts(); // Recarrega os contratos após a correção
				} else {
					showNotification('Nenhuma correção aplicada.', 'info');
				}
			}
		}

		window.openWorkshopModal = async () => {
			const workshopContent = document.getElementById('workshopContent');
			workshopContent.innerHTML = `
				<div class="loading-spinner mx-auto"></div>
				<p class="text-center text-slate-400 mt-4">Verificando inconsistências...</p>
			`;
			openModal('workshopModal');

			const correctionCalculator = new CorrectionCalculator(contracts, clients);
			const missingPaymentAmounts = correctionCalculator.checkAndFixPaymentAmounts();
			const invalidClientContracts = correctionCalculator.checkInvalidClients();

			let html = `
				<h4 class="text-xl font-semibold text-white mb-4">Resultados da Verificação</h4>
			`;

			if (missingPaymentAmounts.length > 0) {
				html += `
					<div class="bg-yellow-900/20 border border-yellow-600 p-4 rounded-lg mb-4">
						<p class="text-yellow-400 font-semibold mb-2">
							<i class="fas fa-exclamation-circle mr-2"></i>
							${missingPaymentAmounts.length} Parcelas com 'paymentAmount' ausente:
						</p>
						<ul class="list-disc list-inside text-slate-300 space-y-1">
							${missingPaymentAmounts.map(c => `<li>${c.description}</li>`).join('')}
						</ul>
						<button id="applyPaymentAmountFix" class="mt-4 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg">
							Aplicar Correção (Payment Amount)
						</button>
					</div>
				`;
			} else {
				html += `
					<div class="bg-green-900/20 border border-green-600 p-4 rounded-lg mb-4">
						<p class="text-green-400 font-semibold">
							<i class="fas fa-check-circle mr-2"></i>
							Nenhuma parcela com 'paymentAmount' ausente encontrada.
						</p>
					</div>
				`;
			}

			if (invalidClientContracts.length > 0) {
				html += `
					<div class="bg-red-900/20 border border-red-600 p-4 rounded-lg mb-4">
						<p class="text-red-400 font-semibold mb-2">
							<i class="fas fa-times-circle mr-2"></i>
							${invalidClientContracts.length} Contratos com cliente inválido:
						</p>
						<ul class="list-disc list-inside text-slate-300 space-y-1">
							${invalidClientContracts.map(c => `<li>${c.description}</li>`).join('')}
						</ul>
						<p class="text-sm text-slate-400 mt-2">
							<strong>Atenção:</strong> Contratos com clientes inválidos podem precisar de correção manual ou exclusão.
						</p>
					</div>
				`;
			} else {
				html += `
					<div class="bg-green-900/20 border border-green-600 p-4 rounded-lg mb-4">
						<p class="text-green-400 font-semibold">
							<i class="fas fa-check-circle mr-2"></i>
							Nenhum contrato com cliente inválido encontrado.
						</p>
					</div>
				`;
			}

			if (missingPaymentAmounts.length === 0 && invalidClientContracts.length === 0) {
				html += `
					<div class="bg-blue-900/20 border border-blue-600 p-4 rounded-lg">
						<p class="text-blue-400 font-semibold">
							<i class="fas fa-info-circle mr-2"></i>
							Nenhuma inconsistência crítica encontrada no momento.
						</p>
					</div>
				`;
			}

			workshopContent.innerHTML = html;

			if (missingPaymentAmounts.length > 0) {
				document.getElementById('applyPaymentAmountFix').addEventListener('click', async () => {
					await correctionCalculator.applyCorrections(missingPaymentAmounts);
					closeModal();
					showNotification('Correções de "paymentAmount" aplicadas!', 'success');
					renderSection(currentSection); // Recarrega a seção atual
				});
			}
		};

		// 
		// LIXEIRA (Exemplo de funcionalidade avançada)
		// 

		window.openTrashModal = async () => {
			const trashContent = document.getElementById('trashContent');
			trashContent.innerHTML = `
				<div class="loading-spinner mx-auto"></div>
				<p class="text-center text-slate-400 mt-4">Carregando itens excluídos...</p>
			`;
			openModal('trashModal');

			try {
				const q = query(collection(db, 'trash'), orderBy('deletedAt', 'desc'));
				const querySnapshot = await getDocs(q);
				const trashItems = [];
				querySnapshot.forEach((doc) => {
					trashItems.push({ id: doc.id, ...doc.data() });
				});

				let html = `
					<h4 class="text-xl font-semibold text-white mb-4">Itens Excluídos Recentemente</h4>
				`;

				if (trashItems.length === 0) {
					html += `
						<div class="bg-blue-900/20 border border-blue-600 p-4 rounded-lg">
							<p class="text-blue-400 font-semibold text-center">
								<i class="fas fa-box-open mr-2"></i>
								A lixeira está vazia.
							</p>
						</div>
					`;
				} else {
					html += `
						<div class="overflow-x-auto">
							<table class="w-full">
								<thead class="table-header">
									<tr>
										<th class="px-4 py-3 text-left text-white">Tipo</th>
										<th class="px-4 py-3 text-left text-white">Nome/Descrição</th>
										<th class="px-4 py-3 text-center text-white">Excluído em</th>
										<th class="px-4 py-3 text-center text-white">Ações</th>
									</tr>
								</thead>
								<tbody>
					`;
					trashItems.forEach(item => {
						html += `
							<tr class="table-row">
								<td class="px-4 py-3 text-slate-300">${item.type}</td>
								<td class="px-4 py-3 text-slate-200 font-medium">${item.name || item.description || 'N/A'}</td>
								<td class="px-4 py-3 text-center text-slate-300">${formatDate(item.deletedAt)}</td>
								<td class="px-4 py-3 text-center">
									<button onclick="window.restoreItem('${item.id}')" class="btn-action text-green-400 hover:text-green-300 mx-1" title="Restaurar">
										<i class="fas fa-undo"></i>
									</button>
									<button onclick="window.permanentlyDeleteItem('${item.id}')" class="btn-action text-red-400 hover:text-red-300 mx-1" title="Excluir Permanentemente">
										<i class="fas fa-times"></i>
									</button>
								</td>
							</tr>
						`;
					});
					html += `
								</tbody>
							</table>
						</div>
					`;
				}
				trashContent.innerHTML = html;
			} catch (error) {
				showNotification('Erro ao carregar lixeira: ' + error.message, 'error');
				closeModal();
			}
		};

		window.restoreItem = async (itemId) => {
			if (!confirm('Tem certeza que deseja restaurar este item?')) return;

			try {
				const itemDoc = await getDoc(doc(db, 'trash', itemId));
				if (!itemDoc.exists()) throw new Error('Item na lixeira não encontrado.');
				const itemData = itemDoc.data();

				if (itemData.type === 'client') {
					await addDoc(collection(db, 'clients'), { ...itemData, deletedAt: deleteField() });
					await deleteDoc(doc(db, 'trash', itemId));
					showNotification('Cliente restaurado com sucesso!', 'success');
					await loadClients();
				} else if (itemData.type === 'contract') {
					await addDoc(collection(db, 'contracts'), { ...itemData, deletedAt: deleteField() });
					await deleteDoc(doc(db, 'trash', itemId));
					showNotification('Contrato restaurado com sucesso!', 'success');
					await loadContracts();
				} else {
					throw new Error('Tipo de item desconhecido para restauração.');
				}
				
				closeModal();
				window.openTrashModal(); // Recarrega a lixeira
				renderSection(currentSection); // Recarrega a seção atual
			} catch (error) {
				showNotification('Erro ao restaurar item: ' + error.message, 'error');
			}
		};

		window.permanentlyDeleteItem = async (itemId) => {
			if (!confirm('ATENÇÃO: Tem certeza que deseja EXCLUIR PERMANENTEMENTE este item? Esta ação não pode ser desfeita.')) return;

			try {
				await deleteDoc(doc(db, 'trash', itemId));
				showNotification('Item excluído permanentemente!', 'success');
				closeModal();
				window.openTrashModal(); // Recarrega a lixeira
			} catch (error) {
				showNotification('Erro ao excluir permanentemente: ' + error.message, 'error');
			}
		};


		// Expor funções globalmente
		window.openClientModal = () => {
			document.getElementById('clientModalTitle').textContent = 'Novo Cliente';
			document.getElementById('clientForm').reset();
			document.getElementById('clientId').value = '';
			openModal('clientModal');
		};

		window.editClient = editClient;
		window.deleteClient = deleteClient;

		window.openContractModal = () => {
			document.getElementById('contractModalTitle').textContent = 'Novo Contrato';
			document.getElementById('contractForm').reset();
			document.getElementById('contractId').value = '';
			const today = new Date().toISOString().split('T')[0];
			document.getElementById('contractStartDate').value = today;
			document.getElementById('contractFirstParcel').value = today;
			openModal('contractModal');
		};

		window.editContract = editContract;
		window.deleteContract = deleteContract;
		window.viewContractDetails = viewContractDetails;

		window.generateAndShowReport = generateAndShowReport;

	</script>
</body>
</html>
