<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Financeira - Advocacia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1a2847 100%);
            color: #e2e8f0;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 600"><defs><pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(51,65,85,0.1)" stroke-width="1"/></pattern></defs><rect width="1200" height="600" fill="url(%23grid)" /></svg>');
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-right: 1px solid #334155;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.5);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #334155;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #94a3b8;
        }

        .sidebar-header i {
            color: #3b82f6;
            font-size: 24px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            color: #cbd5e1;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
            color: #fff;
            border-left-color: #3b82f6;
        }

        .nav-item.active {
            background-color: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border-left-color: #3b82f6;
        }

        .nav-item i {
            width: 18px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #334155;
            background: rgba(15, 23, 42, 0.5);
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.9) 100%);
        }

        .top-bar {
            padding: 20px 30px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-bottom: 1px solid #475569;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .top-bar h2 {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            margin: 0;
        }

        .top-bar p {
            font-size: 13px;
            color: #94a3b8;
            margin: 4px 0 0 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info p {
            text-align: right;
            font-size: 13px;
        }

        .user-info p:first-child {
            color: #94a3b8;
        }

        .user-info p:last-child {
            font-weight: 600;
            color: #fff;
            font-size: 14px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        /* CONTENT AREA */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .content::-webkit-scrollbar {
            width: 8px;
        }

        .content::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.1);
        }

        .content::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .content::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* CARDS */
        .card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #3b82f6;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }

        .card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* BUTTONS */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: #475569;
            color: white;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        /* MODALS */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #475569;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 24px;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #475569;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: rgba(51, 65, 85, 0.3);
        }

        /* FORMS */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 6px;
            color: #e2e8f0;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #94a3b8;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* TABLES */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #1e293b;
        }

        thead {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
        }

        thead th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: #e2e8f0;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #3b82f6;
        }

        tbody td {
            padding: 14px 16px;
            border-bottom: 1px solid #334155;
            font-size: 14px;
            color: #cbd5e1;
        }

        tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border: 1px solid #10b981;
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid #f59e0b;
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid #ef4444;
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid #3b82f6;
        }

        /* NOTIFICATIONS */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            animation: notificationSlide 0.3s ease-out;
            max-width: 400px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        @keyframes notificationSlide {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #3b82f6;
            transform: translateY(-4px);
        }

        .stat-value {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-value p:first-child {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value p:last-child {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .stat-icon.blue {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .stat-icon.green {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .stat-icon.red {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .stat-icon.yellow {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        /* LOADING */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #475569;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        /* LOGIN PAGE */
        .login-container {
            display: flex;
            height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1a2847 100%);
        }

        .login-left {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .login-form {
            width: 100%;
            max-width: 400px;
        }

        .login-form h1 {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .login-form > p {
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form .form-group label {
            font-size: 13px;
        }

        .form-group.checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .form-group.checkbox input {
            width: auto;
        }

        .form-group.checkbox label {
            margin: 0;
            font-size: 13px;
            font-weight: 400;
        }

        .login-links {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-top: 20px;
        }

        .login-links a {
            color: #3b82f6;
            text-decoration: none;
        }

        .login-links a:hover {
            text-decoration: underline;
        }

        .login-right {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
        }

        .login-right-content h2 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .login-right-content p {
            font-size: 16px;
            line-height: 1.6;
            color: #cbd5e1;
            margin-bottom: 30px;
        }

        .login-right-content ul {
            list-style: none;
        }

        .login-right-content li {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .login-right-content i {
            color: #10b981;
            font-size: 18px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 60px;
                flex-direction: row;
            }

            .sidebar-nav {
                display: none;
            }

            .main-content {
                flex: 1;
            }

            .login-container {
                flex-direction: column;
            }

            .login-right {
                display: none;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div id="notificationContainer"></div>

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="login-container" style="display: none;">
        <div class="login-left">
            <div class="login-form">
                <h1><i class="fas fa-balance-scale"></i> Sistema Financeiro</h1>
                <p>Gestão de Contratos - Advocacia</p>

                <form id="loginForm">
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="loginEmail" required placeholder="seu@email.com">
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="loginPassword" required placeholder="••••••••">
                    </div>
                    <div class="form-group checkbox">
                        <input type="checkbox" id="rememberMe">
                        <label for="rememberMe">Lembrar-me</label>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </form>

                <div class="login-links">
                    <a href="#" onclick="toggleForgotPassword()">Esqueci minha senha</a>
                    <a href="#" onclick="toggleRegister()">Criar conta</a>
                </div>
            </div>
        </div>
        <div class="login-right">
            <div class="login-right-content">
                <h2>Bem-vindo!</h2>
                <p>Sistema completo para gestão de contratos e pagamentos de sua advocacia.</p>
                <ul>
                    <li><i class="fas fa-check"></i> Gestão de Clientes</li>
                    <li><i class="fas fa-check"></i> Controle de Contratos</li>
                    <li><i class="fas fa-check"></i> Registrar Pagamentos</li>
                    <li><i class="fas fa-check"></i> Relatórios Detalhados</li>
                    <li><i class="fas fa-check"></i> Análises Financeiras</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appContainer" class="container" style="display: none;">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-balance-scale"></i> Sistema Financeiro</h1>
                <p>Advocacia</p>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item active" onclick="app.navigate('dashboard')">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="app.navigate('clients')">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </div>
                <div class="nav-item" onclick="app.navigate('contracts')">
                    <i class="fas fa-file-contract"></i>
                    <span>Contratos</span>
                </div>
                <div class="nav-item" onclick="app.navigate('payments')">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Pagamentos</span>
                </div>
                <div class="nav-item" onclick="app.navigate('services')">
                    <i class="fas fa-tasks"></i>
                    <span>Serviços</span>
                </div>
                <div class="nav-item" onclick="app.navigate('reports')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relatórios</span>
                </div>
                <div class="nav-item" onclick="app.navigate('trash')">
                    <i class="fas fa-trash"></i>
                    <span>Lixeira</span>
                </div>
                <div class="nav-item" onclick="app.navigate('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="app.logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- TOP BAR -->
            <div class="top-bar">
                <div>
                    <h2 id="pageTitle">Dashboard</h2>
                    <p id="pageSubtitle">Visão geral do sistema</p>
                </div>
                <div class="user-info">
                    <div>
                        <p>Usuário:</p>
                        <p id="userEmail">usuario@email.com</p>
                    </div>
                    <div class="user-avatar">
                        <span id="userInitial">U</span>
                    </div>
                </div>
            </div>

            <!-- CONTENT -->
            <div class="content" id="content">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>
    </div>
    <!-- MODAIS -->

    <!-- MODAL: NOVO/EDITAR CLIENTE -->
    <div id="clientModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> <span id="clientModalTitle">Novo Cliente</span></h3>
                <button class="modal-close" onclick="app.closeModal('clientModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <input type="hidden" id="clientId">
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" id="clientName" required placeholder="Digite o nome completo">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>CPF/CNPJ *</label>
                            <input type="text" id="clientCpf" required placeholder="000.000.000-00">
                        </div>
                        <div class="form-group">
                            <label>Telefone *</label>
                            <input type="tel" id="clientPhone" required placeholder="(00) 00000-0000">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="clientEmail" placeholder="cliente@email.com">
                    </div>
                    <div class="form-group">
                        <label>Endereço</label>
                        <textarea id="clientAddress" rows="3" placeholder="Rua, número, bairro, cidade, estado"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('clientModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="app.saveClient()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: NOVO/EDITAR CONTRATO -->
    <div id="contractModal" class="modal-overlay">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-file-contract"></i> <span id="contractModalTitle">Novo Contrato</span></h3>
                <button class="modal-close" onclick="app.closeModal('contractModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="contractForm">
                    <input type="hidden" id="contractId">
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select id="contractClient" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Valor Total (R$) *</label>
                            <input type="number" id="contractValue" required step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="contractStatus" required>
                                <option value="Ativo">Ativo</option>
                                <option value="Concluído">Concluído</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descrição *</label>
                        <textarea id="contractDescription" rows="3" required placeholder="Descrição dos serviços"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Data de Início *</label>
                            <input type="date" id="contractStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>Data de Término</label>
                            <input type="date" id="contractEndDate">
                        </div>
                    </div>
                    <div style="border-top: 1px solid #475569; padding-top: 20px; margin-top: 20px;">
                        <h4 style="color: #fff; margin-bottom: 15px; font-size: 14px; font-weight: 600;">
                            <i class="fas fa-calendar-alt"></i> Parcelamento
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Número de Parcelas *</label>
                                <input type="number" id="contractParcels" required min="1" value="1">
                            </div>
                            <div class="form-group">
                                <label>Dia do Vencimento *</label>
                                <input type="number" id="contractDueDay" required min="1" max="31" value="10">
                            </div>
                            <div class="form-group">
                                <label>Primeira Parcela *</label>
                                <input type="date" id="contractFirstParcel" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('contractModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="app.saveContract()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: REGISTRAR PAGAMENTO -->
    <div id="paymentModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-money-check"></i> Registrar Pagamento</h3>
                <button class="modal-close" onclick="app.closeModal('paymentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="paymentInfo" style="background: #334155; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <!-- Informações da parcela -->
                </div>
                <form id="paymentForm">
                    <input type="hidden" id="paymentContractId">
                    <input type="hidden" id="paymentParcelIndex">
                    <div class="form-group">
                        <label>Data do Pagamento *</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    <div class="form-group">
                        <label>Valor Pago (R$) *</label>
                        <input type="number" id="paymentAmount" required step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Método de Pagamento *</label>
                        <select id="paymentMethod" required>
                            <option value="">Selecione um método</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="PIX">PIX</option>
                            <option value="Transferência">Transferência Bancária</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                            <option value="Cheque">Cheque</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Observações</label>
                        <textarea id="paymentNotes" rows="3" placeholder="Observações adicionais"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('paymentModal')">Cancelar</button>
                <button class="btn btn-success" onclick="app.savePayment()">
                    <i class="fas fa-check"></i> Confirmar Pagamento
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: DETALHES DO CONTRATO -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> Detalhes do Contrato</h3>
                <button class="modal-close" onclick="app.closeModal('detailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Conteúdo carregado dinamicamente -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('detailsModal')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: RELATÓRIO -->
    <div id="reportModal" class="modal-overlay">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fas fa-file-pdf"></i> Relatório Mensal</h3>
                <button class="modal-close" onclick="app.closeModal('reportModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="reportContent">
                <!-- Conteúdo do relatório -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('reportModal')">Fechar</button>
                <button class="btn btn-danger" onclick="app.downloadReportPDF()">
                    <i class="fas fa-file-pdf"></i> Baixar PDF
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: GERAR RELATÓRIO -->
    <div id="generateReportModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-chart-line"></i> Gerar Relatório</h3>
                <button class="modal-close" onclick="app.closeModal('generateReportModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="generateReportForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Mês *</label>
                            <select id="reportMonth" required>
                                <option value="">Selecione um mês</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ano *</label>
                            <select id="reportYear" required>
                                <option value="">Selecione um ano</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('generateReportModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="app.generateReport()">
                    <i class="fas fa-file-invoice"></i> Gerar Relatório
                </button>
            </div>
        </div>
    </div>

    <!-- FIREBASE SCRIPTS -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD7fo76dtPorium8rMSXGKiKV3P6MX70Gg",
            authDomain: "financeiro-6cfbb.firebaseapp.com",
            projectId: "financeiro-6cfbb",
            storageBucket: "financeiro-6cfbb.firebasestorage.app",
            messagingSenderId: "962798985393",
            appId: "1:962798985393:web:81e28e3c4535e855bb8e38"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ADMIN USERS
        const ADMIN_USERS = ['lilian.oliveira@advocacia.com.br', 'admin@advocacia.com.br'];

        // UTILIDADES
        class Utils {
            static formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            }

            static formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString + 'T00:00:00');
                return date.toLocaleDateString('pt-BR');
            }

            static showNotification(message, type = 'info') {
                const container = document.getElementById('notificationContainer');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
                container.appendChild(notification);
                setTimeout(() => notification.remove(), 4000);
            }

            static generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
        }

        // APLICAÇÃO
        class App {
            constructor() {
                this.currentUser = null;
                this.clients = [];
                this.contracts = [];
                this.currentPage = 'dashboard';
                this.init();
            }

            async init() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        this.currentUser = user;
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'flex';
                        document.getElementById('userEmail').textContent = user.email;
                        document.getElementById('userInitial').textContent = user.email.charAt(0).toUpperCase();
                        
                        await this.loadClients();
                        await this.loadContracts();
                        this.navigate('dashboard');
                    } else {
                        document.getElementById('loginPage').style.display = 'flex';
                        document.getElementById('appContainer').style.display = 'none';
                    }
                });
            }

            async loadClients() {
                try {
                    const q = query(collection(db, 'clients'), orderBy('name'));
                    const snapshot = await getDocs(q);
                    this.clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.updateClientSelect();
                } catch (error) {
                    Utils.showNotification('Erro ao carregar clientes: ' + error.message, 'error');
                }
            }

            async loadContracts() {
                try {
                    const snapshot = await getDocs(collection(db, 'contracts'));
                    this.contracts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    Utils.showNotification('Erro ao carregar contratos: ' + error.message, 'error');
                }
            }

            updateClientSelect() {
                const select = document.getElementById('contractClient');
                select.innerHTML = '<option value="">Selecione um cliente</option>';
                this.clients.forEach(client => {
                    select.innerHTML += `<option value="${client.id}">${client.name}</option>`;
                });
            }

            navigate(page) {
                this.currentPage = page;
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`.nav-item:nth-child(${['dashboard', 'clients', 'contracts', 'payments', 'services', 'reports', 'trash', 'settings'].indexOf(page) + 1})`).classList.add('active');

                const content = document.getElementById('content');
                
                switch(page) {
                    case 'dashboard':
                        document.getElementById('pageTitle').textContent = 'Dashboard';
                        document.getElementById('pageSubtitle').textContent = 'Visão geral do sistema';
                        this.renderDashboard();
                        break;
                    case 'clients':
                        document.getElementById('pageTitle').textContent = 'Clientes';
                        document.getElementById('pageSubtitle').textContent = 'Gerencie seus clientes';
                        this.renderClients();
                        break;
                    case 'contracts':
                        document.getElementById('pageTitle').textContent = 'Contratos';
                        document.getElementById('pageSubtitle').textContent = 'Gerencie os contratos';
                        this.renderContracts();
                        break;
                    case 'payments':
                        document.getElementById('pageTitle').textContent = 'Pagamentos';
                        document.getElementById('pageSubtitle').textContent = 'Controle de pagamentos';
                        this.renderPayments();
                        break;
                    case 'services':
                        document.getElementById('pageTitle').textContent = 'Serviços';
                        document.getElementById('pageSubtitle').textContent = 'Gestão de serviços';
                        this.renderServices();
                        break;
                    case 'reports':
                        document.getElementById('pageTitle').textContent = 'Relatórios';
                        document.getElementById('pageSubtitle').textContent = 'Relatórios financeiros';
                        this.renderReports();
                        break;
                    case 'trash':
                        document.getElementById('pageTitle').textContent = 'Lixeira';
                        document.getElementById('pageSubtitle').textContent = 'Itens excluídos';
                        this.renderTrash();
                        break;
                    case 'settings':
                        document.getElementById('pageTitle').textContent = 'Configurações';
                        document.getElementById('pageSubtitle').textContent = 'Configurações do sistema';
                        this.renderSettings();
                        break;
                }
            }

            renderDashboard() {
                const content = document.getElementById('content');
                const totalClients = this.clients.length;
                const activeContracts = this.contracts.filter(c => c.status === 'Ativo').length;
                
                let totalReceived = 0;
                let pendingPayments = 0;

                this.contracts.forEach(contract => {
                    (contract.parcels || []).forEach(parcel => {
                        if (parcel.status === 'Paga') {
                            totalReceived += parcel.paymentAmount || parcel.value;
                        } else if (parcel.status === 'Pendente') {
                            pendingPayments += parcel.value;
                        }
                    });
                });

                content.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">
                                <p>Total de Clientes</p>
                                <p>${totalClients}</p>
                            </div>
                            <div class="stat-icon blue">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">
                                <p>Contratos Ativos</p>
                                <p>${activeContracts}</p>
                            </div>
                            <div class="stat-icon green">
                                <i class="fas fa-file-contract"></i>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">
                                <p>Receita Total</p>
                                <p>${Utils.formatCurrency(totalReceived)}</p>
                            </div>
                            <div class="stat-icon yellow">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">
                                <p>A Receber</p>
                                <p>${Utils.formatCurrency(pendingPayments)}</p>
                            </div>
                            <div class="stat-icon red">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-chart-line"></i> Resumo Financeiro</h3>
                        <p style="color: #cbd5e1; font-size: 14px;">Bem-vindo ao Sistema de Gestão Financeira. Utilize o menu lateral para navegar entre as seções.</p>
                    </div>
                `;
            }

            renderClients() {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="app.openClientModal()">
                            <i class="fas fa-plus"></i> Novo Cliente
                        </button>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-users"></i> Lista de Clientes</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>CPF/CNPJ</th>
                                        <th>Telefone</th>
                                        <th>E-mail</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.clients.length === 0 ? '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">Nenhum cliente cadastrado</td></tr>' : ''}
                                    ${this.clients.map(client => `
                                        <tr>
                                            <td>${client.name}</td>
                                            <td>${client.cpf}</td>
                                            <td>${client.phone}</td>
                                            <td>${client.email || '-'}</td>
                                            <td>
                                                <button class="btn btn-sm" onclick="app.editClient('${client.id}')"><i class="fas fa-edit"></i></button>
                                                <button class="btn btn-sm btn-danger" onclick="app.deleteClient('${client.id}')"><i class="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            renderContracts() {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="app.openContractModal()">
                            <i class="fas fa-plus"></i> Novo Contrato
                        </button>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-file-contract"></i> Lista de Contratos</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Descrição</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.contracts.length === 0 ? '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">Nenhum contrato cadastrado</td></tr>' : ''}
                                    ${this.contracts.map(contract => {
                                        const client = this.clients.find(c => c.id === contract.clientId);
                                        return `
                                            <tr>
                                                <td>${client ? client.name : 'N/A'}</td>
                                                <td>${contract.description}</td>
                                                <td>${Utils.formatCurrency(contract.value)}</td>
                                                <td><span class="badge badge-${contract.status === 'Ativo' ? 'success' : contract.status === 'Concluído' ? 'info' : 'danger'}">${contract.status}</span></td>
                                                <td>
                                                    <button class="btn btn-sm" onclick="app.viewContractDetails('${contract.id}')"><i class="fas fa-eye"></i></button>
                                                    <button class="btn btn-sm" onclick="app.editContract('${contract.id}')"><i class="fas fa-edit"></i></button>
                                                    <button class="btn btn-sm btn-danger" onclick="app.deleteContract('${contract.id}')"><i class="fas fa-trash"></i></button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            renderPayments() {
                const content = document.getElementById('content');
                let allParcels = [];

                this.contracts.forEach(contract => {
                    const client = this.clients.find(c => c.id === contract.clientId);
                    (contract.parcels || []).forEach((parcel, index) => {
                        allParcels.push({
                            contractId: contract.id,
                            parcelIndex: index,
                            clientName: client ? client.name : 'N/A',
                            contractDescription: contract.description,
                            ...parcel
                        });
                    });
                });

                allParcels.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                content.innerHTML = `
                    <div class="card">
                        <h3><i class="fas fa-money-bill-wave"></i> Controle de Pagamentos</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Contrato</th>
                                        <th>Parcela</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allParcels.length === 0 ? '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;">Nenhuma parcela cadastrada</td></tr>' : ''}
                                    ${allParcels.map(parcel => {
                                        const isOverdue = new Date(parcel.dueDate) < new Date() && parcel.status !== 'Paga';
                                        return `
                                            <tr>
                                                <td>${parcel.clientName}</td>
                                                <td>${parcel.contractDescription}</td>
                                                <td>${parcel.number}</td>
                                                <td>${Utils.formatDate(parcel.dueDate)}</td>
                                                <td>${Utils.formatCurrency(parcel.value)}</td>
                                                <td><span class="badge badge-${parcel.status === 'Paga' ? 'success' : isOverdue ? 'danger' : 'warning'}">${parcel.status === 'Paga' ? 'Paga' : isOverdue ? 'Vencida' : 'Pendente'}</span></td>
                                                <td>
                                                    ${parcel.status !== 'Paga' ? `<button class="btn btn-sm btn-success" onclick="app.openPaymentModal('${parcel.contractId}', ${parcel.parcelIndex})"><i class="fas fa-dollar-sign"></i></button>` : ''}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            renderServices() {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="card">
                        <h3><i class="fas fa-tasks"></i> Gestão de Serviços</h3>
                        <p style="color: #cbd5e1;">Seção de serviços em desenvolvimento...</p>
                    </div>
                `;
            }

            renderReports() {
                const content = document.getElementById('content');
                const currentYear = new Date().getFullYear();
                let yearOptions = '';
                for (let y = currentYear - 2; y <= currentYear + 1; y++) {
                    yearOptions += `<option value="${y}">${y}</option>`;
                }

                content.innerHTML = `
                    <div class="card" style="max-width: 500px;">
                        <h3><i class="fas fa-chart-bar"></i> Gerar Relatório</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label>Mês</label>
                                <select id="reportMonth">
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Março</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ano</label>
                                <select id="reportYear">
                                    ${yearOptions}
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="app.generateReport()">
                            <i class="fas fa-file-invoice"></i> Gerar Relatório
                        </button>
                    </div>
                `;
            }

            renderTrash() {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="card">
                        <h3><i class="fas fa-trash"></i> Lixeira</h3>
                        <p style="color: #cbd5e1;">Seção de lixeira em desenvolvimento...</p>
                    </div>
                `;
            }

            renderSettings() {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="card">
                        <h3><i class="fas fa-cog"></i> Configurações</h3>
                        <p style="color: #cbd5e1;">Seção de configurações em desenvolvimento...</p>
                    </div>
                `;
            }

            openClientModal(clientId = null) {
                const modal = document.getElementById('clientModal');
                if (clientId) {
                    const client = this.clients.find(c => c.id === clientId);
                    document.getElementById('clientModalTitle').textContent = 'Editar Cliente';
                    document.getElementById('clientId').value = clientId;
                    document.getElementById('clientName').value = client.name;
                    document.getElementById('clientCpf').value = client.cpf;
                    document.getElementById('clientPhone').value = client.phone;
                    document.getElementById('clientEmail').value = client.email || '';
                    document.getElementById('clientAddress').value = client.address || '';
                } else {
                    document.getElementById('clientModalTitle').textContent = 'Novo Cliente';
                    document.getElementById('clientForm').reset();
                    document.getElementById('clientId').value = '';
                }
                modal.classList.add('active');
            }

            openContractModal(contractId = null) {
                const modal = document.getElementById('contractModal');
                const today = new Date().toISOString().split('T')[0];
                if (contractId) {
                    const contract = this.contracts.find(c => c.id === contractId);
                    document.getElementById('contractModalTitle').textContent = 'Editar Contrato';
                    document.getElementById('contractId').value = contractId;
                    document.getElementById('contractClient').value = contract.clientId;
                    document.getElementById('contractValue').value = contract.value;
                    document.getElementById('contractStatus').value = contract.status;
                    document.getElementById('contractDescription').value = contract.description;
                    document.getElementById('contractStartDate').value = contract.startDate;
                    document.getElementById('contractEndDate').value = contract.endDate || '';
                } else {
                    document.getElementById('contractModalTitle').textContent = 'Novo Contrato';
                    document.getElementById('contractForm').reset();
                    document.getElementById('contractId').value = '';
                    document.getElementById('contractStartDate').value = today;
                    document.getElementById('contractFirstParcel').value = today;
                }
                modal.classList.add('active');
            }

            openPaymentModal(contractId, parcelIndex) {
                const contract = this.contracts.find(c => c.id === contractId);
                const parcel = contract.parcels[parcelIndex];
                const client = this.clients.find(c => c.id === contract.clientId);
                const today = new Date().toISOString().split('T')[0];

                document.getElementById('paymentContractId').value = contractId;
                document.getElementById('paymentParcelIndex').value = parcelIndex;
                document.getElementById('paymentAmount').value = parcel.value.toFixed(2);
                document.getElementById('paymentDate').value = today;
                document.getElementById('paymentInfo').innerHTML = `
                    <strong style="color: #fff;">Cliente:</strong> ${client.name}<br>
                    <strong style="color: #fff;">Contrato:</strong> ${contract.description}<br>
                    <strong style="color: #fff;">Parcela:</strong> ${parcel.number} de ${contract.parcels.length}<br>
                    <strong style="color: #fff;">Vencimento:</strong> ${Utils.formatDate(parcel.dueDate)}<br>
                    <strong style="color: #fff;">Valor:</strong> ${Utils.formatCurrency(parcel.value)}
                `;
                document.getElementById('paymentModal').classList.add('active');
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }

            editClient(clientId) {
                this.openClientModal(clientId);
            }

            editContract(contractId) {
                this.openContractModal(contractId);
            }

            async saveClient() {
                const clientId = document.getElementById('clientId').value;
                const data = {
                    name: document.getElementById('clientName').value,
                    cpf: document.getElementById('clientCpf').value,
                    phone: document.getElementById('clientPhone').value,
                    email: document.getElementById('clientEmail').value,
                    address: document.getElementById('clientAddress').value,
                    updatedAt: new Date().toISOString()
                };

                try {
                    if (clientId) {
                        await updateDoc(doc(db, 'clients', clientId), data);
                        Utils.showNotification('Cliente atualizado com sucesso!', 'success');
                    } else {
                        data.createdAt = new Date().toISOString();
                        await setDoc(doc(db, 'clients', Utils.generateId()), data);
                        Utils.showNotification('Cliente criado com sucesso!', 'success');
                    }
                    this.closeModal('clientModal');
                    await this.loadClients();
                    this.renderClients();
                } catch (error) {
                    Utils.showNotification('Erro: ' + error.message, 'error');
                }
            }

            async saveContract() {
                const contractId = document.getElementById('contractId').value;
                const numParcels = parseInt(document.getElementById('contractParcels').value);
                const totalValue = parseFloat(document.getElementById('contractValue').value);
                const firstParcel = document.getElementById('contractFirstParcel').value;
                const dueDay = parseInt(document.getElementById('contractDueDay').value);

                const generateParcels = () => {
                    const parcels = [];
                    const parcelValue = totalValue / numParcels;
                    const baseDate = new Date(firstParcel + 'T00:00:00');

                    for (let i = 0; i < numParcels; i++) {
                        const dueDate = new Date(baseDate);
                        dueDate.setMonth(dueDate.getMonth() + i);
                        dueDate.setDate(dueDay);

                        parcels.push({
                            number: i + 1,
                            value: parcelValue,
                            dueDate: dueDate.toISOString().split('T')[0],
                            status: 'Pendente',
                            paymentDate: null,
                            paymentMethod: null,
                            paymentAmount: null,
                            notes: null
                        });
                    }
                    return parcels;
                };

                const data = {
                    clientId: document.getElementById('contractClient').value,
                    description: document.getElementById('contractDescription').value,
                    value: totalValue,
                    status: document.getElementById('contractStatus').value,
                    startDate: document.getElementById('contractStartDate').value,
                    endDate: document.getElementById('contractEndDate').value || null,
                    parcels: contractId ? undefined : generateParcels(),
                    updatedAt: new Date().toISOString()
                };

                try {
                    if (contractId) {
                        await updateDoc(doc(db, 'contracts', contractId), data);
                        Utils.showNotification('Contrato atualizado com sucesso!', 'success');
                    } else {
                        data.createdAt = new Date().toISOString();
                        await setDoc(doc(db, 'contracts', Utils.generateId()), data);
                        Utils.showNotification('Contrato criado com sucesso!', 'success');
                    }
                    this.closeModal('contractModal');
                    await this.loadContracts();
                    this.renderContracts();
                } catch (error) {
                    Utils.showNotification('Erro: ' + error.message, 'error');
                }
            }

            async savePayment() {
                const contractId = document.getElementById('paymentContractId').value;
                const parcelIndex = parseInt(document.getElementById('paymentParcelIndex').value);
                const paymentDate = document.getElementById('paymentDate').value;
                const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
                const paymentMethod = document.getElementById('paymentMethod').value;
                const notes = document.getElementById('paymentNotes').value;

                try {
                    const contract = this.contracts.find(c => c.id === contractId);

                    // ⚠️ CORREÇÃO 1: Conversão correta para UTC mantendo o dia correto
                    const [year, month, day] = paymentDate.split('-');
                    const utcDate = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day), 12, 0, 0));
                    
                    contract.parcels[parcelIndex].status = 'Paga';
                    contract.parcels[parcelIndex].paymentDate = utcDate.toISOString();
                    contract.parcels[parcelIndex].paymentAmount = paymentAmount;
                    contract.parcels[parcelIndex].paymentMethod = paymentMethod;
                    contract.parcels[parcelIndex].notes = notes;

                    await updateDoc(doc(db, 'contracts', contractId), {
                        parcels: contract.parcels,
                        updatedAt: new Date().toISOString()
                    });

                    Utils.showNotification('Pagamento registrado com sucesso!', 'success');
                    this.closeModal('paymentModal');
                    document.getElementById('paymentForm').reset();
                    await this.loadContracts();
                    this.renderPayments();
                } catch (error) {
                    Utils.showNotification('Erro: ' + error.message, 'error');
                }
            }

            viewContractDetails(contractId) {
                const contract = this.contracts.find(c => c.id === contractId);
                const client = this.clients.find(c => c.id === contract.clientId);
                const parcels = contract.parcels || [];

                const paidParcels = parcels.filter(p => p.status === 'Paga').length;
                const totalPaid = parcels.reduce((sum, p) => p.status === 'Paga' ? sum + (p.paymentAmount || p.value) : sum, 0);

                let html = `
                    <div class="card" style="border: 1px solid #475569; margin-bottom: 20px;">
                        <h4 style="color: #fff; margin-bottom: 10px;">Informações do Cliente</h4>
                        <p style="color: #cbd5e1; font-size: 14px;"><strong>Nome:</strong> ${client.name}</p>
                        <p style="color: #cbd5e1; font-size: 14px;"><strong>CPF/CNPJ:</strong> ${client.cpf}</p>
                        <p style="color: #cbd5e1; font-size: 14px;"><strong>Telefone:</strong> ${client.phone}</p>
                    </div>

                    <div class="card" style="border: 1px solid #475569; margin-bottom: 20px;">
                        <h4 style="color: #fff; margin-bottom: 10px;">Informações do Contrato</h4>
                        <p style="color: #cbd5e1; font-size: 14px;"><strong>Descrição:</strong> ${contract.description}</p>
                        <p style="color: #cbd5e1; font-size: 14px;"><strong>Valor Total:</strong> ${Utils.formatCurrency(contract.value)}</p>
                        <p style="color: #cbd5e1; font-size: 14px;"><strong>Status:</strong> <span class="badge badge-${contract.status === 'Ativo' ? 'success' : contract.status === 'Concluído' ? 'info' : 'danger'}">${contract.status}</span></p>
                        <p style="color: #cbd5e1; font-size: 14px;"><strong>Parcelas Pagas:</strong> ${paidParcels} de ${parcels.length}</p>
                        <p style="color: #cbd5e1; font-size: 14px;"><strong>Total Recebido:</strong> ${Utils.formatCurrency(totalPaid)}</p>
                    </div>

                    <div class="card" style="border: 1px solid #475569;">
                        <h4 style="color: #fff; margin-bottom: 15px;">Parcelas</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                parcels.forEach((parcel, index) => {
                    const isOverdue = new Date(parcel.dueDate) < new Date() && parcel.status !== 'Paga';
                    html += `
                        <tr>
                            <td>${parcel.number}</td>
                            <td>${Utils.formatDate(parcel.dueDate)}</td>
                            <td>${Utils.formatCurrency(parcel.value)}</td>
                            <td><span class="badge badge-${parcel.status === 'Paga' ? 'success' : isOverdue ? 'danger' : 'warning'}">${parcel.status === 'Paga' ? 'Paga' : isOverdue ? 'Vencida' : 'Pendente'}</span></td>
                            <td>${parcel.status !== 'Paga' ? `<button class="btn btn-sm btn-success" onclick="app.openPaymentModal('${contractId}', ${index})"><i class="fas fa-dollar-sign"></i> Pagar</button>` : '<span style="color: #10b981; font-size: 12px;">Pago em ' + Utils.formatDate(parcel.paymentDate) + '</span>'}</td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                document.getElementById('detailsContent').innerHTML = html;
                document.getElementById('detailsModal').classList.add('active');
            }

            async deleteClient(clientId) {
                if (confirm('Tem certeza que deseja excluir este cliente?')) {
                    try {
                        await deleteDoc(doc(db, 'clients', clientId));
                        Utils.showNotification('Cliente excluído com sucesso!', 'success');
                        await this.loadClients();
                        this.renderClients();
                    } catch (error) {
                        Utils.showNotification('Erro: ' + error.message, 'error');
                    }
                }
            }

            async deleteContract(contractId) {
                if (confirm('Tem certeza que deseja excluir este contrato?')) {
                    try {
                        await deleteDoc(doc(db, 'contracts', contractId));
                        Utils.showNotification('Contrato excluído com sucesso!', 'success');
                        await this.loadContracts();
                        this.renderContracts();
                    } catch (error) {
                        Utils.showNotification('Erro: ' + error.message, 'error');
                    }
                }
            }

            generateReport() {
                const month = parseInt(document.getElementById('reportMonth').value);
                const year = parseInt(document.getElementById('reportYear').value);

                if (!month || !year) {
                    Utils.showNotification('Selecione mês e ano!', 'warning');
                    return;
                }

                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0, 23, 59, 59);

                let totalReceived = 0;
                const payments = [];
                // ⚠️ CORREÇÃO 2: DETECTAR INADIMPLENTES NO PERÍODO
                const defaulters = [];

                this.contracts.forEach(contract => {
                    const client = this.clients.find(c => c.id === contract.clientId);
                    
                    (contract.parcels || []).forEach(parcel => {
                        // Pagamentos no período
                        if (parcel.status === 'Paga' && parcel.paymentDate) {
                            const paymentDateObj = new Date(parcel.paymentDate);
                            const paymentYear = paymentDateObj.getUTCFullYear();
                            const paymentMonth = paymentDateObj.getUTCMonth() + 1;

                            if (paymentYear === year && paymentMonth === month) {
                                totalReceived += parcel.paymentAmount || parcel.value;
                                payments.push({
                                    clientName: client ? client.name : 'Cliente não identificado',
                                    contractDescription: contract.description,
                                    parcelNumber: parcel.number,
                                    value: parcel.paymentAmount || parcel.value,
                                    paymentDate: parcel.paymentDate,
                                    paymentMethod: parcel.paymentMethod
                                });
                            }
                        }

                        // ⚠️ CORREÇÃO 2: Detectar inadimplentes (parcelas pendentes/vencidas no período)
                        if (parcel.status === 'Pendente') {
                            const dueDate = new Date(parcel.dueDate);
                            
                            if (dueDate >= startDate && dueDate <= endDate) {
                                const hoje = new Date();
                                const daysOverdue = Math.floor((hoje - dueDate) / (1000 * 60 * 60 * 24));

                                defaulters.push({
                                    clientName: client ? client.name : 'Cliente não identificado',
                                    clientPhone: client ? client.phone : 'N/A',
                                    contractDescription: contract.description,
                                    parcelNumber: parcel.number,
                                    totalParcels: contract.parcels.length,
                                    value: parcel.value,
                                    dueDate: parcel.dueDate,
                                    daysOverdue: daysOverdue > 0 ? daysOverdue : 0,
                                    status: daysOverdue > 0 ? 'Vencida' : 'A vencer'
                                });
                            }
                        }
                    });
                });

                const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

                let html = `
                    <h3 style="color: #fff; margin-bottom: 20px;">Relatório de ${monthNames[month - 1]} de ${year}</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="card" style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981;">
                            <p style="color: #6ee7b7; font-size: 12px; margin: 0 0 8px 0;"><strong>TOTAL RECEBIDO</strong></p>
                            <p style="font-size: 28px; font-weight: 700; color: #fff; margin: 0;">${Utils.formatCurrency(totalReceived)}</p>
                            <p style="color: #cbd5e1; font-size: 12px; margin: 8px 0 0 0;">${payments.length} pagamento(s)</p>
                        </div>
                        <div class="card" style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444;">
                            <p style="color: #fca5a5; font-size: 12px; margin: 0 0 8px 0;"><strong>CLIENTES INADIMPLENTES</strong></p>
                            <p style="font-size: 28px; font-weight: 700; color: #fff; margin: 0;">${defaulters.length}</p>
                            <p style="color: #cbd5e1; font-size: 12px; margin: 8px 0 0 0;">cliente(s) em atraso</p>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 20px;">
                        <h4 style="color: #fff; margin-bottom: 15px;"><i class="fas fa-check-circle" style="color: #10b981; margin-right: 8px;"></i>Pagamentos Recebidos</h4>
                        ${payments.length === 0 ? '<p style="color: #94a3b8; text-align: center; padding: 20px;">Nenhum pagamento registrado neste período.</p>' : `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Contrato</th>
                                            <th>Parcela</th>
                                            <th>Data Pgto</th>
                                            <th>Método</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${payments.map(p => `
                                            <tr>
                                                <td>${p.clientName}</td>
                                                <td>${p.contractDescription}</td>
                                                <td>${p.parcelNumber}</td>
                                                <td>${Utils.formatDate(p.paymentDate)}</td>
                                                <td>${p.paymentMethod}</td>
                                                <td style="color: #10b981; font-weight: 600;">${Utils.formatCurrency(p.value)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>

                    <!-- ⚠️ NOVO: SEÇÃO DE INADIMPLENTES -->
                    <div class="card" style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444;">
                        <h4 style="color: #fca5a5; margin-bottom: 15px;"><i class="fas fa-exclamation-triangle" style="color: #ef4444; margin-right: 8px;"></i>Clientes Inadimplentes</h4>
                        ${defaulters.length === 0 ? '<p style="color: #10b981; text-align: center; padding: 20px; font-weight: 600;">✅ Nenhum cliente inadimplente neste período!</p>' : `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Telefone</th>
                                            <th>Contrato</th>
                                            <th>Parcela</th>
                                            <th>Vencimento</th>
                                            <th>Dias Atraso</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${defaulters.map(d => `
                                            <tr style="background: ${d.daysOverdue > 0 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)'};">
                                                <td style="font-weight: 600; color: #fff;">${d.clientName}</td>
                                                <td>${d.clientPhone}</td>
                                                <td>${d.contractDescription}</td>
                                                <td>${d.parcelNumber}/${d.totalParcels}</td>
                                                <td>${Utils.formatDate(d.dueDate)}</td>
                                                <td style="color: ${d.daysOverdue > 0 ? '#ef4444' : '#f59e0b'}; font-weight: 600;">${d.daysOverdue > 0 ? d.daysOverdue + ' dias' : 'No prazo'}</td>
                                                <td style="color: #ef4444; font-weight: 600;">${Utils.formatCurrency(d.value)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                `;

                document.getElementById('reportContent').innerHTML = html;
                document.getElementById('reportModal').classList.add('active');
            }

            downloadReportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const content = document.getElementById('reportContent').innerText;
                doc.text(content, 10, 10);
                doc.save('relatorio.pdf');
            }

            async logout() {
                try {
                    await signOut(auth);
                    Utils.showNotification('Logout realizado com sucesso!', 'success');
                } catch (error) {
                    Utils.showNotification('Erro ao fazer logout: ' + error.message, 'error');
                }
            }
        }

        // LOGIN
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                Utils.showNotification('Erro ao fazer login: ' + error.message, 'error');
            }
        });

        // INICIALIZAR APP
        const app = new App();
        window.app = app;
    </script>
</body>
</html>
       
