<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sistema de Gest√£o Financeira - Advocacia</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
	<style>
		/* Estilos Globais */
		body { font-family: 'Inter', sans-serif; position: relative; background-color: #0f172a; color: #d1d5db; overflow-y: hidden; }
		body::after { content: ''; position: fixed; z-index: -2; top: 0; left: 0; right: 0; bottom: 0; background-image: url('https://i.postimg.cc/x81V8QJg/Imagem-do-Whats-App-de-2025-10-27-a-s-09-49-28-f966cd35.jpg'); background-repeat: no-repeat; background-size: cover; background-position: center center; opacity: 0.12; }
		
		/* Modais */
		.modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 9000; }
		.modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9001; max-height: 90vh; border: 1px solid #374151; box-shadow: 0 10px 30px 0 rgba(0, 0, 0, 0.4); }
		.modal-body { overflow-y: auto; max-height: 70vh; }
		
		/* Kanban & Scroll */
		.kanban-column { min-width: 320px; }
		.kanban-content { max-height: 60vh; overflow-y: auto; padding-right: 8px; }
		::-webkit-scrollbar { width: 8px; }
		::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
		::-webkit-scrollbar-thumb:hover { background: #6b7280; }
		
		/* Elementos UI */
		.dark-card { background-color: #1f2937; }
		.sort-button, .filter-button { background-color: #374151; border: 1px solid #4b5563; color: #9ca3af; padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
		.sort-button:hover, .filter-button:hover { background-color: #4b5563; color: white; }
		.sort-button.active, .filter-button.active { background-color: #4f46e5; border-color: #4f46e5; color: white; }
		.filter-select { background-color: #1f2937; border: 1px solid #4b5563; color: #9ca3af; padding: 8px 12px; border-radius: 6px; font-size: 14px; transition: all 0.2s; color-scheme: dark; }
		.filter-select:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); outline: none; }
		
		/* Sidebar & Nav */
		.sidebar-nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #d1d5db; transition: all 0.2s; cursor: pointer; }
		.sidebar-nav-item:hover { background-color: #4338ca; color: white; }
		.sidebar-nav-item.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.5); }
		.mobile-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; padding: 0.75rem 0.5rem; color: #9ca3af; transition: all 0.2s; }
		.mobile-nav-item.active { color: #6366f1; background-color: rgba(79, 70, 229, 0.1); }
		
		/* Loading & Auth */
		#loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.9); display: flex; justify-content: center; align-items: center; z-index: 10000; color: white; font-size: 1.2rem; transition: opacity 0.3s; }
		#app-container { display: none; }
		.admin-only { display: none; }
		body.is-admin .admin-only:not(.hidden) { display: block; }
		body.is-admin .flex.admin-only:not(.hidden) { display: flex; }
		body.is-admin .grid.admin-only:not(.hidden) { display: grid; }
		body.is-admin .admin-only.mobile-nav-item { display: flex; }
		body:not(.is-admin) .non-admin-hidden { display: none; }
		
		/* Anima√ß√µes e Notifica√ß√µes */
		@keyframes blob { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } }
		.animate-blob { animation: blob 7s infinite; }
		#notification-list .notification-item { background-color: #374151; padding: 12px; border-radius: 8px; border-left: 4px solid #4f46e5; cursor: pointer; margin-bottom: 4px; }
		#notification-list .notification-item.is-read { background-color: #1f2937; border-left-color: #4b5563; opacity: 0.8; }
		
		/* Outros Estilos Espec√≠ficos */
		.service-tag { display: inline-flex; justify-content: space-between; align-items: center; background-color: #374151; color: #d1d5db; padding: 4px 10px; border-radius: 12px; font-size: 14px; margin: 0 4px 4px 0; }
		.service-tag-small { display: inline-block; background-color: #374151; color: #9ca3af; padding: 2px 8px; border-radius: 9999px; font-size: 12px; margin: 0 4px 4px 0; }
		.parcel-card-vencida { border-left-color: #ef4444; } .parcel-card-vencida .parcel-value { color: #f87171; }
		.parcel-card-avencer { border-left-color: #f59e0b; } .parcel-card-avencer .parcel-value { color: #fbbf24; }
		.ranking-table th { background-color: #374151; color: #d1d5db; padding: 12px; text-align: left; } .ranking-table td { padding: 12px; border-bottom: 1px solid #374151; }
		
		/* Oficina */
		.setting-list-item { display: flex; justify-content: space-between; align-items: center; background-color: #374151; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px; }
		.setting-list-remove-btn { background-color: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
		
		/* Bot√µes de Pagina√ß√£o */
		.pagination-button { background-color: #374151; border: 1px solid #4b5563; color: #9ca3af; padding: 6px 12px; border-radius: 6px; margin: 0 2px; }
		.pagination-button.active { background-color: #4f46e5; border-color: #4f46e5; color: white; }
	</style>
</head>
<body class="text-gray-300">
	<div id="notifications" style="position: fixed; bottom: 20px; right: 20px; z-index: 11000; display: flex; flex-direction: column; gap: 8px;"></div>
	<div id="loading-overlay"><i class="fas fa-spinner fa-spin mr-3"></i> A ligar...</div>

	<div id="auth-overlay" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 relative overflow-hidden px-4">
		<div class="absolute inset-0 opacity-5"><div class="absolute inset-0 bg-[url('https://i.postimg.cc/x81V8QJg/Imagem-do-Whats-App-de-2025-10-27-a-s-09-49-28-f966cd35.jpg')] bg-cover bg-center"></div></div>
		<div class="relative z-10 w-full max-w-md">
			<div class="mb-8 text-center">
				<img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Log√≥tipo" class="h-24 mx-auto mb-6 drop-shadow-lg" />
				<h1 class="text-3xl font-bold text-white mb-2">Sistema Financeiro</h1>
			</div>
			<div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-8 shadow-2xl">
				<form id="login-form" class="space-y-5">
					<div><label class="block text-sm font-medium text-gray-100 mb-2">Email</label><input type="email" id="login-email" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required /></div>
					<div><label class="block text-sm font-medium text-gray-100 mb-2">Senha</label><input type="password" id="login-password" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required /></div>
					<div id="auth-error" class="hidden p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200 text-sm"></div>
					<button type="submit" id="login-submit-button" class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-lg transition mt-6">Entrar</button>
				</form>
			</div>
		</div>
	</div>
	<div id="app-container" class="flex h-screen">
		<aside id="sidebar" class="hidden md:flex md:flex-col md:w-64 bg-gray-900/50 backdrop-blur-lg border-r border-gray-700/50 p-4 transition-all duration-300 z-20">
			<div class="flex-shrink-0 mb-8">
				<img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Log√≥tipo" class="h-20 mx-auto opacity-90" />
			</div>
			<nav class="flex-1 space-y-3">
				<a onclick="window.App.showPage('page-dashboard')" id="tab-dashboard" class="sidebar-nav-item active"><i class="fas fa-tachometer-alt w-5 text-center"></i><span>Painel</span></a>
				<a onclick="window.App.showPage('page-parcelas')" id="tab-parcelas" class="sidebar-nav-item"><i class="fas fa-file-invoice-dollar w-5 text-center"></i><span>Parcelas</span></a>
				<a onclick="window.App.showPage('page-servicos')" id="tab-servicos" class="sidebar-nav-item"><i class="fas fa-tasks w-5 text-center"></i><span>Servi√ßos</span></a>
				<a onclick="window.App.showPage('page-performance')" id="tab-performance" class="sidebar-nav-item admin-only"><i class="fas fa-rocket w-5 text-center"></i><span>Performance</span></a>
				<a onclick="window.App.showPage('page-relatorios')" id="tab-relatorios" class="sidebar-nav-item admin-only"><i class="fas fa-chart-pie w-5 text-center"></i><span>Relat√≥rios</span></a>
				<a onclick="window.App.showPage('page-lixeira')" id="tab-lixeira" class="sidebar-nav-item"><i class="fas fa-trash-alt w-5 text-center"></i><span>Lixeira</span></a>
				<div class="border-t border-gray-700 pt-3 mt-3 admin-only">
					<a onclick="window.App.showPage('page-oficina')" id="tab-oficina" class="sidebar-nav-item admin-only"><i class="fas fa-cogs w-5 text-center"></i><span>Oficina</span></a>
				</div>
			</nav>
			<div class="mt-auto pt-4 border-t border-gray-700 flex items-center gap-3">
				<div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center font-bold text-white"><i class="fas fa-user"></i></div>
				<div><span id="user-display-name" class="text-sm font-medium block"></span><button id="logout-button" class="text-xs text-red-400 hover:text-red-300">Sair</button></div>
			</div>
		</aside>

		<main id="main-content" class="flex-1 flex flex-col h-screen overflow-y-auto pb-24 md:pb-0">
			<header class="sticky top-0 bg-gray-900/30 backdrop-blur-md border-b border-gray-700/50 p-4 z-10 flex justify-between items-center">
				<h1 id="page-title" class="text-2xl font-bold text-white">Painel Principal</h1>
				<div class="flex items-center gap-4">
					<div class="relative">
						<button id="notification-bell" class="p-2 text-gray-300 hover:text-white"><i class="fas fa-bell text-xl"></i><span id="notification-badge" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full"></span></button>
						<div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50">
							<div class="flex justify-between p-3 border-b border-gray-700"><h3 class="font-semibold text-white">Notifica√ß√µes</h3><button id="clear-notifications-button" class="text-xs text-indigo-400">Limpar</button></div>
							<div id="notification-list" class="max-h-80 overflow-y-auto p-2">
								<div id="notification-list-empty" class="hidden text-center p-4 text-gray-400">Sem notifica√ß√µes.</div>
							</div>
						</div>
					</div>
					<button id="mobile-menu-toggle" class="md:hidden p-2 text-gray-300"><i class="fas fa-bars text-xl"></i></button>
				</div>
			</header>

			<div class="p-4 md:p-8 flex-1">
				<div id="page-dashboard">
					<div class="flex flex-wrap gap-4 mb-8">
						<button onclick="window.App.openContractModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-lg flex items-center gap-2"><i class="fas fa-plus-circle"></i> Novo Contrato</button>
						<button onclick="window.App.openReportModal()" class="admin-only bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-5 rounded-lg shadow-lg flex items-center gap-2"><i class="fas fa-chart-line"></i> Relat√≥rio</button>
					</div>

					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
						<div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-gray-400 font-semibold">A Receber (30 dias)</h3><p id="dash-a-receber" class="text-3xl font-bold text-green-400">R$ 0,00</p></div>
						<div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-gray-400 font-semibold">Vencido</h3><p id="dash-vencido" class="text-3xl font-bold text-red-400">R$ 0,00</p></div>
						<div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-gray-400 font-semibold">Recebido (M√™s)</h3><p id="dash-recebido" class="text-3xl font-bold text-indigo-400">R$ 0,00</p></div>
						<div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-gray-400 font-semibold">Contratos Ativos</h3><p id="dash-contratos" class="text-3xl font-bold text-white">0</p></div>
					</div>

					<div class="mb-4 border-b border-gray-700"><h2 class="text-2xl font-semibold mb-4 text-white">Situa√ß√£o das Parcelas</h2></div>
					<div class="grid grid-cols-1 md:grid-cols-3 gap-6 pb-4">
						<div class="kanban-column dark-card shadow-lg rounded-lg p-4"><h3 class="font-bold text-lg mb-4 text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Vencidas</h3><div id="kanban-vencidas" class="kanban-content space-y-3"></div></div>
						<div class="kanban-column dark-card shadow-lg rounded-lg p-4"><h3 class="font-bold text-lg mb-4 text-yellow-400"><i class="far fa-clock mr-2"></i>A Vencer</h3><div id="kanban-a-vencer" class="kanban-content space-y-3"></div></div>
						<div class="kanban-column dark-card shadow-lg rounded-lg p-4"><h3 class="font-bold text-lg mb-4 text-gray-400"><i class="fas fa-check-circle mr-2"></i>Pagas (M√™s)</h3><div id="kanban-pagas" class="kanban-content space-y-3"></div></div>
					</div>

					<div id="exito-section" class="mt-12 hidden">
						<div class="mb-4 border-b border-gray-700"><h2 class="text-2xl font-semibold mb-4 text-white">√äxito Pendente</h2></div>
						<div id="kanban-exito-wrapper" class="flex overflow-x-auto space-x-6 pb-4"></div>
					</div>

					<div class="mt-12">
						<div class="flex flex-wrap justify-between items-center mb-4 border-b border-gray-700 pb-4 gap-4">
							<h2 class="text-2xl font-semibold text-white">Meus Contratos</h2>
							<div class="flex flex-wrap items-center gap-4">
								<button onclick="window.App.exportContractsCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-file-csv mr-1"></i> CSV</button>
								
								<div class="flex bg-gray-800 rounded-lg p-1 border border-gray-700">
									<button id="btn-era-novos" onclick="window.App.setContractEra('novos')" class="px-3 py-1 rounded-md text-sm font-medium bg-indigo-600 text-white shadow-sm transition-all"><i class="fas fa-star text-xs mr-1"></i>Novos</button>
									<button id="btn-era-legados" onclick="window.App.setContractEra('legados')" class="px-3 py-1 rounded-md text-sm font-medium text-gray-400 hover:text-white transition-all"><i class="fas fa-history text-xs mr-1"></i>Legados</button>
									<button id="btn-era-todos" onclick="window.App.setContractEra('todos')" class="px-3 py-1 rounded-md text-sm font-medium text-gray-400 hover:text-white transition-all"><i class="fas fa-list text-xs mr-1"></i>Todos</button>
								</div>

								<select id="advogadoFilter" onchange="window.App.resetAndRenderContractList()" class="filter-select admin-only"></select>
								<div class="flex items-center gap-2 text-sm text-gray-400"><span>Status:</span><div id="contractStatusFilterButtons" class="flex gap-1"></div></div>
								<div class="flex items-center gap-2 text-sm text-gray-400"><span>Ordem:</span><div id="contractSortButtons" class="flex gap-1"></div></div>
							</div>
						</div>
						<div class="mb-4"><input type="text" id="searchInput" placeholder="üîé Pesquisar..." class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white"></div>
						<div id="contractListContainer"></div>
						<div id="paginationContainer" class="flex justify-center items-center gap-2 mt-8"></div>
					</div>
				</div>
				<div id="page-parcelas" class="hidden">
					<div class="flex flex-wrap justify-between items-center mb-4 gap-4">
						<h2 class="text-2xl font-semibold text-white">Controle de Parcelas</h2>
						<div class="flex items-center gap-4">
							<input type="text" id="parcelasSearchInput" placeholder="üîé Pesquisar..." class="w-full p-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
							<div class="flex items-center gap-2"><span class="text-sm text-gray-400">Ordem:</span><div id="parcelasSortButtons" class="flex gap-1"></div></div>
						</div>
					</div>
					<div id="parcelasListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
				</div>

				<div id="page-servicos" class="hidden">
					<div class="flex flex-wrap justify-between items-center mb-4 gap-4">
						<h2 class="text-2xl font-semibold text-white">Produ√ß√£o de Servi√ßos</h2>
						<div class="flex items-center gap-4">
							<select id="servicosAdvogadoFilter" onchange="window.App.renderServicosPage()" class="filter-select admin-only"></select>
							<div class="flex items-center gap-2"><span class="text-sm text-gray-400">Ordem:</span><div id="servicosSortButtons" class="flex gap-1"></div></div>
							<input type="text" id="servicosSearchInput" placeholder="üîé Pesquisar..." class="w-full p-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
						</div>
					</div>
					<div id="servicosListContainer" class="space-y-8"></div>
				</div>

				<div id="page-performance" class="hidden admin-only">
					<div class="mb-6 border-b border-gray-700 pb-4"><h2 class="text-2xl font-semibold text-white">Performance Gerencial</h2></div>
					<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
						<div class="dark-card shadow-lg p-6 rounded-lg"><h3 class="text-lg font-semibold text-gray-300 mb-4">Contratos Ativos</h3><div class="relative" style="height: 350px;"><canvas id="adminChartContratos"></canvas></div></div>
						<div class="dark-card shadow-lg p-6 rounded-lg"><h3 class="text-lg font-semibold text-gray-300 mb-4">Fatura√ß√£o (Ano)</h3><div class="relative" style="height: 350px;"><canvas id="adminChartFaturamento"></canvas></div></div>
					</div>
					<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
						<div class="dark-card shadow-lg p-6 rounded-lg"><h3 class="text-lg font-semibold text-gray-300 mb-4">Ranking Financeiro</h3><table class="ranking-table" id="adminTableFaturamento"><thead><tr><th>Rank</th><th>Advogado</th><th>Valor</th></tr></thead><tbody></tbody></table></div>
						<div class="dark-card shadow-lg p-6 rounded-lg"><h3 class="text-lg font-semibold text-gray-300 mb-4">Ranking Produ√ß√£o</h3><table class="ranking-table" id="adminTableContratos"><thead><tr><th>Rank</th><th>Advogado</th><th>Contratos</th></tr></thead><tbody></tbody></table></div>
					</div>
				</div>

				<div id="page-relatorios" class="hidden admin-only">
					<div class="flex flex-wrap justify-between items-center mb-6 border-b border-gray-700 pb-4">
						<h2 class="text-2xl font-semibold text-white">Relat√≥rios Avan√ßados</h2>
						<div class="flex items-center gap-4">
							<input type="date" id="reportStartDate" class="filter-select">
							<input type="date" id="reportEndDate" class="filter-select">
							<button onclick="window.App.generateAdvancedReport()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg flex items-center gap-2"><i class="fas fa-sync-alt"></i> Gerar</button>
							<button id="exportPdfButton" onclick="window.App.exportReportPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg flex items-center gap-2" disabled><i class="fas fa-file-pdf"></i> PDF</button>
						</div>
					</div>
					<div id="advancedReportContainer" class="space-y-8 hidden">
						<div id="report-kpis" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
						<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
							<div class="dark-card shadow-lg p-6 rounded-lg"><h3 class="text-lg font-semibold text-gray-300 mb-4">Linha do Tempo</h3><div class="relative" style="height: 350px;"><canvas id="advReportTimelineChart"></canvas></div></div>
							<div class="dark-card shadow-lg p-6 rounded-lg"><h3 class="text-lg font-semibold text-gray-300 mb-4">Novos Contratos</h3><div class="relative" style="height: 350px;"><canvas id="advReportNewContractsChart"></canvas></div></div>
						</div>
						<div class="dark-card shadow-lg p-6 rounded-lg"><h3 class="text-lg font-semibold text-gray-300 mb-4">Por Advogado</h3><div class="relative" style="height: 400px; max-width: 600px; margin: auto;"><canvas id="advReportByAdvogadoChart"></canvas></div></div>
					</div>
					<div id="advancedReportEmpty" class="text-center py-10 text-gray-400"><i class="fas fa-chart-pie fa-3x mb-3"></i><p>Selecione as datas e gere o relat√≥rio.</p></div>
				</div>

				<div id="page-lixeira" class="hidden">
					<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-white">Lixeira</h2></div>
					<div id="lixeiraListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
				</div>

				<div id="page-oficina" class="hidden admin-only">
					<div class="mb-6 border-b border-gray-700 pb-4"><h2 class="text-2xl font-semibold text-white">Oficina</h2></div>
					<div class="dark-card shadow-lg p-6 rounded-lg max-w-md">
						<h3 class="text-lg font-semibold text-gray-300 mb-4">Gerenciar Advogados</h3>
						<form id="formAddAdvogado" class="flex gap-2 mb-4">
							<input type="text" id="inputAdvogadoName" placeholder="Nome do Advogado" class="form-input flex-1" required>
							<button type="submit" class="form-button"><i class="fas fa-plus"></i></button>
						</form>
						<div class="space-y-2 max-h-80 overflow-y-auto" id="advogadoSettingsList"></div>
					</div>
				</div>
			</div>
		</main>

		<nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-900/90 backdrop-blur-lg border-t border-gray-700 flex justify-around z-30 pb-1">
			<a onclick="window.App.showPage('page-dashboard')" id="mobile-tab-dashboard" class="mobile-nav-item active"><i class="fas fa-tachometer-alt text-xl"></i><span class="text-[10px]">Painel</span></a>
			<a onclick="window.App.showPage('page-parcelas')" id="mobile-tab-parcelas" class="mobile-nav-item"><i class="fas fa-file-invoice-dollar text-xl"></i><span class="text-[10px]">Parcelas</span></a>
			<a onclick="window.App.showPage('page-servicos')" id="mobile-tab-servicos" class="mobile-nav-item"><i class="fas fa-tasks text-xl"></i><span class="text-[10px]">Servi√ßos</span></a>
			<a onclick="window.App.showPage('page-performance')" id="mobile-tab-performance" class="mobile-nav-item admin-only"><i class="fas fa-rocket text-xl"></i><span class="text-[10px]">Perf.</span></a>
			<a onclick="window.App.showPage('page-relatorios')" id="mobile-tab-relatorios" class="mobile-nav-item admin-only"><i class="fas fa-chart-pie text-xl"></i><span class="text-[10px]">Relat.</span></a>
			<a onclick="window.App.showPage('page-lixeira')" id="mobile-tab-lixeira" class="mobile-nav-item"><i class="fas fa-trash-alt text-xl"></i><span class="text-[10px]">Lixeira</span></a>
			<a onclick="window.App.showPage('page-oficina')" id="mobile-tab-oficina" class="mobile-nav-item admin-only"><i class="fas fa-cogs text-xl"></i><span class="text-[10px]">Oficina</span></a>
		</nav>
	</div>

	<div id="modalDisplayName" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 overflow-hidden">
		<div class="p-5 border-b border-gray-700"><h2 class="text-xl font-bold text-white">Bem-vindo!</h2></div>
		<div class="p-6 modal-body">
			<form id="formDisplayName">
				<label class="block text-sm text-gray-400 mb-2">Seu Nome</label>
				<input type="text" id="inputDisplayName" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white mb-4" required>
				<button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">Salvar</button>
			</form>
		</div>
	</div>

	<div id="modalContrato" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-2/5 overflow-hidden flex flex-col">
		<div class="flex justify-between items-center p-5 border-b border-gray-700">
			<h2 id="modalContratoTitle" class="text-xl font-bold text-white">Contrato</h2>
			<button onclick="window.App.closeModal('modalContrato')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
		</div>
		<form id="formContrato" class="flex flex-col flex-1 overflow-hidden">
			<div class="p-6 space-y-4 overflow-y-auto modal-body">
				<input type="hidden" id="contractId">
				<input type="hidden" id="financialDataChanged" value="false">
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div><label class="text-sm text-gray-400">Cliente</label><input type="text" id="clienteNome" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white" required></div>
					<div><label class="text-sm text-gray-400">Advogado</label><select id="advogadoResponsavel" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white" required></select></div>
				</div>
				<div>
					<label class="text-sm text-gray-400">Servi√ßos</label>
					<div id="servicosContainer" class="flex flex-wrap gap-1 mb-2"></div>
					<div class="flex gap-2"><input type="text" id="contratoServicoInput" class="flex-grow bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-white" placeholder="Novo servi√ßo"><input type="date" id="contratoPrazoInput" class="bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-white"><button type="button" id="addServiceButton" class="bg-indigo-600 px-3 rounded-md text-white text-sm">Add</button></div>
				</div>
				<div><label class="text-sm text-gray-400">Pagamento</label><select id="contratoTipoPagamento" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white"><option>Parcelado</option><option>Pr√≥-labore</option><option>Entrada √∫nica</option></select></div>
				<div><label class="text-sm text-gray-400">Obs</label><textarea id="contratoObservacoes" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white" rows="2"></textarea></div>
				
				<div class="admin-only border-t border-gray-700 pt-4 mt-2">
					<div id="financial-warning" class="hidden p-2 bg-yellow-900/30 border border-yellow-700 rounded text-yellow-300 text-xs mb-2">Financeiro bloqueado (j√° possui pagamentos).</div>
					<label class="flex items-center mb-2"><input type="checkbox" id="contratoEspecial" class="mr-2"> <span class="text-sm text-gray-300">Contrato Especial (Manual)</span></label>
					
					<div id="financial-fields-standard" class="space-y-3">
						<label class="flex items-center"><input type="checkbox" id="contratoJaQuitado" class="mr-2"> <span class="text-xs text-gray-400">J√° Quitado (Legado)</span></label>
						<div class="grid grid-cols-2 gap-4">
							<div><label class="text-xs text-gray-400">Total (R$)</label><input type="number" step="0.01" id="valorTotal" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white"></div>
							<div><label class="text-xs text-gray-400">Qtd Parcelas</label><input type="number" id="numParcelas" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white" value="1"></div>
						</div>
						<div><label class="text-xs text-gray-400">1¬™ Vencimento</label><input type="date" id="vencimentoPrimeiraParcela" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white"></div>
					</div>

					<div id="financial-fields-special" class="hidden space-y-3">
						<div class="flex gap-2 items-end">
							<div class="flex-1"><label class="text-xs text-gray-400">Valor</label><input type="number" step="0.01" id="parcelaValorManual" class="w-full p-1 bg-gray-900 border border-gray-700 rounded-md text-white"></div>
							<div class="flex-1"><label class="text-xs text-gray-400">Data</label><input type="date" id="parcelaVencimentoManual" class="w-full p-1 bg-gray-900 border border-gray-700 rounded-md text-white"></div>
							<button type="button" id="addManualParcelButton" class="bg-indigo-600 px-3 py-1 rounded-md text-white text-xs h-8">Add</button>
						</div>
						<div id="manualParcelList" class="max-h-32 overflow-y-auto bg-gray-900 p-2 rounded-md border border-gray-700 space-y-1"></div>
					</div>
					<div class="mt-2"><label class="text-xs text-gray-400">Taxa √äxito</label><input type="text" id="taxaExito" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white"></div>
				</div>
			</div>
			<div class="flex justify-end p-4 border-t border-gray-700 bg-gray-900/50">
				<button type="button" onclick="window.App.closeModal('modalContrato')" class="mr-2 px-4 py-2 text-gray-400 hover:text-white">Cancelar</button>
				<button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
			</div>
		</form>
	</div>
	<div id="modalPagamento" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 overflow-hidden">
		<div class="p-5 border-b border-gray-700"><h2 class="text-xl font-bold text-white">Pagamento</h2></div>
		<form id="formPagamento" class="p-6 space-y-4">
			<div id="pagamentoInfo" class="bg-gray-700 p-3 rounded-md text-white text-sm"></div>
			<div><label class="text-sm text-gray-400">Valor Pago</label><input type="number" step="0.01" id="pagamentoValor" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white" required></div>
			<div><label class="text-sm text-gray-400">Data</label><input type="date" id="pagamentoData" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white" required></div>
			<input type="hidden" id="pagamentoContractId"><input type="hidden" id="pagamentoParcelIndex">
			<div class="flex justify-end pt-4"><button type="button" onclick="window.App.closeModal('modalPagamento')" class="mr-2 text-gray-400">Cancelar</button><button type="submit" class="bg-green-600 px-4 py-2 rounded-lg text-white font-bold">Confirmar</button></div>
		</form>
	</div>

	<div id="modalRelatorio" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-2/3 overflow-hidden admin-only">
		<div class="p-5 border-b border-gray-700"><h2 class="text-xl font-bold text-white">Relat√≥rio Mensal</h2><button onclick="window.App.closeModal('modalRelatorio')" class="float-right text-gray-400">&times;</button></div>
		<div class="p-6 modal-body">
			<div class="flex gap-4 mb-4">
				<select id="reportMonth" class="flex-1 p-2 bg-gray-900 border border-gray-700 rounded-md text-white"></select>
				<select id="reportYear" class="flex-1 p-2 bg-gray-900 border border-gray-700 rounded-md text-white"></select>
			</div>
			<div class="flex gap-2 mb-6">
				<button onclick="window.App.generateAndShowReport()" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg">Gerar</button>
				<button onclick="window.App.exportReportCSV()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg">CSV</button>
			</div>
			<div id="reportResult" class="space-y-4 text-white"></div>
		</div>
	</div>

	<div id="modalExito" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 overflow-hidden">
		<div class="p-5 border-b border-gray-700"><h2 class="text-xl font-bold text-white">Receber √äxito</h2></div>
		<form id="formExito" class="p-6 space-y-4">
			<div id="exitoInfo" class="bg-gray-700 p-3 rounded-md text-white text-sm"></div>
			<div class="admin-only"><label class="text-sm text-gray-400">Valor L√≠quido</label><input type="number" step="0.01" id="exitoValorRecebido" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-white" required></div>
			<input type="hidden" id="exitoContractId">
			<div class="flex justify-end pt-4"><button type="button" onclick="window.App.closeModal('modalExito')" class="mr-2 text-gray-400">Cancelar</button><button type="submit" class="bg-indigo-600 px-4 py-2 rounded-lg text-white font-bold">Salvar</button></div>
		</form>
	</div>
	
	<div id="modalCliente" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-2/3 overflow-hidden">
		<div class="p-5 border-b border-gray-700 flex justify-between"><h2 id="clienteModalTitle" class="text-xl font-bold text-white"></h2><button onclick="window.App.closeModal('modalCliente')" class="text-gray-400 text-2xl">&times;</button></div>
		<div id="clienteModalContent" class="p-6 space-y-4 modal-body text-gray-300"></div>
	</div>

	<div id="modal-backdrop" class="modal-backdrop"></div>

	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
		import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
		import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel, writeBatch, serverTimestamp, query, orderBy, limit, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
		
		const ADMIN_USERS = ["dra. renata fabris","Darc", "dr. felipe gurj√£o", "lilian"];
		const CONTRACTS_PER_PAGE = 12;
		const CUTOFF_DATE = "2025-11-01"; // Data de Corte para "Novos"

		const Utils = {
			showToast(msg, type='info') {
				const n = document.createElement('div');
				n.className = `px-4 py-3 rounded-lg shadow-lg text-white text-sm ${type==='error'?'bg-red-800':'bg-gray-700'}`;
				n.textContent = msg;
				document.getElementById('notifications').appendChild(n);
				setTimeout(()=>n.remove(), 2500);
			},
			debounce(fn, ms=300) { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; },
			sanitizeText(s) { if(s==null) return ''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; },
			sanitizeId(n) { return n ? n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9]/g,'_').toLowerCase() : 'unknown'; },
			parseNumber(n) { const v=Number(n); return Number.isFinite(v)?v:0; },
			formatCurrency(v) { return (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); },
			formatDate(d) { if(!d) return ''; const date=new Date(d); return `${String(date.getUTCDate()).padStart(2,'0')}/${String(date.getUTCMonth()+1).padStart(2,'0')}/${date.getUTCFullYear()}`; },
			timeAgo(d) { if(!d) return ''; const s=Math.floor((new Date()-d)/1000); if(s>86400) return `h√° ${Math.floor(s/86400)}d`; if(s>3600) return `h√° ${Math.floor(s/3600)}h`; return 'agora'; },
			confirm(m) { return new Promise(r=>{ if(window.confirm(m)) r(true); else r(false); }); } 
		};

		class CorrectionCalculator {
			constructor() { this.IPCA = {"2023-01":0.53,"2023-02":0.84,"2023-03":0.71,"2023-04":0.61,"2023-05":0.23,"2023-06":-0.08,"2023-07":0.12,"2023-08":0.23,"2023-09":0.26,"2023-10":0.24,"2023-11":0.28,"2023-12":0.56,"2024-01":0.42,"2024-02":0.83,"2024-03":0.16,"2024-04":0.38,"2024-05":0.46,"2024-06":0.36,"2024-07":0.16,"2024-08":0.24,"2024-09":0.26,"2024-10":0.42,"2024-11":0.53,"2024-12":0.48,"2025-01":0.55,"2025-02":0.78,"2025-03":0.21,"2025-04":0.35,"2025-05":0.40,"2025-06":0.26,"2025-07":0.22,"2025-08":0.31,"2025-09":0.33,"2025-10":0.40}; }
			calc(val, due, ref=new Date()) {
				const dV = new Date(due), dR = new Date(ref); dV.setUTCHours(0,0,0,0); dR.setUTCHours(0,0,0,0);
				if(dR <= dV) return val;
				let f = 1.0, c = new Date(Date.UTC(dV.getUTCFullYear(), dV.getUTCMonth(), 1));
				const e = new Date(Date.UTC(dR.getUTCFullYear(), dR.getUTCMonth(), 1));
				while(c < e) { f *= (1 + (this.IPCA[`${c.getUTCFullYear()}-${String(c.getUTCMonth()+1).padStart(2,'0')}`]||0)/100); c.setUTCMonth(c.getUTCMonth()+1); }
				const m = Math.max(0, (dR.getUTCFullYear()-dV.getUTCFullYear())*12 + (dR.getUTCMonth()-dV.getUTCMonth()) + (dR.getUTCDate()-dV.getUTCDate())/30);
				return val * f * (1 + 0.01 * m);
			}
		}

		class Services {
			constructor(app) { 
				this.app = app; this.db=null; 
				this.appConfig = { apiKey: "AIzaSyA0TWb7DgZAHNl3TuoK3xQD-ANvCcQIDK4", authDomain: "fabrisgurjao.firebaseapp.com", projectId: "fabrisgurjao", storageBucket: "fabrisgurjao.firebasestorage.app", messagingSenderId: "466702265991", appId: "1:466702265991:web:78c4d98b47cab537921222" };
			}
			init() {
				try { const f=initializeApp(this.appConfig); this.auth=getAuth(f); this.db=getFirestore(f); onAuthStateChanged(this.auth, u=>this.app.handleAuth(u)); } 
				catch(e) { console.error(e); document.getElementById('loading-overlay').textContent="Erro Conex√£o"; }
			}
			async login(e,p) { try { await signInWithEmailAndPassword(this.auth,e,p); } catch(x) { document.getElementById('auth-error').textContent="Erro ao entrar."; document.getElementById('auth-error').classList.remove('hidden'); } }
			async logout() { await signOut(this.auth); }
			async updateProfile(n) { await updateProfile(this.auth.currentUser,{displayName:n}); return true; }
			
			startListeners(uid) {
				onSnapshot(collection(this.db,'contracts'), s => this.app.updateContracts(s.docs.map(d=>({id:d.id,...d.data()}))));
				onSnapshot(query(collection(this.db,`notifications/${uid}/alerts`), orderBy('timestamp','desc'), limit(20)), s => this.app.updateNotifs(s.docs.map(d=>({id:d.id,...d.data()}))));
				onSnapshot(collection(this.db,'systemSettings'), s => { const st={}; s.docs.forEach(d=>st[d.id]=d.data()); this.app.updateSettings(st); });
			}
			async saveSetting(id, d) { await setDoc(doc(this.db,'systemSettings',id),d,{merge:true}); }
			async notify(u, d) { try{ await addDoc(collection(this.db,`notifications/${Utils.sanitizeId(u)}/alerts`),{...d,isRead:false,timestamp:serverTimestamp()}); }catch(e){} }
			async markRead(uid, ids) { const b=writeBatch(this.db); ids.forEach(i=>b.update(doc(this.db,`notifications/${uid}/alerts`,i),{isRead:true})); await b.commit(); }
			
			// CRUD Helpers
			async addC(d) { await addDoc(collection(this.db,'contracts'),d); Utils.showToast('Salvo!'); }
			async updC(id,d) { await updateDoc(doc(this.db,'contracts',id),d); Utils.showToast('Atualizado!'); }
			async delC(id) { await deleteDoc(doc(this.db,'contracts',id)); }
		}

		class ReportHandler {
			constructor(app) { this.app = app; }
			calcRange(start, end, contracts) {
				let tp=0, te=0, dets=[], byAdv={}, byM={};
				const actives = contracts.filter(c => !c.isDeleted);
				const notPaid = []; // Nova lista rigorosa

				actives.forEach(c => {
					let paidInMonth = false;
					const adv = c.advogadoResponsavel || 'N/A';
					
					// Recebimentos
					(c.parcels||[]).forEach(p => {
						const dPay = p.paymentDate ? new Date(p.paymentDate) : null;
						const dDue = new Date(p.dueDate);
						// Logica de Recebimento
						if(p.status==='Paga' && dPay && dPay >= start && dPay <= end) {
							tp += p.valuePaid;
							dets.push({t:`Parcela ${p.number}`, c:c.clientName, d:dPay, v:p.valuePaid, a:adv});
							paidInMonth = true;
						}
						// [FIX] L√≥gica de Inadimpl√™ncia: Se vencia no m√™s e n√£o pagou
						if(dDue >= start && dDue <= end && p.status !== 'Paga') {
							notPaid.push({ c:c.clientName, a:adv, p:p.number, v:p.value, due:dDue });
						}
					});
					// Exito
					if(c.successFeePaymentDate) {
						const d = new Date(c.successFeePaymentDate);
						if(d >= start && d <= end) {
							te += c.successFeeValueReceived;
							dets.push({t:'√äxito', c:c.clientName, d:d, v:c.successFeeValueReceived, a:adv});
						}
					}
				});
				dets.sort((a,b)=>a.d-b.d);
				notPaid.sort((a,b)=>a.due-b.due);
				return { tp, te, total:tp+te, dets, notPaid };
			}
		}

		class DOMBuilder {
			constructor(app) { this.app = app; }
			el(tag, cls, txt) { const e=document.createElement(tag); if(cls)e.className=cls; if(txt)e.innerHTML=txt; return e; }
			
			// [FIX] Corre√ß√£o dos bot√µes de a√ß√£o e dados do modal
			createParcelCard(item) {
				const { contract, parcel, index, diff, corr, isLate } = item;
				const div = this.el('div', `dark-card shadow-lg p-4 rounded-lg border-l-4 ${isLate?'border-red-500':'border-yellow-500'} mb-4`);
				
				div.innerHTML = `
					<div class="flex justify-between items-start">
						<h3 class="font-bold text-white text-lg">${contract.clientName}</h3>
						<span class="text-xs text-gray-500">${contract.advogadoResponsavel}</span>
					</div>
					<p class="text-sm text-gray-400 mb-2">${(contract.serviceTypes||[]).map(s=>s.name).join(', ')} - Parcela ${parcel.number}/${contract.parcels.length}</p>
					<div class="text-sm space-y-1 border-t border-gray-700 pt-2">
						<div class="flex justify-between text-gray-400"><span>Original:</span> <span class="line-through">${Utils.formatCurrency(parcel.value)}</span></div>
						<div class="flex justify-between text-white font-bold"><span>Corrigido:</span> <span class="${isLate?'text-red-400':'text-yellow-400'} text-lg">${Utils.formatCurrency(corr)}</span></div>
						<div class="flex justify-between text-gray-300"><span>Vence:</span> <span>${Utils.formatDate(parcel.dueDate)}</span></div>
						<div class="flex justify-between font-bold ${isLate?'text-red-400 bg-red-900/20':'text-yellow-400 bg-yellow-900/20'} p-1 rounded">
							<span>${isLate?'Atrasado h√°:':'Faltam:'}</span><span>${Math.abs(diff)} dia(s)</span>
						</div>
					</div>
					<div class="mt-3 flex gap-2">
						<button class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-2 rounded text-sm" onclick="window.App.openPaymentModal('${contract.id}', ${index})"><i class="fas fa-check mr-1"></i> Pagar</button>
						<button class="bg-gray-600 hover:bg-gray-500 text-white py-1 px-3 rounded" onclick="window.App.openContractModal('${contract.id}')" title="Editar"><i class="fas fa-pencil-alt"></i></button>
						<button class="bg-indigo-600 hover:bg-indigo-500 text-white py-1 px-3 rounded" onclick="window.App.openClientHistoryModal('${contract.clientName}')" title="Hist√≥rico"><i class="fas fa-eye"></i></button>
					</div>
				`;
				return div;
			}

			createContractCard(c, st) {
				const div = this.el('div', `dark-card shadow-lg rounded-lg border-l-4 ${st.borderColor} p-4 flex flex-col justify-between`);
				div.innerHTML = `
					<div>
						<div class="flex justify-between mb-2">
							<h3 class="font-bold text-white text-lg truncate" title="${c.clientName}">${c.clientName}</h3>
							<span class="px-2 py-0.5 rounded text-[10px] font-bold h-fit ${st.statusColor}">${st.statusText}</span>
						</div>
						<p class="text-xs text-indigo-300 mb-2"><i class="fas fa-user-tie mr-1"></i> ${c.advogadoResponsavel}</p>
						<div class="flex flex-wrap gap-1 mb-3">${(c.serviceTypes||[]).map(s=>`<span class="text-[10px] bg-gray-700 px-2 py-0.5 rounded text-gray-300">${s.name}</span>`).join('')}</div>
						<div class="border-t border-gray-700 pt-2 text-sm">
							<div class="flex justify-between text-gray-400"><span>Total:</span> <span class="text-gray-200">${Utils.formatCurrency(c.totalValue)}</span></div>
							${c.successFee ? `<div class="flex justify-between text-gray-400"><span>√äxito:</span> <span class="text-indigo-400">${c.successFee}</span></div>` : ''}
						</div>
					</div>
					<div class="mt-3 flex justify-end gap-2 border-t border-gray-700 pt-2">
						<button class="text-gray-400 hover:text-indigo-400 text-sm" onclick="window.App.openClientHistoryModal('${c.clientName}')"><i class="fas fa-eye"></i></button>
						<button class="text-gray-400 hover:text-green-400 text-sm" onclick="window.App.openContractModal('${c.id}')"><i class="fas fa-pencil-alt"></i></button>
						<button class="text-gray-400 hover:text-red-400 text-sm" onclick="window.App.moveToLixeira('${c.id}')"><i class="fas fa-trash-alt"></i></button>
					</div>
				`;
				return div;
			}
		}
class App {
			constructor() {
				this.db = { contracts: [], notifications: [], settings: {advogados:{list:[]}} };
				this.user = null; this.isAdmin = false; this.uid = null;
				this.era = 'novos'; // 'novos', 'legados', 'todos'
				this.page = 'page-dashboard';
				this.srv = new Services(this);
				this.dom = new DOMBuilder(this);
				this.rep = new ReportHandler(this);
				this.calc = new CorrectionCalculator();
			}

			initialize() {
				this.srv.init();
				this.setupUI();
			}

			setupUI() {
				// Login & Auth
				document.getElementById('login-form').onsubmit = (e) => { e.preventDefault(); this.srv.login(document.getElementById('login-email').value, document.getElementById('login-password').value); };
				document.getElementById('logout-button').onclick = () => this.srv.logout();
				document.getElementById('formDisplayName').onsubmit = async (e) => { e.preventDefault(); if(await this.srv.updateProfile(document.getElementById('inputDisplayName').value)) window.location.reload(); };

				// Modais e Forms
				document.getElementById('formContrato').onsubmit = (e) => this.handleContractSubmit(e);
				document.getElementById('formPagamento').onsubmit = (e) => this.handlePaymentSubmit(e);
				document.getElementById('formExito').onsubmit = (e) => this.handleExitoSubmit(e);
				document.getElementById('formAddAdvogado').onsubmit = (e) => { e.preventDefault(); const v=document.getElementById('inputAdvogadoName').value; if(v){ const l=this.db.settings.advogados?.list||[]; if(!l.includes(v)) this.srv.saveSetting('advogados',{list:[...l,v]}); document.getElementById('inputAdvogadoName').value=''; } };
				
				// A√ß√µes
				document.getElementById('addServiceButton').onclick = () => {
					const n=document.getElementById('contratoServicoInput').value, d=document.getElementById('contratoPrazoInput').value;
					if(n) { this.createServiceTag(n,d); document.getElementById('contratoServicoInput').value=''; }
				};
				document.getElementById('addManualParcelButton').onclick = () => this.addManualParcel();
				document.getElementById('contratoEspecial').onchange = (e) => { document.getElementById('financial-fields-standard').style.display=e.target.checked?'none':'block'; document.getElementById('financial-fields-special').style.display=e.target.checked?'block':'none'; };

				// Filtros & Navega√ß√£o
				document.getElementById('mobile-menu-toggle').onclick = () => { document.getElementById('sidebar').classList.toggle('hidden'); document.getElementById('modal-backdrop').style.display = document.getElementById('sidebar').classList.contains('hidden')?'none':'block'; };
				document.getElementById('modal-backdrop').onclick = () => { this.closeModal(this.openModalId); document.getElementById('sidebar').classList.add('hidden'); document.getElementById('modal-backdrop').style.display='none'; document.getElementById('notification-dropdown').classList.add('hidden'); };
				
				// Search Debounce
				const reRender = Utils.debounce(() => this.render());
				['searchInput','parcelasSearchInput','servicosSearchInput'].forEach(id => document.getElementById(id).oninput = reRender);
				['advogadoFilter','servicosAdvogadoFilter'].forEach(id => document.getElementById(id).onchange = reRender);

				// Notifications
				document.getElementById('notification-bell').onclick = (e) => { e.stopPropagation(); document.getElementById('notification-dropdown').classList.toggle('hidden'); };
				document.getElementById('clear-notifications-button').onclick = () => { const ids=this.db.notifications.filter(n=>!n.isRead).map(n=>n.id); if(ids.length) this.srv.markRead(this.uid, ids); };
			}

			handleAuth(user) {
				if(user) {
					this.user = user.displayName; this.uid = Utils.sanitizeId(user.displayName);
					this.isAdmin = ADMIN_USERS.map(u=>u.toLowerCase()).includes(this.user?.toLowerCase());
					document.body.classList.toggle('is-admin', this.isAdmin);
					document.getElementById('auth-overlay').style.display = 'none';
					document.getElementById('app-container').style.display = 'flex';
					if(!this.user) this.openModal('modalDisplayName');
					else {
						document.getElementById('user-display-name').textContent = this.user;
						this.srv.startListeners(this.uid);
					}
				} else {
					document.getElementById('auth-overlay').style.display = 'flex';
					document.getElementById('app-container').style.display = 'none';
				}
				document.getElementById('loading-overlay').style.display = 'none';
			}

			updateContracts(data) { this.db.contracts = data; this.render(); }
			updateNotifs(data) { this.db.notifications = data; this.renderNotifs(); }
			updateSettings(data) { this.db.settings = data; if(this.page==='page-oficina') this.renderOficina(); this.renderFilters(); }

			// --- L√ìGICA DE FILTRO (Data de Cria√ß√£o) ---
			getFilteredList(includeDeleted=false) {
				let list = this.db.contracts;
				if(!this.isAdmin) list = list.filter(c => c.advogadoResponsavel === this.user);
				if(!includeDeleted) list = list.filter(c => !c.isDeleted);
				
				// Filtro de Era (Novos/Legados/Todos)
				if(this.era !== 'todos') {
					list = list.filter(c => {
						const d = (c.createdAt || "").substring(0,10);
						return this.era === 'novos' ? d >= CUTOFF_DATE : d < CUTOFF_DATE;
					});
				}
				return list;
			}

			setContractEra(era) {
				this.era = era;
				// Atualiza bot√µes
				['novos','legados','todos'].forEach(e => {
					const btn = document.getElementById(`btn-era-${e}`);
					if(e === era) { btn.className = "px-3 py-1 rounded-md text-sm font-medium bg-indigo-600 text-white shadow-sm transition-all"; btn.children[0].className= btn.children[0].className.replace('text-gray-400','text-white'); }
					else { btn.className = "px-3 py-1 rounded-md text-sm font-medium text-gray-400 hover:text-white transition-all"; }
				});
				this.render();
			}

			render() {
				if(document.getElementById('app-container').style.display === 'none') return;
				
				// Dashboard e Kanban (Afetados pelo Filtro)
				if(this.page === 'page-dashboard') {
					const list = this.getFilteredList(false);
					const srch = document.getElementById('searchInput').value.toLowerCase();
					const adv = document.getElementById('advogadoFilter').value;
					
					// KPIs e Kanban
					const kb = { v:[], a:[], p:[], vals:{r:0, v:0, p:0, c:0} };
					const now = new Date(); now.setHours(0,0,0,0); const mStart = new Date(now.getFullYear(), now.getMonth(), 1);
					
					list.forEach(c => {
						kb.vals.c++;
						// Filtra lista principal visual
						let show = c.clientName.toLowerCase().includes(srch);
						if(adv !== 'Todos' && c.advogadoResponsavel !== adv) show = false;
						
						// Processa Parcelas para Kanban e KPIs
						(c.parcels||[]).forEach((p, i) => {
							const due = new Date(p.dueDate);
							if(p.status === 'Pendente') {
								if(due < now) {
									const corr = this.calc.calc(p.value, p.dueDate);
									kb.vals.v += corr;
									kb.v.push({contract:c, parcel:p, index:i, diff:Math.ceil((due-now)/86400000), corr, isLate:true});
								} else if(due <= new Date(now.getTime() + 30*86400000)) {
									kb.vals.r += p.value;
									kb.a.push({contract:c, parcel:p, index:i, diff:Math.ceil((due-now)/86400000), corr:p.value, isLate:false});
								}
							} else if (p.status === 'Paga') {
								const dPay = p.paymentDate ? new Date(p.paymentDate) : null;
								if(dPay && dPay >= mStart && dPay <= now) {
									kb.vals.p += p.valuePaid;
									kb.p.push({contract:c, parcel:p, index:i, diff:0, corr:0, isLate:false});
								}
							}
						});
					});

					// Render Dashboard
					document.getElementById('dash-a-receber').textContent = Utils.formatCurrency(kb.vals.r);
					document.getElementById('dash-vencido').textContent = Utils.formatCurrency(kb.vals.v);
					document.getElementById('dash-recebido').textContent = Utils.formatCurrency(kb.vals.p);
					document.getElementById('dash-contratos').textContent = kb.vals.c;

					// Render Kanban
					['vencidas','a-vencer','pagas'].forEach((k, i) => {
						const el = document.getElementById(`kanban-${k}`); el.innerHTML = '';
						const arr = i===0 ? kb.v : (i===1 ? kb.a : kb.p);
						arr.forEach(item => el.appendChild(this.dom.createParcelCard(item)));
					});

					// Render Lista de Contratos
					const contList = document.getElementById('contractListContainer'); contList.innerHTML = '';
					const displayList = list.filter(c => (adv==='Todos'||c.advogadoResponsavel===adv) && c.clientName.toLowerCase().includes(srch));
					if(displayList.length === 0) contList.innerHTML = '<div class="text-center p-4 text-gray-500">Nenhum contrato encontrado neste filtro.</div>';
					else {
						const grid = document.createElement('div'); grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';
						displayList.slice(0, 12).forEach(c => grid.appendChild(this.dom.createContractCard(c, this.getContractStatus(c))));
						contList.appendChild(grid);
					}
				}
				
				// Parcelas Page
				if(this.page === 'page-parcelas') {
					const list = this.getFilteredList(false);
					const srch = document.getElementById('parcelasSearchInput').value.toLowerCase();
					const cont = document.getElementById('parcelasListContainer'); cont.innerHTML = '';
					list.forEach(c => {
						if(!c.clientName.toLowerCase().includes(srch)) return;
						(c.parcels||[]).forEach((p, i) => {
							if(p.status === 'Pendente') {
								const due = new Date(p.dueDate); const now = new Date(); now.setHours(0,0,0,0);
								const isLate = due < now;
								const corr = isLate ? this.calc.calc(p.value, p.dueDate) : p.value;
								cont.appendChild(this.dom.createParcelCard({contract:c, parcel:p, index:i, diff:Math.ceil((due-now)/86400000), corr, isLate}));
							}
						});
					});
					if(!cont.innerHTML) cont.innerHTML = '<div class="col-span-3 text-center p-10 text-gray-500">Nenhuma parcela pendente encontrada.</div>';
				}

				// Servi√ßos Page
				if(this.page === 'page-servicos') {
					const list = this.getFilteredList(false);
					const srch = document.getElementById('servicosSearchInput').value.toLowerCase();
					const cont = document.getElementById('servicosListContainer'); cont.innerHTML = '';
					list.forEach(c => {
						if(!c.clientName.toLowerCase().includes(srch)) return;
						if(!c.serviceTypes?.length) return;
						let done=0; c.serviceTypes.forEach(s => { if(s.status==='Conclu√≠do') done++; else if(s.status==='50% Conclu√≠do') done+=0.5; else if(s.status==='Em Andamento') done+=0.25; });
						const prog = (done/c.serviceTypes.length)*100;
						if(prog < 100) cont.appendChild(this.dom.createServicoCard(c, prog, 0)); // Prog Financeiro simplificado
					});
					if(!cont.innerHTML) cont.innerHTML = '<div class="text-center p-10 text-gray-500">Todos os servi√ßos conclu√≠dos.</div>';
				}

				// Lixeira
				if(this.page === 'page-lixeira') {
					const list = this.getFilteredList(true).filter(c => c.isDeleted);
					const cont = document.getElementById('lixeiraListContainer'); cont.innerHTML = '';
					if(!list.length) cont.innerHTML = '<div class="col-span-3 text-center text-gray-500 p-10">Lixeira vazia.</div>';
					else list.forEach(c => {
						const d = this.dom.el('div','dark-card p-4 rounded');
						d.innerHTML = `<h3 class="font-bold text-white">${c.clientName}</h3><div class="mt-2 flex gap-2"><button onclick="window.App.restore('${c.id}')" class="bg-green-600 px-3 py-1 rounded text-white text-sm">Restaurar</button>${this.isAdmin?`<button onclick="window.App.delPerm('${c.id}')" class="bg-red-600 px-3 py-1 rounded text-white text-sm">Excluir</button>`:''}</div>`;
						cont.appendChild(d);
					});
				}
			}

			// CRUD Handlers
			async handleContractSubmit(e) {
				e.preventDefault();
				const id = document.getElementById('contractId').value;
				const isSpec = document.getElementById('contratoEspecial').checked;
				const servs = Array.from(document.querySelectorAll('#servicosContainer .service-tag')).map(t => ({name:t.dataset.name, status:t.dataset.status, deadline:t.dataset.deadline}));
				
				const d = {
					clientName: document.getElementById('clienteNome').value,
					advogadoResponsavel: document.getElementById('advogadoResponsavel').value,
					serviceTypes: servs,
					paymentType: document.getElementById('contratoTipoPagamento').value,
					observations: document.getElementById('contratoObservacoes').value,
					isSpecialContract: isSpec
				};

				if(this.isAdmin) {
					d.successFee = document.getElementById('taxaExito').value;
					if(isSpec) {
						// Parcela Manual (coletada do DOM, simplificado aqui)
						const manualDivs = document.getElementById('manualParcelList').children;
						d.parcels = Array.from(manualDivs).map((div, i) => {
							const txt = div.innerText; // "R$ 1000 - Vence: ..."
							// Em produ√ß√£o ideal: usar array em mem√≥ria. Aqui simplificamos assumindo recria√ß√£o.
							// Para manter simples, assumimos que o usu√°rio preencheu e o DOMBuilder tem os dados ou usamos this.tempParcels se implementado.
							// REVIS√ÉO: Vamos usar a l√≥gica padr√£o se n√£o tivermos array.
							return { number: i+1, value: 0, dueDate: new Date().toISOString(), status:'Pendente' }; 
						});
						// OBS: Para a vers√£o final robusta, recomendo manter o array `this.manualParcels` na classe e usar aqui.
						d.parcels = this.manualParcels.map((p,i)=>({number:i+1, value:p.value, dueDate:p.dueDate, status:'Pendente', valuePaid:0}));
						d.totalValue = d.parcels.reduce((s,p)=>s+p.value,0);
					} else {
						const total = Utils.parseNumber(document.getElementById('valorTotal').value);
						const qtd = parseInt(document.getElementById('numParcelas').value)||1;
						const start = document.getElementById('vencimentoPrimeiraParcela').value;
						const paid = document.getElementById('contratoJaQuitado').checked;
						if(qtd>0 && start) {
							d.totalValue = total; d.parcels = [];
							let dt = new Date(start+"T12:00:00Z");
							const val = total/qtd;
							for(let i=0; i<qtd; i++) {
								d.parcels.push({number:i+1, value:val, dueDate:dt.toISOString(), status:paid?'Paga':'Pendente', valuePaid:paid?val:0, paymentDate:paid?new Date().toISOString():null});
								dt.setMonth(dt.getMonth()+1);
							}
						}
					}
				}

				if(id) { await this.srv.updC(id, d); }
				else { d.createdAt = new Date().toISOString(); d.isDeleted = false; await this.srv.addC(d); }
				this.closeModal('modalContrato');
			}

			async handlePaymentSubmit(e) {
				e.preventDefault();
				const id = document.getElementById('pagamentoContractId').value, idx = document.getElementById('pagamentoParcelIndex').value;
				const c = this.db.contracts.find(x=>x.id===id);
				if(!c) return;
				const p = [...c.parcels];
				p[idx].status = 'Paga';
				p[idx].valuePaid = Utils.parseNumber(document.getElementById('pagamentoValor').value);
				p[idx].paymentDate = new Date(document.getElementById('pagamentoData').value+"T12:00:00Z").toISOString();
				await this.srv.updC(id, {parcels:p});
				this.closeModal('modalPagamento');
			}

			async handleExitoSubmit(e) {
				e.preventDefault();
				const id = document.getElementById('exitoContractId').value;
				await this.srv.updC(id, {
					successFeeValueReceived: Utils.parseNumber(document.getElementById('exitoValorRecebido').value),
					successFeePaymentDate: new Date().toISOString()
				});
				this.closeModal('modalExito');
			}

			// Report Logic
			generateAndShowReport() {
				if(!this.isAdmin) return;
				const m = parseInt(document.getElementById('reportMonth').value), y = parseInt(document.getElementById('reportYear').value);
				const start = new Date(y, m, 1), end = new Date(y, m+1, 0, 23, 59, 59);
				
				// Usa o filtro atual (getFilteredList) para respeitar a Era
				const res = this.rep.calcRange(start, end, this.getFilteredList(true));
				
				const r = document.getElementById('reportResult');
				r.innerHTML = `
					<div class="grid grid-cols-2 gap-4 mb-4">
						<div class="bg-gray-700 p-3 rounded text-center"><div class="text-xs text-gray-400">Recebido (Parcelas)</div><div class="text-xl font-bold text-white">${Utils.formatCurrency(res.tp)}</div></div>
						<div class="bg-gray-700 p-3 rounded text-center"><div class="text-xs text-gray-400">Recebido (√äxito)</div><div class="text-xl font-bold text-indigo-400">${Utils.formatCurrency(res.te)}</div></div>
					</div>
					<div class="space-y-2">
						<h4 class="font-bold text-white border-b border-gray-600 pb-1">Entradas</h4>
						${res.dets.length ? res.dets.map(d=>`<div class="flex justify-between text-sm bg-gray-800 p-2 rounded"><span>${d.c} (${d.t})</span><span class="text-green-400">${Utils.formatCurrency(d.v)}</span></div>`).join('') : '<div class="text-gray-500 text-xs">Nenhum.</div>'}
						
						<h4 class="font-bold text-red-300 border-b border-gray-600 pb-1 mt-4">Inadimplentes (Vencimento no M√™s)</h4>
						${res.notPaid.length ? res.notPaid.map(d=>`<div class="flex justify-between text-sm bg-red-900/20 p-2 rounded items-center"><div><div class="text-white">${d.c}</div><div class="text-[10px] text-gray-400">Venc: ${Utils.formatDate(d.due)}</div></div><div class="text-right"><div class="text-red-400 font-bold">${Utils.formatCurrency(d.v)}</div><div class="text-[10px] text-gray-500">${d.a}</div></div></div>`).join('') : '<div class="text-green-500 text-xs">Todos pagaram!</div>'}
					</div>
				`;
			}

			// Utils de Estado e Navega√ß√£o
			renderNotifs() {
				const l=document.getElementById('notification-list'), b=document.getElementById('notification-badge');
				l.innerHTML=''; const u=this.db.notifications.filter(n=>!n.isRead);
				b.classList.toggle('hidden', u.length===0);
				if(!this.db.notifications.length) document.getElementById('notification-list-empty').classList.remove('hidden');
				else {
					document.getElementById('notification-list-empty').classList.add('hidden');
					this.db.notifications.forEach(n=>l.appendChild(this.dom.createNotificationItem(n)));
				}
			}
			renderOficina() { this.dom.renderSettings(this.db.settings.advogados?.list||[]); }
			renderFilters() { this.dom.renderAdvOptions(this.db.settings.advogados?.list||[], this.user, this.isAdmin); }
			
			showPage(id) {
				document.querySelectorAll('[id^="page-"]').forEach(p=>p.classList.add('hidden'));
				document.getElementById(id).classList.remove('hidden');
				document.querySelectorAll('.sidebar-nav-item, .mobile-nav-item').forEach(b=>b.classList.remove('active'));
				const base = id.replace('page-','');
				document.getElementById('tab-'+base)?.classList.add('active');
				document.getElementById('mobile-tab-'+base)?.classList.add('active');
				this.page = id; this.render();
			}
			
			getContractStatus(c) {
				const paid = (c.parcels||[]).every(p=>p.status==='Paga');
				const done = (c.serviceTypes||[]).every(s=>s.status==='Conclu√≠do');
				if(paid && done) return {statusText:'Conclu√≠do', statusColor:'bg-gray-600 text-gray-300', borderColor:'border-gray-500'};
				if(paid && !done) return {statusText:'Em Andamento', statusColor:'bg-blue-900 text-blue-300', borderColor:'border-blue-500'};
				return {statusText:'Ativo', statusColor:'bg-yellow-900 text-yellow-300', borderColor:'border-yellow-500'};
			}

			// Modais e Helpers
			openModal(id) { this.openModalId=id; document.getElementById('modal-backdrop').style.display='block'; document.getElementById(id).style.display='block'; }
			closeModal(id) { if(!id)return; document.getElementById(id).style.display='none'; this.openModalId=null; if(!document.querySelector('.modal[style*="block"]')) document.getElementById('modal-backdrop').style.display='none'; }
			
			// [FIX] M√©todos P√∫blicos para onclick no HTML
			openContractModal(id) { 
				document.getElementById('formContrato').reset(); 
				document.getElementById('servicosContainer').innerHTML='';
				this.manualParcels = []; document.getElementById('manualParcelList').innerHTML='';
				if(id) {
					const c = this.db.contracts.find(x=>x.id===id);
					document.getElementById('contractId').value=c.id;
					document.getElementById('clienteNome').value=c.clientName;
					document.getElementById('advogadoResponsavel').value=c.advogadoResponsavel;
					(c.serviceTypes||[]).forEach(s=>this.createServiceTag(s.name,s.deadline));
					if(this.isAdmin && c.isSpecialContract) {
						document.getElementById('contratoEspecial').checked=true;
						document.getElementById('financial-fields-standard').style.display='none';
						document.getElementById('financial-fields-special').style.display='block';
						// Recupera parcelas para edi√ß√£o manual visual
						this.manualParcels = (c.parcels||[]).map(p=>({value:p.value, dueDate:p.dueDate.split('T')[0]}));
						this.manualParcels.forEach((p,i)=>document.getElementById('manualParcelList').appendChild(this.dom.createManualParcelListItem(p.value,p.dueDate,i)));
					}
				} else { document.getElementById('contractId').value=''; }
				this.openModal('modalContrato'); 
			}
			openPaymentModal(id, idx) { 
				const c=this.db.contracts.find(x=>x.id===id); 
				document.getElementById('pagamentoContractId').value=id; 
				document.getElementById('pagamentoParcelIndex').value=idx; 
				document.getElementById('pagamentoValor').value=c.parcels[idx].value; 
				document.getElementById('pagamentoData').value=new Date().toISOString().split('T')[0];
				document.getElementById('pagamentoInfo').textContent=`${c.clientName} - Parcela ${idx+1}`;
				this.openModal('modalPagamento'); 
			}
			openClientHistoryModal(name) {
				const title = document.getElementById('clienteModalTitle');
				const content = document.getElementById('clienteModalContent');
				title.textContent = `Hist√≥rico: ${name}`;
				content.innerHTML = '';
				
				const contracts = this.getFilteredList(true).filter(c => c.clientName === name);
				if(contracts.length === 0) content.innerHTML = '<p class="text-center text-gray-500">Nenhum hist√≥rico encontrado.</p>';
				
				contracts.forEach(c => {
					const div = document.createElement('div');
					div.className = `bg-gray-700 p-4 rounded border-l-4 ${c.isDeleted?'border-red-500 opacity-60':'border-indigo-500'}`;
					let html = `<div class="flex justify-between"><h4 class="font-bold text-white">${(c.serviceTypes||[]).map(s=>s.name).join(', ')}</h4><span class="text-xs text-gray-400">${Utils.formatDate(c.createdAt)}</span></div>`;
					html += `<p class="text-sm text-gray-300">Obs: ${c.observations || 'Nenhuma'}</p>`;
					html += `<ul class="mt-2 text-sm space-y-1">`;
					(c.parcels||[]).forEach(p => {
						html += `<li class="flex justify-between"><span>P${p.number} - ${Utils.formatDate(p.dueDate)}</span><span class="${p.status==='Paga'?'text-green-400':'text-red-400'}">${p.status} (${Utils.formatCurrency(p.value)})</span></li>`;
					});
					html += `</ul>`;
					div.innerHTML = html;
					content.appendChild(div);
				});
				this.openModal('modalCliente');
			}
			openReportModal() { 
				const m=document.getElementById('reportMonth'), y=document.getElementById('reportYear');
				if(!m.options.length) { ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"].forEach((x,i)=>m.add(new Option(x,i))); const n=new Date().getFullYear(); for(let i=n;i>=n-5;i--) y.add(new Option(i,i)); m.value=new Date().getMonth(); }
				this.openModal('modalRelatorio'); 
			}
			openExitoModal(id) { document.getElementById('exitoContractId').value=id; this.openModal('modalExito'); }
			
			addManualParcel() {
				const v=Utils.parseNumber(document.getElementById('parcelaValorManual').value), d=document.getElementById('parcelaVencimentoManual').value;
				if(v>0 && d) {
					this.manualParcels.push({value:v, dueDate:d});
					const div = document.getElementById('manualParcelList');
					div.appendChild(this.dom.createManualParcelListItem(v,d,this.manualParcels.length-1));
				}
			}
			removeManualParcel(idx) {
				this.manualParcels.splice(idx, 1);
				const div = document.getElementById('manualParcelList'); div.innerHTML='';
				this.manualParcels.forEach((p,i)=>div.appendChild(this.dom.createManualParcelListItem(p.value,p.dueDate,i)));
			}
			createServiceTag(n,d) { 
				const t=document.createElement('div'); t.className='service-tag'; t.dataset.name=n; t.dataset.status='Pendente'; t.dataset.deadline=d||'';
				t.innerHTML=`<span>${n}</span><span class="remove-tag text-red-400 ml-2 cursor-pointer">&times;</span>`;
				t.querySelector('.remove-tag').onclick=()=>t.remove();
				document.getElementById('servicosContainer').appendChild(t); 
			}
			
			exportContractsCSV() { 
				const h = ["ID","Cliente","Advogado","Total","Data","Status"];
				const r = [h.join(',')];
				this.getFilteredList(false).forEach(c => r.push([c.id, c.clientName, c.advogadoResponsavel, c.totalValue, c.createdAt, this.getContractStatus(c).statusText].join(',')));
				const b = new Blob(["\uFEFF"+r.join('\n')],{type:'text/csv;charset=utf-8;'});
				const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='contratos.csv'; a.click();
			}
			exportReportCSV() { /* Simplificado: Reusa l√≥gica se necess√°rio */ }
			
			restore(id) { if(confirm('Restaurar?')) this.srv.updC(id, {isDeleted:false}); }
			delPerm(id) { if(confirm('Excluir PERMANENTEMENTE?')) this.srv.delC(id); }
		}

		document.addEventListener('DOMContentLoaded', () => {
			window.App = new App();
			window.App.initialize();
		});
	</script>
</body>
</html>		
