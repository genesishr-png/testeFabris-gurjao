<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sistema Financeiro Jur√≠dico</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
	<style>
		body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #d1d5db; overflow-y: hidden; }
		body::after { content: ''; position: fixed; z-index: -2; top: 0; left: 0; right: 0; bottom: 0; background-image: url('https://i.postimg.cc/x81V8QJg/Imagem-do-Whats-App-de-2025-10-27-a-s-09-49-28-f966cd35.jpg'); background-repeat: no-repeat; background-size: cover; background-position: center; opacity: 0.12; }
		.modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9000; }
		.modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9001; max-height: 90vh; border: 1px solid #374151; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
		.modal-body { overflow-y: auto; max-height: 70vh; }
		.kanban-column { min-width: 320px; }
		.kanban-content { max-height: 60vh; overflow-y: auto; padding-right: 8px; }
		::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
		.service-tag { display: inline-flex; justify-content: space-between; align-items: center; background: #374151; padding: 4px 10px; border-radius: 12px; font-size: 14px; margin: 0 4px 4px 0; }
		.service-tag-small { display: inline-block; background: #374151; color: #9ca3af; padding: 2px 8px; border-radius: 9999px; font-size: 12px; margin: 0 4px 4px 0; }
		.sidebar-nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #d1d5db; transition: all 0.2s; cursor: pointer; }
		.sidebar-nav-item:hover, .sidebar-nav-item.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 14px rgba(79, 70, 229, 0.4); }
		.mobile-nav-item { display: flex; flex-direction: column; align-items: center; padding: 0.75rem 0.5rem; color: #9ca3af; }
		.mobile-nav-item.active { color: #6366f1; background: rgba(79, 70, 229, 0.1); }
		.dark-card { background-color: #1f2937; }
		.filter-select { background: #1f2937; border: 1px solid #4b5563; color: #9ca3af; padding: 8px 12px; border-radius: 6px; color-scheme: dark; }
		.sort-button { background: #374151; border: 1px solid #4b5563; padding: 4px 10px; border-radius: 6px; font-size: 12px; }
		.sort-button.active { background: #4f46e5; color: white; border-color: #4f46e5; }
		#loading-overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.9); display: flex; justify-content: center; align-items: center; z-index: 10000; color: white; transition: opacity 0.3s; }
		#app-container, .admin-only { display: none; }
		body.is-admin .admin-only:not(.hidden) { display: block; }
		body.is-admin .flex.admin-only:not(.hidden) { display: flex; }
		.notification-item { background: #374151; padding: 12px; border-radius: 8px; border-left: 4px solid #4f46e5; cursor: pointer; margin-bottom: 8px; }
		.notification-item.is-read { background: #1f2937; border-left-color: #4b5563; opacity: 0.7; }
		.ranking-table { width: 100%; border-collapse: collapse; }
		.ranking-table th, .ranking-table td { padding: 12px 16px; border-bottom: 1px solid #374151; text-align: left; }
		.ranking-table th { background: #374151; color: #d1d5db; }
		.ranking-table .rank-1 { color: #34d399; font-weight: 700; }
		.ranking-table .rank-2 { color: #60a5fa; font-weight: 600; }
		.ranking-table .rank-3 { color: #f59e0b; font-weight: 500; }
		.parcel-card-vencida { border-left-color: #ef4444; } .parcel-card-vencida .parcel-value { color: #f87171; }
		.parcel-card-avencer { border-left-color: #f59e0b; } .parcel-card-avencer .parcel-value { color: #fbbf24; }
		.setting-list-item { display: flex; justify-content: space-between; padding: 8px; background: #374151; margin-bottom: 4px; border-radius: 6px; }
		.parcel-list-item { display: flex; justify-content: space-between; padding: 6px; background: #374151; margin-bottom: 4px; border-radius: 6px; font-size: 13px; }
		
		/* [NOVO] Estilo Bonito para o Select de Data */
		.pretty-select-wrapper { position: relative; display: inline-block; }
		.pretty-select {
			appearance: none;
			background-color: rgba(31, 41, 55, 0.8); /* gray-800 com transpar√™ncia */
			border: 1px solid #6366f1; /* indigo-500 */
			color: #e0e7ff; /* indigo-100 */
			padding: 8px 36px 8px 16px;
			border-radius: 9999px;
			font-size: 0.875rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
			backdrop-filter: blur(4px);
		}
		.pretty-select:hover { background-color: rgba(55, 65, 81, 0.9); border-color: #818cf8; box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }
		.pretty-select:focus { outline: none; ring: 2px solid #a5b4fc; }
		.select-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #818cf8; }

		@keyframes blob { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } }
		.animate-blob { animation: blob 7s infinite; }
	</style>
</head>
<body class="text-gray-300">
	<div id="notifications"></div>
	<div id="loading-overlay"><i class="fas fa-spinner fa-spin mr-3"></i> A carregar...</div>

	<div id="auth-overlay" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 relative overflow-hidden px-4">
		<div class="absolute inset-0 opacity-5"><div class="absolute inset-0 bg-[url('https://i.postimg.cc/x81V8QJg/Imagem-do-Whats-App-de-2025-10-27-a-s-09-49-28-f966cd35.jpg')] bg-cover bg-center"></div></div>
		<div class="absolute top-0 left-1/2 -translate-x-1/2 w-96 h-96 bg-blue-500 rounded-full mix-blend-screen filter blur-3xl opacity-10 animate-blob"></div>
		<div class="absolute bottom-0 right-1/4 w-96 h-96 bg-indigo-500 rounded-full mix-blend-screen filter blur-3xl opacity-10 animate-blob" style="animation-delay: 2s;"></div>
		<div class="relative z-10 w-full max-w-md">
			<div class="mb-8 text-center">
				<img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Logo" class="h-24 mx-auto mb-6 drop-shadow-lg" />
				<h1 class="text-3xl font-bold text-white mb-2">Sistema Financeiro</h1>
			</div>
			<div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-8 shadow-2xl">
				<form id="login-form" class="space-y-5">
					<div><label class="block text-sm font-medium text-gray-100 mb-2">Email</label><input type="email" id="login-email" placeholder="seu@email.com" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-blue-500 transition" required /></div>
					<div><label class="block text-sm font-medium text-gray-100 mb-2">Senha</label><input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-blue-500 transition" required /></div>
					<div id="auth-error" class="hidden p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200 text-sm"></div>
					<button type="submit" id="login-submit-button" class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold rounded-lg hover:shadow-lg transition mt-6">Entrar</button>
				</form>
			</div>
		</div>
	</div>
	<div id="app-container" class="flex h-screen">
		<aside id="sidebar" class="hidden md:flex md:flex-col md:w-64 bg-gray-900/50 backdrop-blur-lg border-r border-gray-700/50 p-4 z-20 transition-all">
			<div class="mb-8"><img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" class="h-20 mx-auto opacity-90" /></div>
			<nav class="flex-1 space-y-2">
				<a onclick="window.App.showPage('page-dashboard')" id="tab-dashboard" class="sidebar-nav-item active"><i class="fas fa-tachometer-alt w-5 text-center"></i><span>Painel</span></a>
				<a onclick="window.App.showPage('page-parcelas')" id="tab-parcelas" class="sidebar-nav-item"><i class="fas fa-file-invoice-dollar w-5 text-center"></i><span>Parcelas</span></a>
				<a onclick="window.App.showPage('page-servicos')" id="tab-servicos" class="sidebar-nav-item"><i class="fas fa-tasks w-5 text-center"></i><span>Servi√ßos</span></a>
				<a onclick="window.App.showPage('page-performance')" id="tab-performance" class="sidebar-nav-item admin-only"><i class="fas fa-rocket w-5 text-center"></i><span>Performance</span></a>
				<a onclick="window.App.showPage('page-relatorios')" id="tab-relatorios" class="sidebar-nav-item admin-only"><i class="fas fa-chart-pie w-5 text-center"></i><span>Relat√≥rios</span></a>
				<a onclick="window.App.showPage('page-lixeira')" id="tab-lixeira" class="sidebar-nav-item"><i class="fas fa-trash-alt w-5 text-center"></i><span>Lixeira</span></a>
				<div class="border-t border-gray-700 pt-2 mt-2 admin-only">
					<a onclick="window.App.showPage('page-oficina')" id="tab-oficina" class="sidebar-nav-item"><i class="fas fa-cogs w-5 text-center"></i><span>Oficina</span></a>
				</div>
			</nav>
			<div class="mt-auto border-t border-gray-700 pt-4 flex items-center gap-3 p-2">
				<div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center font-bold text-white"><i class="fas fa-user"></i></div>
				<div><span id="user-display-name" class="text-sm text-gray-200 font-medium block"></span><button id="logout-button" class="text-xs text-red-400 hover:text-red-300">Sair</button></div>
			</div>
		</aside>

		<main id="main-content" class="flex-1 flex flex-col h-screen overflow-y-auto pb-24 md:pb-0">
			<header class="sticky top-0 bg-gray-900/30 backdrop-blur-md border-b border-gray-700/50 p-4 z-10 flex justify-between items-center">
				<h1 id="page-title" class="text-2xl font-bold text-white">Painel Principal</h1>
				<div class="flex items-center gap-4">
					
					<div class="pretty-select-wrapper">
						<select id="globalDateFilter" class="pretty-select">
							<option value="novos">‚ú® Atuais (Novos)</option>
							<option value="legado">üìú Legado (Antigos)</option>
						</select>
						<i class="fas fa-calendar-check select-icon"></i>
					</div>

					<div class="relative">
						<button id="notification-bell" class="p-2 text-gray-300 hover:text-white"><i class="fas fa-bell text-xl"></i><span id="notification-badge" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full"></span></button>
						<div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-xl overflow-hidden z-50">
							<div class="flex justify-between p-3 border-b border-gray-700"><h3 class="font-semibold text-white">Notifica√ß√µes</h3><button id="clear-notifications-button" class="text-xs text-indigo-400">Limpar</button></div>
							<div id="notification-list" class="max-h-64 overflow-y-auto p-2">
								<div id="notification-list-empty" class="hidden text-center p-4 text-gray-500">Nada novo.</div>
							</div>
						</div>
					</div>
					<button id="mobile-menu-toggle" class="md:hidden text-white text-xl"><i class="fas fa-bars"></i></button>
				</div>
			</header>

			<div class="p-4 md:p-8 flex-1">
				<div id="page-dashboard">
					<div class="flex flex-wrap gap-4 mb-8">
						<button onclick="window.App.openContractModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-lg flex items-center gap-2"><i class="fas fa-plus-circle"></i> Novo Contrato</button>
						<button onclick="window.App.openReportModal()" class="admin-only bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-5 rounded-lg shadow-lg flex items-center gap-2"><i class="fas fa-chart-line"></i> Relat√≥rio Mensal</button>
					</div>

					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
						<div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-gray-400 font-semibold">A Receber (30d)</h3><p id="dash-a-receber" class="text-3xl font-bold text-green-400"></p></div>
						<div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-gray-400 font-semibold">Vencido (Corrigido)</h3><p id="dash-vencido" class="text-3xl font-bold text-red-400"></p></div>
						<div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-gray-400 font-semibold">Recebido (M√™s)</h3><p id="dash-recebido" class="text-3xl font-bold text-indigo-400"></p></div>
						<div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-gray-400 font-semibold">Contratos Ativos</h3><p id="dash-contratos" class="text-3xl font-bold text-white"></p></div>
					</div>

					<div class="mb-4 border-b border-gray-700"><h2 class="text-xl font-semibold text-white mb-2">Situa√ß√£o Financeira</h2></div>
					<div class="grid grid-cols-1 md:grid-cols-3 gap-6 pb-4">
						<div class="kanban-column dark-card rounded-lg p-4"><h3 class="text-red-400 font-bold mb-4"><i class="fas fa-exclamation-triangle"></i> Vencidas</h3><div id="kanban-vencidas" class="kanban-content space-y-3"></div></div>
						<div class="kanban-column dark-card rounded-lg p-4"><h3 class="text-yellow-400 font-bold mb-4"><i class="far fa-clock"></i> A Vencer (30d)</h3><div id="kanban-a-vencer" class="kanban-content space-y-3"></div></div>
						<div class="kanban-column dark-card rounded-lg p-4"><h3 class="text-gray-400 font-bold mb-4"><i class="fas fa-check-circle"></i> Pagas (M√™s)</h3><div id="kanban-pagas" class="kanban-content space-y-3"></div></div>
					</div>

					<div id="exito-section" class="mt-8 hidden">
						<div class="mb-4 border-b border-gray-700"><h2 class="text-xl font-semibold text-white">√äxitos Pendentes</h2></div>
						<div id="kanban-exito-wrapper" class="flex overflow-x-auto space-x-6 pb-4"></div>
					</div>

					<div class="mt-12">
						<div class="flex flex-wrap justify-between items-center mb-4 border-b border-gray-700 pb-2">
							<h2 class="text-xl font-semibold text-white">Lista de Contratos</h2>
							<div class="flex gap-4 items-center">
								<button onclick="window.App.exportContractsCSV()" class="text-green-400 text-sm hover:underline"><i class="fas fa-file-csv"></i> CSV</button>
								<select id="advogadoFilter" onchange="window.App.resetAndRenderContractList()" class="filter-select admin-only"></select>
								<div id="contractStatusFilterButtons" class="flex gap-1"></div>
								<div id="contractSortButtons" class="flex gap-1"></div>
							</div>
						</div>
						<input type="text" id="searchInput" placeholder="Pesquisar..." class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white mb-4">
						<div id="contractListContainer"></div>
						<div id="paginationContainer" class="flex justify-center gap-2 mt-8"></div>
					</div>
				</div>
				</div> <div id="page-parcelas" class="hidden">
					<div class="flex justify-between items-center mb-4 flex-wrap gap-4">
						<h2 class="text-xl font-semibold text-white">Controle de Parcelas</h2>
						<div class="flex gap-4 items-center flex-wrap">
							<input type="text" id="parcelasSearchInput" placeholder="Pesquisar cliente..." class="bg-gray-900 border border-gray-700 p-2 rounded text-white">
							<div class="flex items-center gap-2"><span class="text-xs text-gray-500">Ordenar:</span><div id="parcelasSortButtons" class="flex gap-1"></div></div>
						</div>
					</div>
					<div id="parcelasListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
				</div>

				<div id="page-servicos" class="hidden">
					<div class="flex justify-between items-center mb-4 flex-wrap gap-4">
						<h2 class="text-xl font-semibold text-white">Produ√ß√£o de Servi√ßos</h2>
						<div class="flex gap-4 items-center flex-wrap">
							<select id="servicosAdvogadoFilter" onchange="window.App.renderServicosPage()" class="filter-select admin-only"></select>
							<div class="flex items-center gap-2"><span class="text-xs text-gray-500">Ordenar:</span><div id="servicosSortButtons" class="flex gap-1"></div></div>
							<input type="text" id="servicosSearchInput" placeholder="Pesquisar..." class="bg-gray-900 border border-gray-700 p-2 rounded text-white">
						</div>
					</div>
					<div id="servicosListContainer" class="space-y-6"></div>
				</div>

				<div id="page-performance" class="hidden admin-only">
					<div class="mb-6 border-b border-gray-700 pb-2"><h2 class="text-xl font-semibold text-white">Performance</h2></div>
					<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
						<div class="space-y-6">
							<div class="dark-card p-4 rounded-lg shadow"><h3 class="text-gray-300 font-bold mb-4">Contratos Ativos</h3><div class="h-64"><canvas id="adminChartContratos"></canvas></div></div>
							<div class="dark-card p-4 rounded-lg shadow"><h3 class="text-gray-300 font-bold mb-4">Fatura√ß√£o (Ano)</h3><div class="h-64"><canvas id="adminChartFaturamento"></canvas></div></div>
						</div>
						<div class="space-y-6">
							<div class="dark-card p-4 rounded-lg shadow"><h3 class="text-gray-300 font-bold mb-4">Ranking Financeiro</h3><table class="ranking-table" id="adminTableFaturamento"><thead><tr><th>#</th><th>Nome</th><th>Valor</th></tr></thead><tbody></tbody></table></div>
							<div class="dark-card p-4 rounded-lg shadow"><h3 class="text-gray-300 font-bold mb-4">Ranking Contratos</h3><table class="ranking-table" id="adminTableContratos"><thead><tr><th>#</th><th>Nome</th><th>Qtd</th></tr></thead><tbody></tbody></table></div>
						</div>
					</div>
				</div>

				<div id="page-relatorios" class="hidden admin-only">
					<div class="flex flex-wrap justify-between items-center mb-6 gap-4 border-b border-gray-700 pb-4">
						<h2 class="text-2xl font-semibold text-white">Relat√≥rios Avan√ßados</h2>
						<div class="flex flex-wrap items-center gap-4">
							<input type="date" id="reportStartDate" class="filter-select">
							<span class="text-gray-500">at√©</span>
							<input type="date" id="reportEndDate" class="filter-select">
							<button onclick="window.App.generateAdvancedReport()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow"><i class="fas fa-sync-alt"></i> Gerar</button>
							<button id="exportPdfButton" onclick="window.App.exportReportPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow" disabled><i class="fas fa-file-pdf"></i> PDF</button>
						</div>
					</div>
					<div id="advancedReportContainer" class="space-y-8">
						<div id="report-kpis" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
						<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
							<div class="dark-card p-4 rounded-lg"><h3 class="text-gray-300 mb-2">Linha do Tempo</h3><div class="h-64"><canvas id="advReportTimelineChart"></canvas></div></div>
							<div class="dark-card p-4 rounded-lg"><h3 class="text-gray-300 mb-2">Novos Contratos</h3><div class="h-64"><canvas id="advReportNewContractsChart"></canvas></div></div>
						</div>
						<div class="dark-card p-4 rounded-lg"><h3 class="text-gray-300 mb-2">Por Advogado</h3><div class="h-64 max-w-lg mx-auto"><canvas id="advReportByAdvogadoChart"></canvas></div></div>
					</div>
					<div id="advancedReportEmpty" class="hidden text-center py-10 text-gray-500"><i class="fas fa-chart-pie fa-3x mb-2"></i><p>Selecione as datas para gerar.</p></div>
				</div>

				<div id="page-lixeira" class="hidden">
					<h2 class="text-xl font-semibold text-white mb-4">Lixeira</h2>
					<div id="lixeiraListContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
				</div>

				<div id="page-oficina" class="hidden admin-only">
					<h2 class="text-xl font-semibold text-white mb-4">Oficina de Configura√ß√µes</h2>
					<div class="dark-card p-6 rounded-lg max-w-lg">
						<h3 class="font-bold text-indigo-400 mb-4"><i class="fas fa-users-cog"></i> Advogados</h3>
						<form id="formAddAdvogado" class="flex gap-2 mb-4">
							<input type="text" id="inputAdvogadoName" placeholder="Nome..." class="form-input" required>
							<button type="submit" class="form-button">Add</button>
						</form>
						<div id="advogadoSettingsList" class="max-h-60 overflow-y-auto space-y-1"></div>
					</div>
				</div>

			</div>
		</main>

		<nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-900/90 backdrop-blur border-t border-gray-700 flex justify-around z-30">
			<a onclick="window.App.showPage('page-dashboard')" id="mobile-tab-dashboard" class="mobile-nav-item active"><i class="fas fa-tachometer-alt"></i><span class="text-[10px]">Painel</span></a>
			<a onclick="window.App.showPage('page-parcelas')" id="mobile-tab-parcelas" class="mobile-nav-item"><i class="fas fa-file-invoice-dollar"></i><span class="text-[10px]">Parcelas</span></a>
			<a onclick="window.App.showPage('page-servicos')" id="mobile-tab-servicos" class="mobile-nav-item"><i class="fas fa-tasks"></i><span class="text-[10px]">Servi√ßos</span></a>
			<a onclick="window.App.showPage('page-relatorios')" id="mobile-tab-relatorios" class="mobile-nav-item admin-only"><i class="fas fa-chart-pie"></i><span class="text-[10px]">Relat.</span></a>
		</nav>
	</div>

	<div id="modalDisplayName" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3">
		<div class="p-4 border-b border-gray-700"><h2 class="text-xl font-bold text-white">Bem-vindo(a)!</h2></div>
		<div class="p-6">
			<form id="formDisplayName">
				<label class="block text-sm text-gray-400 mb-1">Seu Nome</label>
				<input type="text" id="inputDisplayName" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white mb-4" required>
				<button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 rounded">Salvar</button>
			</form>
		</div>
	</div>

	<div id="modalContrato" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/2 flex flex-col">
		<div class="p-4 border-b border-gray-700 flex justify-between items-center"><h2 id="modalContratoTitle" class="text-xl font-bold text-white">Novo Contrato</h2><button onclick="window.App.closeModal('modalContrato')" class="text-gray-400 hover:text-white">&times;</button></div>
		<form id="formContrato" class="flex flex-col flex-1 overflow-hidden">
			<div class="p-6 overflow-y-auto modal-body space-y-4">
				<input type="hidden" id="contractId"><input type="hidden" id="financialDataChanged" value="false">
				<div class="grid grid-cols-2 gap-4">
					<div><label class="text-sm text-gray-400">Cliente</label><input type="text" id="clienteNome" class="form-input" required></div>
					<div><label class="text-sm text-gray-400">Advogado</label><select id="advogadoResponsavel" class="form-input" required></select></div>
				</div>
				<div class="bg-gray-900/50 p-3 rounded border border-gray-700">
					<label class="text-sm text-gray-400">Servi√ßos</label>
					<div id="servicosContainer" class="flex flex-wrap gap-2 mb-2"></div>
					<div class="flex gap-2">
						<input type="text" id="contratoServicoInput" class="form-input flex-1" placeholder="Nome servi√ßo...">
						<input type="date" id="contratoPrazoInput" class="form-input w-32">
						<button type="button" id="addServiceButton" class="bg-indigo-600 px-3 rounded text-white text-sm">Add</button>
					</div>
				</div>
				<div><label class="text-sm text-gray-400">Pagamento</label><select id="contratoTipoPagamento" class="form-input"><option>Parcelado</option><option>Pr√≥-labore</option><option>Entrada √∫nica</option></select></div>
				<div><label class="text-sm text-gray-400">Obs</label><textarea id="contratoObservacoes" rows="2" class="form-input"></textarea></div>
				
				<div class="admin-only border-t border-gray-700 pt-4">
					<div id="financial-warning" class="hidden text-yellow-400 text-xs mb-2"><i class="fas fa-exclamation-triangle"></i> Financeiro bloqueado (j√° possui pagamentos).</div>
					<div class="flex items-center mb-2"><input type="checkbox" id="contratoEspecial" class="mr-2"><label for="contratoEspecial" class="text-sm text-gray-300">Modo Manual (Datas Variadas)</label></div>
					
					<div id="financial-fields-standard" class="space-y-3">
						<div class="flex items-center mb-2"><input type="checkbox" id="contratoJaQuitado" class="mr-2"><label for="contratoJaQuitado" class="text-sm text-gray-300">J√° Quitado</label></div>
						<div class="grid grid-cols-2 gap-4">
							<div><label class="text-xs text-gray-400">Valor Total</label><input type="number" step="0.01" id="valorTotal" class="form-input"></div>
							<div><label class="text-xs text-gray-400">Qtd Parcelas</label><input type="number" id="numParcelas" value="1" class="form-input"></div>
						</div>
						<div><label class="text-xs text-gray-400">1¬∫ Vencimento</label><input type="date" id="vencimentoPrimeiraParcela" class="form-input"></div>
					</div>

					<div id="financial-fields-special" class="hidden space-y-2">
						<div class="flex gap-2">
							<input type="number" id="parcelaValorManual" placeholder="Valor" class="form-input">
							<input type="date" id="parcelaVencimentoManual" class="form-input">
							<button type="button" id="addManualParcelButton" class="bg-indigo-600 px-3 rounded text-white text-sm">Add</button>
						</div>
						<div id="manualParcelList" class="max-h-32 overflow-y-auto"></div>
					</div>
					<div class="mt-2"><label class="text-xs text-gray-400">√äxito</label><input type="text" id="taxaExito" class="form-input"></div>
				</div>
			</div>
			<div class="p-4 border-t border-gray-700 flex justify-end gap-2">
				<button type="button" onclick="window.App.closeModal('modalContrato')" class="bg-gray-600 text-white px-4 py-2 rounded">Cancelar</button>
				<button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Salvar</button>
			</div>
		</form>
	</div>
	<div id="modalPagamento" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3">
		<div class="p-4 border-b border-gray-700 flex justify-between items-center"><h2 class="text-xl font-bold text-white">Registar Pagamento</h2><button onclick="window.App.closeModal('modalPagamento')" class="text-gray-400 hover:text-white">&times;</button></div>
		<form id="formPagamento">
			<div class="p-6 space-y-4 modal-body">
				<div id="pagamentoInfo" class="mb-4 bg-gray-700 p-3 rounded text-sm text-gray-300"></div>
				<div><label class="text-sm text-gray-400">Valor Pago (R$)</label><input type="number" step="0.01" id="pagamentoValor" class="form-input" required></div>
				<div><label class="text-sm text-gray-400">Data Pagamento</label><input type="date" id="pagamentoData" class="form-input" required></div>
				<input type="hidden" id="pagamentoContractId"><input type="hidden" id="pagamentoParcelIndex">
			</div>
			<div class="p-4 border-t border-gray-700 flex justify-end gap-2">
				<button type="button" onclick="window.App.closeModal('modalPagamento')" class="bg-gray-600 text-white px-4 py-2 rounded">Cancelar</button>
				<button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Confirmar</button>
			</div>
		</form>
	</div>

	<div id="modalCliente" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-2/3 flex flex-col">
		<div class="p-4 border-b border-gray-700 flex justify-between items-center"><h2 id="clienteModalTitle" class="text-xl font-bold text-white"></h2><button onclick="window.App.closeModal('modalCliente')" class="text-gray-400 hover:text-white">&times;</button></div>
		<div id="clienteModalContent" class="p-6 overflow-y-auto modal-body space-y-4"></div>
	</div>

	<div id="modalRelatorio" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-2/3 admin-only flex flex-col">
		<div class="p-4 border-b border-gray-700 flex justify-between items-center"><h2 class="text-xl font-bold text-white">Relat√≥rio Mensal</h2><button onclick="window.App.closeModal('modalRelatorio')" class="text-gray-400 hover:text-white">&times;</button></div>
		<div class="p-6 overflow-y-auto modal-body">
			<div class="flex gap-4 mb-4">
				<div class="flex-1"><label class="text-sm text-gray-400">M√™s</label><select id="reportMonth" class="form-input"></select></div>
				<div class="flex-1"><label class="text-sm text-gray-400">Ano</label><select id="reportYear" class="form-input"></select></div>
			</div>
			<div class="flex gap-2 mb-6">
				<button onclick="window.App.generateAndShowReport()" class="flex-1 bg-teal-600 text-white font-bold py-2 rounded shadow hover:bg-teal-700">Ver Relat√≥rio</button>
				<button onclick="window.App.showAnalyticsInModal()" class="flex-1 bg-purple-600 text-white font-bold py-2 rounded shadow hover:bg-purple-700">Gr√°ficos</button>
				<button onclick="window.App.exportReportCSV()" class="flex-1 bg-green-600 text-white font-bold py-2 rounded shadow hover:bg-green-700">CSV</button>
			</div>
			<div id="reportResult" class="space-y-4"></div>
			<div id="reportChartsContainer" class="hidden grid grid-cols-2 gap-4">
				<div class="dark-card p-4 rounded"><h3 class="text-gray-300 mb-2">Real</h3><div class="h-64"><canvas id="actualIncomeChartModal"></canvas></div></div>
				<div class="dark-card p-4 rounded"><h3 class="text-gray-300 mb-2">Proje√ß√£o</h3><div class="h-64"><canvas id="projectedIncomeChartModal"></canvas></div></div>
			</div>
		</div>
	</div>

	<div id="modalExito" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3">
		<div class="p-4 border-b border-gray-700 flex justify-between items-center"><h2 class="text-xl font-bold text-white">Registar √äxito</h2><button onclick="window.App.closeModal('modalExito')" class="text-gray-400 hover:text-white">&times;</button></div>
		<form id="formExito">
			<div class="p-6 modal-body space-y-4">
				<div id="exitoInfo" class="mb-4 bg-gray-700 p-3 rounded text-sm"></div>
				<div class="admin-only"><label class="text-sm text-gray-400">Valor L√≠quido (R$)</label><input type="number" step="0.01" id="exitoValorRecebido" class="form-input" required></div>
				<input type="hidden" id="exitoContractId">
			</div>
			<div class="p-4 border-t border-gray-700 flex justify-end gap-2">
				<button type="button" onclick="window.App.closeModal('modalExito')" class="bg-gray-600 text-white px-4 py-2 rounded">Cancelar</button>
				<button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Salvar</button>
			</div>
		</form>
	</div>

	<div id="modal-backdrop" class="modal-backdrop"></div>

	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
		import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
		import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel, writeBatch, serverTimestamp, query, orderBy, limit, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
		
		const ADMIN_USERS = ["dra. renata fabris","darc", "dr. felipe gurj√£o", "lilian"];
		const CONTRACTS_PER_PAGE = 12;
		const CUTOFF_DATE = new Date('2025-09-01T00:00:00Z'); // Data de Corte para Novos/Legado

		const Utils = {
			toastContainer: null,
			initToast() {
				let el = document.getElementById('notifications');
				if (!el) { el = document.createElement('div'); el.id = 'toast-fallback'; el.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:11000;display:flex;flex-direction:column;gap:8px;'; document.body.appendChild(el); }
				this.toastContainer = el;
			},
			showToast(msg, type = 'info') {
				if (!this.toastContainer) this.initToast();
				const n = document.createElement('div'); n.className = 'px-4 py-3 rounded-lg shadow-lg text-sm text-white animate-bounce';
				n.style.background = type === 'error' ? '#7f1d1d' : (type === 'success' ? '#065f46' : '#374151');
				n.textContent = msg; this.toastContainer.appendChild(n); setTimeout(() => n.remove(), 3000);
			},
			debounce(fn, ms = 300) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; },
			sanitizeText(s) { if (s == null) return ''; return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#39;').trim(); },
			sanitizeForFirestoreId(n) { if (!n) return 'unknown'; return n.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, '_').toLowerCase(); },
			parseNumber(n) { const v = Number(n); return Number.isFinite(v) ? v : 0; },
			confirm(msg) {
				return new Promise(res => {
					let m = document.getElementById('confirmModal');
					if (!m) { m = document.createElement('div'); m.id='confirmModal'; m.innerHTML=`<div style="position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:12000;display:flex;align-items:center;justify-content:center"><div class="dark-card p-6 rounded-lg max-w-sm w-full"><p id="cfmMsg" class="text-white mb-4"></p><div class="flex justify-end gap-2"><button id="cfmNo" class="bg-gray-600 text-white px-4 py-2 rounded">N√£o</button><button id="cfmYes" class="bg-red-600 text-white px-4 py-2 rounded">Sim</button></div></div></div>`; document.body.appendChild(m); }
					m.querySelector('#cfmMsg').textContent=msg; m.style.display='flex';
					m.querySelector('#cfmNo').onclick=()=>{m.style.display='none';res(false)}; m.querySelector('#cfmYes').onclick=()=>{m.style.display='none';res(true)};
				});
			},
			formatCurrency(v) { return (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); },
			formatDate(d) { if (!d) return ''; const dt = new Date(d); return `${String(dt.getUTCDate()).padStart(2,'0')}/${String(dt.getUTCMonth()+1).padStart(2,'0')}/${dt.getUTCFullYear()}`; },
			timeAgo(d) { if (!d) return ''; const sec = Math.floor((new Date()-new Date(d))/1000); if(sec<60) return 'agora'; const m=Math.floor(sec/60); if(m<60) return `${m}m atr√°s`; const h=Math.floor(m/60); if(h<24) return `${h}h atr√°s`; return `${Math.floor(h/24)}d atr√°s`; }
		};

		class CorrectionCalculator {
			constructor() { this.IPCA = { "2023-01":0.53, "2023-02":0.84, "2023-03":0.71, "2023-04":0.61, "2023-05":0.23, "2023-06":-0.08, "2023-07":0.12, "2023-08":0.23, "2023-09":0.26, "2023-10":0.24, "2023-11":0.28, "2023-12":0.56, "2024-01":0.42, "2024-02":0.83, "2024-03":0.16, "2024-04":0.38, "2024-05":0.46, "2024-06":0.36, "2024-07":0.16, "2024-08":0.24, "2024-09":0.26, "2024-10":0.42, "2024-11":0.53, "2024-12":0.48, "2025-01":0.55, "2025-02":0.78, "2025-03":0.21, "2025-04":0.35, "2025-05":0.40, "2025-06":0.26, "2025-07":0.22, "2025-08":0.31, "2025-09":0.33, "2025-10":0.40 }; }
			toUTC(y,m,d){ const t=new Date(Date.UTC(y,m,d)); t.setUTCHours(0,0,0,0); return t; }
			diff(d1,d2){ let y=(d2.getUTCFullYear()-d1.getUTCFullYear())*12+(d2.getUTCMonth()-d1.getUTCMonth()); return Math.max(0, y + (d2.getUTCDate()-d1.getUTCDate())/30); }
			getFactor(v,r){ let f=1.0, c=new Date(Date.UTC(v.getUTCFullYear(),v.getUTCMonth(),1)); while(c<new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),1))){ const k=`${c.getUTCFullYear()}-${String(c.getUTCMonth()+1).padStart(2,'0')}`; if(this.IPCA[k]) f*=(1+this.IPCA[k]/100); c.setUTCMonth(c.getUTCMonth()+1); } return f; }
			calcularValorCorrigido(val, dv, dr=new Date()){ const r=this.toUTC(dr.getUTCFullYear(),dr.getUTCMonth(),dr.getUTCDate()), v=new Date(dv), vt=this.toUTC(v.getUTCFullYear(),v.getUTCMonth(),v.getUTCDate()); if(r<=vt) return val; return val * this.getFactor(vt,r) * (1 + 0.01 * this.diff(vt,r)); }
		}

		class AuthService {
			constructor(app) { this.app = app; this.auth = null; this.firebaseConfig = { apiKey: "AIzaSyA0TWb7DgZAHNl3TuoK3xQD-ANvCcQIDK4", authDomain: "fabrisgurjao.firebaseapp.com", projectId: "fabrisgurjao", storageBucket: "fabrisgurjao.firebasestorage.app", messagingSenderId: "466702265991", appId: "1:466702265991:web:78c4d98b47cab537921222", measurementId: "G-E99R5TFMQK" }; }
			initialize() { const app = initializeApp(this.firebaseConfig); this.auth = getAuth(app); this.app.firebaseService.setDB(getFirestore(app)); onAuthStateChanged(this.auth, u => this.app.handleAuthStateChange(u)); }
			async login(e, p) { const b=document.getElementById('login-submit-button'); if(b)b.disabled=true; try{ await signInWithEmailAndPassword(this.auth, e, p); }catch{ document.getElementById('auth-error').classList.remove('hidden'); document.getElementById('auth-error').textContent='Erro no login.'; }finally{ if(b)b.disabled=false; } }
			async logout() { await signOut(this.auth); }
			async updateUserProfile(n) { try{ await updateProfile(this.auth.currentUser, {displayName:n}); return true; }catch{ return false; } }
		}

		class FirebaseService {
			constructor(app) { this.app = app; this.db = null; this.subs = []; }
			setDB(db) { this.db = db; }
			startSnapshotListener(col) { this.subs.push(onSnapshot(collection(this.db, col), s => this.app.handleSnapshotUpdate(s.docs.map(d => ({id:d.id, ...d.data()}))))); }
			startNotificationListener(u) { this.subs.push(onSnapshot(query(collection(this.db, `notifications/${u}/alerts`), orderBy("timestamp", "desc"), limit(20)), s => this.app.handleNotificationUpdate(s.docs.map(d => ({id:d.id, ...d.data()}))))); }
			startSystemSettingsListener() { this.subs.push(onSnapshot(collection(this.db, 'systemSettings'), s => { const r={}; s.docs.forEach(d=>r[d.id]=d.data()); this.app.handleSystemSettingsUpdate(r); })); }
			stopListeners() { this.subs.forEach(u => u()); this.subs = []; }
			async saveSystemSettings(id, d) { await setDoc(doc(this.db, 'systemSettings', id), d, {merge:true}); return true; }
			async sendNotification(u, d) { try{ await addDoc(collection(this.db, `notifications/${u}/alerts`), {...d, isRead:false, timestamp:serverTimestamp()}); }catch{} }
			async markNotificationsAsRead(u, ids) { const b = writeBatch(this.db); ids.forEach(id => b.update(doc(this.db, `notifications/${u}/alerts`, id), {isRead:true})); await b.commit(); }
			async addContract(d) { try{ await addDoc(collection(this.db, 'contracts'), d); Utils.showToast('Salvo!', 'success'); return true; }catch{ Utils.showToast('Erro ao salvar.', 'error'); return false; } }
			async updateContract(id, d) { try{ await updateDoc(doc(this.db, 'contracts', id), d); Utils.showToast('Atualizado!', 'success'); return true; }catch{ return false; } }
			async updateContractField(id, d) { try{ await updateDoc(doc(this.db, 'contracts', id), d); return true; }catch{ return false; } }
			async deleteContract(id) { await deleteDoc(doc(this.db, 'contracts', id)); Utils.showToast('Deletado.', 'success'); }
		}
		class AnalyticsHandler {
			constructor() { this.charts = {}; }
			renderChart(id, type, labels, data, label, color) {
				const ctx = document.getElementById(id)?.getContext('2d'); if (!ctx) return;
				if (this.charts[id]) this.charts[id].destroy();
				this.charts[id] = new Chart(ctx, { type, data: { labels, datasets: [{ label, data, backgroundColor: color+'99', borderColor: color, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } } } });
			}
			renderPie(id, labels, data, label) {
				const ctx = document.getElementById(id)?.getContext('2d'); if (!ctx) return;
				if (this.charts[id]) this.charts[id].destroy();
				this.charts[id] = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ label, data, backgroundColor: ['#4f46e5', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#d1d5db' } } } } });
			}
			destroyPageCharts(p) { Object.keys(this.charts).forEach(k => { this.charts[k].destroy(); delete this.charts[k]; }); }
		}

		class ReportHandler {
			constructor(app) { this.app = app; }
			calculateIncomeByDateRange(start, end, contracts) {
				let parc = 0, exito = 0, byAdv = {}, byMonth = {}, newCt = {};
				let detailed = []; // Quem Pagou
				let pending = [];  // Quem N√ÉO Pagou
				
				contracts.forEach(c => {
					const adv = c.advogadoResponsavel || 'N/A';
					if (c.createdAt) { const d = new Date(c.createdAt); if (d >= start && d <= end) newCt[`${d.getFullYear()}-${d.getMonth()+1}`] = (newCt[`${d.getFullYear()}-${d.getMonth()+1}`]||0)+1; }
					
					(c.parcels||[]).forEach(p => { 
						// Quem Pagou
						if (p.status === 'Paga' && p.paymentDate) { 
							const dPay = new Date(p.paymentDate); 
							if (dPay >= start && dPay <= end) { 
								parc += p.valuePaid; 
								detailed.push({ type: `Parcela ${p.number}`, clientName: c.clientName, date: dPay, value: p.valuePaid, advogado: adv }); 
								byAdv[adv]=(byAdv[adv]||0)+p.valuePaid; 
								byMonth[`${dPay.getFullYear()}-${dPay.getMonth()+1}`]=(byMonth[`${dPay.getFullYear()}-${dPay.getMonth()+1}`]||0)+p.valuePaid; 
							} 
						}
						// Quem N√ÉO Pagou (Venceu no per√≠odo e n√£o est√° paga)
						const dDue = new Date(p.dueDate);
						if (dDue >= start && dDue <= end && p.status !== 'Paga') {
							pending.push({ type: `Parcela ${p.number}`, clientName: c.clientName, date: dDue, value: p.value, advogado: adv });
						}
					});

					if (c.successFeePaymentDate) { 
						const d = new Date(c.successFeePaymentDate); 
						if (d >= start && d <= end) { 
							exito += c.successFeeValueReceived; 
							detailed.push({ type: '√äxito', clientName: c.clientName, date: d, value: c.successFeeValueReceived, advogado: adv }); 
							byAdv[adv]=(byAdv[adv]||0)+c.successFeeValueReceived; 
							byMonth[`${d.getFullYear()}-${d.getMonth()+1}`]=(byMonth[`${d.getFullYear()}-${d.getMonth()+1}`]||0)+c.successFeeValueReceived; 
						} 
					}
				});
				detailed.sort((a,b) => a.date - b.date);
				pending.sort((a,b) => a.date - b.date);
				return { totalParcelas: parc, totalExito: exito, totalGeral: parc+exito, totalContratos: Object.values(newCt).reduce((a,b)=>a+b,0), detailedPayments: detailed, pendingPayments: pending, byAdvogado: byAdv, byMonth, newContractsByMonth: newCt };
			}
			calculateMonthlyIncome(y, m, contracts) { return this.calculateIncomeByDateRange(new Date(y, m, 1), new Date(y, m + 1, 0, 23, 59, 59), contracts); }
			calculateAdminPerformanceData(contracts) {
				const h = new Date(); const fat = this.calculateIncomeByDateRange(new Date(h.getFullYear(), 0, 1), new Date(h.getFullYear(), 11, 31), contracts);
				const count = {}; contracts.filter(c => !c.isDeleted && this.app.getContractStatus(c).statusText !== 'Conclu√≠do').forEach(c => count[c.advogadoResponsavel||'N/A'] = (count[c.advogadoResponsavel||'N/A']||0)+1);
				return { contratosPorAdvogado: count, faturamentoPorAdvogado: fat.byAdvogado };
			}
			getActualIncomeData(contracts) {
				const l = [], d = []; const h = new Date();
				for (let i = 11; i >= 0; i--) { const dt = new Date(h.getFullYear(), h.getMonth() - i, 1); l.push(dt.toLocaleString('pt-BR', { month: 'short', year: '2-digit' })); d.push(this.calculateMonthlyIncome(dt.getFullYear(), dt.getMonth(), contracts).totalGeral); }
				return { labels: l, data: d };
			}
			getProjectedIncomeData(contracts) {
				const l = [], d = new Array(12).fill(0); const h = new Date(); h.setHours(0,0,0,0); const start = new Date(h.getFullYear(), h.getMonth(), 1);
				for (let i = 0; i < 12; i++) { const dt = new Date(h.getFullYear(), h.getMonth() + i, 1); l.push(dt.toLocaleString('pt-BR', { month: 'short', year: '2-digit' })); }
				contracts.filter(c => !c.isDeleted).forEach(c => (c.parcels||[]).forEach(p => { if (p.status === 'Pendente') { const due = new Date(p.dueDate); if (due >= start) { const diff = (due.getFullYear()-start.getFullYear())*12 + (due.getMonth()-start.getMonth()); if (diff >= 0 && diff < 12) d[diff] += p.value; } } }));
				return { labels: l, data: d };
			}
		}

		class DOMBuilder {
			constructor(app) { this.app = app; }
			el(tag, { cls = '', text = '', html = '', id = '' } = {}) { const e = document.createElement(tag); if (cls) e.className = cls; if (text) e.textContent = text; if (html) e.innerHTML = html; if (id) e.id = id; return e; }
			card(html, cls='') { return this.el('div', { cls: 'dark-card shadow-lg p-4 rounded-lg transition-all hover:-translate-y-1 '+cls, html }); }
			createParcelCard(c, p, i, type, rem, vc = null) {
				const d = Utils.formatDate(p.dueDate), v = Utils.formatCurrency(p.value), vCorr = vc ? Utils.formatCurrency(vc) : '';
				const border = type === 'vencida' ? 'border-red-500' : (type === 'a-vencer' ? 'border-yellow-500' : 'border-gray-700');
				const body = `<p class="font-bold text-white">${c.clientName}</p><p class="text-sm text-gray-400 mb-3">${(c.serviceTypes||[]).map(s=>s.name).join(', ')} - P.${p.number}</p>
				<div class="space-y-2 text-sm">${type==='vencida' ? `<div class="flex text-xs text-gray-400">Orig: <span class="ml-auto line-through">${v}</span></div><div class="flex text-red-400">Corr: <span class="ml-auto font-bold text-lg">${vCorr}</span></div>` : `<div class="flex text-gray-300">Valor: <span class="ml-auto font-bold text-lg text-white">${v}</span></div>`}
				<div class="flex text-gray-400"><i class="fas fa-calendar-alt w-5 mr-2"></i>Venc: <span class="ml-auto font-medium text-gray-300">${d}</span></div></div>
				${type==='paga' ? `<div class="mt-4 text-center text-sm bg-green-900/50 text-green-300 p-2 rounded">Pago ${Utils.formatCurrency(p.valuePaid)} em ${Utils.formatDate(p.paymentDate)}</div>` : `<button onclick="window.App.openPaymentModal('${c.id}', ${i})" class="mt-4 w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold py-2 rounded text-sm hover:shadow-lg">Pagar</button>`}`;
				return this.el('div', { cls: `dark-card shadow-lg p-4 rounded-lg border-l-4 ${border} transition-all hover:-translate-y-1`, html: body });
			}
			createContractCard(c, s) {
				const html = `<div class="p-5"><div class="flex justify-between items-start mb-3"><h3 class="font-bold text-xl text-white">${c.clientName}</h3><span class="px-2 py-1 rounded-full text-xs font-semibold ${s.statusColor}">${s.statusText}</span></div>
				<p class="text-xs text-indigo-300 mb-3"><i class="fas fa-user-tie mr-1"></i> ${c.advogadoResponsavel}</p><div class="mb-4">${(c.serviceTypes||[]).map(x=>`<span class="service-tag-small">${x.name}</span>`).join('')}</div>
				<div class="border-t border-gray-700 pt-4 space-y-3 text-sm"><div class="flex items-center text-gray-400"><i class="fas fa-file-invoice-dollar w-5 mr-2"></i><strong>Fixo:</strong><span class="ml-auto font-medium text-gray-300">${Utils.formatCurrency(c.totalValue)}</span></div>${c.successFee?`<div class="flex items-center text-gray-400"><i class="fas fa-star w-5 mr-2"></i><strong>√äxito:</strong><span class="ml-auto font-medium text-indigo-400">${c.successFee}</span></div>`:''}</div></div>
				<div class="bg-gray-900/50 px-4 py-2 flex justify-end gap-2"><button onclick="window.App.openClientHistoryModal('${c.clientName}')" class="text-gray-400 hover:text-indigo-400 py-1 px-3"><i class="fas fa-eye"></i></button><button onclick="window.App.openContractModal('${c.id}')" class="text-gray-400 hover:text-green-400 py-1 px-3"><i class="fas fa-pencil-alt"></i></button><button onclick="window.App.moveToLixeira('${c.id}')" class="text-gray-400 hover:text-red-400 py-1 px-3"><i class="fas fa-trash-alt"></i></button></div>`;
				return this.el('div', { cls: `dark-card shadow-lg rounded-lg overflow-hidden ${s.borderColor} flex flex-col justify-between border-l-4 transition-all hover:-translate-y-1`, html });
			}
			createParcelaCard({ contract, parcel, index, diffDays, valorCorrigido, isVencida }) {
				const html = `<p class="font-bold text-lg text-white">${contract.clientName}</p><p class="text-sm text-gray-400 mb-3">P.${parcel.number}</p>
				<div class="border-t border-gray-700 pt-3 mt-3 space-y-2">${isVencida ? `<div class="flex justify-between text-sm"><span class="text-gray-400">Orig:</span><span class="line-through text-gray-400">${Utils.formatCurrency(parcel.value)}</span></div><div class="flex justify-between"><span class="text-sm text-white">Corr:</span><span class="font-semibold text-lg parcel-value">${Utils.formatCurrency(valorCorrigido)}</span></div>` : `<div class="flex justify-between"><span class="text-sm text-white">Valor:</span><span class="font-semibold text-lg parcel-value">${Utils.formatCurrency(parcel.value)}</span></div>`}
				<div class="flex justify-between text-sm"><span class="text-gray-400">Venc:</span><span class="font-medium text-gray-300">${Utils.formatDate(parcel.dueDate)}</span></div>
				<div class="flex justify-between items-center font-bold text-sm ${isVencida ? 'text-red-400 bg-red-900/30' : 'text-yellow-400 bg-yellow-900/30'} px-2 py-1 rounded"><span>${isVencida ? 'Atrasado:' : 'Faltam:'}</span><span>${Math.abs(diffDays)}d</span></div></div>
				<div class="mt-4 flex gap-2"><button onclick="window.App.openPaymentModal('${contract.id}', ${index})" class="flex-1 bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm hover:shadow-lg">Pagar</button><button onclick="window.App.openContractModal('${contract.id}')" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg"><i class="fas fa-pencil-alt"></i></button></div>`;
				return this.el('div', { cls: `dark-card shadow-lg p-5 rounded-lg border-l-4 ${isVencida ? 'parcel-card-vencida' : 'parcel-card-avencer'} transition-all hover:-translate-y-1`, html });
			}
			createNotificationItem(n) { const d = this.el('div', { cls: `notification-item ${n.isRead?'is-read':''}`, html: `<p>${Utils.sanitizeText(n.message)}</p><div class="time">${Utils.timeAgo(n.timestamp?.toDate())}</div>` }); d.onclick=()=>{if(!n.isRead) window.App.markNotificationsAsRead([n.id]); window.App.closeNotificationDropdown();}; return d; }
		}

		class App {
			constructor() {
				this.database = { contracts: [], notifications: [], settings: { advogados: { list: [] } } };
				this.currentUserDisplayName = null; this.currentSafeName = null; this.isUserAdmin = false;
				this.currentAdvancedReportData = null; this.currentPageId = null; this.lastOverdueCheck = null;
				this.manualParcels = [];
				this.currentContractSort = 'name-asc'; this.currentParcelasSort = 'days-asc'; this.currentServicosSort = 'name-asc';
				this.contractListPage = 0; this.contractStatusFilter = 'ativos';
				this.globalDateFilter = 'novos'; // Filtro Padr√£o

				this.authService = new AuthService(this);
				this.firebaseService = new FirebaseService(this);
				this.domBuilder = new DOMBuilder(this);
				this.reportHandler = new ReportHandler(this);
				this.analyticsHandler = new AnalyticsHandler(this);
				this.correctionCalculator = new CorrectionCalculator(this);
			}

			initialize() { this.authService.initialize(); this._initDOMReferences(); this.setupEventListeners(); this._setupModalAccessibility(); }
			
			_initDOMReferences() {
				this.backdrop = document.getElementById('modal-backdrop'); this.appContainer = document.getElementById('app-container');
				this.loadingOverlay = document.getElementById('loading-overlay'); this.authOverlay = document.getElementById('auth-overlay');
				this.notificationDropdown = document.getElementById('notification-dropdown');
			}

			setupEventListeners() {
				document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); this.authService.login(document.getElementById('login-email').value, document.getElementById('login-password').value); });
				document.getElementById('logout-button').addEventListener('click', () => this.authService.logout());
				document.getElementById('formDisplayName').addEventListener('submit', this.handleDisplayNameSubmit.bind(this));
				document.getElementById('formContrato').addEventListener('submit', this.handleContractSubmit.bind(this));
				document.getElementById('formPagamento').addEventListener('submit', this.handlePaymentSubmit.bind(this));
				document.getElementById('formExito').addEventListener('submit', this.handleExitoSubmit.bind(this));
				document.getElementById('formAddAdvogado').addEventListener('submit', this.handleAddAdvogado.bind(this));
				document.getElementById('addServiceButton').addEventListener('click', this.handleAddServiceTag.bind(this));
				document.getElementById('contratoEspecial').addEventListener('change', this.toggleSpecialContractFields.bind(this));
				document.getElementById('addManualParcelButton').addEventListener('click', this.handleAddManualParcel.bind(this));
				document.getElementById('searchInput').addEventListener('input', Utils.debounce(() => this.resetAndRenderContractList(), 300));
				document.getElementById('servicosSearchInput').addEventListener('input', Utils.debounce(() => this.renderServicosPage(), 300));
				document.getElementById('parcelasSearchInput').addEventListener('input', Utils.debounce(() => this.renderParcelasPage(), 300));
				
				// Listener do Filtro Global
				document.getElementById('globalDateFilter').addEventListener('change', (e) => {
					this.globalDateFilter = e.target.value;
					Utils.showToast(`Modo: ${e.target.options[e.target.selectedIndex].text}`, 'info');
					this.render();
				});

				document.getElementById('mobile-menu-toggle').addEventListener('click', () => { const s = document.getElementById('sidebar'); s.classList.toggle('hidden'); this.backdrop.style.display = s.classList.contains('hidden') ? 'none' : 'block'; });
				if(this.backdrop) this.backdrop.addEventListener('click', () => { if (this.openModalId) this.closeModal(this.openModalId); document.getElementById('sidebar').classList.add('hidden'); this.closeNotificationDropdown(); });
				document.getElementById('notification-bell').addEventListener('click', (e) => { e.stopPropagation(); this.notificationDropdown.classList.toggle('hidden'); });
				document.getElementById('clear-notifications-button').addEventListener('click', () => this.markNotificationsAsRead());
				document.addEventListener('click', (e) => { if (!this.notificationDropdown.classList.contains('hidden') && !e.target.closest('#notification-bell') && !this.notificationDropdown.contains(e.target)) this.closeNotificationDropdown(); });
				['valorTotal', 'numParcelas', 'vencimentoPrimeiraParcela', 'contratoJaQuitado'].forEach(id => document.getElementById(id)?.addEventListener('change', () => document.getElementById('financialDataChanged').value = 'true'));
			}
			handleAuthStateChange(user) {
				if (user) {
					const isAdmin = ADMIN_USERS.includes((user.displayName || '').toLowerCase());
					this.currentUserDisplayName = user.displayName; this.currentSafeName = Utils.sanitizeForFirestoreId(user.displayName); this.isUserAdmin = isAdmin;
					document.body.classList.toggle('is-admin', this.isUserAdmin);
					if (!user.displayName) {
						document.getElementById('loading-overlay').style.display = 'none'; document.getElementById('auth-overlay').style.display = 'flex'; document.getElementById('app-container').style.display = 'none'; this.openModal('modalDisplayName');
					} else {
						document.getElementById('user-display-name').textContent = user.displayName;
						document.getElementById('loading-overlay').style.display = 'none'; document.getElementById('auth-overlay').style.display = 'none'; document.getElementById('app-container').style.display = 'flex';
						this.setupUIAccess(); this.firebaseService.startSnapshotListener('contracts'); this.firebaseService.startNotificationListener(this.currentSafeName); this.firebaseService.startSystemSettingsListener();
					}
				} else {
					this.currentUserDisplayName = null; this.currentSafeName = null; this.isUserAdmin = false; this.lastOverdueCheck = null;
					document.body.classList.remove('is-admin'); document.getElementById('auth-overlay').style.display = 'flex'; document.getElementById('app-container').style.display = 'none'; document.getElementById('loading-overlay').style.display = 'none';
					this.firebaseService.stopListeners();
				}
			}

			handleSnapshotUpdate(contracts) {
				const old = this.database.contracts || []; this.database.contracts = contracts;
				this.checkAndNotifyOverdue(old, contracts); this.contractListPage = 0; this.render();
			}
			handleNotificationUpdate(n) { this.database.notifications = n; this.renderNotificationDropdown(); }
			handleSystemSettingsUpdate(s) { if (!s.advogados) s.advogados = { list: [] }; this.database.settings = s; this.renderAdvogadoFilters(); this.populateAdvogadoSelectModal(); if (this.currentPageId === 'page-oficina') this.renderOficinaPage(); }

			// --- L√ìGICA CORE: FILTRO DE DATA ---
			getFilteredContracts(includeDeleted = false) {
				let contracts = this.database.contracts;
				if (!this.isUserAdmin) contracts = contracts.filter(c => c.advogadoResponsavel === this.currentUserDisplayName);
				
				// Filtro Global: Novos vs Legado
				contracts = contracts.filter(c => {
					let refDate = c.createdAt ? new Date(c.createdAt) : new Date();
					if (c.parcels && c.parcels.length > 0) {
						// Pega a data da primeira parcela cronol√≥gica
						const sorted = [...c.parcels].sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
						refDate = new Date(sorted[0].dueDate);
					}
					return this.globalDateFilter === 'novos' ? refDate >= CUTOFF_DATE : refDate < CUTOFF_DATE;
				});

				if (!includeDeleted) contracts = contracts.filter(c => !c.isDeleted);
				return contracts;
			}

			render() {
				if (document.getElementById('app-container').style.display !== 'flex') return;
				const pid = this.currentPageId || 'page-dashboard';
				if (!this.currentPageId) this.showPage(pid);

				if (pid === 'page-dashboard') { this.renderKanban(); this.renderContractList(); }
				else if (pid === 'page-parcelas') this.renderParcelasPage();
				else if (pid === 'page-servicos') this.renderServicosPage();
				else if (pid === 'page-lixeira') this.renderLixeiraPage();
				else if (pid === 'page-relatorios') this.renderAdvancedReportPage();
				else if (pid === 'page-performance') this.renderPerformancePage();
				else if (pid === 'page-oficina') this.renderOficinaPage();
				this.renderSortButtons();
			}

			renderKanban() {
				const contracts = this.getFilteredContracts(false);
				const kVenc = document.getElementById('kanban-vencidas'), kAvenc = document.getElementById('kanban-a-vencer'), kPagas = document.getElementById('kanban-pagas'), kExito = document.getElementById('kanban-exito-wrapper');
				const fVenc = document.createDocumentFragment(), fAvenc = document.createDocumentFragment(), fPagas = document.createDocumentFragment(), fExito = document.createDocumentFragment();
				
				const hoje = new Date(); hoje.setHours(0,0,0,0); const d1 = new Date(hoje.getFullYear(), hoje.getMonth(), 1); const d30 = new Date(); d30.setDate(hoje.getDate()+30);
				let t30 = 0, tVenc = 0, hasExito = 0;

				contracts.forEach(c => {
					const rem = (c.parcels||[]).reduce((s,p)=>p.status==='Pendente'?s+p.value:s,0);
					(c.parcels||[]).forEach((p,i) => {
						const venc = new Date(p.dueDate);
						if (p.status === 'Paga') { const dp = new Date(p.paymentDate); if(dp>=d1 && dp<=hoje) fPagas.append(this.domBuilder.createParcelCard(c, p, i, 'paga', rem)); }
						else {
							if (venc < hoje) { const vc = this.correctionCalculator.calcularValorCorrigido(p.value, p.dueDate); tVenc+=vc; fVenc.append(this.domBuilder.createParcelCard(c, p, i, 'vencida', rem, vc)); }
							else if (venc >= hoje && venc <= d30) { t30+=p.value; fAvenc.append(this.domBuilder.createParcelCard(c, p, i, 'a-vencer', rem)); }
						}
					});
					if (c.successFee && !c.successFeePaymentDate && (c.parcels||[]).every(p=>p.status==='Paga')) { fExito.append(this.domBuilder.createExitoCard(c)); hasExito++; }
				});

				kVenc.innerHTML=''; kAvenc.innerHTML=''; kPagas.innerHTML=''; kExito.innerHTML='';
				kVenc.append(fVenc); kAvenc.append(fAvenc); kPagas.append(fPagas);
				if(hasExito>0) { kExito.append(fExito); document.getElementById('exito-section').classList.remove('hidden'); } else document.getElementById('exito-section').classList.add('hidden');
				
				const totalPagoMes = this.reportHandler.calculateMonthlyIncome(hoje.getFullYear(), hoje.getMonth(), this.getFilteredContracts(true)).totalGeral;
				document.getElementById('dash-a-receber').textContent = Utils.formatCurrency(t30);
				document.getElementById('dash-vencido').textContent = Utils.formatCurrency(tVenc);
				document.getElementById('dash-recebido').textContent = Utils.formatCurrency(totalPagoMes);
				document.getElementById('dash-contratos').textContent = contracts.length;
			}

			renderContractList() {
				const container = document.getElementById('contractListContainer'); const search = (document.getElementById('searchInput').value||'').toLowerCase();
				const advFilter = document.getElementById('advogadoFilter')?.value || 'Todos';
				let list = this.getFilteredContracts(false).filter(c => {
					const s = this.getContractStatus(c); const done = s.statusText === 'Conclu√≠do';
					if (this.contractStatusFilter==='ativos' && done) return false;
					if (this.contractStatusFilter==='concluidos' && !done) return false;
					const matchAdv = (this.isUserAdmin && advFilter==='Todos') || c.advogadoResponsavel === (this.isUserAdmin ? advFilter : this.currentUserDisplayName);
					const matchText = c.clientName.toLowerCase().includes(search) || (c.serviceTypes||[]).some(x=>x.name.toLowerCase().includes(search));
					return matchAdv && matchText;
				});

				if (this.currentContractSort === 'name-asc') list.sort((a,b)=>a.clientName.localeCompare(b.clientName));
				else if (this.currentContractSort === 'value-desc') list.sort((a,b)=>(b.totalValue||0)-(a.totalValue||0));

				const total = list.length; const pages = Math.ceil(total/CONTRACTS_PER_PAGE);
				if (this.contractListPage >= pages && pages > 0) this.contractListPage = pages - 1;
				const pgList = list.slice(this.contractListPage*CONTRACTS_PER_PAGE, (this.contractListPage+1)*CONTRACTS_PER_PAGE);

				container.innerHTML = '';
				if (total === 0) { container.innerHTML = `<div class="dark-card p-4 rounded text-center text-gray-400">Nenhum contrato encontrado.</div>`; this.domBuilder.renderPaginationControls(document.getElementById('paginationContainer'), 0, 0, 0); return; }
				const grid = this.domBuilder.el('div', { cls: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' });
				pgList.forEach(c => grid.append(this.domBuilder.createContractCard(c, this.getContractStatus(c))));
				container.append(grid);
				this.domBuilder.renderPaginationControls(document.getElementById('paginationContainer'), total, pages, this.contractListPage);
			}

			renderParcelasPage() {
				const contracts = this.getFilteredContracts(false);
				const container = document.getElementById('parcelasListContainer'); const search = (document.getElementById('parcelasSearchInput').value || '').toLowerCase();
				const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
				let list = [];
				contracts.forEach(c => {
					if (!c.clientName.toLowerCase().includes(search)) return;
					(c.parcels||[]).forEach((p, i) => {
						if (p.status === 'Pendente') {
							const due = new Date(p.dueDate); const diff = Math.ceil((due - hoje) / 86400000);
							const isVencida = due < hoje; const valCorr = isVencida ? this.correctionCalculator.calcularValorCorrigido(p.value, p.dueDate) : p.value;
							list.push({ contract: c, parcel: p, index: i, diffDays: diff, valorCorrigido: valCorr, isVencida });
						}
					});
				});
				if (this.currentParcelasSort === 'days-asc') list.sort((a, b) => a.diffDays - b.diffDays);
				else if (this.currentParcelasSort === 'value-desc') list.sort((a, b) => b.valorCorrigido - a.valorCorrigido);
				else if (this.currentParcelasSort === 'name-asc') list.sort((a, b) => a.contract.clientName.localeCompare(b.contract.clientName));

				container.innerHTML = '';
				if (list.length === 0) container.innerHTML = `<div class="col-span-3 text-center py-10"><i class="fas fa-check-circle fa-3x text-green-500 mb-2"></i><p>Tudo em dia!</p></div>`;
				else list.forEach(item => container.append(this.domBuilder.createParcelaCard(item)));
			}

			renderServicosPage() {
				const contracts = this.getFilteredContracts(false);
				const container = document.getElementById('servicosListContainer'); const search = (document.getElementById('servicosSearchInput').value || '').toLowerCase();
				const advFilter = document.getElementById('servicosAdvogadoFilter')?.value || 'Todos';
				container.innerHTML = '';
				let active = contracts.filter(c => {
					const matchAdv = (this.isUserAdmin && advFilter === 'Todos') || c.advogadoResponsavel === (this.isUserAdmin ? advFilter : this.currentUserDisplayName);
					const matchText = c.clientName.toLowerCase().includes(search);
					return matchAdv && matchText && c.serviceTypes && c.serviceTypes.length > 0;
				});
				if (this.currentServicosSort === 'name-asc') active.sort((a, b) => a.clientName.localeCompare(b.clientName));
				else if (this.currentServicosSort === 'adv-asc') active.sort((a, b) => a.advogadoResponsavel.localeCompare(b.advogadoResponsavel));
				
				let hasItems = false;
				active.forEach(c => {
					const total = (c.serviceTypes||[]).length;
					let prog = 0; (c.serviceTypes||[]).forEach(s => { if(s.status==='Conclu√≠do') prog+=1; else if(s.status==='50% Conclu√≠do') prog+=0.5; else if(s.status==='Em Andamento') prog+=0.25; });
					const sp = total > 0 ? (prog/total)*100 : 0;
					if(sp < 100) { container.append(this.domBuilder.createServicoCard(c, sp, ((c.parcels||[]).reduce((s,p)=>s+(p.valuePaid||0),0)/c.totalValue)*100 || 0)); hasItems = true; }
				});
				if (!hasItems) container.innerHTML = `<div class="text-center py-10 text-gray-500">Nenhum servi√ßo pendente.</div>`;
			}

			renderLixeiraPage() {
				const container = document.getElementById('lixeiraListContainer'); container.innerHTML = '';
				const deleted = this.getFilteredContracts(true).filter(c => c.isDeleted === true);
				if (deleted.length === 0) container.innerHTML = `<p class="text-center col-span-3 text-gray-500">Lixeira vazia.</p>`;
				deleted.forEach(c => {
					container.append(this.domBuilder.card(`<p class="font-bold text-white">${c.clientName}</p><p class="text-sm text-gray-400 mb-3">${(c.serviceTypes||[]).map(s=>s.name).join(', ')}</p><div class="border-t border-gray-700 pt-3 flex gap-2"><button onclick="window.App.restoreContract('${c.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm w-full">Restaurar</button>${this.isUserAdmin ? `<button onclick="window.App.deleteContractPermanently('${c.id}')" class="bg-red-700 text-white px-3 py-1 rounded text-sm w-full">Excluir</button>` : ''}</div>`, 'border-l-4 border-gray-600'));
				});
			}

			// --- RELAT√ìRIO DETALHADO (QUEM PAGOU vs QUEM N√ÉO PAGOU) ---
			generateAndShowReport() {
				const m = parseInt(document.getElementById('reportMonth').value);
				const y = parseInt(document.getElementById('reportYear').value);
				// Usa contratos filtrados (para respeitar legacy/novos)
				const data = this.reportHandler.calculateMonthlyIncome(y, m, this.getFilteredContracts(true));
				
				let html = `<div class="grid grid-cols-2 gap-4 text-center mb-6">
					<div class="dark-card p-4 rounded">Total Parc.<br><b class="text-white text-xl">${Utils.formatCurrency(data.totalParcelas)}</b></div>
					<div class="dark-card p-4 rounded">Total √äxito<br><b class="text-indigo-400 text-xl">${Utils.formatCurrency(data.totalExito)}</b></div>
				</div>
				<div class="bg-green-900/20 border border-green-700 p-4 text-center rounded mb-6"><h3 class="font-bold text-green-400 text-2xl">${Utils.formatCurrency(data.totalGeral)}</h3><p class="text-xs">RECEBIDO EM ${m + 1}/${y}</p></div>`;

				// Lista Quem Pagou
				html += `<h4 class="text-green-400 font-bold text-xs uppercase border-b border-gray-700 pb-1 mb-2">Quem Pagou (Entradas)</h4>`;
				if (data.detailedPayments.length > 0) {
					html += `<div class="space-y-1 mb-6">`;
					data.detailedPayments.forEach(p => {
						html += `<div class="flex justify-between bg-gray-800 p-2 rounded text-sm"><div><span class="text-white">${p.clientName}</span> <span class="text-xs text-gray-500">(${p.type})</span></div><div class="text-green-400 font-bold">${Utils.formatCurrency(p.value)}</div></div>`;
					});
					html += `</div>`;
				} else html += `<p class="text-xs text-gray-500 italic mb-6">Nenhum recebimento.</p>`;

				// Lista Quem N√ÉO Pagou
				const pendingTotal = data.pendingPayments.reduce((acc,curr)=>acc+curr.value,0);
				html += `<h4 class="text-red-400 font-bold text-xs uppercase border-b border-gray-700 pb-1 mb-2 flex justify-between"><span>Quem N√£o Pagou (Pendentes)</span><span>Total: ${Utils.formatCurrency(pendingTotal)}</span></h4>`;
				if (data.pendingPayments.length > 0) {
					html += `<div class="space-y-1">`;
					data.pendingPayments.forEach(p => {
						html += `<div class="flex justify-between bg-red-900/10 border border-red-900/30 p-2 rounded text-sm"><div><span class="text-white">${p.clientName}</span> <span class="text-xs text-red-300">Venc: ${Utils.formatDate(p.date)}</span></div><div class="text-red-400 font-bold">${Utils.formatCurrency(p.value)}</div></div>`;
					});
					html += `</div>`;
				} else html += `<p class="text-xs text-gray-500 italic">Nenhuma pend√™ncia.</p>`;

				document.getElementById('reportResult').innerHTML = html;
				document.getElementById('reportResult').classList.remove('hidden'); document.getElementById('reportChartsContainer').classList.add('hidden');
			}

			exportReportPDF() {
				if (!this.currentAdvancedReportData) return;
				const { jsPDF } = window.jspdf; const doc = new jsPDF(); const d = this.currentAdvancedReportData;
				doc.setFontSize(18); doc.text("Relat√≥rio Financeiro", 14, 22); doc.setFontSize(11); doc.text(`Gerado em ${new Date().toLocaleDateString()}`, 14, 30);
				
				// Tabela Resumo
				doc.autoTable({ startY: 40, head: [['Item', 'Valor']], body: [['Fatura√ß√£o Total (Recebido)', Utils.formatCurrency(d.totalGeral)], ['Novos Contratos', d.totalContratos], ['Total Parcelas', Utils.formatCurrency(d.totalParcelas)], ['Total √äxito', Utils.formatCurrency(d.totalExito)]], theme: 'grid', headStyles: { fillColor: [22, 163, 74] } });
				
				// Tabela Quem Pagou
				doc.text("Detalhes: Quem Pagou", 14, doc.lastAutoTable.finalY + 15);
				const rowsPaid = d.detailedPayments.map(x => [x.clientName, x.type, Utils.formatDate(x.date), x.advogado, Utils.formatCurrency(x.value)]);
				doc.autoTable({ startY: doc.lastAutoTable.finalY + 20, head: [['Cliente', 'Tipo', 'Data', 'Adv', 'Valor']], body: rowsPaid, headStyles: { fillColor: [22, 163, 74] } });

				// Tabela Quem N√ÉO Pagou
				if (d.pendingPayments && d.pendingPayments.length > 0) {
					doc.addPage(); doc.setTextColor(220, 38, 38); doc.text("Pend√™ncias: Quem N√ÉO Pagou", 14, 20); doc.setTextColor(0);
					const rowsPending = d.pendingPayments.map(x => [x.clientName, x.type, Utils.formatDate(x.date), x.advogado, Utils.formatCurrency(x.value)]);
					doc.autoTable({ startY: 25, head: [['Cliente', 'Parcela', 'Vencimento', 'Adv', 'Valor']], body: rowsPending, headStyles: { fillColor: [220, 38, 38] } });
				}
				doc.save('relatorio_completo.pdf');
			}

			// --- OUTRAS FUN√á√ïES (Vers√£o Completa) ---
			renderAdvancedReportPage() { this.generateAdvancedReport(); } 
			generateAdvancedReport() {
				this.analyticsHandler.destroyPageCharts('page-relatorios');
				const s = new Date(document.getElementById('reportStartDate').value + 'T00:00:00');
				const e = new Date(document.getElementById('reportEndDate').value + 'T23:59:59');
				const data = this.reportHandler.calculateIncomeByDateRange(s, e, this.getFilteredContracts(true));
				this.currentAdvancedReportData = data;
				
				if (data.totalGeral === 0 && data.totalContratos === 0) { document.getElementById('advancedReportContainer').classList.add('hidden'); document.getElementById('advancedReportEmpty').classList.remove('hidden'); document.getElementById('exportPdfButton').disabled = true; }
				else {
					document.getElementById('advancedReportContainer').classList.remove('hidden'); document.getElementById('advancedReportEmpty').classList.add('hidden'); document.getElementById('exportPdfButton').disabled = false;
					document.getElementById('report-kpis').innerHTML = `<div class="dark-card p-4 rounded text-center">Fatura√ß√£o<br><b class="text-2xl text-green-400">${Utils.formatCurrency(data.totalGeral)}</b></div><div class="dark-card p-4 rounded text-center">Novos<br><b class="text-2xl text-blue-400">${data.totalContratos}</b></div><div class="dark-card p-4 rounded text-center">Pendentes<br><b class="text-2xl text-red-400">${Utils.formatCurrency(data.pendingPayments.reduce((a,b)=>a+b.value,0))}</b></div><div class="dark-card p-4 rounded text-center">√äxito<br><b class="text-2xl text-indigo-400">${Utils.formatCurrency(data.totalExito)}</b></div>`;
					this.analyticsHandler.renderChart('advReportTimelineChart', 'line', Object.keys(data.byMonth).sort(), Object.keys(data.byMonth).sort().map(k => data.byMonth[k]), 'Fatura√ß√£o', '#4ade80');
					this.analyticsHandler.renderChart('advReportNewContractsChart', 'bar', Object.keys(data.newContractsByMonth).sort(), Object.keys(data.newContractsByMonth).sort().map(k => data.newContractsByMonth[k]), 'Novos', '#8b5cf6');
					this.analyticsHandler.renderPie('advReportByAdvogadoChart', Object.keys(data.byAdvogado), Object.values(data.byAdvogado), 'Por Advogado');
				}
			}
			renderPerformancePage() {
				if (!this.isUserAdmin) return;
				this.analyticsHandler.destroyPageCharts('page-performance');
				const { contratosPorAdvogado, faturamentoPorAdvogado } = this.reportHandler.calculateAdminPerformanceData(this.getFilteredContracts(true));
				this.analyticsHandler.renderPie('adminChartContratos', Object.keys(contratosPorAdvogado), Object.values(contratosPorAdvogado), 'Contratos');
				this.analyticsHandler.renderChart('adminChartFaturamento', 'bar', Object.keys(faturamentoPorAdvogado), Object.values(faturamentoPorAdvogado), 'Fatura√ß√£o', '#4ade80');
				const tb1 = document.getElementById('adminTableFaturamento').querySelector('tbody'); tb1.innerHTML='';
				Object.entries(faturamentoPorAdvogado).sort(([,a],[,b])=>b-a).forEach(([l,v],i) => tb1.append(this.domBuilder.createRankingRow(i+1, l, Utils.formatCurrency(v))));
				const tb2 = document.getElementById('adminTableContratos').querySelector('tbody'); tb2.innerHTML='';
				Object.entries(contratosPorAdvogado).sort(([,a],[,b])=>b-a).forEach(([l,v],i) => tb2.append(this.domBuilder.createRankingRow(i+1, l, v)));
			}
			renderOficinaPage() {
				const list = document.getElementById('advogadoSettingsList'); if(!list) return;
				list.innerHTML = ''; const arr = this.database.settings.advogados?.list || [];
				if(arr.length === 0) list.innerHTML = `<p class="text-sm text-gray-400 text-center p-2">Vazio.</p>`;
				else [...arr].sort().forEach(n => list.append(this.domBuilder.createSettingListItem(n)));
			}
			showPage(id) {
				if ((this.currentPageId==='page-relatorios'&&id!=='page-relatorios')||(this.currentPageId==='page-performance'&&id!=='page-performance')) this.analyticsHandler.destroyPageCharts(this.currentPageId);
				this.currentPageId = id;
				['page-dashboard', 'page-parcelas', 'page-servicos', 'page-lixeira', 'page-relatorios', 'page-performance', 'page-oficina'].forEach(p => document.getElementById(p)?.classList.add('hidden'));
				document.querySelectorAll('.sidebar-nav-item, .mobile-nav-item').forEach(e => e.classList.remove('active'));
				document.getElementById(id)?.classList.remove('hidden');
				const base = id.split('-')[1]; document.getElementById(`tab-${base}`)?.classList.add('active'); document.getElementById(`mobile-tab-${base}`)?.classList.add('active');
				const sb = document.getElementById('sidebar'); if(window.innerWidth<768 && !sb.classList.contains('hidden')) { sb.classList.add('hidden'); document.getElementById('modal-backdrop').style.display='none'; }
				this.render();
			}
			setupUIAccess() { const adm=this.isUserAdmin; ['advogadoFilter', 'servicosAdvogadoFilter'].forEach(id=>{const e=document.getElementById(id);if(e){e.disabled=!adm;e.value=adm?'Todos':this.currentUserDisplayName;}}); }
			getContractStatus(c) { const p=(c.parcels||[]).every(x=>x.status==='Paga'), s=(c.serviceTypes||[]).every(x=>x.status==='Conclu√≠do'); if(p&&s) return c.successFee&&!c.successFeePaymentDate?{statusText:'Aguardando √äxito',statusColor:'bg-indigo-900 text-indigo-300',borderColor:'border-indigo-500'}:{statusText:'Conclu√≠do',statusColor:'bg-gray-700 text-gray-300',borderColor:'border-gray-600'}; if(p) return {statusText:'Em Andamento',statusColor:'bg-blue-900 text-blue-300',borderColor:'border-blue-500'}; return {statusText:'Ativo',statusColor:'bg-yellow-900 text-yellow-300',borderColor:'border-yellow-500'}; }
			renderSortButtons() { /* Helper padr√£o */ }
			renderAdvogadoFilters() { const all=new Set(this.database.settings.advogados?.list||[]); ['advogadoFilter','servicosAdvogadoFilter'].forEach(id=>{const s=document.getElementById(id);if(!s)return;const v=s.value;s.innerHTML='<option value="Todos">Todos</option>';[...all].sort().forEach(a=>s.add(new Option(a,a)));s.value=this.isUserAdmin?(v||'Todos'):this.currentUserDisplayName;s.disabled=!this.isUserAdmin;}); }
			populateAdvogadoSelectModal() { const s=document.getElementById('advogadoResponsavel');if(!s)return;s.innerHTML='<option>N√£o Informado</option>';const all=new Set(this.database.settings.advogados?.list||[]);[...all].sort().forEach(a=>s.add(new Option(a,a))); }
			changeContractPage(i) { this.contractListPage=i; this.renderContractList(); }
			resetAndRenderContractList() { this.contractListPage=0; this.renderContractList(); }
			
			// --- HANDLERS DE A√á√ÉO ---
			async handleDisplayNameSubmit(e) { e.preventDefault(); if(await this.authService.updateUserProfile(document.getElementById('inputDisplayName').value)) window.location.reload(); }
			async handleContractSubmit(e) {
				e.preventDefault(); const id=document.getElementById('contractId').value, spec=document.getElementById('contratoEspecial').checked, svcs=Array.from(document.querySelectorAll('#servicosContainer .service-tag')).map(t=>({name:Utils.sanitizeText(t.dataset.name),status:t.dataset.status,deadline:t.dataset.deadline}));
				if(!svcs.length){Utils.showToast('Adicione servi√ßos.','error');return;}
				const data={clientName:Utils.sanitizeText(document.getElementById('clienteNome').value),advogadoResponsavel:document.getElementById('advogadoResponsavel').value,serviceTypes:svcs,paymentType:document.getElementById('contratoTipoPagamento').value,observations:document.getElementById('contratoObservacoes').value,isSpecialContract:spec};
				if(this.isUserAdmin){
					let p=[],t=0;
					if(spec){ this.manualParcels.forEach((x,i)=>{t+=x.value;p.push({number:i+1,value:x.value,dueDate:new Date(x.dueDate+'T12:00:00').toISOString(),status:'Pendente',valuePaid:0});}); }
					else{ t=Utils.parseNumber(document.getElementById('valorTotal').value);const n=parseInt(document.getElementById('numParcelas').value)||1,start=document.getElementById('vencimentoPrimeiraParcela').value,paid=document.getElementById('contratoJaQuitado').checked;
						if(n>0&&t>0){let dt=new Date((start||new Date().toISOString().split('T')[0])+'T12:00:00');const v=t/n;for(let i=0;i<n;i++){const isP=paid&&n===1;p.push({number:i+1,value:v,dueDate:dt.toISOString(),status:isP?'Paga':'Pendente',valuePaid:isP?v:0,paymentDate:isP?new Date().toISOString():null});dt.setMonth(dt.getMonth()+1);}}
					}
					data.totalValue=t;data.parcels=p;data.successFee=document.getElementById('taxaExito').value;
				}
				if(!id){if(!this.isUserAdmin){data.parcels=[];data.totalValue=0;} data.isDeleted=false;data.createdAt=new Date().toISOString(); if(await this.firebaseService.addContract(data)) this.closeModal('modalContrato');}
				else{const old=this.database.contracts.find(c=>c.id===id); if(!this.isUserAdmin&&old){data.totalValue=old.totalValue;data.parcels=old.parcels;} data.createdAt=old?.createdAt; if(await this.firebaseService.updateContract(id,data)) this.closeModal('modalContrato');}
			}
			async handlePaymentSubmit(e) { e.preventDefault(); const id=document.getElementById('pagamentoContractId').value, idx=document.getElementById('pagamentoParcelIndex').value, c=this.database.contracts.find(x=>x.id===id), val=this.isUserAdmin?Utils.parseNumber(document.getElementById('pagamentoValor').value):(c?.parcels[idx]?.value||0); if(c&&val>0){const p=[...c.parcels]; p[idx]={...p[idx],status:'Paga',valuePaid:val,paymentDate:new Date(document.getElementById('pagamentoData').value+'T12:00:00').toISOString()}; await this.firebaseService.updateContractField(id,{parcels:p}); this.closeModal('modalPagamento');} }
			async handleExitoSubmit(e) { e.preventDefault(); const id=document.getElementById('exitoContractId').value, val=this.isUserAdmin?Utils.parseNumber(document.getElementById('exitoValorRecebido').value):0; if(await this.firebaseService.updateContractField(id,{successFeeValueReceived:val,successFeePaymentDate:new Date().toISOString()})) this.closeModal('modalExito'); }
			handleAddServiceTag() { const n=document.getElementById('contratoServicoInput'),d=document.getElementById('contratoPrazoInput'); if(n.value){this.createServiceTag(n.value,d.value,'Pendente');n.value='';d.value='';} }
			async updateServiceStatus(id, idx, st) { const c=this.database.contracts.find(x=>x.id===id); if(c){const s=[...c.serviceTypes];s[idx].status=st;await this.firebaseService.updateContractField(id,{serviceTypes:s});} }
			async sendNotification(u, d) { if(u&&u!==this.currentUserDisplayName) await this.firebaseService.sendNotification(Utils.sanitizeForFirestoreId(u), d); }
			
			// L√≥gica de Notifica√ß√£o Di√°ria
			checkAndNotifyOverdue(oldContracts, newContracts) {
				const today = new Date().toISOString().split('T')[0];
				if (this.lastOverdueCheck === today) return;
				const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); const yStr = yesterday.toISOString().split('T')[0];
				// Verifica apenas contratos relevantes para o usu√°rio (ou todos se admin)
				let contractsToCheck = this.database.contracts;
				if (!this.isUserAdmin) contractsToCheck = contractsToCheck.filter(c => c.advogadoResponsavel === this.currentUserDisplayName);

				contractsToCheck.forEach(c => {
					(c.parcels || []).forEach(p => {
						if (p.status === 'Pendente' && p.dueDate.startsWith(yStr)) {
							// Notifica APENAS o advogado respons√°vel
							this.sendNotification(c.advogadoResponsavel, { message: `Aten√ß√£o: Parcela ${p.number} de ${c.clientName} venceu ontem.`, contractId: c.id, sender: "Sistema" });
						}
					});
				});
				this.lastOverdueCheck = today;
			}

			async moveToLixeira(id) { if(await Utils.confirm('Mover para Lixeira?')) await this.firebaseService.updateContractField(id,{isDeleted:true}); }
			async restoreContract(id) { if(await Utils.confirm('Restaurar?')) await this.firebaseService.updateContractField(id,{isDeleted:false}); }
			async deleteContractPermanently(id) { if(this.isUserAdmin && await Utils.confirm('EXCLUIR PERMANENTEMENTE?')) await this.firebaseService.deleteContract(id); }
			async handleAddAdvogado(e) { e.preventDefault(); const n=document.getElementById('inputAdvogadoName').value; const l=this.database.settings.advogados?.list||[]; if(n&&!l.includes(n)) await this.firebaseService.saveSystemSettings('advogados',{list:[...l,n]}); document.getElementById('inputAdvogadoName').value=''; }
			async handleRemoveAdvogado(n) { if(await Utils.confirm('Remover?')) await this.firebaseService.saveSystemSettings('advogados',{list:(this.database.settings.advogados?.list||[]).filter(x=>x!==n)}); }
			handleAddManualParcel() { const v=Utils.parseNumber(document.getElementById('parcelaValorManual').value),d=document.getElementById('parcelaVencimentoManual').value; if(v>0&&d){this.manualParcels.push({value:v,dueDate:d}); this.renderManualParcelList(); document.getElementById('parcelaValorManual').value='';} }
			handleRemoveManualParcel(i) { this.manualParcels.splice(i,1); this.renderManualParcelList(); }
			renderManualParcelList() { const c=document.getElementById('manualParcelList'); c.innerHTML=''; this.manualParcels.forEach((p,i)=>c.append(this.domBuilder.createManualParcelListItem(p.value,p.dueDate,i))); }
			toggleSpecialContractFields(e) { document.getElementById('financial-fields-standard').style.display=e.target.checked?'none':'block'; document.getElementById('financial-fields-special').style.display=e.target.checked?'block':'none'; }
			openModal(id) { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); document.getElementById(id).style.display='block'; document.getElementById('modal-backdrop').style.display='block'; this.openModalId=id; }
			closeModal(id) { document.getElementById(id).style.display='none'; if(this.openModalId===id)this.openModalId=null; if(!document.querySelector('.modal[style*="block"]')) document.getElementById('modal-backdrop').style.display='none'; }
			
			// M√©todos "open" espec√≠ficos apenas preparam o form e chamam openModal
			openContractModal(id=null) { document.getElementById('formContrato').reset(); this.manualParcels=[]; document.getElementById('servicosContainer').innerHTML=''; this.populateAdvogadoSelectModal(); if(id){const c=this.database.contracts.find(x=>x.id===id); document.getElementById('contractId').value=id; document.getElementById('clienteNome').value=c.clientName; document.getElementById('advogadoResponsavel').value=c.advogadoResponsavel; (c.serviceTypes||[]).forEach(s=>this.createServiceTag(s.name,s.deadline,s.status)); if(this.isUserAdmin){document.getElementById('valorTotal').value=c.totalValue;}} this.openModal('modalContrato'); }
			openPaymentModal(id, idx) { const c=this.database.contracts.find(x=>x.id===id), p=c.parcels[idx]; document.getElementById('pagamentoContractId').value=id; document.getElementById('pagamentoParcelIndex').value=idx; document.getElementById('pagamentoInfo').textContent=`${c.clientName} - P.${p.number}`; document.getElementById('pagamentoValor').value=p.value; this.openModal('modalPagamento'); }
			openClientHistoryModal(name) { const l=this.database.contracts.filter(c=>c.clientName===name); const d=document.getElementById('clienteModalContent'); d.innerHTML=''; l.forEach(c=>{d.innerHTML+=`<div class="bg-gray-700 p-2 rounded mb-2"><b class="text-white">${c.clientName}</b> - ${Utils.formatCurrency(c.totalValue)}</div>`}); this.openModal('modalCliente'); }
			openReportModal() { if(this.isUserAdmin) { const m=document.getElementById('reportMonth'); if(m.options.length===0){['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].forEach((x,i)=>m.add(new Option(x,i)));for(let i=new Date().getFullYear();i>=2020;i--)document.getElementById('reportYear').add(new Option(i,i));} this.openModal('modalRelatorio'); this.generateAndShowReport(); } }
			openExitoModal(id) { document.getElementById('exitoContractId').value=id; this.openModal('modalExito'); }
			createServiceTag(n,d,s) { this.domBuilder.createServiceTag(n,d,s); } // Chama do Builder
			
			renderNotificationDropdown() { const l=document.getElementById('notification-list'); l.innerHTML=''; this.database.notifications.forEach(n=>l.append(this.domBuilder.createNotificationItem(n))); document.getElementById('notification-badge').classList.toggle('hidden', this.database.notifications.filter(x=>!x.isRead).length===0); }
			async markNotificationsAsRead(ids) { await this.firebaseService.markNotificationsAsRead(this.currentSafeName, ids||this.database.notifications.filter(x=>!x.isRead).map(x=>x.id)); }
			closeNotificationDropdown() { document.getElementById('notification-dropdown').classList.add('hidden'); }
			showAnalyticsInModal() { document.getElementById('reportResult').classList.add('hidden'); document.getElementById('reportChartsContainer').classList.remove('hidden'); const c = this.getFilteredContracts(true); const d1 = this.reportHandler.getActualIncomeData(c); this.analyticsHandler.renderChart('actualIncomeChartModal', 'bar', d1.labels, d1.data, 'Fatura√ß√£o', '#4ade80'); const d2 = this.reportHandler.getProjectedIncomeData(c); this.analyticsHandler.renderChart('projectedIncomeChartModal', 'bar', d2.labels, d2.data, 'Proje√ß√£o', '#8b5cf6'); }
			
			// Exporta√ß√£o CSV Completa
			exportReportCSV() {
				if(!this.isUserAdmin) return;
				const m = parseInt(document.getElementById('reportMonth').value); const y = parseInt(document.getElementById('reportYear').value);
				const d = this.reportHandler.calculateMonthlyIncome(y, m, this.getFilteredContracts(true));
				
				let rows = ["Tipo de Lista,Cliente,Descri√ß√£o,Data,Valor"];
				// Adiciona Pagos
				d.detailedPayments.forEach(p => rows.push(`"PAGO",${this._fCSV(p.clientName)},${p.type},${Utils.formatDate(p.date)},${p.value}`));
				// Adiciona Pendentes
				d.pendingPayments.forEach(p => rows.push(`"PENDENTE",${this._fCSV(p.clientName)},${p.type},${Utils.formatDate(p.date)},${p.value}`));
				
				this._dlCSV(rows.join('\n'), `relatorio_${m+1}_${y}.csv`);
			}
			exportContractsCSV() {
				const r = ["ID,Cliente,Advogado,Valor Total,Status"];
				this.getFilteredContracts(false).forEach(c => r.push([c.id, this._fCSV(c.clientName), this._fCSV(c.advogadoResponsavel), c.totalValue, this.getContractStatus(c).statusText].join(',')));
				this._dlCSV(r.join('\n'), 'contratos.csv');
			}
			_fCSV(s) { if (s == null) return ''; let str = String(s); if (str.includes(',')) str = `"${str}"`; return str; }
			_dlCSV(c, n) { const b = new Blob(["\uFEFF" + c], { type: 'text/csv;charset=utf-8;' }); const l = document.createElement("a"); l.href = URL.createObjectURL(b); l.download = n; document.body.appendChild(l); l.click(); document.body.removeChild(l); }

			_setupModalAccessibility() { document.addEventListener('keydown', e=>{if(e.key==='Escape')this.closeModal(this.openModalId)}); }
		}

		document.addEventListener('DOMContentLoaded', () => {
			const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
			s.onload = () => { window.App = new App(); window.App.initialize(); };
			document.head.appendChild(s);
		});
	</script>
</body>
</html>
