<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sistema de Gest√£o Financeira - Advocacia</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<style>
		
		body {
			font-family: 'Inter', sans-serif;
			position: relative;
			background-color: #0f172a;
			color: #d1d5db;
		}
		body::after {
			content: '';
			position: fixed;
			z-index: -1;
			top: 0; left: 0; right: 0; bottom: 0;
			background-image: url('https://i.postimg.cc/x81V8QJg/Imagem-do-Whats-App-de-2025-10-27-a-s-09-49-28-f966cd35.jpg');
			background-repeat: no-repeat;
			background-size: cover;
			background-position: center center;
			opacity: 0.12;
		}
		.modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 9000; }
		.modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9001; max-height: 90vh; overflow-y: auto; }
		.kanban-column { min-width: 320px; }
		.kanban-content { max-height: 60vh; overflow-y: auto; padding-right: 8px; }
		::-webkit-scrollbar { width: 8px; }
		::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
		::-webkit-scrollbar-thumb:hover { background: #6b7280; }
		.service-tag { display: inline-flex; justify-content: space-between; align-items: center; background-color: #374151; color: #d1d5db; padding: 4px 10px; border-radius: 12px; font-size: 14px; margin-right: 4px; margin-bottom: 4px; width: 100%; }
		.service-tag-small { display: inline-block; background-color: #374151; color: #9ca3af; padding: 2px 8px; border-radius: 9999px; font-size: 12px; margin-right: 4px; margin-bottom: 4px; }
		.service-tag .remove-tag { margin-left: 8px; cursor: pointer; font-weight: bold; }
		.nav-tab { cursor: pointer; padding: 10px 20px; border-bottom: 3px solid transparent; color: #9ca3af; transition: all 0.2s; }
		.nav-tab:hover { color: #e5e7eb; }
		.nav-tab.active { border-bottom-color: #6366f1; color: #e5e7eb; }
		.nav-tab-icon { cursor: pointer; padding: 10px 15px; color: #9ca3af; transition: all 0.2s; }
		.nav-tab-icon:hover { color: #e5e7eb; }
		.nav-tab-icon.active { color: #6366f1; }
		.progress-bar-bg { background-color: #374151; border-radius: 9999px; overflow: hidden; }
		.progress-bar { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
		.dark-card { background-color: #1f2937; border: 1px solid #374151; }
		.header-with-logo { position: relative; display: flex; justify-content: space-between; align-items: center; }
		.header-user-block { margin-right: 160px; }
		.header-logo { position: absolute; right: 0; top: 50%; transform: translateY(-50%); max-height: 60px; opacity: 0.8; }
		.sort-button, .filter-button { background-color: #374151; border: 1px solid #4b5563; color: #9ca3af; padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
		.sort-button:hover, .filter-button:hover { background-color: #4b5563; color: white; }
		.sort-button.active, .filter-button.active { background-color: #4f46e5; border-color: #4f46e5; color: white; }
		.filter-select { background-color: #374151; border: 1px solid #4b5563; color: #9ca3af; padding: 8px 12px; border-radius: 6px; font-size: 14px; }
		.filter-select:disabled { background-color: #4b5563; opacity: 0.7; cursor: not-allowed; }

		/* --- Bloco Corrigido (Login/Loading) --- */
		#loading-overlay { 
			position: fixed; 
			top: 0; left: 0; 
			width: 100%; height: 100%; 
			background-color: rgba(17, 24, 39, 0.9); 
			display: flex; 
			justify-content: center; 
			align-items: center; 
			z-index: 10000; 
			color: white; 
			font-size: 1.2rem; 
			transition: opacity 0.3s; 
		}
		/* As regras CSS antigas para #auth-overlay foram removidas */
		#app-container { display: none; }
		/* --- Fim da Corre√ß√£o --- */

		.admin-only { display: none; }
		body.is-admin .admin-only { display: block; }
		body.is-admin .flex.admin-only { display: flex; }
		body:not(.is-admin) .non-admin-hidden { display: none; }
		
		/* CSS antigo do .login-modal n√£o √© mais necess√°rio */
		.login-modal { }

		@keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -60%); } to { opacity: 1; transform: translate(-50%, -50%); } }
		.notification { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 11000; animation: slideIn 0.3s ease; }
		@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
		body.light-theme { background-color: #f8fafc; color: #1e293b; }
		body.light-theme .dark-card { background-color: #ffffff; border-color: #e2e8f0; }
		body.light-theme .login-modal { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); }
		@media (max-width: 768px) { .kanban-column { min-width: 100%; } .header-user-block { margin-right: 0; } }

		/* === IN√çCIO: ESTILOS DE PAGINA√á√ÉO === */
		.pagination-button {
			background-color: #374151;
			border: 1px solid #4b5563;
			color: #9ca3af;
			padding: 6px 12px;
			border-radius: 6px;
			font-size: 14px;
			cursor: pointer;
			transition: all 0.2s;
			font-weight: 500;
		}
		.pagination-button:hover:not(:disabled) {
			background-color: #4b5563;
			color: white;
		}
		.pagination-button.active {
			background-color: #4f46e5;
			border-color: #4f46e5;
			color: white;
			cursor: default;
		}
		.pagination-button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		#paginationContainer span {
			padding: 6px 4px;
			font-size: 14px;
			color: #6b7280;
		}
		/* === FIM: ESTILOS DE PAGINA√á√ÉO === */

		/* === IN√çCIO: ESTILOS (UX/TRANSI√á√ïES) === */
		.modal input, .modal select, .modal textarea {
			transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
		}
		.modal button {
			transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
		}
		.modal button:hover:not(:disabled) {
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.2);
		}
		/* === FIM: ESTILOS (UX/TRANSI√á√ïES) === */
		
		/* === IN√çCIO: ESTILOS (NOVO LOGIN) === */
		@keyframes blob {
			0%, 100% { transform: translate(0, 0) scale(1); }
			33% { transform: translate(30px, -50px) scale(1.1); }
			66% { transform: translate(-20px, 20px) scale(0.9); }
		}
		.animate-blob {
			animation: blob 7s infinite;
			animation: blob 7s infinite;
		}
	<body class="text-gray-300">
	<div id="notifications"></div>

	<div id="loading-overlay">
		<i class="fas fa-spinner fa-spin mr-3"></i> A ligar...
	</div>

	<!-- [NOVO HTML DE LOGIN (Tradu√ß√£o do seu React)] -->
	<div id="auth-overlay" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 relative overflow-hidden px-4">
		<!-- Efeito de Fundo -->
		<div class="absolute inset-0 opacity-5">
			<div class="absolute inset-0 bg-[url('https://i.postimg.cc/x81V8QJg/Imagem-do-Whats-App-de-2025-10-27-a-s-09-49-28-f966cd35.jpg')] bg-cover bg-center"></div>
		</div>
	
		<!-- Elementos Decorativos -->
		<div class="absolute top-0 left-1/2 -translate-x-1/2 w-96 h-96 bg-blue-500 rounded-full mix-blend-screen filter blur-3xl opacity-10 animate-blob"></div>
		<div class="absolute bottom-0 right-1/4 w-96 h-96 bg-indigo-500 rounded-full mix-blend-screen filter blur-3xl opacity-10 animate-blob" style="animation-delay: 2s;"></div>
	
		<div class="relative z-10 w-full max-w-md">
			<!-- Log√≥tipo e Cabe√ßalho -->
			<div class="mb-8 text-center">
				<img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Log√≥tipo Fabris e Gurj√£o" class="h-24 mx-auto mb-6 drop-shadow-lg" />
				<h1 class="text-3xl font-bold text-white mb-2">
					Sistema Financeiro
				</h1>
				<p class="text-gray-300 text-sm">
					Gest√£o profissional para advocacia
				</p>
			</div>
	
			<!-- Cart√£o de Login -->
			<div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-8 shadow-2xl">
				<!-- Mantive o ID "login-form" para o JS funcionar -->
				<form id="login-form" class="space-y-5">
					<!-- Input de Email -->
					<div>
						<label for="login-email" class="block text-sm font-medium text-gray-100 mb-2">
							Email
						</label>
						<div class="relative">
							<!-- Usei FontAwesome (que j√° temos) no lugar do Lucide-React -->
							<i class="fas fa-envelope absolute left-3 top-3.5 text-gray-400"></i>
							<input type="email"
								   id="login-email"
								   placeholder="seu@email.com"
								   class="w-full pl-10 pr-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
								   required />
						</div>
					</div>
	
					<!-- Input de Senha -->
					<div>
						<label for="login-password" class="block text-sm font-medium text-gray-100 mb-2">
							Senha
						</label>
						<div class="relative">
							<!-- Usei FontAwesome (que j√° temos) no lugar do Lucide-React -->
							<i class="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
							<input type="password"
								   id="login-password"
								   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
								   class="w-full pl-10 pr-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
								   required />
						</div>
					</div>
	
					<!-- Mensagem de Erro (Mantive o ID "auth-error" e apliquei o seu novo estilo) -->
					<div id="auth-error" class="hidden p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200 text-sm">
						<!-- O JS vai preencher o erro aqui -->
					</div>
	
					<!-- Bot√£o de Submeter -->
					<button type="submit"
							id="login-submit-button"
							class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold rounded-lg transition duration-200 flex items-center justify-center gap-2 mt-6">
						<!-- Usei FontAwesome (que j√° temos) no lugar do Lucide-React -->
						<i id="login-button-icon" class="fas fa-sign-in-alt"></i>
						<span id="login-button-text">Entrar no Sistema</span>
					</button>
				</form>
	
				<!-- Rodap√© -->
				<div class="mt-6 text-center text-gray-400 text-xs">
					<p>Acesso restrito a utilizadores autorizados</p>
				</div>
			</div>
		</div>
	</div>
	<!-- [FIM DO NOVO HTML DE LOGIN] -->


	<div id="app-container" class="container mx-auto p-4 md:p-8" aria-hidden="false">
		<header class="mb-6 header-with-logo">
			<div>
				<h1 class="text-3xl font-bold text-white">Painel de Gest√£o</h1>
				<p class="text-gray-400">Controlo Financeiro e de Produ√ß√£o do Escrit√≥rio</p>
			</div>
			<div class="flex items-center header-user-block">
				<span id="user-display-name" class="text-sm text-gray-300 font-medium mr-4"></span>
				<button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg shadow-md text-sm flex items-center gap-2">
					<i class="fas fa-sign-out-alt"></i> Sair
				</button>
			</div>
			<img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Log√≥tipo Fabris e Gurj√£o" class="header-logo">
		</header>
		<div class="border-b border-gray-700 mb-8">
			<nav class="flex justify-between items-center -mb-px">
				<div class="flex">
					<a onclick="window.App.showPage('page-dashboard')" id="tab-dashboard" class="nav-tab active">
						<i class="fas fa-tachometer-alt mr-2"></i>Painel Principal
					</a>
					<a onclick="window.App.showPage('page-inadimplentes')" id="tab-inadimplentes" class="nav-tab">
						<i class="fas fa-exclamation-triangle mr-2"></i>Inadimplentes
					</a>
					<a onclick="window.App.showPage('page-servicos')" id="tab-servicos" class="nav-tab">
						<i class="fas fa-tasks mr-2"></i>Servi√ßos
					</a>
				</div>
				<div>
					<a onclick="window.App.showPage('page-lixeira')" id="tab-lixeira" class="nav-tab-icon" title="Lixeira" aria-label="Abrir Lixeira">
						<i class="fas fa-trash-alt"></i>
					</a>
				</div>
			</nav>
		</div>

		<div id="page-dashboard">
			<div class="flex flex-wrap gap-4 mb-8">
				<button onclick="window.App.openContractModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
					<i class="fas fa-plus-circle"></i> Novo Contrato
				</button>
				<button onclick="window.App.openReportModal()" class="admin-only bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
					<i class="fas fa-chart-line"></i> Relat√≥rio Mensal
				</button>
			</div>

			<div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
				<div class="dark-card p-6 rounded-lg shadow-lg admin-only">
					<h3 class="text-lg font-semibold text-gray-400">A Receber (Pr√≥x. 30 dias)</h3>
					<p id="dash-a-receber" class="text-3xl font-bold text-green-400"></p>
				</div>
				<div class="dark-card p-6 rounded-lg shadow-lg admin-only">
					<h3 class="text-lg font-semibold text-gray-400">Vencido (Corrigido)</h3>
					<p id="dash-vencido" class="text-3xl font-bold text-red-400"></p>
				</div>
				<div class="dark-card p-6 rounded-lg shadow-lg admin-only">
					<h3 class="text-lg font-semibold text-gray-400">Recebido (Este M√™s)</h3>
					<p id="dash-recebido" class="text-3xl font-bold text-indigo-400"></p>
				</div>
				<div class="dark-card p-6 rounded-lg shadow-lg">
					<h3 class="text-lg font-semibold text-gray-400">Meus Contratos Ativos</h3>
					<p id="dash-contratos" class="text-3xl font-bold text-white"></p>
				</div>
			</div>

			<div class="mb-4 border-b border-gray-700">
				<h2 class="text-2xl font-semibold mb-4 text-white">Situa√ß√£o das Parcelas (Meus Contratos)</h2>
			</div>

			<div id="kanban-board" class="flex overflow-x-auto space-x-4 pb-4">
				<div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
					<h3 class="font-bold text-lg mb-4 text-red-400 flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i>Vencidas</h3>
					<div id="kanban-vencidas" class="kanban-content space-y-3"></div>
				</div>
				<div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
					<h3 class="font-bold text-lg mb-4 text-yellow-400 flex items-center gap-2"><i class="far fa-clock"></i>A Vencer (Pr√≥x. 30 dias)</h3>
					<div id="kanban-a-vencer" class="kanban-content space-y-3"></div>
				</div>
				<div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
					<h3 class="font-bold text-lg mb-4 text-gray-400 flex items-center gap-2"><i class="fas fa-check-circle"></i>Pagas (Este M√™s)</h3>
					<div id="kanban-pagas" class="kanban-content space-y-3"></div>
				</div>
				<div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
					<h3 class="font-bold text-lg mb-4 text-indigo-400 flex items-center gap-2"><i class="fas fa-gavel"></i>Aguardando √äxito</h3>
					<div id="kanban-exito" class="kanban-content space-y-3"></div>
				</div>
			</div>

			<div class="mt-12">
				<div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-4">
					<h2 class="text-2xl font-semibold text-white">Meus Contratos</h2>
					<div class="flex items-center gap-4">
						<button onclick="window.App.exportContractsCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2 text-sm">
							<i class="fas fa-file-csv"></i> Exportar (CSV)
						</button>
						<select id="advogadoFilter" onchange="window.App.resetAndRenderContractList()" class="filter-select admin-only"></select>
						<div class="flex items-center gap-2">
							<span class="text-sm text-gray-400">Ordenar por:</span>
							<div id="contractSortButtons" class="flex gap-1"></div>
						</div>
					</div>
				</div>
				<div class="mb-4">
					<input type="text" id="searchInput" placeholder="üîé Pesquisar por cliente ou tipo de servi√ßo..." class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
				</div>
				<div id="contractListContainer"></div>
				
				<div id="paginationContainer" class="flex justify-center items-center gap-2 mt-8">
					</div>
				</div>
		</div>

		<div id="page-inadimplentes" class="hidden">
			<div class="flex justify-between items-center mb-4">
				<h2 class="text-2xl font-semibold text-white">Controlo de Inadimplentes (Meus Contratos)</h2>
				<div class="flex items-center gap-2">
					<span class="text-sm text-gray-400">Ordenar por:</span>
					<div id="inadimplentesSortButtons" class="flex gap-1"></div>
				</div>
			</div>
			<div id="inadimplentesListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
		</div>

		<div id="page-servicos" class="hidden">
			<div class="flex justify-between items-center mb-4">
				<h2 class="text-2xl font-semibold text-white">Controlo de Produ√ß√£o de Servi√ßos (Meus Contratos)</h2>
				<div class="flex items-center gap-4">
					<select id="servicosAdvogadoFilter" onchange="window.App.renderServicosPage()" class="filter-select admin-only"></select>
					<div class="flex items-center gap-2">
						<span class="text-sm text-gray-400">Ordenar por:</span>
						<div id="servicosSortButtons" class="flex gap-1"></div>
					</div>
					<input type="text" id="servicosSearchInput" placeholder="üîé Pesquisar..." class="w-full md:w-auto p-2 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
				</div>
			</div>
			<div id="servicosListContainer" class="space-y-6"></div>
		</div>

		<div id="page-lixeira" class="hidden">
			<div class="flex justify-between items-center mb-4">
				<h2 class="text-2xl font-semibold text-white">Lixeira de Contratos</h2>
			</div>
			<p class="text-gray-400 mb-6">Contratos exclu√≠dos s√£o mantidos aqui. Pode restaur√°-los ou exclu√≠-los permanentemente (apenas admins).</p>
			<div id="lixeiraListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
		</div>
	</div>
		<!-- [MUDAN√áA ARIA]: role, aria-modal, aria-labelledby -->
	<div id="modalDisplayName" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3" role="dialog" aria-modal="true" aria-labelledby="modalDisplayNameTitle">
		<div class="p-6">
			<h2 id="modalDisplayNameTitle" class="text-2xl font-bold text-white mb-4">Bem-vindo(a)!</h2>
			<p class="text-gray-400 mb-4">Percebemos que √© o seu primeiro acesso. Como gostaria de ser chamado(a)?</p>
			<form id="formDisplayName">
				<div class="mb-4">
					<label for="inputDisplayName" class="block text-sm font-medium text-gray-400">O seu Nome de Exibi√ß√£o</label>
					<input type="text" id="inputDisplayName" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
				</div>
				<button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Guardar e Entrar</button>
			</form>
		</div>
	</div>

	<!-- [MUDAN√áA ARIA]: role, aria-modal, aria-labelledby -->
	<div id="modalContrato" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-2/5" role="dialog" aria-modal="true" aria-labelledby="modalContratoTitle">
		<div class="p-6">
			<div class="flex justify-between items-center mb-4">
				<h2 id="modalContratoTitle" class="text-2xl font-bold text-white">Registar Novo Contrato</h2>
				<button onclick="window.App.closeModal('modalContrato')" class="text-gray-400 hover:text-white text-2xl" aria-label="Fechar modal">&times;</button>
			</div>
			<form id="formContrato">
				<input type="hidden" id="contractId">
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
					<div>
						<label for="clienteNome" class="block text-sm font-medium text-gray-400">Nome do Cliente</label>
						<input type="text" id="clienteNome" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
					</div>
					<div>
						<label for="advogadoResponsavel" class="block text-sm font-medium text-gray-400">Advogado Respons√°vel</label>
						<select id="advogadoResponsavel" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required></select>
					</div>
				</div>
				<div class="mb-4">
					<label class="block text-sm font-medium text-gray-400">Adicionar Servi√ßos</label>
					<div id="servicosContainerWrapper" class="mt-1 p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm">
						<div id="servicosContainer" class="flex flex-wrap items-center gap-1 w-full mb-2">
							</div>
						<div class="flex gap-2">
							<input type="text" id="contratoServicoInput" class="flex-grow outline-none bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="Nome do Servi√ßo...">
							<input type="date" id="contratoPrazoInput" class="bg-gray-800 border border-gray-600 rounded-md shadow-sm text-gray-400 px-3 py-2" style="color-scheme: dark;">
							<button type="button" id="addServiceButton" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-3 rounded-lg">Adicionar</button>
						</div>
					</div>
				</div>
				<div class="mb-4">
					<label for="contratoTipoPagamento" class="block text-sm font-medium text-gray-400">Modalidade de Pagamento</label>
					<select id="contratoTipoPagamento" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
						<option>Parcelado</option>
						<option>Pr√≥-labore</option>
						<option>Entrada √∫nica</option>
					</select>
				</div>
				<div class="mb-4">
					<label for="contratoObservacoes" class="block text-sm font-medium text-gray-400">Observa√ß√µes</label>
					<textarea id="contratoObservacoes" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" placeholder="Detalhes da negocia√ß√£o, informa√ß√µes do caso, etc..."></textarea>
				</div>
				
				<div class="admin-only">
					<h3 class="text-lg font-semibold mb-2 border-t border-gray-700 pt-4 text-white">Detalhes Financeiros</h3>
					
					<div class="mb-4 p-3 bg-gray-900/50 rounded-lg border border-gray-700">
						<label for="contratoJaQuitado" class="flex items-center">
							<input type="checkbox" id="contratoJaQuitado" class="h-4 w-4 bg-gray-700 border-gray-600 rounded text-indigo-600 focus:ring-indigo-500">
							<span class="ml-2 text-sm font-medium text-gray-300">Marcar valor fixo como j√° quitado (contrato antigo)</span>
						</label>
						<p class="text-xs text-gray-500 ml-6 mt-1">Isto criar√° 1 parcela √∫nica j√° "Paga" com o Valor Total. Deixe o N¬∞ de Parcelas como 1.</p>
					</div>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div class="mb-4">
							<label for="valorTotal" class="block text-sm font-medium text-gray-400">Valor Fixo Total (R$)</label>
							<input type="number" step="0.01" id="valorTotal" placeholder="0 se for s√≥ √™xito" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white">
						</div>
						<div class="mb-4">
							<label for="numParcelas" class="block text-sm font-medium text-gray-400">N¬∞ de Parcelas</label>
							<input type="number" id="numParcelas" placeholder="1 para '√Ä Vista'" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" value="1">
						</div>
					</div>
					<div class="mb-4">
						<label for="vencimentoPrimeiraParcela" class="block text-sm font-medium text-gray-400">Vencimento da 1¬™ Parcela</label>
						<input type="date" id="vencimentoPrimeiraParcela" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" style="color-scheme: dark;">
					</div>
					<div class="mb-4">
						<label for="taxaExito" class="block text-sm font-medium text-gray-400">Taxa de √äxito (Bonifica√ß√£o)</label>
						<input type="text" id="taxaExito" placeholder="Ex: 20%, 10000, 5 SALARIOS" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white">
					</div>
				</div>

				<div class="flex justify-end mt-6">
					<button type="button" onclick="window.App.closeModal('modalContrato')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
					<button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
				</div>
			</form>
		</div>
	</div>

	<!-- [MUDAN√áA ARIA]: role, aria-modal, aria-labelledby -->
	<div id="modalPagamento" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3" role="dialog" aria-modal="true" aria-labelledby="modalPagamentoTitle">
		<div class="p-6">
			<div class="flex justify-between items-center mb-4">
				<h2 id="modalPagamentoTitle" class="text-2xl font-bold text-white">Registar Pagamento</h2>
				<button onclick="window.App.closeModal('modalPagamento')" class="text-gray-400 hover:text-white text-2xl" aria-label="Fechar modal">&times;</button>
			</div>
			<form id="formPagamento">
				<div id="pagamentoInfo" class="mb-4 bg-gray-700 p-3 rounded-md text-white"></div>
				<div class="mb-4">
					<label for="pagamentoValor" class="block text-sm font-medium text-gray-400">Valor Pago (R$)</label>
					<input type="number" step="0.01" id="pagamentoValor" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required>
				</div>
				<div class="mb-4">
					<label for="pagamentoData" class="block text-sm font-medium text-gray-400">Data do Pagamento</label>
					<input type="date" id="pagamentoData" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required style="color-scheme: dark;">
				</div>
				<input type="hidden" id="pagamentoContractId">
				<input type="hidden" id="pagamentoParcelIndex">
				<div class="flex justify-end mt-6">
					<button type="button" onclick="window.App.closeModal('modalPagamento')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
					<button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Confirmar Pagamento</button>
				</div>
			</form>
		</div>
	</div>

	<!-- [MUDAN√áA ARIA]: role, aria-modal, aria-labelledby -->
	<div id="modalCliente" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3" role="dialog" aria-modal="true" aria-labelledby="clienteModalTitle">
		<div class="p-6">
			<div class="flex justify-between items-center mb-4">
				<h2 id="clienteModalTitle" class="text-2xl font-bold text-white"></h2>
				<button onclick="window.App.closeModal('modalCliente')" class="text-gray-400 hover:text-white text-2xl" aria-label="Fechar modal">&times;</button>
			</div>
			<div id="clienteModalContent" class="space-y-6"></div>
		</div>
	</div>

	<!-- [MUDAN√áA ARIA]: role, aria-modal, aria-labelledby -->
	<div id="modalRelatorio" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 admin-only" role="dialog" aria-modal="true" aria-labelledby="modalRelatorioTitle">
		<div class="p-6">
			<div class="flex justify-between items-center mb-6">
				<h2 id="modalRelatorioTitle" class="text-2xl font-bold text-white">Relat√≥rio e An√°lise</h2>
				<button onclick="window.App.closeModal('modalRelatorio')" class="text-gray-400 hover:text-white text-2xl" aria-label="Fechar modal">&times;</button>
			</div>
			<div class="flex gap-4 mb-4">
				<div class="flex-1">
					<label for="reportMonth" class="block text-sm font-medium text-gray-400">M√™s</label>
					<select id="reportMonth" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
				</div>
				<div class="flex-1">
					<label for="reportYear" class="block text-sm font-medium text-gray-400">Ano</label>
					<select id="reportYear" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
				</div>
			</div>
			<div class="flex gap-4 mb-6">
				<button onclick="window.App.generateAndShowReport()" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">
					<i class="fas fa-file-invoice-dollar mr-2"></i> Relat√≥rio
				</button>
				<button onclick="window.App.showAnalyticsInModal()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
					<i class="fas fa-chart-bar mr-2"></i> Gr√°ficos
				</button>
				<button onclick="window.App.exportReportCSV()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
					<i class="fas fa-file-csv mr-2"></i> Exportar (CSV)
				</button>
			</div>

			<div id="reportResult" class="space-y-4">
				</div>

			<div id="reportChartsContainer" class="hidden space-y-8">
				<div class="dark-card p-6 rounded-lg shadow-lg">
					<h3 class="text-lg font-semibold text-gray-300 mb-4">Fatura√ß√£o Real (√öltimos 12 Meses)</h3>
					<div class="relative" style="height: 350px;">
						<canvas id="actualIncomeChartModal"></canvas>
					</div>
				</div>
				<div class="dark-card p-6 rounded-lg shadow-lg">
					<h3 class="text-lg font-semibold text-gray-300 mb-4">Proje√ß√£o de Ganhos (Pr√≥ximos 12 Meses)</h3>
					<p class="text-sm text-gray-400 mb-4 -mt-3">(Baseado em parcelas pendentes)</p>
					<div class="relative" style="height: 350px;">
						<canvas id="projectedIncomeChartModal"></canvas>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- [MUDAN√áA ARIA]: role, aria-modal, aria-labelledby -->
	<div id="modalExito" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3" role="dialog" aria-modal="true" aria-labelledby="modalExitoTitle">
		<div class="p-6">
			<div class="flex justify-between items-center mb-4">
				<h2 id="modalExitoTitle" class="text-2xl font-bold text-white">Registar Recebimento de √äxito</h2>
				<button onclick="window.App.closeModal('modalExito')" class="text-gray-400 hover:text-white text-2xl" aria-label="Fechar modal">&times;</button>
			</div>
			<form id="formExito">
				<div id="exitoInfo" class="mb-4 bg-gray-700 p-3 rounded-md"></div>
				<div class="mb-4 admin-only">
					<label for="exitoValorRecebido" class="block text-sm font-medium text-gray-400">Valor L√≠quido Recebido (R$)</label>
					<input type="number" step="0.01" id="exitoValorRecebido" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" placeholder="Ex: 9500.00" required>
				</div>
				<p class="mb-4 text-gray-400 non-admin-hidden">Confirme o recebimento do valor de √™xito.</p>
				<input type="hidden" id="exitoContractId">
				<div class="flex justify-end mt-6">
					<button type="button" onclick="window.App.closeModal('modalExito')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
					<button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Guardar Recebimento</button>
				</div>
			</form>
		</div>
	</div>

	<div id="modal-backdrop" class="modal-backdrop"></div>

	<script type="module">
		// Imports do Firebase
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
		import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
		import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
		
		// Constantes Globais
		const ADMIN_USERS = ["Dra. Renata Fabris", "Dr. Felipe Gurj√£o", "Lilian"];
		const CONTRACTS_PER_PAGE = 12; // Itens por p√°gina
		
		// Objeto de Utilit√°rios (Refatorado para ser independente)
		const Utils = {
			toastContainer: null,
			initToast() {
				if (this.toastContainer) return;
				const el = document.createElement('div');
				el.id = 'toast-container';
				el.style.position = 'fixed';
				el.style.bottom = '20px';
				el.style.right = '20px';
				el.style.zIndex = '11000';
				el.style.display = 'flex';
				el.style.flexDirection = 'column';
				el.style.gap = '8px';
				document.body.appendChild(el);
				this.toastContainer = el;
			},
			showToast(message, type = 'info') {
				this.initToast();
				const n = document.createElement('div');
				n.className = 'px-4 py-3 rounded-lg shadow-lg text-sm';
				n.style.background = type === 'error' ? '#7f1d1d' : (type === 'success' ? '#065f46' : '#374151');
				n.style.color = '#fff';
				n.setAttribute('role', 'alert'); // Acessibilidade
				n.textContent = message;
				this.toastContainer.appendChild(n);
				setTimeout(() => n.remove(), 2500);
			},
			debounce(fn, ms = 300) {
				let t;
				return (...args) => {
					clearTimeout(t);
					t = setTimeout(() => fn(...args), ms);
				};
			},
			sanitizeText(s) {
				if (s == null) return ''; // Trata null e undefined
				const str = String(s);
				const div = document.createElement('div');
				div.textContent = str;
				return div.innerHTML.replace(/"/g, '&quot;').replace(/'/g, '&#39;').trim();
			},
			parseNumber(n) {
				const v = Number(n);
				return Number.isFinite(v) ? v : 0;
			},
			confirm(message) {
				return new Promise((resolve) => {
					let modal = document.getElementById('confirmModal');
					if (!modal) {
						modal = document.createElement('div');
						modal.id = 'confirmModal';
						modal.innerHTML = `
		<div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:12000" role="alertdialog" aria-modal="true" aria-labelledby="confirmMessage">
		<div class="dark-card" style="width:100%;max-width:420px;border-radius:12px;border:1px solid #374151;padding:16px;background:#111827">
		<p id="confirmMessage" class="text-gray-200 mb-4"></p>
		<div class="flex justify-end gap-2">
			<button id="confirmCancel" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
			<button id="confirmOk" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
		</div>
		</div>
		</div>`;
						document.body.appendChild(modal);
					}
					modal.querySelector('#confirmMessage').textContent = message;
					modal.style.display = 'block';
					const onClose = (val) => { modal.style.display = 'none'; resolve(val); };
					modal.querySelector('#confirmCancel').onclick = () => onClose(false);
					modal.querySelector('#confirmOk').onclick = () => onClose(true);
				});
			},
			formatCurrency(value) {
				return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
			},
			formatDate(dateStr) {
				if (!dateStr) return '';
				const date = new Date(dateStr);
				return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
			}
		};
		
		/**
		 * @class CorrectionCalculator
		 * @description Encapsula a l√≥gica de c√°lculo de corre√ß√£o (IPCA + Juros)
		 */
		class CorrectionCalculator {
			constructor() {
				this.ipcaWindowCache = new Map();
				this.ipcaErrorToastShown = false; // [CORRE√á√ÉO] Trava para o spam de toast de erro
			}
		
			toUTCDate(y, m, d) { const dt = new Date(Date.UTC(y, m, d)); dt.setUTCHours(0,0,0,0); return dt; }
			startOfMonthUTC(d) { return this.toUTCDate(d.getUTCFullYear(), d.getUTCMonth(), 1); }
			endOfMonthUTC(d) { return this.toUTCDate(d.getUTCFullYear(), d.getUTCMonth() + 1, 0); }
			
			diffMonths_30_360(fromDate, toDate) {
				let y1 = fromDate.getUTCFullYear(), m1 = fromDate.getUTCMonth() + 1, d1 = fromDate.getUTCDate();
				let y2 = toDate.getUTCFullYear(), m2 = toDate.getUTCMonth() + 1, d2 = toDate.getUTCDate();
				if (d1 === 31) d1 = 30;
				if (d2 === 31 && d1 === 30) d2 = 30;
				return Math.max(0, (y2 - y1) * 12 + (m2 - m1) + (d2 - d1) / 30);
			}
		
			async fetchIPCAAccumulatedFactor(vencDate, refDate = new Date()) {
				const start = this.startOfMonthUTC(vencDate);
				const refMonth = this.startOfMonthUTC(refDate);
				const endPrevMonth = this.endOfMonthUTC(this.toUTCDate(refMonth.getUTCFullYear(), refMonth.getUTCMonth(), 1 - 1));
				
				if (start.getTime() > endPrevMonth.getTime()) return 1;
		
				const toApiDate = (d) => {
					const dd = String(d.getUTCDate()).padStart(2,'0');
					const mm = String(d.getUTCMonth()+1).padStart(2,'0');
					const yyyy = d.getUTCFullYear();
					return `${dd}/${mm}/${yyyy}`;
				};
				
				const cacheKey = `${start.getUTCFullYear()}-${String(start.getUTCMonth()+1).padStart(2,'0')}..${endPrevMonth.getUTCFullYear()}-${String(endPrevMonth.getUTCMonth()+1).padStart(2,'0')}`;
				if (this.ipcaWindowCache.has(cacheKey)) return this.ipcaWindowCache.get(cacheKey);
		
				const base = 'https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados';
				const url = `${base}?formato=json&dataInicial=${toApiDate(start)}&dataFinal=${toApiDate(endPrevMonth)}`;
				const proxy = 'https://api.allorigins.win/get?url=';
		
				try {
					const resp = await fetch(`${proxy}${encodeURIComponent(url)}`);
					if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
					let data = await resp.json();
					data = JSON.parse(data.contents);
					
					const factor = (data || []).reduce((acc, item) => {
						const v = parseFloat(item?.valor);
						return Number.isFinite(v) ? acc * (1 + v/100) : acc;
					}, 1);
					
					const finalFactor = factor || 1;
					this.ipcaWindowCache.set(cacheKey, finalFactor);
					return finalFactor;
				} catch (e) {
					console.error('Falha ao buscar IPCA:', e);
					
					// [CORRE√á√ÉO] Acalma o "spam" de alertas de erro do IPCA
					if (!this.ipcaErrorToastShown) {
						Utils.showToast('Falha ao buscar √≠ndice IPCA. A corre√ß√£o pode estar incompleta.', 'error');
						this.ipcaErrorToastShown = true; // Ativa a trava
						
						// Reseta a trava depois de 1 minuto
						setTimeout(() => { this.ipcaErrorToastShown = false; }, 60000); 
					}
					
					return 1;
				}
			}
			
			async calcularValorCorrigido(valorOriginal, dataVencimento, dataReferencia = new Date()) {
				const ref = this.toUTCDate(dataReferencia.getUTCFullYear(), dataReferencia.getUTCMonth(), dataReferencia.getUTCDate());
				const vRaw = new Date(dataVencimento);
				const venc = this.toUTCDate(vRaw.getUTCFullYear(), vRaw.getUTCMonth(), vRaw.getUTCDate());
				
				if (ref <= venc) return valorOriginal;
		
				// 1. Corre√ß√£o (IPCA)
				const ipcaFactor = await this.fetchIPCAAccumulatedFactor(venc, ref);
				
				// 2. Juros (1% a.m. simples)
				const meses = this.diffMonths_30_360(venc, ref);
				const jurosSimplesFactor = 1 + 0.01 * meses;
				
				return valorOriginal * ipcaFactor * jurosSimplesFactor;
			}
		}
		
		/**
		 * @class AuthService
		 * @description Gerencia a autentica√ß√£o com o Firebase
		 */
		class AuthService {
			constructor(appInstance) {
				this.app = appInstance; // Refer√™ncia √† inst√¢ncia principal do App
				this.auth = null;
				this.firebaseConfig = {
					apiKey: "AIzaSyA0TWb7DgZAHNl3TuoK3xQD-ANvCcQIDK4",
					authDomain: "fabrisgurjao.firebaseapp.com",
					projectId: "fabrisgurjao",
					storageBucket: "fabrisgurjao.firebasestorage.app",
					messagingSenderId: "466702265991",
					appId: "1:466702265991:web:78c4d98b47cab537921222",
					measurementId: "G-E99R5TFMQK"
				};
			}
		
			initialize() {
				try {
					const firebaseApp = initializeApp(this.firebaseConfig);
					this.auth = getAuth(firebaseApp);
					setLogLevel('debug');
					
					const db = getFirestore(firebaseApp); // O DB √© inicializado aqui
					this.app.firebaseService.setDB(db); // E passado para o FirebaseService
		
					this.setupAuthListener();
				} catch (error) {
					console.error("Erro na inicializa√ß√£o do Firebase:", error);
					document.getElementById('loading-overlay').textContent = "Erro ao conectar.";
				}
			}
		
			setupAuthListener() {
				onAuthStateChanged(this.auth, (user) => {
					this.app.handleAuthStateChange(user);
				});
			}
		
			async login(email, password) {
				const authError = document.getElementById('auth-error');
				authError.classList.add('hidden');
				
				// [NOVO] L√≥gica de loading do bot√£o de login
				const loginButton = document.getElementById('login-submit-button');
				const buttonText = document.getElementById('login-button-text');
				const buttonIcon = document.getElementById('login-button-icon');
				
				if (loginButton) loginButton.disabled = true;
				if (buttonText) buttonText.textContent = "A entrar...";
				if (buttonIcon) buttonIcon.className = "fas fa-spinner fa-spin";
		
				try {
					await signInWithEmailAndPassword(this.auth, email, password);
					// O onAuthStateChanged vai tratar do resto
				
				} catch (error) {
					const showAuthError = (m) => { authError.textContent = m; authError.classList.remove('hidden'); };
					if (['auth/invalid-credential', 'auth/wrong-password', 'auth/user-not-found'].includes(error.code)) {
						showAuthError('Email ou senha inv√°lidos.');
					} else {
						showAuthError('Erro ao tentar fazer login.');
						console.error("Erro de login:", error.code, error.message);
					}
				} finally {
					// [NOVO] Reverte o estado do bot√£o
					if (loginButton) loginButton.disabled = false;
					if (buttonText) buttonText.textContent = "Entrar no Sistema";
					if (buttonIcon) buttonIcon.className = "fas fa-sign-in-alt";
				}
			}
		
			async logout() {
				try {
					await signOut(this.auth);
				} catch (error) {
					console.error("Erro ao fazer logout:", error);
					Utils.showToast('Erro ao tentar sair.', 'error');
				}
			}
		
			async updateUserProfile(displayName) {
				if (!this.auth.currentUser) return false;
				try {
					await updateProfile(this.auth.currentUser, { displayName });
					return true;
				} catch (error) {
					console.error("Erro ao guardar nome:", error);
					Utils.showToast('Erro ao guardar o seu nome.', 'error');
					return false;
				}
			}
		}
		
		/**
		 * @class FirebaseService
		 * @description Centraliza todas as opera√ß√µes do Firestore (CRUD)
		 */
		class FirebaseService {
			constructor(appInstance) {
				this.app = appInstance; // Refer√™ncia √† inst√¢ncia principal do App
				this.db = null;
				this.contractsCollection = null;
				this.snapshotListenerUnsubscribe = null;
			}
		
			setDB(dbInstance) {
				this.db = dbInstance;
			}
			
			// Inicia o listener e armazena a fun√ß√£o 'unsubscribe'
			startSnapshotListener(collectionName) {
				if (this.snapshotListenerUnsubscribe) {
					this.snapshotListenerUnsubscribe(); // Cancela listener anterior, se houver
				}
				
				this.contractsCollection = collection(this.db, collectionName);
				
				this.snapshotListenerUnsubscribe = onSnapshot(this.contractsCollection, (snapshot) => {
					const contracts = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
					this.app.handleSnapshotUpdate(contracts);
				}, (error) => {
					console.error("Erro ao buscar dados:", error);
					Utils.showToast('Erro de conex√£o. N√£o foi poss√≠vel atualizar os dados.', 'error');
				});
			}
			
			// Para o listener (ex: no logout)
			stopSnapshotListener() {
				if (this.snapshotListenerUnsubscribe) {
					this.snapshotListenerUnsubscribe();
					this.snapshotListenerUnsubscribe = null;
				}
			}
		
			async addContract(contractData) {
				try {
					await addDoc(this.contractsCollection, contractData);
					Utils.showToast('Contrato guardado com sucesso.', 'success');
					return true;
				} catch (error) {
					console.error("Erro ao adicionar contrato:", error);
					Utils.showToast('Erro ao guardar o contrato. Tente novamente.', 'error');
					return false;
				}
			}
		
			async updateContract(contractId, contractData) {
				try {
					const contractRef = doc(this.contractsCollection, contractId);
					await updateDoc(contractRef, contractData);
					Utils.showToast('Contrato atualizado.', 'success');
					return true;
				} catch (error) {
					console.error("Erro ao atualizar contrato:", error);
					Utils.showToast('Erro ao atualizar o contrato. Tente novamente.', 'error');
					return false;
				}
			}
		
			async updateContractField(contractId, fieldData) {
				// Usado para opera√ß√µes simples como 'isDeleted' ou 'serviceTypes'
				try {
					const contractRef = doc(this.contractsCollection, contractId);
					await updateDoc(contractRef, fieldData);
					return true; // Toast √© geralmente mostrado pela fun√ß√£o chamadora (ex: 'Contrato restaurado')
				} catch (error) {
					console.error(`Erro ao atualizar campo do contrato (${contractId}):`, error);
					Utils.showToast('Erro ao atualizar o item. Tente novamente.', 'error');
					return false;
				}
			}
		
			async deleteContract(contractId) {
				try {
					await deleteDoc(doc(this.contractsCollection, contractId));
					Utils.showToast('Contrato exclu√≠do permanentemente.', 'success');
					return true;
				} catch (error) {
					console.error("Erro ao excluir contrato:", error);
					Utils.showToast('Erro ao excluir o contrato. Tente novamente.', 'error');
					return false;
				}
			}
		}
		
		/**
		 * @class AnalyticsHandler
		 * @description Gerencia a cria√ß√£o e destrui√ß√£o dos gr√°ficos (Chart.js)
		 */
		class AnalyticsHandler {
			constructor() {
				this.actualIncomeChartInstance = null;
				this.projectedIncomeChartInstance = null;
			}
			
			getChartConfig(labels, data, label, backgroundColor, borderColor) {
				return {
					type: 'bar',
					data: {
						labels: labels,
						datasets: [{
							label: label,
							data: data,
							backgroundColor: backgroundColor,
							borderColor: borderColor,
							borderWidth: 1
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							y: { beginAtZero: true, ticks: { color: '#9ca3af' } },
							x: { ticks: { color: '#9ca3af' } }
						},
						plugins: {
							legend: { labels: { color: '#d1d5db' } }
						}
					}
				};
			}
		
			renderActualIncomeChart(ctx, labels, data) {
				if (this.actualIncomeChartInstance) this.actualIncomeChartInstance.destroy();
				this.actualIncomeChartInstance = new Chart(ctx, this.getChartConfig(
					labels, data, 'Fatura√ß√£o Real', 'rgba(74, 222, 128, 0.6)', 'rgba(74, 222, 128, 1)'
				));
			}
		
			renderProjectedIncomeChart(ctx, labels, data) {
				if (this.projectedIncomeChartInstance) this.projectedIncomeChartInstance.destroy();
				this.projectedIncomeChartInstance = new Chart(ctx, this.getChartConfig(
					labels, data, 'Proje√ß√£o (Parcelas)', 'rgba(139, 92, 246, 0.6)', 'rgba(139, 92, 246, 1)'
				));
			}
		
			destroyAllCharts() {
				if (this.actualIncomeChartInstance) {
					this.actualIncomeChartInstance.destroy();
					this.actualIncomeChartInstance = null;
				}
				if (this.projectedIncomeChartInstance) {
					this.projectedIncomeChartInstance.destroy();
					this.projectedIncomeChartInstance = null;
				}
			}
		}
		
		/**
		 * @class ReportHandler
		 * @description Encapsula a l√≥gica de gera√ß√£o de relat√≥rios
		 */
		class ReportHandler {
			constructor(appInstance) {
				this.app = appInstance;
			}
		
			calculateMonthlyIncome(year, month, contractsToRender) {
				if (!this.app.isUserAdmin) return { totalParcelas: 0, totalExito: 0, totalGeral: 0, detailedPayments: [] };
		
				let totalParcelas = 0, totalExito = 0, detailedPayments = [];
				contractsToRender.filter(c => !c.isDeleted).forEach(contract => {
					(contract.parcels || []).forEach(parcel => {
						if (parcel.status === 'Paga') {
							const d = new Date(parcel.paymentDate);
							if (d.getFullYear() === year && d.getMonth() === month) {
								totalParcelas += parcel.valuePaid;
								detailedPayments.push({ type: `Parcela ${parcel.number}/${contract.parcels.length}`, clientName: contract.clientName, date: Utils.formatDate(d), value: parcel.valuePaid });
							}
						}
					});
					if (contract.successFeePaymentDate) {
						const d = new Date(contract.successFeePaymentDate);
						if (d.getFullYear() === year && d.getMonth() === month) {
							totalExito += contract.successFeeValueReceived;
							detailedPayments.push({ type: 'Taxa de √äxito', clientName: contract.clientName, date: Utils.formatDate(d), value: contract.successFeeValueReceived });
						}
					}
				});
				detailedPayments.sort((a, b) => {
					const da = new Date(a.date.split('/').reverse().join('-'));
					const db = new Date(b.date.split('/').reverse().join('-'));
					return da - db;
				});
				return { totalParcelas, totalExito, totalGeral: totalParcelas + totalExito, detailedPayments };
			}
		
			getActualIncomeData(contractsToRender) {
				const labels = [];
				const data = [];
				const hoje = new Date();
		
				for (let i = 11; i >= 0; i--) {
					const date = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
					labels.push(date.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }));
					const income = this.calculateMonthlyIncome(date.getFullYear(), date.getMonth(), contractsToRender);
					data.push(income.totalGeral);
				}
				return { labels, data };
			}
		
			getProjectedIncomeData(contractsToRender) {
				const labels = [];
				const data = new Array(12).fill(0);
				const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
				const inicioMesAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
		
				for (let i = 0; i < 12; i++) {
					const date = new Date(hoje.getFullYear(), hoje.getMonth() + i, 1);
					labels.push(date.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }));
				}
		
				const filteredContracts = contractsToRender.filter(c => !c.isDeleted);
				for (const contract of filteredContracts) {
					if (!contract.parcels) continue;
					for (const parcel of contract.parcels) {
						if (parcel.status === 'Pendente') {
							const dueDate = new Date(parcel.dueDate);
							if (dueDate < inicioMesAtual) continue;
							const diffMonth = (dueDate.getFullYear() - inicioMesAtual.getFullYear()) * 12 + (dueDate.getMonth() - inicioMesAtual.getMonth());
							if (diffMonth >= 0 && diffMonth < 12) data[diffMonth] += parcel.value;
						}
					}
				}
				return { labels, data };
			}
		}
		
		/**
		 * @class DOMBuilder
		 * @description Encapsula toda a cria√ß√£o de elementos DOM
		 */
		class DOMBuilder {
			constructor(appInstance) {
				this.app = appInstance; // Refer√™ncia √† inst√¢ncia principal do App
			}
		
			// Helper para criar um elemento de √≠cone com seguran√ßa
			buildIcon(classes) {
				const icon = document.createElement('i');
				icon.className = classes;
				return icon;
			}
			
			// Helper para criar elementos DOM de forma mais limpa
			buildElement(tag, { className = '', text = '', html = '', id = '' } = {}) {
				const el = document.createElement(tag);
				if (className) el.className = className;
				if (text) el.textContent = text;
				if (html) el.innerHTML = html; // Usar com cuidado, ex: para √≠cones
				if (id) el.id = id;
				return el;
			}
		
			// [REFATORADO] Usa createElement
			createParcelCard(contract, parcel, index, type, remainingValue, valorCorrigido = null) {
				const formattedDate = Utils.formatDate(parcel.dueDate);
				const formattedValue = this.app.isUserAdmin ? Utils.formatCurrency(parcel.value) : '[Restrito]';
				const formattedRemaining = this.app.isUserAdmin ? Utils.formatCurrency(remainingValue) : '[Restrito]';
				const formattedCorrigido = this.app.isUserAdmin && valorCorrigido ? Utils.formatCurrency(valorCorrigido) : '[Restrito]';
		
				let statusClass = '';
				const card = this.buildElement('div', { className: 'dark-card p-4 rounded-lg shadow-md border-l-4' });
		
				const title = this.buildElement('p', { className: 'font-bold text-white', text: contract.clientName });
				const services = (contract.serviceTypes || []).map(s => s.name).join(', ');
				const subtitle = this.buildElement('p', { className: 'text-sm text-gray-400 mb-3', text: `${services} - Parcela ${parcel.number}/${contract.parcels.length || 1}` });
				
				const details = this.buildElement('div', { className: 'space-y-2 text-sm' });
				let actionButton;
		
				if (type === 'vencida') {
					statusClass = 'border-red-400';
					if (this.app.isUserAdmin) {
						details.innerHTML = `
						<div class="flex items-center text-gray-400 text-xs"><strong>Original:</strong><span class="ml-auto font-medium line-through">${formattedValue}</span></div>
						<div class="flex items-center text-red-400"><strong>Corrigido:</strong><span class="ml-auto font-semibold text-lg">${formattedCorrigido}</span></div>`;
					} else {
						details.append(this.buildElement('div', { className: 'text-red-400 font-semibold', text: 'Vencida' }));
					}
				} else if (type === 'a-vencer') {
					statusClass = 'border-yellow-400';
					if (this.app.isUserAdmin) {
						details.innerHTML = `<div class="flex items-center text-gray-300"><i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i><strong>Valor:</strong><span class="ml-auto font-semibold text-lg text-white">${formattedValue}</span></div>`;
					} else {
						details.append(this.buildElement('div', { className: 'text-yellow-400 font-semibold', text: 'A vencer' }));
					}
				} else { // Paga
					statusClass = 'border-gray-600';
					const formattedPaidValue = this.app.isUserAdmin ? Utils.formatCurrency(parcel.valuePaid || 0) : '[Restrito]';
					const paymentDate = Utils.formatDate(parcel.paymentDate);
					if (this.app.isUserAdmin) {
						details.innerHTML = `<div class="flex items-center text-gray-300"><i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i><strong>Valor:</strong><span class="ml-auto font-semibold text-lg text-white">${formattedValue}</span></div>`;
					}
					actionButton = this.buildElement('div', { 
						className: 'mt-4 text-center text-sm bg-green-900/50 text-green-300 p-2 rounded-md font-medium',
						text: `Pago ${this.app.isUserAdmin ? formattedPaidValue : ''} em ${paymentDate}`
					});
				}
				card.classList.add(statusClass);
		
				// Data de Vencimento (comum a todos)
				const vencimentoDiv = this.buildElement('div', { className: 'flex items-center text-gray-300' });
				vencimentoDiv.append(this.buildIcon('fas fa-calendar-alt w-5 text-center mr-2 text-gray-500'));
				vencimentoDiv.append(this.buildElement('strong', { text: 'Vencimento:' }));
				vencimentoDiv.append(this.buildElement('span', { className: 'ml-auto font-medium', text: formattedDate }));
				details.append(vencimentoDiv);
		
				card.append(title, subtitle, details);
		
				// Informa√ß√µes extras (Admin)
				if (this.app.isUserAdmin) {
					const extraInfo = this.buildElement('div', { className: 'text-xs text-gray-400 border-t border-gray-700 pt-2 mt-3 flex justify-between' });
					extraInfo.innerHTML = `<span>Contrato: <strong>${Utils.formatCurrency(contract.totalValue || 0)}</strong></span> <span>Restante: <strong>${formattedRemaining}</strong></span>`;
					card.append(extraInfo);
				}
		
				// Bot√£o de A√ß√£o
				if (type !== 'paga') {
					actionButton = this.buildElement('button', { 
						className: 'mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2',
						html: '<i class="fas fa-check"></i> Registar Pagamento'
					});
					actionButton.onclick = () => window.App.openPaymentModal(contract.id, index);
				}
				if (actionButton) card.append(actionButton);
				
				return card;
			}
			
			// [REFATORADO] Usa createElement
			createExitoCard(contract) {
				const taxaExitoDisplay = this.app.isUserAdmin ? contract.successFee : '[Restrito]';
				
				const card = this.buildElement('div', { className: 'dark-card p-4 rounded-lg shadow-md border-l-4 border-indigo-400' });
				card.append(this.buildElement('p', { className: 'font-bold text-white', text: contract.clientName }));
				
				const services = (contract.serviceTypes || []).map(s => s.name).join(', ');
				card.append(this.buildElement('p', { className: 'text-sm text-gray-400 mb-3', text: services }));
				
				const infoDiv = this.buildElement('div', { className: 'my-4 text-center' });
				infoDiv.append(this.buildElement('p', { className: 'text-sm text-gray-400', text: 'Bonifica√ß√£o Pendente' }));
				infoDiv.append(this.buildElement('p', { className: 'text-2xl font-semibold text-indigo-400', text: taxaExitoDisplay }));
				card.append(infoDiv);
				
				const button = this.buildElement('button', {
					className: 'w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2',
					html: '<i class="fas fa-gavel"></i> Registar Recebimento'
				});
				button.onclick = () => window.App.openExitoModal(contract.id);
				card.append(button);
		
				return card;
			}
		
			// [REFATORADO] Usa createElement
			createContractCard(contract, statusInfo) {
				const { statusText, statusColor, borderColor } = statusInfo;
				
				const card = this.buildElement('div', { className: `dark-card rounded-lg shadow-lg overflow-hidden border-l-4 ${borderColor} flex flex-col justify-between transition-all duration-300 transform hover:-translate-y-2 hover:shadow-2xl` });
				const cardBody = this.buildElement('div', { className: 'p-5' });
				
				// Header do Card
				const header = this.buildElement('div', { className: 'flex justify-between items-start mb-3' });
				header.append(this.buildElement('h3', { className: 'font-bold text-xl text-white', text: contract.clientName }));
				header.append(this.buildElement('span', { className: `px-2 py-1 rounded-full text-xs font-semibold ${statusColor}`, text: statusText }));
				cardBody.append(header);
		
				// Advogado
				const adv = this.buildElement('p', { className: 'text-xs text-indigo-300 mb-3' });
				adv.append(this.buildIcon('fas fa-user-tie mr-1'));
				adv.append(document.createTextNode(` ${contract.advogadoResponsavel}`));
				cardBody.append(adv);
		
				// Tags de Servi√ßo
				const servicesContainer = this.buildElement('div', { className: 'mb-4' });
				(contract.serviceTypes || []).forEach(s => {
					servicesContainer.append(this.buildElement('span', { className: 'service-tag-small', text: s.name }));
				});
				cardBody.append(servicesContainer);
		
				// Detalhes Financeiros
				const financialInfo = this.buildElement('div', { className: 'border-t border-gray-700 pt-4 space-y-3 text-sm' });
				const valorFixoDisplay = this.app.isUserAdmin ? Utils.formatCurrency(contract.totalValue) : '[Restrito]';
				const exitoDisplay = this.app.isUserAdmin && contract.successFee ? contract.successFee : (contract.successFee ? '[Restrito]' : '');
		
				const fixedValueDiv = this.buildElement('div', { className: 'flex items-center text-gray-300' });
				fixedValueDiv.append(this.buildIcon('fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500'));
				fixedValueDiv.append(this.buildElement('strong', { text: 'Valor Fixo:' }));
				fixedValueDiv.append(this.buildElement('span', { className: 'ml-auto font-medium', text: valorFixoDisplay }));
				financialInfo.append(fixedValueDiv);
				
				if (contract.successFee) {
					const exitoDiv = this.buildElement('div', { className: 'flex items-center text-gray-300' });
					exitoDiv.append(this.buildIcon('fas fa-star w-5 text-center mr-2 text-gray-500'));
					exitoDiv.append(this.buildElement('strong', { text: '√äxito:' }));
					exitoDiv.append(this.buildElement('span', { className: 'ml-auto font-medium text-indigo-400', text: exitoDisplay }));
					financialInfo.append(exitoDiv);
				}
				cardBody.append(financialInfo);
				
				// Footer do Card (Bot√µes)
				const footer = this.buildElement('div', { className: 'bg-gray-900/50 px-4 py-2 flex justify-end gap-2' });
				
				const historyBtn = this.buildElement('button', { className: 'text-sm flex items-center gap-2 text-gray-400 hover:text-indigo-400 hover:bg-indigo-900/20 py-1 px-3 rounded-md transition-colors', html: '<i class="fas fa-eye"></i> Hist√≥rico' });
				historyBtn.title = "Ver Hist√≥rico do Cliente";
				historyBtn.setAttribute('aria-label', `Ver Hist√≥rico do Cliente ${contract.clientName}`);
				historyBtn.onclick = () => window.App.openClientHistoryModal(contract.clientName);
		
				const editBtn = this.buildElement('button', { className: 'text-sm flex items-center gap-2 text-gray-400 hover:text-green-400 hover:bg-green-900/20 py-1 px-3 rounded-md transition-colors', html: '<i class="fas fa-pencil-alt"></i> Editar' });
				editBtn.title = "Editar Contrato";
				editBtn.setAttribute('aria-label', `Editar Contrato de ${contract.clientName}`);
				editBtn.onclick = () => window.App.openContractModal(contract.id);
		
				const deleteBtn = this.buildElement('button', { className: 'text-sm flex items-center gap-2 text-gray-400 hover:text-red-400 hover:bg-red-900/20 py-1 px-3 rounded-md transition-colors' });
				deleteBtn.append(this.buildIcon('fas fa-trash-alt'));
				deleteBtn.title = "Mover para Lixeira";
				deleteBtn.setAttribute('aria-label', `Mover Contrato de ${contract.clientName} para lixeira`);
				deleteBtn.onclick = () => window.App.moveToLixeira(contract.id);
		
				footer.append(historyBtn, editBtn, deleteBtn);
				card.append(cardBody, footer);
				return card;
			}
			
			// [REFATORADO] Usa createElement
			createInadimplenteCard({ contract, parcel, index, diffDays, valorCorrigido }) {
				const valorOriginalDisplay = this.app.isUserAdmin ? Utils.formatCurrency(parcel.value) : '[Restrito]';
				const valorCorrigidoDisplay = this.app.isUserAdmin ? Utils.formatCurrency(valorCorrigido) : '[Restrito]';
		
				const card = this.buildElement('div', { className: 'dark-card p-5 rounded-lg shadow-lg border-l-4 border-red-500' });
				card.append(this.buildElement('p', { className: 'font-bold text-lg text-white', text: contract.clientName }));
				
				const services = (contract.serviceTypes || []).map(s => s.name).join(', ');
				card.append(this.buildElement('p', { className: 'text-sm text-gray-400 mb-3', text: services }));
				
				const details = this.buildElement('div', { className: 'border-t border-gray-700 pt-3 mt-3 space-y-2' });
				
				if (this.app.isUserAdmin) {
					details.innerHTML = `
					<div class="flex justify-between items-center text-sm">
						<span class="text-gray-400">Valor Original:</span>
						<span class="font-medium text-gray-400 line-through">${valorOriginalDisplay}</span>
					</div>
					<div class="flex justify-between items-center">
						<span class="text-sm text-white">Valor Corrigido:</span>
						<span class="font-semibold text-lg text-red-400">${valorCorrigidoDisplay}</span>
					</div>`;
				}
				
				details.innerHTML += `
				<div class="flex justify-between items-center text-sm">
					<span class="text-gray-400">Venceu em:</span>
					<span class="font-medium text-gray-300">${Utils.formatDate(parcel.dueDate)}</span>
				</div>
				<div class="flex justify-between items-center text-red-400 font-bold text-sm bg-red-900/30 px-2 py-1 rounded">
					<span>Atrasado h√°:</span>
					<span>${diffDays} dia(s)</span>
				</div>`;
				
				card.append(details);
		
				const button = this.buildElement('button', {
					className: 'mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2',
					html: '<i class="fas fa-check"></i> Registar Pagamento'
				});
				button.onclick = () => window.App.openPaymentModal(contract.id, index);
				card.append(button);
				
				return card;
			}
			
			// [REFATORADO] Usa createElement
			createServicoCard(contract, serviceProgress, financialProgress) {
				const card = this.buildElement('div', { className: 'dark-card p-5 rounded-lg shadow-lg' });
				
				const header = this.buildElement('div', { className: 'flex justify-between items-start' });
				header.append(this.buildElement('h3', { className: 'font-bold text-xl text-indigo-300 mb-4', text: contract.clientName }));
				header.append(this.buildElement('p', { className: 'text-sm text-gray-400', html: `<i class="fas fa-user-tie mr-1"></i> ${contract.advogadoResponsavel}` }));
				card.append(header);
		
				const progressBars = this.buildElement('div', { className: 'space-y-4 mb-4' });
				if (this.app.isUserAdmin) {
					const financialProgressDiv = this.buildElement('div');
					financialProgressDiv.innerHTML = `
					<div class="flex justify-between text-sm mb-1 text-gray-300"><label>Progresso Financeiro</label><span class="font-medium text-teal-300">${financialProgress.toFixed(0)}%</span></div>
					<div class="progress-bar-bg h-3 w-full"><div class="progress-bar bg-teal-500" style="width: ${financialProgress}%"></div></div>`;
					progressBars.append(financialProgressDiv);
				}
				
				const serviceProgressDiv = this.buildElement('div');
				serviceProgressDiv.innerHTML = `
				<div class="flex justify-between text-sm mb-1 text-gray-300"><label>Progresso dos Servi√ßos</label><span class="font-medium text-indigo-300">${serviceProgress.toFixed(0)}%</span></div>
				<div class="progress-bar-bg h-3 w-full"><div class="progress-bar bg-indigo-500" style="width: ${serviceProgress}%"></div></div>`;
				progressBars.append(serviceProgressDiv);
				card.append(progressBars);
				
				const serviceListContainer = this.buildElement('div', { className: 'border-t border-gray-700 pt-3' });
				serviceListContainer.append(this.buildElement('h4', { className: 'font-semibold text-sm mb-2 text-gray-400', text: 'Servi√ßos do Contrato:' }));
				const serviceList = this.buildElement('ul', { className: 'space-y-1' });
		
				(contract.serviceTypes || []).forEach((service, index) => {
					serviceList.append(this.createServiceListItem(contract, service, index));
				});
				
				serviceListContainer.append(serviceList);
				card.append(serviceListContainer);
				return card;
			}
			
			// [REFATORADO] Helper para createServicoCard
			createServiceListItem(contract, service, index) {
				const li = this.buildElement('li', { className: 'flex items-center justify-between p-2 rounded-md' });
		
				const iconClass =
					service.status === 'Conclu√≠do' ? 'fas fa-check-circle text-teal-500' :
					service.status === '50% Conclu√≠do' ? 'fas fa-adjust text-purple-500' :
					service.status === 'Em Andamento' ? 'fas fa-spinner fa-spin text-yellow-500' :
					'far fa-circle text-gray-500';
				const textClass = service.status === 'Conclu√≠do' ? 'text-gray-500 line-through' : 'text-gray-300';
				li.classList.add(service.status !== 'Conclu√≠do' ? 'hover:bg-gray-700/50' : 'bg-gray-900/50');
				
				const serviceNameSpan = this.buildElement('span', { className: textClass });
				serviceNameSpan.append(this.buildIcon(`${iconClass} mr-2`));
				serviceNameSpan.append(document.createTextNode(service.name));
				
				const actionsDiv = this.buildElement('div', { className: 'flex items-center gap-2' });
				
				// L√≥gica de Prazo
				if (service.deadline) {
					const hoje = new Date(); hoje.setHours(0,0,0,0);
					const prazo = new Date(service.deadline + "T12:00:00Z"); // Trata como UTC
					const diffDays = Math.ceil((prazo - hoje) / 86400000);
					const formattedPrazo = Utils.formatDate(prazo);
					let deadlineHtml = '', deadlineClass = '';
					
					if (diffDays < 0 && service.status !== 'Conclu√≠do') {
						deadlineHtml = `<i class="fas fa-exclamation-triangle"></i> Vencido: ${formattedPrazo}`;
						deadlineClass = 'text-xs font-medium text-red-400';
					} else if (diffDays <= 7 && service.status !== 'Conclu√≠do') {
						deadlineHtml = `<i class="fas fa-clock"></i> Vence: ${formattedPrazo}`;
						deadlineClass = 'text-xs font-medium text-yellow-400';
					} else if (service.status !== 'Conclu√≠do') {
						deadlineHtml = `<i class="far fa-calendar-alt"></i> ${formattedPrazo}`;
						deadlineClass = 'text-xs text-gray-500';
					} else {
						deadlineHtml = `<i class="far fa-calendar-check"></i> ${formattedPrazo}`;
						deadlineClass = 'text-xs text-gray-500';
					}
					actionsDiv.append(this.buildElement('span', { className: deadlineClass, html: deadlineHtml }));
				}
				
				// L√≥gica de Status e Bot√µes
				let statusHtml = '', statusClass = '';
				switch (service.status) {
					case 'Conclu√≠do':
						statusClass = 'text-xs font-bold text-teal-400'; statusHtml = 'CONCLU√çDO';
						break;
					case '50% Conclu√≠do':
						statusClass = 'text-xs font-bold text-purple-400'; statusHtml = '50%';
						actionsDiv.append(this.createServiceButton('Concluir', 'bg-indigo-600 hover:bg-indigo-500', () => this.app.updateServiceStatus(contract.id, index, 'Conclu√≠do')));
						break;
					case 'Em Andamento':
						statusClass = 'text-xs font-bold text-yellow-400'; statusHtml = 'EM ANDAMENTO';
						actionsDiv.append(this.createServiceButton('50%', 'bg-purple-600 hover:bg-purple-500', () => this.app.updateServiceStatus(contract.id, index, '50% Conclu√≠do')));
						actionsDiv.append(this.createServiceButton('Concluir', 'bg-indigo-600 hover:bg-indigo-500', () => this.app.updateServiceStatus(contract.id, index, 'Conclu√≠do')));
						break;
					default: // Pendente
						statusClass = 'text-xs font-bold text-gray-400'; statusHtml = 'PENDENTE';
						actionsDiv.append(this.createServiceButton('Iniciar', 'bg-yellow-600 hover:bg-yellow-500', () => this.app.updateServiceStatus(contract.id, index, 'Em Andamento')));
						break;
				}
				actionsDiv.append(this.buildElement('span', { className: statusClass, text: statusHtml }));
				
				li.append(serviceNameSpan, actionsDiv);
				return li;
			}
			
			// Helper para createServiceListItem
			createServiceButton(text, classes, onClick) {
				const btn = this.buildElement('button', {
					className: `text-xs text-white font-semibold py-1 px-2 rounded-md transition-colors ${classes}`,
					text: text
				});
				btn.onclick = onClick;
				return btn;
			}
		
			// [REFATORADO] Usa createElement
			renderPaginationControls(container, totalItems, totalPages, currentPage) {
				container.innerHTML = ''; // Limpa
				if (totalPages <= 1) return;
		
				const createPageButton = (pageIndex, text = null, isDisabled = false, isActive = false) => {
					const btn = this.buildElement('button', {
						className: 'pagination-button',
						text: text !== null ? text : (pageIndex + 1)
					});
					if (isActive) btn.classList.add('active');
					if (isDisabled) {
						btn.disabled = true;
					} else {
						btn.onclick = () => window.App.changeContractPage(pageIndex);
					}
					return btn;
				};
		
				// Bot√£o "Anterior"
				container.append(createPageButton(currentPage - 1, '¬´ Ant', currentPage === 0));
				
				const maxVisibleButtons = 5;
				let startPage = Math.max(0, currentPage - Math.floor(maxVisibleButtons / 2));
				let endPage = Math.min(totalPages - 1, startPage + maxVisibleButtons - 1);
				if (endPage - startPage + 1 < maxVisibleButtons) {
					startPage = Math.max(0, endPage - maxVisibleButtons + 1);
				}
		
				// Bot√£o "Primeira P√°gina" e "..."
				if (startPage > 0) {
					container.append(createPageButton(0));
					if (startPage > 1) {
						container.append(this.buildElement('span', { text: '...' }));
					}
				}
		
				// Bot√µes de n√∫meros
				for (let i = startPage; i <= endPage; i++) {
					container.append(createPageButton(i, null, false, i === currentPage));
				}
		
				// Bot√£o "√öltima P√°gina" e "..."
				if (endPage < totalPages - 1) {
					if (endPage < totalPages - 2) {
						container.append(this.buildElement('span', { text: '...' }));
					}
					container.append(createPageButton(totalPages - 1));
				}
		
				// Bot√£o "Pr√≥ximo"
				container.append(createPageButton(currentPage + 1, 'Pr√≥x ¬ª', currentPage === totalPages - 1));
			}
		}
		
		
		/**
		 * @class App
		 * @description Classe principal que gere o estado e a l√≥gica do dashboard
		 */
		class App {
			constructor() {
				// Estado da Aplica√ß√£o
				this.database = { contracts: [] };
				this.currentUserDisplayName = null;
				this.isUserAdmin = false;
				
				// Estado de UI (Filtros, Ordena√ß√£o, Pagina√ß√£o)
				this.currentContractSort = 'name-asc';
				this.currentInadimplentesSort = 'days-desc';
				this.currentServicosSort = 'name-asc';
				this.contractListPage = 0; // P√°gina atual (base 0)
				
				// Refer√™ncias DOM Principais
				this.backdrop = document.getElementById('modal-backdrop');
				this.appContainer = document.getElementById('app-container');
				this.loadingOverlay = document.getElementById('loading-overlay');
				this.authOverlay = document.getElementById('auth-overlay');
				
				// Estado dos Modais (para acessibilidade)
				this.openModalId = null;
				this.lastFocusedElement = null;
		
				// Servi√ßos Injetados
				this.authService = new AuthService(this);
				this.firebaseService = new FirebaseService(this);
				this.domBuilder = new DOMBuilder(this);
				this.reportHandler = new ReportHandler(this);
				this.analyticsHandler = new AnalyticsHandler(this);
				this.correctionCalculator = new CorrectionCalculator(this);
			}
		
			// --- 1. INICIALIZA√á√ÉO E EVENT LISTENERS ---
		
			initialize() {
				this.authService.initialize();
				this.setupEventListeners();
				this._setupModalAccessibility();
			}
		
			setupEventListeners() {
				// Formul√°rio de Login
				document.getElementById('login-form').addEventListener('submit', (e) => {
					e.preventDefault();
					const email = document.getElementById('login-email').value;
					const password = document.getElementById('login-password').value;
					this.authService.login(email, password);
				});
		
				// Bot√£o de Logout
				document.getElementById('logout-button').addEventListener('click', () => {
					this.authService.logout();
				});
		
				// Formul√°rio de Nome de Exibi√ß√£o
				document.getElementById('formDisplayName').addEventListener('submit', this.handleDisplayNameSubmit.bind(this));
		
				// Formul√°rios de Modais
				document.getElementById('formContrato').addEventListener('submit', this.handleContractSubmit.bind(this));
				document.getElementById('formPagamento').addEventListener('submit', this.handlePaymentSubmit.bind(this));
				document.getElementById('formExito').addEventListener('submit', this.handleExitoSubmit.bind(this));
		
				// Bot√£o de Adicionar Servi√ßo (no modal de contrato)
				document.getElementById('addServiceButton').addEventListener('click', this.handleAddServiceTag.bind(this));
		
				// Inputs de Busca (com debounce)
				const debouncedContracts = Utils.debounce(() => this.resetAndRenderContractList(), 300);
				document.getElementById('searchInput').addEventListener('input', debouncedContracts);
				
				const debouncedServicos = Utils.debounce(() => this.renderServicosPage(), 300);
				document.getElementById('servicosSearchInput').addEventListener('input', debouncedServicos);
		
				// Backdrop dos modais
				if (this.backdrop) {
					this.backdrop.addEventListener('click', () => {
						if (this.openModalId && this.openModalId !== 'modalDisplayName') {
							this.closeModal(this.openModalId);
						}
					});
				}
			}
		
			// --- 2. HANDLERS DE AUTENTICA√á√ÉO E DADOS (Callbacks dos Servi√ßos) ---
		
			handleAuthStateChange(user) {
				if (user) {
					this.currentUserDisplayName = user.displayName;
					this.isUserAdmin = ADMIN_USERS.includes(this.currentUserDisplayName);
					document.body.classList.toggle('is-admin', this.isUserAdmin);
		
					if (!user.displayName) {
						// Primeiro login, pedir nome
						this.loadingOverlay.style.display = 'none';
						this.authOverlay.style.display = 'flex'; // Mostra o novo ecr√£ de login
						this.appContainer.style.display = 'none';
						this.openModal('modalDisplayName');
					} else {
						// Utilizador logado e com nome
						document.getElementById('user-display-name').textContent = user.displayName;
						this.loadingOverlay.style.display = 'none';
						this.authOverlay.style.display = 'none';
						this.appContainer.style.display = 'block';
						this.setupUIAccess();
						this.firebaseService.startSnapshotListener('contracts'); // Inicia o listener
					}
				} else {
					// Utilizador deslogado
					this.currentUserDisplayName = null;
					this.isUserAdmin = false;
					document.body.classList.remove('is-admin');
					this.authOverlay.style.display = 'flex'; // Mostra o novo ecr√£ de login
					this.appContainer.style.display = 'none';
					this.loadingOverlay.style.display = 'none';
					this.firebaseService.stopSnapshotListener(); // Para o listener
				}
			}
		
			handleSnapshotUpdate(contracts) {
				this.database.contracts = contracts;
				this.contractListPage = 0; // Reseta a pagina√ß√£o a cada nova atualiza√ß√£o
				this.render(); // Renderiza a aplica√ß√£o com os novos dados
			}
		
			// --- 3. L√ìGICA DE RENDERIZA√á√ÉO PRINCIPAL ---
		
			async render() {
				if (this.appContainer.style.display !== 'block') return;
		
				const currentPage = document.querySelector('div[id^="page-"]:not(.hidden)');
				if (!currentPage) {
					this.showPage('page-dashboard'); // Padr√£o se nenhuma p√°gina estiver vis√≠vel
					return;
				}
		
				const pageId = currentPage.id;
				
				// As fun√ß√µes de renderiza√ß√£o agora pegam os dados filtrados
				if (pageId === 'page-dashboard') {
					await this.renderKanban();
					this.renderContractList();
				} else if (pageId === 'page-inadimplentes') {
					await this.renderInadimplentesPage();
				} else if (pageId === 'page-servicos') {
					this.renderServicosPage();
				} else if (pageId === 'page-lixeira') {
					this.renderLixeiraPage();
				}
		
				this.renderSortButtons();
				this.renderAdvogadoFilters();
			}
		
			/**
			 * @description Renderiza o quadro Kanban
			 */
			async renderKanban() {
				const contractsToRender = this.getFilteredContracts(false);
				const kanbanVencidas = document.getElementById('kanban-vencidas');
				const kanbanAVencer = document.getElementById('kanban-a-vencer');
				const kanbanPagas = document.getElementById('kanban-pagas');
				const kanbanExito = document.getElementById('kanban-exito');
		
				// Usar DocumentFragment para performance
				const fragVencidas = document.createDocumentFragment();
				const fragAVencer = document.createDocumentFragment();
				const fragPagas = document.createDocumentFragment();
				const fragExito = document.createDocumentFragment();
		
				const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
				const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
				const trintaDiasFrente = new Date(); trintaDiasFrente.setDate(hoje.getDate() + 30);
		
				let totalAVencer30dias = 0;
				let totalVencido = 0;
				const vencidasPromises = [];
		
				for (const contract of contractsToRender) {
					if (!contract.parcels) contract.parcels = [];
					let remainingValue = this.isUserAdmin
						? contract.parcels.reduce((sum, p) => p.status === 'Pendente' ? sum + p.value : sum, 0)
						: 0;
		
					for (let i = 0; i < contract.parcels.length; i++) {
						const parcel = contract.parcels[i];
						const vencimento = new Date(parcel.dueDate);
		
						if (parcel.status === 'Paga') {
							const dataPagamento = new Date(parcel.paymentDate);
							if (dataPagamento >= primeiroDiaMes && dataPagamento <= hoje) {
								fragPagas.append(this.domBuilder.createParcelCard(contract, parcel, i, 'paga', remainingValue));
							}
						} else { // Pendente
							if (vencimento < hoje) { // Vencida
								vencidasPromises.push(
									this.correctionCalculator.calcularValorCorrigido(parcel.value, parcel.dueDate)
										.then(valorCorrigido => {
											if (this.isUserAdmin) totalVencido += valorCorrigido;
											return this.domBuilder.createParcelCard(contract, parcel, i, 'vencida', remainingValue, valorCorrigido);
										})
								);
							} else if (vencimento >= hoje && vencimento <= trintaDiasFrente) { // A vencer
								fragAVencer.append(this.domBuilder.createParcelCard(contract, parcel, i, 'a-vencer', remainingValue));
								if (this.isUserAdmin) totalAVencer30dias += parcel.value;
							}
						}
					}
					if (contract.successFee && !contract.successFeePaymentDate && (contract.parcels || []).every(p => p.status === 'Paga')) {
						fragExito.append(this.domBuilder.createExitoCard(contract));
					}
				}
		
				// Limpa containers
				kanbanVencidas.innerHTML = '';
				kanbanAVencer.innerHTML = '';
				kanbanPagas.innerHTML = '';
				kanbanExito.innerHTML = '';
		
				// Processa promessas vencidas
				const vencidasCards = await Promise.all(vencidasPromises);
				vencidasCards.forEach(card => fragVencidas.append(card));
		
				// Anexa fragmentos
				kanbanVencidas.append(fragVencidas);
				kanbanAVencer.append(fragAVencer);
				kanbanPagas.append(fragPagas);
				kanbanExito.append(fragExito);
		
				const allContracts = this.getFilteredContracts(true); // Inclui deletados para c√°lculo hist√≥rico
				const totalPagoMes = this.isUserAdmin ? this.reportHandler.calculateMonthlyIncome(hoje.getFullYear(), hoje.getMonth(), allContracts).totalGeral : 0;
				this.renderDashboard(totalAVencer30dias, totalVencido, totalPagoMes, contractsToRender.length);
			}
		
			/**
			 * @description Atualiza os n√∫meros do Dashboard
			 */
			renderDashboard(aVencer, vencido, pago, totalContratos) {
				document.getElementById('dash-a-receber').textContent = Utils.formatCurrency(aVencer);
				document.getElementById('dash-vencido').textContent = Utils.formatCurrency(vencido);
				document.getElementById('dash-recebido').textContent = Utils.formatCurrency(pago);
				document.getElementById('dash-contratos').textContent = totalContratos;
			}
		
			/**
			 * @description Renderiza a lista principal de contratos com pagina√ß√£o
			 */
			renderContractList() {
				const listContainer = document.getElementById('contractListContainer');
				const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
				const advogadoFilterEl = document.getElementById('advogadoFilter');
				
				let advogadoFilter = advogadoFilterEl ? advogadoFilterEl.value : 'Todos';
				if (!this.isUserAdmin) advogadoFilter = this.currentUserDisplayName;
		
				// 1. Filtra os contratos
				let filteredContracts = this.getFilteredContracts(false).filter(c => {
					const matchesAdvogado = (this.isUserAdmin && advogadoFilter === 'Todos') || c.advogadoResponsavel === advogadoFilter;
					const matchesSearch = c.clientName.toLowerCase().includes(searchTerm) || (c.serviceTypes || []).some(s => s.name.toLowerCase().includes(searchTerm));
					return matchesAdvogado && matchesSearch;
				});
		
				// 2. Ordena os contratos
				if (this.currentContractSort === 'name-asc') {
					filteredContracts.sort((a, b) => a.clientName.localeCompare(b.clientName));
				} else if (this.currentContractSort === 'value-desc' && this.isUserAdmin) {
					filteredContracts.sort((a, b) => (b.totalValue || 0) - (a.totalValue || 0));
				}
		
				// 3. Calcula o total de itens e p√°ginas
				const totalItems = filteredContracts.length;
				const totalPages = Math.ceil(totalItems / CONTRACTS_PER_PAGE);
		
				// 4. Garante que a p√°gina atual seja v√°lida
				if (this.contractListPage >= totalPages && totalPages > 0) this.contractListPage = totalPages - 1;
				if (this.contractListPage < 0) this.contractListPage = 0;
		
				// 5. Pega apenas os itens da p√°gina atual
				const startIndex = this.contractListPage * CONTRACTS_PER_PAGE;
				const paginatedContracts = filteredContracts.slice(startIndex, startIndex + CONTRACTS_PER_PAGE);
		
				// 6. Limpa o container e renderiza
				listContainer.innerHTML = '';
				const paginationContainer = document.getElementById('paginationContainer');
		
				if (totalItems === 0) {
					listContainer.innerHTML = '<div class="dark-card p-4 rounded-lg shadow-md text-center text-gray-400 py-4">Nenhum contrato encontrado.</div>';
					this.domBuilder.renderPaginationControls(paginationContainer, 0, 0, 0); // Limpa controles
					return;
				}
		
				// 7. Cria o grid e o fragmento
				const gridContainer = this.domBuilder.buildElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' });
				const fragment = document.createDocumentFragment();
		
				paginatedContracts.forEach(contract => {
					const statusInfo = this.getContractStatus(contract);
					fragment.append(this.domBuilder.createContractCard(contract, statusInfo));
				});
				
				gridContainer.append(fragment);
				listContainer.append(gridContainer);
		
				// 9. Renderiza os controles de pagina√ß√£o
				this.domBuilder.renderPaginationControls(paginationContainer, totalItems, totalPages, this.contractListPage);
			}
		
			/**
			 * @description Renderiza a p√°gina de Inadimplentes
			 */
			async renderInadimplentesPage() {
				const contractsToRender = this.getFilteredContracts(false);
				const container = document.getElementById('inadimplentesListContainer');
				container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><i class="fas fa-spinner fa-spin fa-2x text-indigo-400"></i><p class="mt-2 text-sm text-gray-400">A calcular...</p></div>`;
				const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
		
				// 1. Mapeia todas as parcelas vencidas e calcula a corre√ß√£o
				const results = await Promise.all(contractsToRender.map(async (contract) => {
					if (!contract.parcels) return [];
					const contractInadimplencias = [];
					for (let i = 0; i < contract.parcels.length; i++) {
						const parcel = contract.parcels[i];
						const vencimento = new Date(parcel.dueDate);
						if (parcel.status === 'Pendente' && vencimento < hoje) {
							const diffDays = Math.ceil((hoje - vencimento) / 86400000);
							const valorCorrigido = await this.correctionCalculator.calcularValorCorrigido(parcel.value, parcel.dueDate);
							contractInadimplencias.push({ contract, parcel, index: i, diffDays, valorCorrigido });
						}
					}
					return contractInadimplencias;
				}));
				let inadimplentesList = results.flat();
		
				// 2. Ordena
				if (this.currentInadimplentesSort === 'days-desc') {
					inadimplentesList.sort((a, b) => b.diffDays - a.diffDays);
				} else if (this.currentInadimplentesSort === 'value-desc' && this.isUserAdmin) {
					inadimplentesList.sort((a, b) => b.valorCorrigido - a.valorCorrigido);
				} else if (this.currentInadimplentesSort === 'name-asc') {
					inadimplentesList.sort((a, b) => a.contract.clientName.localeCompare(b.contract.clientName));
				}
		
				// 3. Renderiza
				container.innerHTML = '';
				if (inadimplentesList.length === 0) {
					container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><div class="inline-block bg-gray-800 border border-gray-700 text-green-400 p-6 rounded-lg shadow-md"><i class="fas fa-check-circle fa-3x mb-3"></i><p class="font-bold text-xl">Nenhuma pend√™ncia encontrada!</p><p class="text-sm text-gray-400">Todos os pagamentos est√£o em dia.</p></div></div>`;
					return;
				}
				
				const fragment = document.createDocumentFragment();
				inadimplentesList.forEach(item => {
					fragment.append(this.domBuilder.createInadimplenteCard(item));
				});
				container.append(fragment);
			}
		
			/**
			 * @description Renderiza a p√°gina de Servi√ßos/Produ√ß√£o
			 */
			renderServicosPage() {
				const contractsToRender = this.getFilteredContracts(false);
				const container = document.getElementById('servicosListContainer');
				const searchTerm = (document.getElementById('servicosSearchInput').value || '').toLowerCase();
				const advogadoFilterEl = document.getElementById('servicosAdvogadoFilter');
				let advogadoFilter = advogadoFilterEl ? advogadoFilterEl.value : 'Todos';
				if (!this.isUserAdmin) advogadoFilter = this.currentUserDisplayName;
		
				container.innerHTML = '';
		
				let activeContracts = contractsToRender.filter(c => {
					const isNotConcluded = this.getContractStatus(c).statusText !== 'Conclu√≠do';
					if (!isNotConcluded) return false;
					const matchesAdvogado = (this.isUserAdmin && advogadoFilter === 'Todos') || c.advogadoResponsavel === advogadoFilter;
					const matchesSearch = c.clientName.toLowerCase().includes(searchTerm) || (c.serviceTypes || []).some(s => s.name.toLowerCase().includes(searchTerm)) || c.advogadoResponsavel.toLowerCase().includes(searchTerm);
					return matchesAdvogado && matchesSearch;
				});
		
				// Ordena
				if (this.currentServicosSort === 'name-asc') {
					activeContracts.sort((a, b) => a.clientName.localeCompare(b.clientName));
				} else if (this.currentServicosSort === 'adv-asc') {
					activeContracts.sort((a, b) => a.advogadoResponsavel.localeCompare(b.advogadoResponsavel));
				}
		
				if (activeContracts.length === 0) {
					container.innerHTML = `<div class="text-center py-10"><div class="inline-block dark-card text-indigo-400 p-6 rounded-lg shadow-md"><i class="fas fa-coffee fa-3x mb-3"></i><p class="font-bold text-xl">Nenhum contrato ativo encontrado.</p><p class="text-sm text-gray-400">Nenhum resultado para a busca ou todos os trabalhos est√£o conclu√≠dos.</p></div></div>`;
					return;
				}
		
				// Renderiza
				const fragment = document.createDocumentFragment();
				activeContracts.forEach(contract => {
					const totalServices = (contract.serviceTypes || []).length;
					let progressValue = 0;
					(contract.serviceTypes || []).forEach(service => {
						if (service.status === 'Conclu√≠do') progressValue += 1;
						else if (service.status === '50% Conclu√≠do') progressValue += 0.5;
						else if (service.status === 'Em Andamento') progressValue += 0.25;
					});
					const serviceProgress = totalServices > 0 ? (progressValue / totalServices) * 100 : 0;
		
					const totalPaid = (contract.parcels || []).reduce((sum, p) => sum + (p.valuePaid || 0), 0) + (contract.successFeeValueReceived || 0);
					const financialProgress = (contract.totalValue || 0) > 0 ? (totalPaid / contract.totalValue) * 100 : (totalPaid > 0 ? 100 : 0);
					
					fragment.append(this.domBuilder.createServicoCard(contract, serviceProgress, financialProgress));
				});
				container.append(fragment);
			}
			
			/**
			 * @description Renderiza a p√°gina da Lixeira
			 */
			renderLixeiraPage() {
				const contractsToRender = this.getFilteredContracts(true);
				const container = document.getElementById('lixeiraListContainer');
				container.innerHTML = '';
				const deletedContracts = contractsToRender.filter(c => c.isDeleted === true);
		
				if (deletedContracts.length === 0) {
					container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><div class="inline-block dark-card text-gray-400 p-6 rounded-lg shadow-md"><i class="fas fa-trash fa-3x mb-3"></i><p class="font-bold text-xl">Lixeira Vazia</p><p class="text-sm">Nenhum contrato foi exclu√≠do.</p></div></div>`;
					return;
				}
		
				const fragment = document.createDocumentFragment();
				deletedContracts.forEach(contract => {
					const card = this.domBuilder.buildElement('div', { className: 'dark-card p-5 rounded-lg shadow-lg border-l-4 border-gray-600' });
					card.append(this.domBuilder.buildElement('p', { className: 'font-bold text-lg text-white', text: contract.clientName }));
					const services = (contract.serviceTypes || []).map(s => s.name).join(', ');
					card.append(this.domBuilder.buildElement('p', { className: 'text-sm text-gray-400 mb-3', text: services }));
					
					const footer = this.domBuilder.buildElement('div', { className: 'border-t border-gray-700 pt-3 mt-3 flex gap-2' });
					
					const restoreBtn = this.domBuilder.buildElement('button', { className: 'w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2', html: '<i class="fas fa-undo"></i> Restaurar' });
					restoreBtn.onclick = () => this.restoreContract(contract.id);
					footer.append(restoreBtn);
		
					if (this.isUserAdmin) {
						const deleteBtn = this.domBuilder.buildElement('button', { className: 'w-full bg-red-800 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2', html: '<i class="fas fa-times-circle"></i> Excluir Prmt.' });
						deleteBtn.onclick = () => this.deleteContractPermanently(contract.id);
						footer.append(deleteBtn);
					}
					
					card.append(footer);
					fragment.append(card);
				});
				container.append(fragment);
			}
		
			// --- 4. L√ìGICA DE UI (Filtros, Abas, Helpers) ---
		
			showPage(pageId) {
				['page-dashboard', 'page-inadimplentes', 'page-servicos', 'page-lixeira'].forEach(id => {
					const el = document.getElementById(id);
					if (el) el.classList.add('hidden');
				});
				['tab-dashboard', 'tab-inadimplentes', 'tab-servicos', 'tab-lixeira'].forEach(id => {
					const tab = document.getElementById(id);
					if (tab) tab.classList.remove('active');
				});
		
				const targetPage = document.getElementById(pageId);
				if (targetPage) targetPage.classList.remove('hidden');
		
				const tabId = `tab-${pageId.split('-')[1]}`;
				const targetTab = document.getElementById(tabId);
				if (targetTab) targetTab.classList.add('active');
		
				// Chama o render, que agora √© inteligente e renderiza a p√°gina ativa
				this.render();
			}
		
			setupUIAccess() {
				const isAdmin = this.isUserAdmin;
				const advogadoFilters = [
					document.getElementById('advogadoFilter'),
					document.getElementById('servicosAdvogadoFilter')
				];
				advogadoFilters.forEach(select => {
					if (select) {
						select.disabled = !isAdmin;
						select.value = isAdmin ? 'Todos' : this.currentUserDisplayName;
					}
				});
		
				const financialFields = ['valorTotal', 'numParcelas', 'vencimentoPrimeiraParcela', 'taxaExito'];
				financialFields.forEach(id => {
					const field = document.getElementById(id);
					if (field) field.disabled = !isAdmin;
				});
		
				this.populateAdvogadoSelectModal();
			}
			
			getFilteredContracts(includeDeleted = false) {
				const allContracts = this.database.contracts;
				if (this.isUserAdmin) return includeDeleted ? allContracts : allContracts.filter(c => !c.isDeleted);
				return allContracts.filter(c => c.advogadoResponsavel === this.currentUserDisplayName && (includeDeleted ? true : !c.isDeleted));
			}
		
			getContractStatus(contract) {
				const hasPendingParcels = (contract.parcels || []).some(p => p.status === 'Pendente');
				if (hasPendingParcels) return { statusText: 'Ativo', statusColor: 'bg-yellow-900/50 text-yellow-300', borderColor: 'border-yellow-500' };
				if (contract.successFee && !contract.successFeePaymentDate) return { statusText: 'Aguardando √äxito', statusColor: 'bg-indigo-900/50 text-indigo-300', borderColor: 'border-indigo-500' };
				return { statusText: 'Conclu√≠do', statusColor: 'bg-gray-700 text-gray-300', borderColor: 'border-gray-600' };
			}
		
			renderSortButtons() {
				const contractSortContainer = document.getElementById('contractSortButtons');
				const inadimplentesSortContainer = document.getElementById('inadimplentesSortButtons');
				const servicosSortContainer = document.getElementById('servicosSortButtons');
				if (!contractSortContainer || !inadimplentesSortContainer || !servicosSortContainer) return;
				
				const createButton = (container, sortKey, sortLabel, currentSort, callback) => {
					const button = this.domBuilder.buildElement('button', { text: sortLabel, className: 'sort-button' });
					if (currentSort === sortKey) button.classList.add('active');
					button.onclick = () => {
						callback(sortKey); // Atualiza o estado de ordena√ß√£o
						this.render(); // Re-renderiza a p√°gina atual
						this.renderSortButtons(); // Re-desenha os bot√µes
					};
					container.append(button);
				};
		
				// Limpa
				contractSortContainer.innerHTML = '';
				inadimplentesSortContainer.innerHTML = '';
				servicosSortContainer.innerHTML = '';
		
				// Bot√µes da lista de Contratos
				createButton(contractSortContainer, 'name-asc', 'Nome (A-Z)', this.currentContractSort, (key) => { this.currentContractSort = key; this.resetAndRenderContractList(); });
				if (this.isUserAdmin) {
					createButton(contractSortContainer, 'value-desc', 'Valor (Maior)', this.currentContractSort, (key) => { this.currentContractSort = key; this.resetAndRenderContractList(); });
				}
		
				// Bot√µes de Inadimplentes
				createButton(inadimplentesSortContainer, 'days-desc', 'Mais Antigas', this.currentInadimplentesSort, (key) => { this.currentInadimplentesSort = key; });
				createButton(inadimplentesSortContainer, 'name-asc', 'Nome (A-Z)', this.currentInadimplentesSort, (key) => { this.currentInadimplentesSort = key; });
				if (this.isUserAdmin) {
					createButton(inadimplentesSortContainer, 'value-desc', 'Maior Valor', this.currentInadimplentesSort, (key) => { this.currentInadimplentesSort = key; });
				}
		
				// Bot√µes de Servi√ßos
				createButton(servicosSortContainer, 'name-asc', 'Cliente (A-Z)', this.currentServicosSort, (key) => { this.currentServicosSort = key; });
				createButton(servicosSortContainer, 'adv-asc', 'Advogado (A-Z)', this.currentServicosSort, (key) => { this.currentServicosSort = key; });
			}
			
			renderAdvogadoFilters() {
				const advogados = [...new Set(this.database.contracts.map(c => c.advogadoResponsavel))].sort();
				const filterSelects = [document.getElementById('advogadoFilter'), document.getElementById('servicosAdvogadoFilter')];
				const fixedNames = ["Dra. Renata Fabris", "Dr. Felipe Gurj√£o", "Dr. Glaison", "Dr. Bruno D'Lucas", "Dra. Danielle Guimar√£es", "Dr. Joaquim Oc√©lio", "Dra. Larissa Mendes"];
				const allNames = new Set([...fixedNames, ...advogados]);
		
				filterSelects.forEach(select => {
					if (!select) return;
					const currentValue = select.value;
					select.innerHTML = '<option value="Todos">Todos</option>';
					select.add(new Option("N√£o Informado", "N√£o Informado"));
		
					[...allNames].filter(adv => adv && adv !== "N√£o Informado" && adv !== "Todos").sort().forEach(adv => {
						select.add(new Option(adv, adv));
					});
		
					select.value = this.isUserAdmin ? (currentValue || 'Todos') : this.currentUserDisplayName;
					select.disabled = !this.isUserAdmin;
				});
			}
		
			populateAdvogadoSelectModal() {
				const select = document.getElementById('advogadoResponsavel');
				if (!select) return;
				const currentValue = select.value;
				select.innerHTML = '';
				select.add(new Option("N√£o Informado", "N√£o Informado"));
		
				const advogados = [...new Set(this.database.contracts.map(c => c.advogadoResponsavel))].sort();
				const fixedNames = ["Dra. Renata Fabris", "Dr. Felipe Gurj√£o", "Dr. Glaison", "Dr. Bruno D'Lucas", "Dra. Danielle Guimar√£es", "Dr. Joaquim Oc√©lio", "Dra. Larissa Mendes"];
				const allNames = new Set([...fixedNames, ...advogados]);
		
				[...allNames].filter(adv => adv && adv !== "N√£o Informado").sort().forEach(adv => {
					select.add(new Option(adv, adv));
				});
		
				select.value = currentValue && currentValue !== 'N√£o Informado' ? currentValue : (this.isUserAdmin ? 'N√£o Informado' : this.currentUserDisplayName);
				select.disabled = !this.isUserAdmin && !!this.currentUserDisplayName;
			}
			
			changeContractPage(pageIndex) {
				this.contractListPage = pageIndex;
				this.renderContractList();
				document.getElementById('contractListContainer').scrollIntoView({ behavior: 'smooth' });
			}
			
			resetAndRenderContractList() {
				this.contractListPage = 0;
				this.renderContractList();
			}
		
			// --- 5. L√ìGICA DE A√á√ïES (CRUD) ---
			
			async handleDisplayNameSubmit(e) {
				e.preventDefault();
				const name = document.getElementById('inputDisplayName').value;
				if (name && (await this.authService.updateUserProfile(name))) {
					this.currentUserDisplayName = name;
					this.isUserAdmin = ADMIN_USERS.includes(name);
					document.body.classList.toggle('is-admin', this.isUserAdmin);
					document.getElementById('user-display-name').textContent = name;
					this.closeModal('modalDisplayName');
					this.appContainer.style.display = 'block';
					this.setupUIAccess();
					this.firebaseService.startSnapshotListener('contracts'); // Inicia listener ap√≥s salvar nome
				}
			}
		
			async handleContractSubmit(e) {
				e.preventDefault();
				const contractId = document.getElementById('contractId').value;
				const serviceTags = document.querySelectorAll('#servicosContainer .service-tag');
				const serviceTypes = Array.from(serviceTags).map(tag => ({
					name: Utils.sanitizeText(tag.dataset.name),
					status: tag.dataset.status || 'Pendente',
					deadline: tag.dataset.deadline || null
				}));
				if (serviceTypes.length === 0) { Utils.showToast('Adicione pelo menos um servi√ßo.', 'error'); return; }
		
				const contractData = {
					clientName: Utils.sanitizeText(document.getElementById('clienteNome').value),
					advogadoResponsavel: Utils.sanitizeText(document.getElementById('advogadoResponsavel').value),
					serviceTypes,
					paymentType: Utils.sanitizeText(document.getElementById('contratoTipoPagamento').value),
					observations: Utils.sanitizeText(document.getElementById('contratoObservacoes').value),
				};
		
				if (this.isUserAdmin) {
					Object.assign(contractData, {
						totalValue: Utils.parseNumber(document.getElementById('valorTotal').value),
						successFee: Utils.sanitizeText(document.getElementById('taxaExito').value) || null,
					});
				}
		
				if (!contractId) {
					// --- L√≥gica de NOVO Contrato ---
					Object.assign(contractData, {
						successFeeValueReceived: 0,
						successFeePaymentDate: null,
						isDeleted: false,
						parcels: []
					});
		
					if (this.isUserAdmin) {
						const jaQuitado = document.getElementById('contratoJaQuitado').checked;
						const totalValue = contractData.totalValue;
						const numParcels = parseInt(document.getElementById('numParcelas').value) || 1;
						const firstDueDate = document.getElementById('vencimentoPrimeiraParcela').value;
		
						if (numParcels > 0 && totalValue > 0) {
							if (!firstDueDate && !jaQuitado) {
								Utils.showToast('Informe data da 1¬™ parcela.', 'error');
								return;
							}
							const parcelValue = totalValue / numParcels;
							let currentDueDate = new Date((firstDueDate || new Date().toISOString().split('T')[0]) + 'T12:00:00Z');
							for (let i = 0; i < numParcels; i++) {
								const isPaid = jaQuitado && numParcels === 1;
								contractData.parcels.push({
									number: i + 1, value: parcelValue,
									dueDate: new Date(currentDueDate).toISOString(),
									status: isPaid ? 'Paga' : 'Pendente',
									valuePaid: isPaid ? parcelValue : 0,
									paymentDate: isPaid ? new Date().toISOString() : null
								});
								currentDueDate.setMonth(currentDueDate.getMonth() + 1);
							}
						}
					}
					if (await this.firebaseService.addContract(contractData)) {
						this.closeModal('modalContrato');
					}
				} else {
					// --- L√≥gica de EDITAR Contrato ---
					const existingContract = this.database.contracts.find(c => c.id === contractId);
					if (!this.isUserAdmin && existingContract) {
						// N√£o-admin s√≥ pode editar campos n√£o-financeiros
						contractData.totalValue = existingContract.totalValue;
						contractData.successFee = existingContract.successFee;
						contractData.parcels = existingContract.parcels;
						contractData.successFeeValueReceived = existingContract.successFeeValueReceived;
						contractData.successFeePaymentDate = existingContract.successFeePaymentDate;
					} else if (this.isUserAdmin && existingContract) {
						// Admin editando mant√©m parcelas e pagamentos de √™xito existentes
						contractData.parcels = existingContract.parcels;
						contractData.successFeeValueReceived = existingContract.successFeeValueReceived;
						contractData.successFeePaymentDate = existingContract.successFeePaymentDate;
					}
					contractData.isDeleted = existingContract?.isDeleted || false;
					
					if (await this.firebaseService.updateContract(contractId, contractData)) {
						this.closeModal('modalContrato');
					}
				}
			}
			
			async handlePaymentSubmit(e) {
				e.preventDefault();
				const contractId = document.getElementById('pagamentoContractId').value;
				const parcelIndex = parseInt(document.getElementById('pagamentoParcelIndex').value);
				const contract = this.database.contracts.find(c => c.id === contractId);
				const valuePaid = this.isUserAdmin
					? Utils.parseNumber(document.getElementById('pagamentoValor').value)
					: (contract?.parcels[parcelIndex]?.value || 0);
				const paymentDate = document.getElementById('pagamentoData').value;
		
				if (contract && !isNaN(valuePaid)) {
					const updatedParcels = [...(contract.parcels || [])];
					updatedParcels[parcelIndex].status = 'Paga';
					updatedParcels[parcelIndex].valuePaid = valuePaid;
					updatedParcels[parcelIndex].paymentDate = new Date(paymentDate + 'T12:00:00Z').toISOString();
					
					const success = await this.firebaseService.updateContractField(contractId, { parcels: updatedParcels });
					if (success) {
						this.closeModal('modalPagamento');
						Utils.showToast('Pagamento registado.', 'success');
					}
				} else {
					Utils.showToast('Valor de pagamento inv√°lido.', 'error');
				}
			}
		
			async handleExitoSubmit(e) {
				e.preventDefault();
				const contractId = document.getElementById('exitoContractId').value;
				const valueReceived = this.isUserAdmin ? Utils.parseNumber(document.getElementById('exitoValorRecebido').value) : 0;
				const contract = this.database.contracts.find(c => c.id === contractId);
		
				if (contract) {
					if (this.isUserAdmin && (isNaN(valueReceived) || valueReceived <= 0)) {
						Utils.showToast('Valor de √™xito inv√°lido.', 'error');
						return;
					}
					const success = await this.firebaseService.updateContractField(contractId, {
						successFeeValueReceived: valueReceived,
						successFeePaymentDate: new Date().toISOString()
					});
					if (success) {
						this.closeModal('modalExito');
						Utils.showToast('√äxito registado.', 'success');
					}
				}
			}
		
			handleAddServiceTag() {
				const nameInput = document.getElementById('contratoServicoInput');
				const deadlineInput = document.getElementById('contratoPrazoInput');
				const serviceName = Utils.sanitizeText(nameInput.value);
				const deadline = deadlineInput.value || null;
		
				if (serviceName) {
					this.createServiceTag(serviceName, deadline, 'Pendente');
					nameInput.value = '';
					deadlineInput.value = '';
					nameInput.focus();
				} else {
					Utils.showToast('Por favor, insira um nome para o servi√ßo.', 'error');
				}
			}
			
			async updateServiceStatus(contractId, serviceIndex, newStatus) {
				const contract = this.database.contracts.find(c => c.id === contractId);
				if (contract && (contract.serviceTypes || [])[serviceIndex]) {
					const updatedServiceTypes = [...contract.serviceTypes];
					updatedServiceTypes[serviceIndex].status = newStatus;
					await this.firebaseService.updateContractField(contractId, { serviceTypes: updatedServiceTypes });
				}
			}
		
			async moveToLixeira(contractId) {
				const contract = this.database.contracts.find(c => c.id === contractId);
				if (!contract) return;
				const ok = await Utils.confirm(`Tem a certeza que deseja mover o contrato de "${contract.clientName}" para a lixeira?`);
				if (!ok) return;
				
				const success = await this.firebaseService.updateContractField(contractId, { isDeleted: true });
				if (success) Utils.showToast('Contrato movido para a lixeira.', 'success');
			}
		
			async restoreContract(contractId) {
				const ok = await Utils.confirm(`Tem a certeza que deseja restaurar este contrato?`);
				if (!ok) return;
				const success = await this.firebaseService.updateContractField(contractId, { isDeleted: false });
				if (success) Utils.showToast('Contrato restaurado.', 'success');
			}
		
			async deleteContractPermanently(contractId) {
				if (!this.isUserAdmin) return;
				const ok = await Utils.confirm(`EXCLUS√ÉO PERMANENTE: Tem a certeza? Esta a√ß√£o n√£o pode ser desfeita.`);
				if (!ok) return;
				await this.firebaseService.deleteContract(contractId);
				// O Toast j√° √© mostrado pelo firebaseService
			}
		
			// --- 6. L√ìGICA DE MODAIS (com Acessibilidade) ---
		
			openModal(modalId) {
				// Guarda o foco atual
				this.lastFocusedElement = document.activeElement;
		
				// Fecha outros modais
				const modals = document.querySelectorAll('.modal');
				modals.forEach(m => { if (m && m.style.display === 'block' && m.id !== modalId) m.style.display = 'none'; });
				
				const modal = document.getElementById(modalId);
				if (modal) modal.style.display = 'block';
				
				if (this.backdrop) this.backdrop.style.display = 'block';
				document.body.style.overflow = 'hidden';
				this.appContainer.setAttribute('aria-hidden', 'true');
				this.openModalId = modalId;
		
				// Foca no primeiro elemento interativo dentro do modal
				const firstFocusableEl = modal.querySelector('button, [href], input, select, textarea');
				if (firstFocusableEl) firstFocusableEl.focus();
			}
		
			closeModal(modalId) {
				const el = document.getElementById(modalId);
				if (el) el.style.display = 'none';
				
				if (this.openModalId === modalId) this.openModalId = null;
		
				const anyOpen = Array.from(document.querySelectorAll('.modal')).some(m => m.style.display === 'block');
				
				if (this.backdrop && !anyOpen) {
					this.backdrop.style.display = 'none';
					document.body.style.overflow = '';
					this.appContainer.setAttribute('aria-hidden', 'false');
					
					// Restaura o foco para o elemento que abriu o modal
					if (this.lastFocusedElement) this.lastFocusedElement.focus();
				}
				
				// Limpa gr√°ficos se for o modal de relat√≥rio
				if (modalId === 'modalRelatorio') {
					this.analyticsHandler.destroyAllCharts();
				}
			}
		
			openContractModal(contractId = null) {
				try {
					const form = document.getElementById('formContrato'); form.reset();
					const title = document.getElementById('modalContratoTitle');
					const servicosContainer = document.getElementById('servicosContainer'); servicosContainer.innerHTML = '';
					this.populateAdvogadoSelectModal();
					const advogadoSelect = document.getElementById('advogadoResponsavel');
					const jaQuitadoCheckbox = document.getElementById('contratoJaQuitado');
		
					if (contractId) {
						// Modo de Edi√ß√£o
						const contract = this.database.contracts.find(c => c.id === contractId);
						if (!contract) { Utils.showToast('Contrato n√£o encontrado.', 'error'); return; }
						title.textContent = "Editar Contrato";
						document.getElementById('contractId').value = contract.id;
						document.getElementById('clienteNome').value = contract.clientName;
						advogadoSelect.value = contract.advogadoResponsavel;
						(contract.serviceTypes || []).forEach(service => this.createServiceTag(service.name, service.deadline, service.status));
						document.getElementById('contratoTipoPagamento').value = contract.paymentType || 'Parcelado';
						document.getElementById('contratoObservacoes').value = contract.observations || '';
						jaQuitadoCheckbox.checked = false;
						jaQuitadoCheckbox.disabled = true;
						if (this.isUserAdmin) {
							document.getElementById('valorTotal').value = contract.totalValue || '';
							document.getElementById('numParcelas').value = (contract.parcels || []).length || 1;
							document.getElementById('taxaExito').value = contract.successFee || '';
							if ((contract.parcels || []).length > 0) {
								document.getElementById('vencimentoPrimeiraParcela').value = contract.parcels[0].dueDate.split('T')[0];
							}
						}
					} else {
						// Modo de Cria√ß√£o
						title.textContent = "Registar Novo Contrato";
						document.getElementById('contractId').value = '';
						advogadoSelect.value = this.isUserAdmin ? 'N√£o Informado' : this.currentUserDisplayName;
						jaQuitadoCheckbox.checked = false;
						jaQuitadoCheckbox.disabled = false;
					}
					this.setupUIAccess();
					this.openModal('modalContrato');
				} catch (e) {
					console.error('Erro em openContractModal:', e);
					Utils.showToast('Falha ao abrir o modal de contrato.', 'error');
				}
			}
			
			async openPaymentModal(contractId, parcelIndex) {
				const contract = this.database.contracts.find(c => c.id === contractId);
				if (!contract || !contract.parcels || !contract.parcels[parcelIndex]) return;
				const parcel = contract.parcels[parcelIndex];
		
				let valorCorrigido = parcel.value;
				let infoCorrecao = '';
				if (new Date(parcel.dueDate) < new Date()) {
					valorCorrigido = await this.correctionCalculator.calcularValorCorrigido(parcel.value, parcel.dueDate);
					if (this.isUserAdmin) infoCorrecao = `<p class="text-red-400"><strong>Valor Corrigido:</strong> ${Utils.formatCurrency(valorCorrigido)}</p>`;
				}
		
				document.getElementById('pagamentoContractId').value = contractId;
				document.getElementById('pagamentoParcelIndex').value = parcelIndex;
				const infoDiv = document.getElementById('pagamentoInfo');
				infoDiv.innerHTML = `
					<p><strong>Cliente:</strong> ${contract.clientName}</p>
					<p><strong>Parcela:</strong> ${parcel.number}/${contract.parcels.length}</p>
					${this.isUserAdmin ? `<p><strong>Valor Original:</strong> ${Utils.formatCurrency(parcel.value)}</p>` : ''}
					${infoCorrecao}`;
		
				const valorInput = document.getElementById('pagamentoValor');
				valorInput.value = (this.isUserAdmin ? valorCorrigido : parcel.value).toFixed(2);
				valorInput.disabled = !this.isUserAdmin;
		
				document.getElementById('pagamentoData').value = new Date().toISOString().split('T')[0];
				this.openModal('modalPagamento');
			}
		
			openClientHistoryModal(clientName) {
				const clientContracts = (this.isUserAdmin ? this.database.contracts : this.getFilteredContracts(true))
					.filter(c => c.clientName === clientName);
				const title = document.getElementById('clienteModalTitle'); title.textContent = `Hist√≥rico de ${clientName}`;
				const content = document.getElementById('clienteModalContent'); content.innerHTML = '';
		
				let totalContratado = 0, totalPago = 0;
				const fragment = document.createDocumentFragment();
		
				clientContracts.forEach(contract => {
					const contractValue = contract.totalValue || 0;
					if (this.isUserAdmin) totalContratado += contractValue;
		
					let contractHtml = `<div class="bg-gray-700 p-4 rounded-lg ${contract.isDeleted ? 'opacity-60 border-l-4 border-gray-500' : ''}">`;
					contractHtml += `<div class="flex justify-between items-start">
						<h3 class="font-bold text-lg text-white">${(contract.serviceTypes || []).map(s => s.name).join(', ')} <span class="text-base font-normal text-gray-400">- ${contract.paymentType || ''}</span></h3>
						${contract.isDeleted ? '<span class="text-xs bg-red-900/50 text-red-300 px-2 py-1 rounded-full font-semibold">Exclu√≠do</span>' : ''}
					</div>`;
					contractHtml += `<p class="text-sm text-gray-400 mb-2">Adv: ${contract.advogadoResponsavel}</p>`;
					if (contract.observations) contractHtml += `<blockquote class="text-sm mt-2 p-2 bg-gray-600/50 rounded-md text-gray-300 border-l-4 border-indigo-500 pl-4"><strong>Obs:</strong> ${Utils.sanitizeText(contract.observations)}</blockquote>`;
		
					if ((contract.parcels || []).length > 0) {
						contractHtml += `<ul class="mt-2 text-sm space-y-1">`;
						contract.parcels.forEach(p => {
							const statusClass = p.status === 'Paga' ? 'text-green-400' : 'text-red-400';
							let valorPagoDisplay = '';
							if (p.status === 'Paga') {
								if (this.isUserAdmin) totalPago += p.valuePaid || 0;
								valorPagoDisplay = this.isUserAdmin ? `(pago ${Utils.formatCurrency(p.valuePaid || 0)})` : '(pago)';
							}
							const valorParcelaDisplay = this.isUserAdmin ? Utils.formatCurrency(p.value) : '[Restrito]';
							contractHtml += `<li>Parcela ${p.number} - ${valorParcelaDisplay} - <span class="${statusClass}">${p.status}</span> ${valorPagoDisplay}</li>`;
						});
						contractHtml += `</ul>`;
					}
					if (contract.successFeePaymentDate) {
						const exitoRecebidoDisplay = this.isUserAdmin ? Utils.formatCurrency(contract.successFeeValueReceived) : '[Recebido]';
						if (this.isUserAdmin) totalPago += contract.successFeeValueReceived || 0;
						contractHtml += `<p class="mt-2 text-sm text-green-400">√äxito Recebido: ${exitoRecebidoDisplay}</p>`;
					}
					contractHtml += `</div>`;
					
					const el = this.domBuilder.buildElement('div');
					el.innerHTML = contractHtml; // innerHTML usado aqui para conte√∫do complexo, mas dados do BD (obs) s√£o sanitizados
					fragment.append(el);
				});
		
				if (this.isUserAdmin) {
					const summaryHtml = `
					<div class="grid grid-cols-3 gap-4 text-center">
						<div><p class="text-sm text-gray-400">Total Contratado</p><p class="font-bold text-lg text-white">${Utils.formatCurrency(totalContratado)}</p></div>
						<div><p class="text-sm text-gray-400">Total Pago</p><p class="font-bold text-lg text-green-400">${Utils.formatCurrency(totalPago)}</p></div>
						<div><p class="text-sm text-gray-400">Saldo Devedor</p><p class="font-bold text-lg text-red-400">${Utils.formatCurrency(totalContratado - totalPago)}</p></div>
					</div><hr class="my-4 border-gray-700">`;
					const summaryEl = this.domBuilder.buildElement('div');
					summaryEl.innerHTML = summaryHtml;
					content.append(summaryEl);
				}
				
				content.append(fragment);
				this.openModal('modalCliente');
			}
			
			openReportModal() {
				if (!this.isUserAdmin) { Utils.showToast('Apenas admins podem abrir o relat√≥rio.', 'error'); return; }
				this.openModal('modalRelatorio');
				try {
					this._populateDateSelectors();
					this.generateAndShowReport();
				} catch(e) {
					console.error("Erro ao gerar relat√≥rio:", e);
					Utils.showToast('N√£o foi poss√≠vel gerar o relat√≥rio.', 'error');
				}
			}
		
			_populateDateSelectors() {
				const monthSelect = document.getElementById('reportMonth');
				const yearSelect = document.getElementById('reportYear');
				if (monthSelect.options.length > 0) return; // J√° populado
				const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
				const anoAtual = new Date().getFullYear();
				meses.forEach((mes, index) => { monthSelect.add(new Option(mes, index)); });
				for (let i = anoAtual; i >= anoAtual - 5; i--) { yearSelect.add(new Option(i, i)); }
				monthSelect.value = new Date().getMonth(); yearSelect.value = anoAtual;
			}
			
			generateAndShowReport() {
				if (!this.isUserAdmin) return;
				document.getElementById('reportChartsContainer').classList.add('hidden');
				const resultDiv = document.getElementById('reportResult');
				resultDiv.classList.remove('hidden');
		
				const month = parseInt(document.getElementById('reportMonth').value);
				const year = parseInt(document.getElementById('reportYear').value);
				const income = this.reportHandler.calculateMonthlyIncome(year, month, this.getFilteredContracts(true));
		
				let detailsHtml = '<h4 class="text-lg font-semibold mt-6 border-t border-gray-700 pt-4 text-white">Detalhes dos Recebimentos</h4>';
				if (income.detailedPayments.length > 0) {
					detailsHtml += '<ul class="space-y-2 mt-2 text-sm">';
					income.detailedPayments.forEach(p => {
						detailsHtml += `<li class="flex justify-between items-center bg-gray-700/50 p-3 rounded-md"><div><p class="font-semibold text-white">${p.clientName}</p><p class="text-xs text-gray-400">${p.type} - ${p.date}</p></div><span class="font-semibold text-green-400 text-lg">${Utils.formatCurrency(p.value)}</span></li>`;
					});
					detailsHtml += '</ul>';
				} else {
					detailsHtml += '<p class="text-sm text-gray-400 mt-2">Nenhum recebimento neste per√≠odo.</p>';
				}
		
				resultDiv.innerHTML = `
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div class="dark-card p-4 rounded-lg text-center"><p class="text-sm text-gray-400">Total (Parcelas)</p><p class="text-2xl font-bold text-white">${Utils.formatCurrency(income.totalParcelas)}</p></div>
						<div class="dark-card p-4 rounded-lg text-center"><p class="text-sm text-gray-400">Total (√äxito)</p><p class="text-2xl font-bold text-indigo-400">${Utils.formatCurrency(income.totalExito)}</p></div>
					</div>
					<div class="bg-gray-900 p-4 rounded-lg border border-gray-700 text-center"><p class="text-white font-bold">TOTAL GERAL RECEBIDO</p><p class="text-3xl font-extrabold text-green-400">${Utils.formatCurrency(income.totalGeral)}</p></div>
				` + detailsHtml;
			}
		
			showAnalyticsInModal() {
				if (!this.isUserAdmin) return;
				document.getElementById('reportResult').classList.add('hidden');
				document.getElementById('reportChartsContainer').classList.remove('hidden');
				
				try {
					const actualCtx = document.getElementById('actualIncomeChartModal')?.getContext('2d');
					const projectedCtx = document.getElementById('projectedIncomeChartModal')?.getContext('2d');
					if (!actualCtx || !projectedCtx) return;
		
					const allContracts = this.getFilteredContracts(true);
					const actualData = this.reportHandler.getActualIncomeData(allContracts);
					this.analyticsHandler.renderActualIncomeChart(actualCtx, actualData.labels, actualData.data);
					
					const projectedData = this.reportHandler.getProjectedIncomeData(allContracts);
					this.analyticsHandler.renderProjectedIncomeChart(projectedCtx, projectedData.labels, projectedData.data);
				} catch (e) {
					console.error('Erro ao renderizar gr√°ficos:', e);
					Utils.showToast('Erro ao carregar gr√°ficos.', 'error');
				}
			}
		
			openExitoModal(contractId) {
				const contract = this.database.contracts.find(c => c.id === contractId); if (!contract) return;
				document.getElementById('exitoContractId').value = contractId;
				const exitoInfoEl = document.getElementById('exitoInfo');
				const valorRecebidoInput = document.getElementById('exitoValorRecebido');
		
				exitoInfoEl.innerHTML = `<p><strong>Cliente:</strong> ${contract.clientName}</p><p><strong>Servi√ßo:</strong> ${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p>${this.isUserAdmin ? `<p><strong>Bonifica√ß√£o Prevista:</strong> <span class="font-bold text-indigo-400">${contract.successFee}</span></p>` : ''}`;
		
				valorRecebidoInput.value = '';
				valorRecebidoInput.closest('.admin-only').style.display = this.isUserAdmin ? 'block' : 'none';
				document.querySelector('#modalExito .non-admin-hidden').style.display = this.isUserAdmin ? 'none' : 'block';
		
				this.openModal('modalExito');
			}
		
			createServiceTag(serviceName, deadline, status = 'Pendente') {
				const container = document.getElementById('servicosContainer');
				const tag = this.domBuilder.buildElement('div', { className: 'service-tag' });
				tag.dataset.name = serviceName;
				tag.dataset.deadline = deadline || '';
				tag.dataset.status = status;
		
				let deadlineHtml = '';
				if (deadline) {
					const prazo = new Date(deadline + "T12:00:00Z");
					deadlineHtml = `<span class="text-xs text-gray-400 ml-2">(${Utils.formatDate(prazo)})</span>`;
				}
				tag.innerHTML = `<span>${serviceName}${deadlineHtml}</span><span class="remove-tag" onclick="this.parentElement.remove()">&times;</span>`;
				container.appendChild(tag);
			}
		
			// --- 7. EXPORTA√á√ÉO E FUN√á√ïES AUXILIARES ---
		
			_formatCSVCell(data) {
				if (data == null) return '';
				let s = String(data);
				if (s.includes(',') || s.includes('"') || s.includes('\n')) {
					s = s.replace(/"/g, '""');
					return `"${s}"`;
				}
				return s;
			}
			
			_downloadCSV(csvContent, filename) {
				const b = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
				const l = document.createElement("a");
				const u = URL.createObjectURL(b);
				l.href = u;
				l.download = filename;
				l.style.visibility = 'hidden';
				document.body.appendChild(l);
				l.click();
				document.body.removeChild(l);
			}
		
			exportContractsCSV() {
				const headers = ["ID", "Cliente", "Advogado", "Tipo Pagamento", "Valor Total", "Taxa √äxito", "Status", "Servi√ßos", "Observa√ß√µes"];
				let csvRows = [headers.join(',')];
				this.getFilteredContracts(false).forEach(c => {
					const status = this.getContractStatus(c).statusText;
					const services = (c.serviceTypes || []).map(s => s.name).join('; ');
					const row = [
						c.id, c.clientName, c.advogadoResponsavel, c.paymentType || '',
						this.isUserAdmin ? c.totalValue : 'Restrito', this.isUserAdmin ? c.successFee : 'Restrito',
						status, services, c.observations || ''
					].map(this._formatCSVCell).join(',');
					csvRows.push(row);
				});
				this._downloadCSV(csvRows.join('\n'), 'contratos_export.csv');
			}
		
			exportReportCSV() {
				if (!this.isUserAdmin) return;
				const month = parseInt(document.getElementById('reportMonth').value);
				const year = parseInt(document.getElementById('reportYear').value);
				const income = this.reportHandler.calculateMonthlyIncome(year, month, this.getFilteredContracts(true));
				
				if (income.detailedPayments.length === 0) { Utils.showToast("Nenhum dado para exportar.", "info"); return; }
				
				const headers = ["Cliente", "Tipo", "Data", "Valor"];
				let csvRows = [headers.join(',')];
				income.detailedPayments.forEach(p => {
					const row = [p.clientName, p.type, p.date, p.value].map(this._formatCSVCell).join(',');
					csvRows.push(row);
				});
				const monthName = document.getElementById('reportMonth').options[month].text;
				this._downloadCSV(csvRows.join('\n'), `relatorio_${monthName}_${year}.csv`);
			}
			
			// (Fun√ß√£o de Rec√°lculo - mantida se necess√°ria para admin)
			async recalculateAllDebts(referenceDate = new Date()) {
				if (!this.isUserAdmin) { Utils.showToast('A√ß√£o n√£o permitida.', 'error'); return; }
				Utils.showToast('A iniciar rec√°lculo... Isto pode demorar um momento.', 'info');
				const contracts = this.database.contracts.filter(c => !c.isDeleted);
				for (const contract of contracts) {
					if (!contract.parcels) continue;
					const updatedParcels = await Promise.all(contract.parcels.map(async (p) => {
						if (p.status === 'Pendente') {
							const updated = await this.correctionCalculator.calcularValorCorrigido(p.value, p.dueDate, referenceDate);
							return { ...p, correctedValue: updated };
						}
						return p;
					}));
					// Esta opera√ß√£o √© pesada e pode ser otimizada, mas segue a l√≥gica original
					await this.firebaseService.updateContractField(contract.id, { parcels: updatedParcels });
				}
				Utils.showToast('Rec√°lculo conclu√≠do.', 'success');
			}
		
			// --- 8. [NOVO] HELPERS DE ACESSIBILIDADE ---
			
			_setupModalAccessibility() {
				document.addEventListener('keydown', this._handleKeyDown.bind(this));
			}
		
			_handleKeyDown(event) {
				// Fecha modal com 'Esc'
				if (event.key === 'Escape' && this.openModalId) {
					if (this.openModalId !== 'modalDisplayName') { // N√£o permite fechar o modal de nome
						this.closeModal(this.openModalId);
					}
				}
		
				// Trava de Foco com 'Tab'
				if (event.key === 'Tab' && this.openModalId) {
					this._trapFocus(event);
				}
			}
		
			_trapFocus(event) {
				const modal = document.getElementById(this.openModalId);
				if (!modal) return;
				
				const focusableElements = modal.querySelectorAll(
					'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
				);
				if (focusableElements.length === 0) return; // Se n√£o h√° nada foc√°vel, n√£o faz nada
				
				const firstElement = focusableElements[0];
				const lastElement = focusableElements[focusableElements.length - 1];
		
				if (event.shiftKey) { // Shift + Tab
					if (document.activeElement === firstElement) {
						lastElement.focus();
						event.preventDefault();
					}
				} else { // Tab
					if (document.activeElement === lastElement) {
						firstElement.focus();
						event.preventDefault();
					}
				}
				
				// Cobre o caso do foco tentar sair do modal
				if (!modal.contains(document.activeElement)) {
					firstElement.focus();
				}
			}
		}
		
		// --- INICIALIZA√á√ÉO DA APLICA√á√ÉO ---
		document.addEventListener('DOMContentLoaded', () => {
			// Exp√µe a inst√¢ncia da classe no objeto window para que
			// os `onclick` do HTML (onclick="window.App.showPage(...)") funcionem.
			window.App = new App();
			window.App.initialize();
		});
		
	</script>
</body>
</html>
