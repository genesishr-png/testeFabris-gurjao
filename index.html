<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sistema Financeiro Jur√≠dico</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
	<style>
		/* --- ESTILOS GERAIS --- */
		body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; }
		body::after { content: ''; position: fixed; z-index: -2; top: 0; left: 0; right: 0; bottom: 0; background-image: url('https://i.postimg.cc/x81V8QJg/Imagem-do-Whats-App-de-2025-10-27-a-s-09-49-28-f966cd35.jpg'); background-repeat: no-repeat; background-size: cover; background-position: center; opacity: 0.12; }
		
		/* --- MODAIS (CORRE√á√ÉO DEFINITIVA) --- */
		.modal-backdrop { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); z-index: 9000; backdrop-filter: blur(3px); }
		.modal { 
			display: none; /* Garante que come√ßa FECHADO */
			position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9001; 
			max-height: 90vh; width: 90%; max-width: 800px; 
			background-color: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; 
			box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
			flex-direction: column;
		}
		.modal-header { flex-shrink: 0; padding: 1.25rem; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; align-items: center; background: rgba(31, 41, 55, 0.95); }
		.modal-body { flex: 1; overflow-y: auto; padding: 1.5rem; }
		.modal-footer { flex-shrink: 0; padding: 1rem 1.5rem; border-top: 1px solid #374151; background: rgba(31, 41, 55, 0.95); display: flex; justify-content: flex-end; gap: 0.5rem; }

		/* Scrollbars */
		::-webkit-scrollbar { width: 8px; }
		::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
		::-webkit-scrollbar-thumb:hover { background: #6b7280; }

		/* Cards & UI */
		.dark-card { background-color: #1f2937; border: 1px solid #374151; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s; }
		.dark-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); }
		
		/* --- INPUTS (CORRE√á√ÉO DE COR E ACESSIBILIDADE) --- */
		.form-input, select, textarea, input[type="text"], input[type="number"], input[type="date"] {
			width: 100%; 
			background-color: #374151 !important; /* For√ßa fundo escuro */
			border: 1px solid #4b5563; 
			color: #ffffff !important; /* For√ßa texto branco */
			padding: 0.6rem 0.75rem; 
			border-radius: 0.5rem; 
			outline: none; 
			transition: all 0.2s; 
			color-scheme: dark;
		}
		.form-input:focus, select:focus, textarea:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3); }
		.form-input:disabled { opacity: 0.6; cursor: not-allowed; background-color: #1f2937 !important; }
		label { display: block; margin-bottom: 0.3rem; font-size: 0.85rem; color: #9ca3af; font-weight: 500; }

		/* --- LOGIN ORIGINAL (Restaurado) --- */
		#login-form input {
			background-color: rgba(255, 255, 255, 0.1) !important;
			border: 1px solid rgba(255, 255, 255, 0.2);
			color: white !important;
			padding-left: 2.5rem; /* Espa√ßo para √≠cone */
		}
		#login-form input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
		#login-form label { color: #e5e7eb; }

		/* Navega√ß√£o */
		.sidebar-nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #d1d5db; transition: all 0.2s; cursor: pointer; }
		.sidebar-nav-item:hover { background-color: #4338ca; color: white; }
		.sidebar-nav-item.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.5); }
		
		/* Kanban & Tags */
		.kanban-column { min-width: 320px; }
		.kanban-content { max-height: 60vh; overflow-y: auto; padding-right: 8px; }
		.service-tag { display: inline-flex; align-items: center; background-color: #4b5563; color: white; padding: 4px 10px; border-radius: 999px; font-size: 0.8rem; margin: 0 4px 4px 0; border: 1px solid #6b7280; }
		
		/* Bot√µes */
		.btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
		.btn-primary { background: linear-gradient(to right, #4f46e5, #4338ca); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3); }
		.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4); }
		.btn-secondary { background-color: #4b5563; color: white; } .btn-secondary:hover { background-color: #374151; }
		.btn-danger { background: linear-gradient(to right, #dc2626, #b91c1c); color: white; }
		.btn-success { background: linear-gradient(to right, #16a34a, #15803d); color: white; }

		/* Filtro Global (Glassmorphism) */
		.pretty-select-wrapper { position: relative; }
		.pretty-select { appearance: none; background: rgba(31, 41, 55, 0.7); border: 1px solid #6366f1; color: #e0e7ff; padding: 0.5rem 2.5rem 0.5rem 1rem; border-radius: 9999px; font-weight: 600; cursor: pointer; backdrop-filter: blur(4px); transition: all 0.2s; }
		.pretty-select:hover { background: rgba(55, 65, 81, 0.9); box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }
		.select-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #818cf8; }

		/* Checkboxes Centralizados */
		.checkbox-group-centered { display: flex; justify-content: center; align-items: center; gap: 2rem; background-color: rgba(31, 41, 55, 0.5); padding: 1rem; border-radius: 0.75rem; border: 1px solid #4b5563; margin-bottom: 1.5rem; }
		.checkbox-item-custom { display: flex; align-items: center; cursor: pointer; user-select: none; }
		.checkbox-item-custom input { width: 1.2rem; height: 1.2rem; margin-right: 0.5rem; cursor: pointer; accent-color: #4f46e5; }
		.checkbox-item-custom label { margin-bottom: 0; cursor: pointer; color: #e2e8f0; font-size: 0.95rem; }

		/* Lista Oficina */
		.setting-list-item { display: flex; justify-content: space-between; align-items: center; background-color: #1f2937; border: 1px solid #374151; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; transition: all 0.2s; }
		.setting-list-item:hover { border-color: #6366f1; background-color: #252f3e; transform: translateX(2px); }
		.setting-list-remove-btn { background: rgba(220, 38, 38, 0.15); color: #f87171; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border: 1px solid rgba(220, 38, 38, 0.2); cursor: pointer; }
		.setting-list-remove-btn:hover { background: #dc2626; color: white; border-color: #dc2626; }

		/* Outros */
		.parcel-card-vencida { border-left-color: #ef4444; } .parcel-card-vencida .parcel-value { color: #f87171; }
		.parcel-card-avencer { border-left-color: #f59e0b; } .parcel-card-avencer .parcel-value { color: #fbbf24; }
		.ranking-table { width: 100%; border-collapse: separate; border-spacing: 0 4px; }
		.ranking-table th { text-align: left; padding: 0 1rem; color: #9ca3af; font-size: 0.75rem; text-transform: uppercase; font-weight: 600; }
		.ranking-table td { background: #2d3748; padding: 0.75rem 1rem; border-top: 1px solid #374151; border-bottom: 1px solid #374151; }
		.ranking-table tr td:first-child { border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; border-left: 1px solid #374151; font-weight: bold; width: 40px; text-align: center; }
		.ranking-table tr td:last-child { border-top-right-radius: 0.5rem; border-bottom-right-radius: 0.5rem; border-right: 1px solid #374151; text-align: right; }
		.rank-1 { color: #34d399; } .rank-2 { color: #60a5fa; } .rank-3 { color: #f59e0b; }

		#loading-overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.95); display: flex; justify-content: center; align-items: center; z-index: 10000; color: white; font-size: 1.25rem; }
		#app-container, .admin-only { display: none; }
		body.is-admin .admin-only:not(.hidden) { display: block; }
		body.is-admin .flex.admin-only:not(.hidden) { display: flex; }
		.notification-item { background: #374151; padding: 12px; border-radius: 8px; border-left: 4px solid #4f46e5; margin-bottom: 8px; cursor: pointer; }
		.notification-item.is-read { background: #1f2937; border-left-color: #4b5563; opacity: 0.6; }
		.sort-button { background-color: #374151; border: 1px solid #4b5563; color: #9ca3af; padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; }
		.sort-button.active { background-color: #4f46e5; border-color: #4f46e5; color: white; }
		
		@keyframes blob { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } }
		.animate-blob { animation: blob 7s infinite; }
	</style>
</head>
<body>
	<div id="notifications"></div>
	<div id="loading-overlay"><i class="fas fa-spinner fa-spin mr-3"></i> A carregar sistema...</div>

	<!-- LOGIN (DESIGN ORIGINAL) -->
	<div id="auth-overlay" class="min-h-screen flex items-center justify-center bg-gray-900 relative overflow-hidden px-4">
		<div class="absolute inset-0 opacity-10 bg-[url('https://i.postimg.cc/x81V8QJg/Imagem-do-Whats-App-de-2025-10-27-a-s-09-49-28-f966cd35.jpg')] bg-cover bg-center"></div>
		<div class="absolute w-96 h-96 bg-blue-600 rounded-full mix-blend-overlay filter blur-3xl opacity-20 animate-blob top-0 left-1/4"></div>
		<div class="absolute w-96 h-96 bg-indigo-600 rounded-full mix-blend-overlay filter blur-3xl opacity-20 animate-blob animation-delay-2000 bottom-0 right-1/4"></div>
		
		<div class="relative z-10 w-full max-w-md bg-gray-800/80 backdrop-blur-xl border border-gray-700 p-8 rounded-2xl shadow-2xl">
			<div class="text-center mb-8">
				<img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" class="h-20 mx-auto mb-4 drop-shadow-lg">
				<h1 class="text-2xl font-bold text-white mb-2">Sistema Financeiro</h1>
				<p class="text-gray-300 text-sm">Gest√£o profissional para advocacia</p>
			</div>
			<form id="login-form" class="space-y-5">
				<div>
					<label for="login-email">Email</label>
					<div class="relative">
						<i class="fas fa-envelope absolute left-3 top-3.5 text-gray-400"></i>
						<input type="email" id="login-email" placeholder="seu@email.com" required>
					</div>
				</div>
				<div>
					<label for="login-password">Senha</label>
					<div class="relative">
						<i class="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
						<input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
					</div>
				</div>
				<div id="auth-error" class="hidden p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200 text-sm"></div>
				<button type="submit" id="login-submit-button" class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-lg transition duration-200 flex items-center justify-center gap-2 mt-6">
					<i class="fas fa-sign-in-alt"></i> Entrar no Sistema
				</button>
			</form>
			<div class="mt-6 text-center text-gray-400 text-xs"><p>Acesso restrito a utilizadores autorizados</p></div>
		</div>
	</div>

	<!-- APP CONTAINER -->
	<div id="app-container" class="flex h-screen">
		<aside id="sidebar" class="hidden md:flex md:flex-col md:w-64 bg-gray-900/95 backdrop-blur border-r border-gray-800 p-4 z-20">
			<div class="mb-8 text-center"><img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" class="h-16 mx-auto opacity-90"></div>
			<nav class="flex-1 space-y-2">
				<a onclick="window.App.showPage('page-dashboard')" id="tab-dashboard" class="sidebar-nav-item active"><i class="fas fa-chart-line w-5 text-center"></i> Painel</a>
				<a onclick="window.App.showPage('page-parcelas')" id="tab-parcelas" class="sidebar-nav-item"><i class="fas fa-file-invoice-dollar w-5 text-center"></i> Parcelas</a>
				<a onclick="window.App.showPage('page-servicos')" id="tab-servicos" class="sidebar-nav-item"><i class="fas fa-tasks w-5 text-center"></i> Servi√ßos</a>
				<a onclick="window.App.showPage('page-performance')" id="tab-performance" class="sidebar-nav-item admin-only"><i class="fas fa-trophy w-5 text-center"></i> Performance</a>
				<a onclick="window.App.showPage('page-relatorios')" id="tab-relatorios" class="sidebar-nav-item admin-only"><i class="fas fa-file-alt w-5 text-center"></i> Relat√≥rios</a>
				<a onclick="window.App.showPage('page-lixeira')" id="tab-lixeira" class="sidebar-nav-item"><i class="fas fa-trash w-5 text-center"></i> Lixeira</a>
				<div class="border-t border-gray-700 my-2 pt-2 admin-only"><a onclick="window.App.showPage('page-oficina')" id="tab-oficina" class="sidebar-nav-item"><i class="fas fa-cogs w-5 text-center"></i> Oficina</a></div>
			</nav>
			<div class="border-t border-gray-800 pt-4 flex items-center gap-3">
				<div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center font-bold text-white"><i class="fas fa-user"></i></div>
				<div class="overflow-hidden"><span id="user-display-name" class="text-sm font-medium block truncate">Usu√°rio</span><button id="logout-button" class="text-xs text-red-400 hover:text-red-300">Sair</button></div>
			</div>
		</aside>

		<main id="main-content" class="flex-1 flex flex-col h-screen overflow-y-auto pb-20 md:pb-0 relative bg-gray-900/50">
			<header class="sticky top-0 bg-gray-900/90 backdrop-blur-md border-b border-gray-800 p-4 z-10 flex justify-between items-center shadow-md">
				<h1 id="page-title" class="text-xl font-bold text-white hidden md:block">Painel</h1>
				<div class="flex items-center gap-4 w-full md:w-auto justify-end">
					<div class="pretty-select-wrapper">
						<select id="globalDateFilter" class="pretty-select"><option value="novos">‚ú® Atuais (Novos)</option><option value="legado">üìú Legado (Antigos)</option></select>
						<i class="fas fa-calendar-check select-icon"></i>
					</div>
					<div class="relative">
						<button id="notification-bell" class="p-2 text-gray-400 hover:text-white relative"><i class="fas fa-bell text-xl"></i><span id="notification-badge" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-gray-900"></span></button>
						<div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl overflow-hidden z-50">
							<div class="p-3 border-b border-gray-700 flex justify-between"><h3 class="font-bold text-white">Notifica√ß√µes</h3><button id="clear-notifications-button" class="text-xs text-indigo-400">Ler todas</button></div>
							<div id="notification-list" class="max-h-64 overflow-y-auto p-2 space-y-1"><div class="text-center p-4 text-gray-500 text-sm">Sem notifica√ß√µes.</div></div>
						</div>
					</div>
					<button id="mobile-menu-toggle" class="md:hidden text-white text-xl"><i class="fas fa-bars"></i></button>
				</div>
			</header>

			<div class="p-4 md:p-8 flex-1">
				
				<!-- DASHBOARD -->
				<div id="page-dashboard">
					<div class="flex flex-wrap gap-4 mb-8">
						<button onclick="window.App.openContractModal()" class="btn btn-primary shadow-lg"><i class="fas fa-plus"></i> Novo Contrato</button>
						<button onclick="window.App.openReportModal()" class="admin-only btn btn-success shadow-lg" style="background-color: #0d9488;"><i class="fas fa-chart-pie"></i> Relat√≥rio Mensal</button>
					</div>

					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
						<div class="dark-card p-5 rounded-xl"><p class="text-gray-400 text-sm font-medium">A Receber (30 dias)</p><p id="dash-a-receber" class="text-2xl font-bold text-green-400 mt-1">R$ 0,00</p></div>
						<div class="dark-card p-5 rounded-xl"><p class="text-gray-400 text-sm font-medium">Vencido (Corrigido)</p><p id="dash-vencido" class="text-2xl font-bold text-red-400 mt-1">R$ 0,00</p></div>
						<div class="dark-card p-5 rounded-xl"><p class="text-gray-400 text-sm font-medium">Recebido (M√™s)</p><p id="dash-recebido" class="text-2xl font-bold text-indigo-400 mt-1">R$ 0,00</p></div>
						<div class="dark-card p-5 rounded-xl"><p class="text-gray-400 text-sm font-medium">Contratos Ativos</p><p id="dash-contratos" class="text-2xl font-bold text-white mt-1">0</p></div>
					</div>

					<div class="grid grid-cols-1 md:grid-cols-3 gap-6 pb-8">
						<div class="kanban-column dark-card rounded-xl p-4 flex flex-col h-full"><h3 class="text-red-400 font-bold mb-4 flex items-center gap-2"><i class="fas fa-exclamation-circle"></i> Vencidas</h3><div id="kanban-vencidas" class="kanban-content space-y-3 flex-1"></div></div>
						<div class="kanban-column dark-card rounded-xl p-4 flex flex-col h-full"><h3 class="text-yellow-400 font-bold mb-4 flex items-center gap-2"><i class="fas fa-clock"></i> A Vencer</h3><div id="kanban-a-vencer" class="kanban-content space-y-3 flex-1"></div></div>
						<div class="kanban-column dark-card rounded-xl p-4 flex flex-col h-full"><h3 class="text-gray-400 font-bold mb-4 flex items-center gap-2"><i class="fas fa-check-circle"></i> Pagas (M√™s)</h3><div id="kanban-pagas" class="kanban-content space-y-3 flex-1"></div></div>
					</div>

					<div id="exito-section" class="mb-8 hidden"><h3 class="text-xl font-bold text-white mb-4">√äxitos Pendentes</h3><div id="kanban-exito-wrapper" class="flex overflow-x-auto space-x-4 pb-2"></div></div>

					<div>
						<div class="flex justify-between items-center mb-4 flex-wrap gap-4">
							<h2 class="text-xl font-bold text-white">Contratos</h2>
							<div class="flex items-center gap-3">
								<button onclick="window.App.exportContractsCSV()" class="text-sm text-green-400 hover:text-green-300"><i class="fas fa-download"></i> CSV</button>
								<select id="advogadoFilter" onchange="window.App.resetAndRenderContractList()" class="filter-select admin-only"></select>
								<div id="contractSortButtons" class="flex gap-1"></div>
							</div>
						</div>
						<input type="text" id="searchInput" placeholder="Pesquisar contrato..." class="w-full bg-gray-800 border-gray-700 rounded-lg p-3 text-white mb-4 focus:ring-2 focus:ring-indigo-500">
						<div id="contractListContainer"></div>
						<div id="paginationContainer" class="flex justify-center gap-2 mt-6"></div>
					</div>
				</div>

				<!-- OUTRAS P√ÅGINAS -->
				<div id="page-parcelas" class="hidden">
					<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Todas as Parcelas</h2><input type="text" id="parcelasSearchInput" placeholder="Buscar..." class="bg-gray-800 border-gray-700 p-2 rounded text-white"></div>
					<div class="flex gap-2 mb-4 justify-end"><span class="text-sm text-gray-500 self-center">Ordenar:</span><div id="parcelasSortButtons" class="flex gap-1"></div></div>
					<div id="parcelasListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
				</div>

				<div id="page-servicos" class="hidden">
					<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Servi√ßos</h2><input type="text" id="servicosSearchInput" placeholder="Buscar..." class="bg-gray-800 border-gray-700 p-2 rounded text-white"></div>
					<div class="flex gap-2 mb-4 justify-end flex-wrap"><select id="servicosAdvogadoFilter" onchange="window.App.renderServicosPage()" class="filter-select admin-only"></select><div id="servicosSortButtons" class="flex gap-1"></div></div>
					<div id="servicosListContainer" class="space-y-4"></div>
				</div>

				<div id="page-performance" class="hidden admin-only">
					<h2 class="text-2xl font-bold text-white mb-6">Performance</h2>
					<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
						<div class="dark-card p-4 rounded-xl"><h3 class="text-gray-400 mb-4 font-semibold uppercase text-xs tracking-wider">Fatura√ß√£o por Advogado</h3><div class="h-96"><canvas id="adminChartFaturamento"></canvas></div></div>
						<div class="dark-card p-4 rounded-xl"><h3 class="text-gray-400 mb-4 font-semibold uppercase text-xs tracking-wider">Contratos Ativos</h3><div class="h-96"><canvas id="adminChartContratos"></canvas></div></div>
					</div>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
						<div class="dark-card p-6 rounded-xl border border-gray-700"><h3 class="text-white font-bold mb-4 text-lg">Ranking Financeiro</h3><table class="ranking-table" id="adminTableFaturamento"><thead><tr><th>#</th><th>Nome</th><th>Valor</th></tr></thead><tbody></tbody></table></div>
						<div class="dark-card p-6 rounded-xl border border-gray-700"><h3 class="text-white font-bold mb-4 text-lg">Ranking Contratos</h3><table class="ranking-table" id="adminTableContratos"><thead><tr><th>#</th><th>Nome</th><th>Qtd</th></tr></thead><tbody></tbody></table></div>
					</div>
				</div>

				<div id="page-relatorios" class="hidden admin-only">
					<div class="flex flex-wrap justify-between items-center mb-6 bg-gray-800 p-4 rounded-xl">
						<h2 class="text-xl font-bold text-white">Relat√≥rios Avan√ßados</h2>
						<div class="flex gap-2 items-center">
							<input type="date" id="reportStartDate" class="bg-gray-700 border-gray-600 rounded p-1 text-sm text-white">
							<span class="text-gray-500">at√©</span>
							<input type="date" id="reportEndDate" class="bg-gray-700 border-gray-600 rounded p-1 text-sm text-white">
							<button onclick="window.App.generateAdvancedReport()" class="btn btn-primary text-xs">Gerar</button>
							<button id="exportPdfButton" onclick="window.App.exportReportPDF()" class="btn btn-danger text-xs" disabled>PDF</button>
						</div>
					</div>
					<div id="advancedReportContainer" class="space-y-8 hidden">
						<div id="report-kpis" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
						<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
							<div class="dark-card p-4 rounded-xl"><h3 class="text-gray-400 mb-2">Evolu√ß√£o</h3><div class="h-64"><canvas id="advReportTimelineChart"></canvas></div></div>
							<div class="dark-card p-4 rounded-xl"><h3 class="text-gray-400 mb-2">Novos Contratos</h3><div class="h-64"><canvas id="advReportNewContractsChart"></canvas></div></div>
						</div>
						<div class="dark-card p-4 rounded-xl"><h3 class="text-gray-400 mb-2">Distribui√ß√£o</h3><div class="h-64 mx-auto max-w-md"><canvas id="advReportByAdvogadoChart"></canvas></div></div>
					</div>
					<div id="advancedReportEmpty" class="text-center py-20 text-gray-500"><i class="fas fa-chart-area fa-3x mb-4"></i><p>Selecione um per√≠odo para visualizar.</p></div>
				</div>

				<div id="page-lixeira" class="hidden">
					<h2 class="text-2xl font-bold text-white mb-6">Lixeira</h2>
					<div id="lixeiraListContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
				</div>

				<div id="page-oficina" class="hidden admin-only">
					<h2 class="text-2xl font-bold text-white mb-6">Oficina</h2>
					<div class="dark-card p-8 rounded-xl max-w-lg mx-auto border border-gray-700 shadow-2xl">
						<h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2"><i class="fas fa-user-shield text-indigo-500"></i> Gerenciar Advogados</h3>
						<form id="formAddAdvogado" class="flex gap-3 mb-6">
							<input type="text" id="inputAdvogadoName" class="form-input flex-1 bg-gray-900 border-gray-700 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Nome do Advogado..." required>
							<button type="submit" class="btn btn-primary px-4 aspect-square rounded-lg shadow-lg hover:shadow-indigo-500/20 transition-all"><i class="fas fa-plus"></i></button>
						</form>
						<div class="bg-gray-800/50 rounded-xl p-4 max-h-[400px] overflow-y-auto border border-gray-700/50">
							<div id="advogadoSettingsList" class="space-y-2"></div>
						</div>
						<p class="text-xs text-gray-500 mt-4 text-center">Use o bot√£o vermelho para remover um advogado da lista.</p>
					</div>
				</div>

			</div>
		</main>

		<nav class="md:hidden fixed bottom-0 w-full bg-gray-900 border-t border-gray-800 flex justify-around p-2 z-30">
			<a onclick="window.App.showPage('page-dashboard')" class="text-gray-400 flex flex-col items-center text-xs"><i class="fas fa-home text-lg mb-1"></i>Painel</a>
			<a onclick="window.App.showPage('page-parcelas')" class="text-gray-400 flex flex-col items-center text-xs"><i class="fas fa-dollar-sign text-lg mb-1"></i>$$</a>
			<a onclick="window.App.showPage('page-servicos')" class="text-gray-400 flex flex-col items-center text-xs"><i class="fas fa-check text-lg mb-1"></i>Jobs</a>
			<a onclick="window.App.showPage('page-relatorios')" class="text-gray-400 flex flex-col items-center text-xs admin-only"><i class="fas fa-chart-pie text-lg mb-1"></i>Rel</a>
		</nav>
	</div>

	<!-- MODAIS (CORRIGIDO: display:none) -->
	<div id="modalDisplayName" class="modal">
		<div class="modal-header"><h2 class="text-xl font-bold text-white">Bem-vindo(a)!</h2></div>
		<div class="modal-body text-center">
			<p class="text-gray-400 mb-6">Como gostaria de ser chamado?</p>
			<form id="formDisplayName"><input id="inputDisplayName" class="w-full mb-4" required><button type="submit" class="w-full btn btn-primary">Come√ßar</button></form>
		</div>
	</div>

	<div id="modalContrato" class="modal">
		<div class="modal-header"><h2 id="modalContratoTitle" class="text-lg font-bold text-white">Novo Contrato</h2><button onclick="window.App.closeModal('modalContrato')" class="text-gray-400 hover:text-white">&times;</button></div>
		<form id="formContrato" class="flex-1 flex flex-col overflow-hidden">
			<div class="modal-body space-y-4">
				<input type="hidden" id="contractId"><input type="hidden" id="financialDataChanged" value="false">
				<div class="grid grid-cols-2 gap-4">
					<div><label>Cliente</label><input id="clienteNome" class="form-input" required></div>
					<div><label>Advogado</label><select id="advogadoResponsavel" class="form-input" required></select></div>
				</div>
				<div class="bg-gray-800 p-3 rounded border border-gray-600">
					<label class="mb-2 block font-bold text-indigo-400">Servi√ßos</label>
					<div id="servicosContainer" class="flex flex-wrap gap-2 mb-2"></div>
					<div class="flex gap-2">
						<input id="contratoServicoInput" placeholder="Ex: Div√≥rcio..." class="form-input flex-1">
						<input type="date" id="contratoPrazoInput" class="form-input w-36">
						<button type="button" id="addServiceButton" class="btn btn-primary text-xs">Adicionar</button>
					</div>
				</div>
				<div class="grid grid-cols-2 gap-4">
					<div><label>Tipo Pgto</label><select id="contratoTipoPagamento" class="form-input"><option>Parcelado</option><option>Pr√≥-labore</option><option>Entrada √∫nica</option></select></div>
					<div><label>Obs</label><input id="contratoObservacoes" class="form-input"></div>
				</div>
				
				<div class="admin-only border-t border-gray-600 pt-4 mt-2">
					<div id="financial-warning" class="hidden bg-yellow-900/30 text-yellow-200 p-2 rounded text-xs mb-2">Financeiro bloqueado (parcialmente pago).</div>
					
					<div class="checkbox-group-centered">
						<div class="checkbox-item-custom">
							<input type="checkbox" id="contratoEspecial">
							<label for="contratoEspecial">Modo Manual</label>
						</div>
						<div class="checkbox-item-custom">
							<input type="checkbox" id="contratoJaQuitado">
							<label for="contratoJaQuitado">J√° Quitado</label>
						</div>
					</div>

					<div id="financial-fields-standard" class="space-y-3">
						<div class="grid grid-cols-2 gap-4">
							<div><label>Total (R$)</label><input type="number" step="0.01" id="valorTotal" class="form-input"></div>
							<div><label>Parcelas</label><input type="number" id="numParcelas" value="1" class="form-input"></div>
						</div>
						<div><label>1¬∫ Vencimento</label><input type="date" id="vencimentoPrimeiraParcela" class="form-input"></div>
					</div>
					<div id="financial-fields-special" class="hidden space-y-2">
						<div class="flex gap-2"><input type="number" id="parcelaValorManual" placeholder="R$" class="form-input"><input type="date" id="parcelaVencimentoManual" class="form-input"><button type="button" id="addManualParcelButton" class="btn btn-primary text-xs">Add</button></div>
						<div id="manualParcelList" class="bg-gray-900 p-2 rounded max-h-32 overflow-y-auto"></div>
					</div>
					<div class="mt-3"><label>√äxito (opcional)</label><input id="taxaExito" class="form-input" placeholder="Ex: 20% ou R$ 5.000"></div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" onclick="window.App.closeModal('modalContrato')" class="btn btn-secondary">Cancelar</button>
				<button type="submit" class="btn btn-primary">Salvar</button>
			</div>
		</form>
	</div>

	<div id="modalPagamento" class="modal md:w-1/3">
		<div class="modal-header"><h2 class="font-bold text-white">Pagamento</h2><button onclick="window.App.closeModal('modalPagamento')" class="text-gray-400 hover:text-white">&times;</button></div>
		<form id="formPagamento" class="flex-1 flex flex-col">
			<div class="modal-body space-y-4">
				<div id="pagamentoInfo" class="bg-gray-800 p-3 rounded text-sm text-gray-200 border border-gray-600"></div>
				<input type="hidden" id="pagamentoContractId"><input type="hidden" id="pagamentoParcelIndex">
				<div><label>Valor Pago (R$)</label><input type="number" step="0.01" id="pagamentoValor" class="form-input" required></div>
				<div><label>Data Pagamento</label><input type="date" id="pagamentoData" class="form-input" required></div>
			</div>
			<div class="modal-footer"><button type="button" onclick="window.App.closeModal('modalPagamento')" class="btn btn-secondary">Cancelar</button><button type="submit" class="btn btn-success">Confirmar</button></div>
		</form>
	</div>

	<div id="modalExito" class="modal md:w-1/3">
		<div class="modal-header"><h2 class="font-bold text-white">Receber √äxito</h2><button onclick="window.App.closeModal('modalExito')" class="text-gray-400 hover:text-white">&times;</button></div>
		<form id="formExito" class="flex-1 flex flex-col">
			<div class="modal-body space-y-4">
				<div id="exitoInfo" class="bg-gray-800 p-3 rounded text-sm text-gray-200 border border-gray-600"></div>
				<input type="hidden" id="exitoContractId">
				<div class="admin-only"><label>Valor L√≠quido (R$)</label><input type="number" step="0.01" id="exitoValorRecebido" class="form-input" required></div>
			</div>
			<div class="modal-footer"><button type="button" onclick="window.App.closeModal('modalExito')" class="btn btn-secondary">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
		</form>
	</div>

	<div id="modalCliente" class="modal md:w-2/3">
		<div class="modal-header"><h2 id="clienteModalTitle" class="font-bold text-white"></h2><button onclick="window.App.closeModal('modalCliente')" class="text-gray-400 hover:text-white">&times;</button></div>
		<div id="clienteModalContent" class="modal-body space-y-4"></div>
	</div>

	<div id="modalRelatorio" class="modal md:w-2/3 admin-only">
		<div class="modal-header"><h2 class="font-bold text-white">Relat√≥rio Mensal</h2><button onclick="window.App.closeModal('modalRelatorio')" class="text-gray-400 hover:text-white">&times;</button></div>
		<div class="modal-body">
			<div class="flex gap-4 mb-4">
				<div class="flex-1"><label>M√™s</label><select id="reportMonth" class="form-input"></select></div>
				<div class="flex-1"><label>Ano</label><select id="reportYear" class="form-input"></select></div>
			</div>
			<div class="flex gap-2 mb-6">
				<button onclick="window.App.generateAndShowReport()" class="flex-1 btn btn-primary" style="background-color: #0d9488;">Visualizar</button>
				<button onclick="window.App.showAnalyticsInModal()" class="flex-1 btn btn-primary" style="background-color: #7c3aed;">Gr√°ficos</button>
				<button onclick="window.App.exportReportCSV()" class="flex-1 btn btn-success">CSV</button>
			</div>
			<div id="reportResult" class="space-y-4"></div>
			<div id="reportChartsContainer" class="hidden grid grid-cols-2 gap-4"><div class="dark-card p-4 rounded"><canvas id="actualIncomeChartModal"></canvas></div><div class="dark-card p-4 rounded"><canvas id="projectedIncomeChartModal"></canvas></div></div>
		</div>
	</div>

	<div id="modal-backdrop" class="modal-backdrop"></div>

	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
		import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
		import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel, writeBatch, serverTimestamp, query, orderBy, limit, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
		
		const ADMIN_USERS = ["dra. renata fabris","darc", "dr. felipe gurj√£o", "lilian"];
		const CONTRACTS_PER_PAGE = 12;
		const CUTOFF_DATE = new Date('2025-09-01T00:00:00Z');

		const Utils = {
			toastContainer: null,
			initToast() {
				let el = document.getElementById('notifications');
				if (!el) { el = document.createElement('div'); el.id = 'toast-fallback'; el.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:11000;display:flex;flex-direction:column;gap:8px;'; document.body.appendChild(el); }
				this.toastContainer = el;
			},
			showToast(msg, type = 'info') {
				if (!this.toastContainer) this.initToast();
				const n = document.createElement('div'); n.className = 'px-4 py-3 rounded-lg shadow-lg text-sm text-white animate-bounce';
				n.style.background = type === 'error' ? '#991b1b' : (type === 'success' ? '#065f46' : '#374151');
				n.textContent = msg; this.toastContainer.appendChild(n); setTimeout(() => n.remove(), 3000);
			},
			debounce(fn, ms = 300) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; },
			sanitizeText(s) { if (s == null) return ''; return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#39;').trim(); },
			sanitizeForFirestoreId(n) { if (!n) return 'unknown'; return n.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, '_').toLowerCase(); },
			parseNumber(n) { const v = Number(n); return Number.isFinite(v) ? v : 0; },
			confirm(msg) {
				return new Promise(res => {
					let m = document.getElementById('confirmModal');
					if (!m) { m = document.createElement('div'); m.id='confirmModal'; m.innerHTML=`<div style="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:12000;display:flex;align-items:center;justify-content:center"><div class="dark-card p-6 rounded-lg max-w-sm w-full border border-gray-600"><p id="cfmMsg" class="text-white mb-6 text-lg font-medium text-center"></p><div class="flex justify-center gap-4"><button id="cfmNo" class="btn btn-secondary">N√£o</button><button id="cfmYes" class="btn btn-danger">Sim</button></div></div></div>`; document.body.appendChild(m); }
					m.querySelector('#cfmMsg').textContent=msg; m.style.display='flex';
					m.querySelector('#cfmNo').onclick=()=>{m.style.display='none';res(false)}; m.querySelector('#cfmYes').onclick=()=>{m.style.display='none';res(true)};
				});
			},
			formatCurrency(v) { return (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); },
			formatDate(d) { if (!d) return ''; const dt = new Date(d); return `${String(dt.getUTCDate()).padStart(2,'0')}/${String(dt.getUTCMonth()+1).padStart(2,'0')}/${dt.getUTCFullYear()}`; },
			timeAgo(d) { if (!d) return ''; const sec = Math.floor((new Date()-new Date(d))/1000); if(sec<60) return 'agora'; const m=Math.floor(sec/60); if(m<60) return `${m}m atr√°s`; const h=Math.floor(m/60); if(h<24) return `${h}h atr√°s`; return `${Math.floor(h/24)}d atr√°s`; }
		};

		class CorrectionCalculator {
			constructor() { this.IPCA = { "2023-01":0.53, "2023-02":0.84, "2023-03":0.71, "2023-04":0.61, "2023-05":0.23, "2023-06":-0.08, "2023-07":0.12, "2023-08":0.23, "2023-09":0.26, "2023-10":0.24, "2023-11":0.28, "2023-12":0.56, "2024-01":0.42, "2024-02":0.83, "2024-03":0.16, "2024-04":0.38, "2024-05":0.46, "2024-06":0.36, "2024-07":0.16, "2024-08":0.24, "2024-09":0.26, "2024-10":0.42, "2024-11":0.53, "2024-12":0.48, "2025-01":0.55, "2025-02":0.78, "2025-03":0.21, "2025-04":0.35, "2025-05":0.40, "2025-06":0.26, "2025-07":0.22, "2025-08":0.31, "2025-09":0.33, "2025-10":0.40 }; }
			toUTC(y,m,d){ const t=new Date(Date.UTC(y,m,d)); t.setUTCHours(0,0,0,0); return t; }
			diff(d1,d2){ let y=(d2.getUTCFullYear()-d1.getUTCFullYear())*12+(d2.getUTCMonth()-d1.getUTCMonth()); return Math.max(0, y + (d2.getUTCDate()-d1.getUTCDate())/30); }
			getFactor(v,r){ let f=1.0, c=new Date(Date.UTC(v.getUTCFullYear(),v.getUTCMonth(),1)); while(c<new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),1))){ const k=`${c.getUTCFullYear()}-${String(c.getUTCMonth()+1).padStart(2,'0')}`; if(this.IPCA[k]) f*=(1+this.IPCA[k]/100); c.setUTCMonth(c.getUTCMonth()+1); } return f; }
			calcularValorCorrigido(val, dv, dr=new Date()){ const r=this.toUTC(dr.getUTCFullYear(),dr.getUTCMonth(),dr.getUTCDate()), v=new Date(dv), vt=this.toUTC(v.getUTCFullYear(),v.getUTCMonth(),v.getUTCDate()); if(r<=vt) return val; return val * this.getFactor(vt,r) * (1 + 0.01 * this.diff(vt,r)); }
		}

		class AuthService {
			constructor(app) { this.app = app; this.auth = null; this.firebaseConfig = { apiKey: "AIzaSyA0TWb7DgZAHNl3TuoK3xQD-ANvCcQIDK4", authDomain: "fabrisgurjao.firebaseapp.com", projectId: "fabrisgurjao", storageBucket: "fabrisgurjao.firebasestorage.app", messagingSenderId: "466702265991", appId: "1:466702265991:web:78c4d98b47cab537921222", measurementId: "G-E99R5TFMQK" }; }
			initialize() { const app = initializeApp(this.firebaseConfig); this.auth = getAuth(app); this.app.firebaseService.setDB(getFirestore(app)); onAuthStateChanged(this.auth, u => this.app.handleAuthStateChange(u)); }
			async login(e, p) { const b=document.getElementById('login-submit-button'); if(b)b.disabled=true;b.textContent="Autenticando..."; try{ await signInWithEmailAndPassword(this.auth, e, p); }catch{ document.getElementById('auth-error').classList.remove('hidden'); document.getElementById('auth-error').textContent='Credenciais inv√°lidas.'; }finally{ if(b){b.disabled=false;b.textContent="Entrar no Sistema";} } }
			async logout() { await signOut(this.auth); }
			async updateUserProfile(n) { try{ await updateProfile(this.auth.currentUser, {displayName:n}); return true; }catch{ return false; } }
		}

		class FirebaseService {
			constructor(app) { this.app = app; this.db = null; this.subs = []; }
			setDB(db) { this.db = db; }
			startSnapshotListener(col) { this.subs.push(onSnapshot(collection(this.db, col), s => this.app.handleSnapshotUpdate(s.docs.map(d => ({id:d.id, ...d.data()}))))); }
			startNotificationListener(u) { this.subs.push(onSnapshot(query(collection(this.db, `notifications/${u}/alerts`), orderBy("timestamp", "desc"), limit(20)), s => this.app.handleNotificationUpdate(s.docs.map(d => ({id:d.id, ...d.data()}))))); }
			startSystemSettingsListener() { this.subs.push(onSnapshot(collection(this.db, 'systemSettings'), s => { const r={}; s.docs.forEach(d=>r[d.id]=d.data()); this.app.handleSystemSettingsUpdate(r); })); }
			stopListeners() { this.subs.forEach(u => u()); this.subs = []; }
			async saveSystemSettings(id, d) { await setDoc(doc(this.db, 'systemSettings', id), d, {merge:true}); return true; }
			async sendNotification(u, d) { try{ await addDoc(collection(this.db, `notifications/${u}/alerts`), {...d, isRead:false, timestamp:serverTimestamp()}); }catch{} }
			async markNotificationsAsRead(u, ids) { const b = writeBatch(this.db); ids.forEach(id => b.update(doc(this.db, `notifications/${u}/alerts`, id), {isRead:true})); await b.commit(); }
			async addContract(d) { try{ await addDoc(collection(this.db, 'contracts'), d); Utils.showToast('Salvo com sucesso!', 'success'); return true; }catch{ Utils.showToast('Erro ao salvar.', 'error'); return false; } }
			async updateContract(id, d) { try{ await updateDoc(doc(this.db, 'contracts', id), d); Utils.showToast('Atualizado!', 'success'); return true; }catch{ return false; } }
			async updateContractField(id, d) { try{ await updateDoc(doc(this.db, 'contracts', id), d); return true; }catch{ return false; } }
			async deleteContract(id) { await deleteDoc(doc(this.db, 'contracts', id)); Utils.showToast('Removido permanentemente.', 'success'); }
		}

		class AnalyticsHandler {
			constructor() { this.charts = {}; }
			renderChart(id, type, labels, data, label, color) {
				const ctx = document.getElementById(id)?.getContext('2d'); if (!ctx) return;
				if (this.charts[id]) this.charts[id].destroy();
				this.charts[id] = new Chart(ctx, { type, data: { labels, datasets: [{ label, data, backgroundColor: color+'99', borderColor: color, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } } } });
			}
			renderPie(id, labels, data, label) {
				const ctx = document.getElementById(id)?.getContext('2d'); if (!ctx) return;
				if (this.charts[id]) this.charts[id].destroy();
				this.charts[id] = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ label, data, backgroundColor: ['#4f46e5', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#d1d5db' } } } } });
			}
			destroyPageCharts(p) { Object.keys(this.charts).forEach(k => { this.charts[k].destroy(); delete this.charts[k]; }); }
		}

		class ReportHandler {
			constructor(app) { this.app = app; }
			calculateIncomeByDateRange(start, end, contracts) {
				let parc = 0, exito = 0, byAdv = {}, byMonth = {}, newCt = {};
				let detailed = []; // Quem Pagou
				let pending = [];  // Quem N√ÉO Pagou
				
				contracts.forEach(c => {
					const adv = c.advogadoResponsavel || 'N/A';
					if (c.createdAt) { const d = new Date(c.createdAt); if (d >= start && d <= end) newCt[`${d.getFullYear()}-${d.getMonth()+1}`] = (newCt[`${d.getFullYear()}-${d.getMonth()+1}`]||0)+1; }
					
					(c.parcels||[]).forEach(p => { 
						if (p.status === 'Paga' && p.paymentDate) { 
							const dPay = new Date(p.paymentDate); 
							if (dPay >= start && dPay <= end) { 
								parc += p.valuePaid; 
								detailed.push({ type: `Parcela ${p.number}`, clientName: c.clientName, date: dPay, value: p.valuePaid, advogado: adv }); 
								byAdv[adv]=(byAdv[adv]||0)+p.valuePaid; 
								byMonth[`${dPay.getFullYear()}-${dPay.getMonth()+1}`]=(byMonth[`${dPay.getFullYear()}-${dPay.getMonth()+1}`]||0)+p.valuePaid; 
							} 
						}
						const dDue = new Date(p.dueDate);
						if (dDue >= start && dDue <= end && p.status !== 'Paga') {
							pending.push({ type: `Parcela ${p.number}`, clientName: c.clientName, date: dDue, value: p.value, advogado: adv });
						}
					});

					if (c.successFeePaymentDate) { 
						const d = new Date(c.successFeePaymentDate); 
						if (d >= start && d <= end) { 
							exito += c.successFeeValueReceived; 
							detailed.push({ type: '√äxito', clientName: c.clientName, date: d, value: c.successFeeValueReceived, advogado: adv }); 
							byAdv[adv]=(byAdv[adv]||0)+c.successFeeValueReceived; 
							byMonth[`${d.getFullYear()}-${d.getMonth()+1}`]=(byMonth[`${d.getFullYear()}-${d.getMonth()+1}`]||0)+c.successFeeValueReceived; 
						} 
					}
				});
				detailed.sort((a,b) => a.date - b.date);
				pending.sort((a,b) => a.date - b.date);
				return { totalParcelas: parc, totalExito: exito, totalGeral: parc+exito, totalContratos: Object.values(newCt).reduce((a,b)=>a+b,0), detailedPayments: detailed, pendingPayments: pending, byAdvogado: byAdv, byMonth, newContractsByMonth: newCt };
			}
			calculateMonthlyIncome(y, m, contracts) { return this.calculateIncomeByDateRange(new Date(y, m, 1), new Date(y, m + 1, 0, 23, 59, 59), contracts); }
			calculateAdminPerformanceData(contracts) {
				const h = new Date(); const fat = this.calculateIncomeByDateRange(new Date(h.getFullYear(), 0, 1), new Date(h.getFullYear(), 11, 31), contracts);
				const count = {}; contracts.filter(c => !c.isDeleted && this.app.getContractStatus(c).statusText !== 'Conclu√≠do').forEach(c => count[c.advogadoResponsavel||'N/A'] = (count[c.advogadoResponsavel||'N/A']||0)+1);
				return { contratosPorAdvogado: count, faturamentoPorAdvogado: fat.byAdvogado };
			}
			getActualIncomeData(contracts) {
				const l = [], d = []; const h = new Date();
				for (let i = 11; i >= 0; i--) { const dt = new Date(h.getFullYear(), h.getMonth() - i, 1); l.push(dt.toLocaleString('pt-BR', { month: 'short', year: '2-digit' })); d.push(this.calculateMonthlyIncome(dt.getFullYear(), dt.getMonth(), contracts).totalGeral); }
				return { labels: l, data: d };
			}
			getProjectedIncomeData(contracts) {
				const l = [], d = new Array(12).fill(0); const h = new Date(); h.setHours(0,0,0,0); const start = new Date(h.getFullYear(), h.getMonth(), 1);
				for (let i = 0; i < 12; i++) { const dt = new Date(h.getFullYear(), h.getMonth() + i, 1); l.push(dt.toLocaleString('pt-BR', { month: 'short', year: '2-digit' })); }
				contracts.filter(c => !c.isDeleted).forEach(c => (c.parcels||[]).forEach(p => { if (p.status === 'Pendente') { const due = new Date(p.dueDate); if (due >= start) { const diff = (due.getFullYear()-start.getFullYear())*12 + (due.getMonth()-start.getMonth()); if (diff >= 0 && diff < 12) d[diff] += p.value; } } }));
				return { labels: l, data: d };
			}
		}

		class DOMBuilder {
			constructor(app) { this.app = app; }
			el(tag, { cls = '', text = '', html = '', id = '' } = {}) { const e = document.createElement(tag); if (cls) e.className = cls; if (text) e.textContent = text; if (html) e.innerHTML = html; if (id) e.id = id; return e; }
			card(html, cls='') { return this.el('div', { cls: 'dark-card shadow-lg p-4 rounded-lg transition-all hover:-translate-y-1 '+cls, html }); }
			createParcelCard(c, p, i, type, rem, vc = null) {
				const d = Utils.formatDate(p.dueDate), v = Utils.formatCurrency(p.value), vCorr = vc ? Utils.formatCurrency(vc) : '';
				const border = type === 'vencida' ? 'border-red-500' : (type === 'a-vencer' ? 'border-yellow-500' : 'border-gray-700');
				const body = `<p class="font-bold text-white text-lg">${c.clientName}</p><p class="text-sm text-gray-400 mb-3">${(c.serviceTypes||[]).map(s=>s.name).join(', ')} - P.${p.number}</p>
				<div class="space-y-2 text-sm">${type==='vencida' ? `<div class="flex justify-between text-xs text-gray-400"><span>Orig:</span> <span class="line-through">${v}</span></div><div class="flex justify-between text-red-400 font-bold text-lg"><span>Corr:</span> <span>${vCorr}</span></div>` : `<div class="flex justify-between text-gray-300"><span>Valor:</span> <span class="font-bold text-lg text-white">${v}</span></div>`}
				<div class="flex justify-between text-gray-400 mt-2"><span>Vencimento:</span> <span class="font-medium text-gray-300">${d}</span></div></div>
				${type==='paga' ? `<div class="mt-4 text-center text-sm bg-green-900/50 text-green-300 p-2 rounded">Pago ${Utils.formatCurrency(p.valuePaid)} em ${Utils.formatDate(p.paymentDate)}</div>` : `<button onclick="window.App.openPaymentModal('${c.id}', ${i})" class="mt-4 w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-2 rounded text-sm hover:shadow-lg transition">Pagar</button>`}`;
				return this.el('div', { cls: `dark-card shadow-lg p-5 rounded-xl border-l-4 ${border} transition-all hover:-translate-y-1`, html: body });
			}
			createContractCard(c, s) {
				const html = `<div class="p-5"><div class="flex justify-between items-start mb-3"><h3 class="font-bold text-xl text-white truncate">${c.clientName}</h3><span class="px-2 py-1 rounded-full text-xs font-semibold ${s.statusColor}">${s.statusText}</span></div>
				<p class="text-xs text-indigo-300 mb-3"><i class="fas fa-user-tie mr-1"></i> ${c.advogadoResponsavel}</p><div class="mb-4">${(c.serviceTypes||[]).map(x=>`<span class="service-tag-small">${x.name}</span>`).join('')}</div>
				<div class="border-t border-gray-700 pt-4 space-y-2 text-sm"><div class="flex justify-between text-gray-400"><span>Fixo:</span><span class="font-medium text-gray-300">${Utils.formatCurrency(c.totalValue)}</span></div>${c.successFee?`<div class="flex justify-between text-gray-400"><span>√äxito:</span><span class="font-medium text-indigo-400">${c.successFee}</span></div>`:''}</div></div>
				<div class="bg-gray-800/50 px-4 py-3 flex justify-end gap-2 border-t border-gray-700"><button onclick="window.App.openClientHistoryModal('${c.clientName}')" class="text-sm text-gray-400 hover:text-indigo-400 p-1"><i class="fas fa-eye"></i></button><button onclick="window.App.openContractModal('${c.id}')" class="text-sm text-gray-400 hover:text-green-400 p-1"><i class="fas fa-pencil-alt"></i></button><button onclick="window.App.moveToLixeira('${c.id}')" class="text-sm text-gray-400 hover:text-red-400 p-1"><i class="fas fa-trash-alt"></i></button></div>`;
				return this.el('div', { cls: `dark-card shadow-lg rounded-xl overflow-hidden ${s.borderColor} border-l-4 transition-all hover:-translate-y-1`, html });
			}
			createParcelaCard({ contract, parcel, index, diffDays, valorCorrigido, isVencida }) {
				const html = `<p class="font-bold text-lg text-white">${contract.clientName}</p><p class="text-sm text-gray-400 mb-3">P.${parcel.number}</p>
				<div class="border-t border-gray-700 pt-3 mt-3 space-y-2">${isVencida ? `<div class="flex justify-between text-sm"><span class="text-gray-400">Orig:</span><span class="line-through text-gray-400">${Utils.formatCurrency(parcel.value)}</span></div><div class="flex justify-between"><span class="text-sm text-white">Corr:</span><span class="font-semibold text-lg parcel-value">${Utils.formatCurrency(valorCorrigido)}</span></div>` : `<div class="flex justify-between"><span class="text-sm text-white">Valor:</span><span class="font-semibold text-lg parcel-value">${Utils.formatCurrency(parcel.value)}</span></div>`}
				<div class="flex justify-between text-sm"><span class="text-gray-400">Venc:</span><span class="font-medium text-gray-300">${Utils.formatDate(parcel.dueDate)}</span></div>
				<div class="flex justify-between items-center font-bold text-sm ${isVencida ? 'text-red-400 bg-red-900/30' : 'text-yellow-400 bg-yellow-900/30'} px-2 py-1 rounded"><span>${isVencida ? 'Atrasado:' : 'Faltam:'}</span><span>${Math.abs(diffDays)}d</span></div></div>
				<div class="mt-4 flex gap-2"><button onclick="window.App.openPaymentModal('${contract.id}', ${index})" class="flex-1 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-2 px-3 rounded-lg text-sm transition">Pagar</button><button onclick="window.App.openContractModal('${contract.id}')" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg"><i class="fas fa-pencil-alt"></i></button></div>`;
				return this.el('div', { cls: `dark-card shadow-lg p-5 rounded-lg border-l-4 ${isVencida ? 'parcel-card-vencida' : 'parcel-card-avencer'} transition-all hover:-translate-y-1`, html });
			}
			createNotificationItem(n) { const d = this.el('div', { cls: `notification-item ${n.isRead?'is-read':''}`, html: `<p class="text-sm text-white">${Utils.sanitizeText(n.message)}</p><div class="text-xs text-gray-500 mt-1">${Utils.timeAgo(n.timestamp?.toDate())}</div>` }); d.onclick=()=>{if(!n.isRead) window.App.markNotificationsAsRead([n.id]); window.App.closeNotificationDropdown();}; return d; }
			createServiceTag(n,d,s) { const t=this.el('div',{cls:'service-tag'}); t.dataset.name=n; t.dataset.deadline=d; t.dataset.status=s; t.innerHTML=`<span>${n}${d?` <small class="text-gray-400">(${Utils.formatDate(d)})</small>`:''}</span><span class="ml-2 cursor-pointer hover:text-red-400 font-bold" onclick="this.parentElement.remove()">&times;</span>`; document.getElementById('servicosContainer').appendChild(t); }
			createManualParcelListItem(v,d,i) { return this.el('div', { cls: 'parcel-list-item', html: `<span>${Utils.formatCurrency(v)} - ${Utils.formatDate(d)}</span><button type="button" class="text-red-400 hover:text-red-300 font-bold" onclick="window.App.handleRemoveManualParcel(${i})">&times;</button>` }); }
			createSettingListItem(n) { return this.el('div', { cls: 'setting-list-item', html: `<span class="font-medium text-white">${Utils.sanitizeText(n)}</span><button class="setting-list-remove-btn" onclick="window.App.handleRemoveAdvogado('${Utils.sanitizeText(n)}')"><i class="fas fa-times"></i></button>` }); }
			createExitoCard(c) { return this.card(`<p class="font-bold text-white">${c.clientName}</p><p class="text-sm text-gray-400 mb-3">${(c.serviceTypes||[]).map(s=>s.name).join(', ')}</p><div class="my-4 text-center"><p class="text-sm text-gray-400">Bonifica√ß√£o</p><p class="text-2xl font-semibold text-indigo-400">${c.successFee || 'N/A'}</p></div><button onclick="window.App.openExitoModal('${c.id}')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg text-sm">Receber</button>`, 'border-l-4 border-indigo-500 w-80 flex-shrink-0'); }
			createServicoCard(c, sp, fp) {
				const html = `<div class="flex justify-between items-start"><h3 class="font-bold text-xl text-indigo-300 mb-4">${c.clientName}</h3><p class="text-sm text-gray-400"><i class="fas fa-user-tie mr-1"></i> ${c.advogadoResponsavel}</p></div>
				<div class="space-y-4 mb-4"><div><div class="flex justify-between text-sm mb-1 text-gray-300"><label>Financeiro</label><span class="font-medium text-teal-300">${fp.toFixed(0)}%</span></div><div class="w-full bg-gray-700 rounded-full h-2"><div class="bg-teal-500 h-2 rounded-full" style="width: ${fp}%"></div></div></div>
				<div><div class="flex justify-between text-sm mb-1 text-gray-300"><label>Servi√ßos</label><span class="font-medium text-indigo-300">${sp.toFixed(0)}%</span></div><div class="w-full bg-gray-700 rounded-full h-2"><div class="bg-indigo-500 h-2 rounded-full" style="width: ${sp}%"></div></div></div></div>
				<div class="border-t border-gray-700 pt-3"><h4 class="font-semibold text-sm mb-2 text-gray-400">Servi√ßos:</h4><ul class="space-y-1">${(c.serviceTypes||[]).map((s,i) => `<li class="flex items-center justify-between p-2 rounded hover:bg-gray-700/50"><span class="${s.status==='Conclu√≠do'?'text-gray-500 line-through':'text-gray-300'} text-sm">${s.name}</span><div class="flex gap-2 text-xs">${s.status!=='Conclu√≠do'?`<button onclick="window.App.updateServiceStatus('${c.id}', ${i}, 'Em Andamento')" class="text-yellow-400 hover:underline">Iniciar</button><button onclick="window.App.updateServiceStatus('${c.id}', ${i}, 'Conclu√≠do')" class="text-teal-400 hover:underline">Fim</button>`:`<span class="text-teal-500 font-bold">‚úì</span>`}</div></li>`).join('')}</ul></div>`;
				return this.card(html);
			}
			createRankingRow(r, l, v) { 
				const cls = r === 1 ? 'rank-1' : (r === 2 ? 'rank-2' : (r === 3 ? 'rank-3' : 'rank-other'));
				const medal = r === 1 ? 'ü•á' : (r === 2 ? 'ü•à' : (r === 3 ? 'ü•â' : ''));
				return this.el('tr', { 
					html: `<td><span class="${cls}">${r}</span></td>
						   <td class="text-gray-200 font-medium">${medal} ${l}</td>
						   <td class="${cls}">${v}</td>` 
				}); 
			}
			renderPaginationControls(cont, total, pages, curr) {
				cont.innerHTML = ''; if(pages <= 1) return;
				const btn = (i, t, d, a) => { const b = this.el('button', { cls: `pagination-button px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white mx-1 ${a?'bg-indigo-600 hover:bg-indigo-600':''}`, text: t||(i+1) }); if(d) b.disabled=true; else b.onclick=()=>window.App.changeContractPage(i); return b; };
				cont.append(btn(curr-1, '¬´', curr===0));
				for(let i=0; i<pages; i++) cont.append(btn(i, null, false, i===curr));
				cont.append(btn(curr+1, '¬ª', curr===pages-1));
			}
		}

		class App {
			constructor() {
				this.database = { contracts: [], notifications: [], settings: { advogados: { list: [] } } };
				this.currentUserDisplayName = null; this.currentSafeName = null; this.isUserAdmin = false;
				this.currentAdvancedReportData = null; this.currentPageId = null; this.lastOverdueCheck = null;
				this.manualParcels = [];
				this.currentContractSort = 'name-asc'; this.currentParcelasSort = 'days-asc'; this.currentServicosSort = 'name-asc';
				this.contractListPage = 0; this.contractStatusFilter = 'ativos';
				this.globalDateFilter = 'novos';

				this.authService = new AuthService(this);
				this.firebaseService = new FirebaseService(this);
				this.domBuilder = new DOMBuilder(this);
				this.reportHandler = new ReportHandler(this);
				this.analyticsHandler = new AnalyticsHandler(this);
				this.correctionCalculator = new CorrectionCalculator(this);
			}

			initialize() { this.authService.initialize(); this._initDOMReferences(); this.setupEventListeners(); this._setupModalAccessibility(); }
			
			_initDOMReferences() {
				this.backdrop = document.getElementById('modal-backdrop'); this.appContainer = document.getElementById('app-container');
				this.loadingOverlay = document.getElementById('loading-overlay'); this.authOverlay = document.getElementById('auth-overlay');
				this.notificationDropdown = document.getElementById('notification-dropdown');
			}

			setupEventListeners() {
				document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); this.authService.login(document.getElementById('login-email').value, document.getElementById('login-password').value); });
				document.getElementById('logout-button').addEventListener('click', () => this.authService.logout());
				document.getElementById('formDisplayName').addEventListener('submit', this.handleDisplayNameSubmit.bind(this));
				document.getElementById('formContrato').addEventListener('submit', this.handleContractSubmit.bind(this));
				document.getElementById('formPagamento').addEventListener('submit', this.handlePaymentSubmit.bind(this));
				document.getElementById('formExito').addEventListener('submit', this.handleExitoSubmit.bind(this));
				document.getElementById('formAddAdvogado').addEventListener('submit', this.handleAddAdvogado.bind(this));
				
				// AQUI: Listener correto para adicionar servi√ßo + Enter
				const addSvcBtn = document.getElementById('addServiceButton');
				if(addSvcBtn) addSvcBtn.addEventListener('click', this.handleAddServiceTag.bind(this));
				document.getElementById('contratoServicoInput').addEventListener('keypress', (e) => {
					if(e.key === 'Enter') { e.preventDefault(); this.handleAddServiceTag(); }
				});
				
				document.getElementById('contratoEspecial').addEventListener('change', this.toggleSpecialContractFields.bind(this));
				const addParcelBtn = document.getElementById('addManualParcelButton');
				if(addParcelBtn) addParcelBtn.addEventListener('click', this.handleAddManualParcel.bind(this));
				
				document.getElementById('searchInput').addEventListener('input', Utils.debounce(() => this.resetAndRenderContractList(), 300));
				document.getElementById('servicosSearchInput').addEventListener('input', Utils.debounce(() => this.renderServicosPage(), 300));
				document.getElementById('parcelasSearchInput').addEventListener('input', Utils.debounce(() => this.renderParcelasPage(), 300));
				
				document.getElementById('globalDateFilter').addEventListener('change', (e) => { this.globalDateFilter = e.target.value; Utils.showToast(`Visualizando: ${e.target.options[e.target.selectedIndex].text}`); this.render(); });

				document.getElementById('mobile-menu-toggle').addEventListener('click', () => { const s = document.getElementById('sidebar'); s.classList.toggle('hidden'); this.backdrop.style.display = s.classList.contains('hidden') ? 'none' : 'block'; });
				if(this.backdrop) this.backdrop.addEventListener('click', () => { if (this.openModalId && this.openModalId !== 'modalDisplayName') this.closeModal(this.openModalId); document.getElementById('sidebar').classList.add('hidden'); this.closeNotificationDropdown(); });
				document.getElementById('notification-bell').addEventListener('click', (e) => { e.stopPropagation(); this.notificationDropdown.classList.toggle('hidden'); });
				document.getElementById('clear-notifications-button').addEventListener('click', () => this.markNotificationsAsRead());
				document.addEventListener('click', (e) => { if (!this.notificationDropdown.classList.contains('hidden') && !e.target.closest('#notification-bell') && !this.notificationDropdown.contains(e.target)) this.closeNotificationDropdown(); });
				['valorTotal', 'numParcelas', 'vencimentoPrimeiraParcela', 'contratoJaQuitado'].forEach(id => document.getElementById(id)?.addEventListener('change', () => document.getElementById('financialDataChanged').value = 'true'));
			}

			handleAuthStateChange(user) {
				if (user) {
					const isAdmin = ADMIN_USERS.includes((user.displayName || '').toLowerCase());
					this.currentUserDisplayName = user.displayName; this.currentSafeName = Utils.sanitizeForFirestoreId(user.displayName); this.isUserAdmin = isAdmin;
					document.body.classList.toggle('is-admin', this.isUserAdmin);
					
					// L√≥gica corrigida para n√£o pedir nome se j√° tiver
					if (!user.displayName) {
						document.getElementById('loading-overlay').style.display = 'none'; 
						document.getElementById('auth-overlay').style.display = 'flex'; 
						document.getElementById('app-container').style.display = 'none'; 
						this.openModal('modalDisplayName');
					} else {
						document.getElementById('user-display-name').textContent = user.displayName;
						document.getElementById('loading-overlay').style.display = 'none'; 
						document.getElementById('auth-overlay').style.display = 'none'; 
						document.getElementById('app-container').style.display = 'flex';
						this.setupUIAccess(); 
						this.firebaseService.startSnapshotListener('contracts'); 
						this.firebaseService.startNotificationListener(this.currentSafeName); 
						this.firebaseService.startSystemSettingsListener();
					}
				} else {
					this.currentUserDisplayName = null; this.currentSafeName = null; this.isUserAdmin = false; this.lastOverdueCheck = null;
					document.body.classList.remove('is-admin'); document.getElementById('auth-overlay').style.display = 'flex'; document.getElementById('app-container').style.display = 'none'; document.getElementById('loading-overlay').style.display = 'none';
					this.firebaseService.stopListeners();
				}
			}

			handleSnapshotUpdate(contracts) {
				const old = this.database.contracts || []; this.database.contracts = contracts;
				this.checkAndNotifyOverdue(old, contracts); this.contractListPage = 0; this.render();
			}
			handleNotificationUpdate(n) { this.database.notifications = n; this.renderNotificationDropdown(); }
			handleSystemSettingsUpdate(s) { if (!s.advogados) s.advogados = { list: [] }; this.database.settings = s; this.renderAdvogadoFilters(); this.populateAdvogadoSelectModal(); if (this.currentPageId === 'page-oficina') this.renderOficinaPage(); }

			getFilteredContracts(includeDeleted = false) {
				let contracts = this.database.contracts;
				if (!this.isUserAdmin) contracts = contracts.filter(c => c.advogadoResponsavel === this.currentUserDisplayName);
				contracts = contracts.filter(c => {
					let refDate = null;
					if (c.parcels && c.parcels.length > 0) {
						const sorted = [...c.parcels].sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
						refDate = new Date(sorted[0].dueDate);
					} else if (c.createdAt) { refDate = new Date(c.createdAt); }
					if (!refDate || isNaN(refDate.getTime())) refDate = new Date('2000-01-01');
					return this.globalDateFilter === 'novos' ? refDate >= CUTOFF_DATE : refDate < CUTOFF_DATE;
				});
				if (!includeDeleted) contracts = contracts.filter(c => !c.isDeleted);
				return contracts;
			}

			render() {
				if (document.getElementById('app-container').style.display !== 'flex') return;
				const pid = this.currentPageId || 'page-dashboard';
				if (!this.currentPageId) this.showPage(pid);
				if (pid === 'page-dashboard') { this.renderKanban(); this.renderContractList(); }
				else if (pid === 'page-parcelas') this.renderParcelasPage();
				else if (pid === 'page-servicos') this.renderServicosPage();
				else if (pid === 'page-lixeira') this.renderLixeiraPage();
				else if (pid === 'page-relatorios') this.renderAdvancedReportPage();
				else if (pid === 'page-performance') this.renderPerformancePage();
				else if (pid === 'page-oficina') this.renderOficinaPage();
				this.renderSortButtons();
			}

			renderKanban() {
				const contracts = this.getFilteredContracts(false);
				const kVenc = document.getElementById('kanban-vencidas'), kAvenc = document.getElementById('kanban-a-vencer'), kPagas = document.getElementById('kanban-pagas'), kExito = document.getElementById('kanban-exito-wrapper');
				const fVenc = document.createDocumentFragment(), fAvenc = document.createDocumentFragment(), fPagas = document.createDocumentFragment(), fExito = document.createDocumentFragment();
				const hoje = new Date(); hoje.setHours(0,0,0,0); const d1 = new Date(hoje.getFullYear(), hoje.getMonth(), 1); const d30 = new Date(); d30.setDate(hoje.getDate()+30);
				let t30 = 0, tVenc = 0, hasExito = 0;
				contracts.forEach(c => {
					const rem = (c.parcels||[]).reduce((s,p)=>p.status==='Pendente'?s+p.value:s,0);
					(c.parcels||[]).forEach((p,i) => {
						const venc = new Date(p.dueDate);
						if (p.status === 'Paga') { const dp = new Date(p.paymentDate); if(dp>=d1 && dp<=hoje) fPagas.append(this.domBuilder.createParcelCard(c, p, i, 'paga', rem)); }
						else {
							if (venc < hoje) { const vc = this.correctionCalculator.calcularValorCorrigido(p.value, p.dueDate); tVenc+=vc; fVenc.append(this.domBuilder.createParcelCard(c, p, i, 'vencida', rem, vc)); }
							else if (venc >= hoje && venc <= d30) { t30+=p.value; fAvenc.append(this.domBuilder.createParcelCard(c, p, i, 'a-vencer', rem)); }
						}
					});
					if (c.successFee && !c.successFeePaymentDate && (c.parcels||[]).every(p=>p.status==='Paga')) { fExito.append(this.domBuilder.createExitoCard(c)); hasExito++; }
				});
				kVenc.innerHTML=''; kAvenc.innerHTML=''; kPagas.innerHTML=''; kExito.innerHTML='';
				kVenc.append(fVenc); kAvenc.append(fAvenc); kPagas.append(fPagas);
				if(hasExito>0) { kExito.append(fExito); document.getElementById('exito-section').classList.remove('hidden'); } else document.getElementById('exito-section').classList.add('hidden');
				const totalPagoMes = this.reportHandler.calculateMonthlyIncome(hoje.getFullYear(), hoje.getMonth(), this.getFilteredContracts(true)).totalGeral;
				document.getElementById('dash-a-receber').textContent = Utils.formatCurrency(t30);
				document.getElementById('dash-vencido').textContent = Utils.formatCurrency(tVenc);
				document.getElementById('dash-recebido').textContent = Utils.formatCurrency(totalPagoMes);
				document.getElementById('dash-contratos').textContent = contracts.length;
			}

			renderContractList() {
				const container = document.getElementById('contractListContainer'); const search = (document.getElementById('searchInput').value||'').toLowerCase();
				const advFilter = document.getElementById('advogadoFilter')?.value || 'Todos';
				let list = this.getFilteredContracts(false).filter(c => {
					const s = this.getContractStatus(c); const done = s.statusText === 'Conclu√≠do';
					if (this.contractStatusFilter==='ativos' && done) return false;
					if (this.contractStatusFilter==='concluidos' && !done) return false;
					const matchAdv = (this.isUserAdmin && advFilter==='Todos') || c.advogadoResponsavel === (this.isUserAdmin ? advFilter : this.currentUserDisplayName);
					const matchText = c.clientName.toLowerCase().includes(search) || (c.serviceTypes||[]).some(x=>x.name.toLowerCase().includes(search));
					return matchAdv && matchText;
				});
				if (this.currentContractSort === 'name-asc') list.sort((a,b)=>a.clientName.localeCompare(b.clientName));
				else if (this.currentContractSort === 'value-desc') list.sort((a,b)=>(b.totalValue||0)-(a.totalValue||0));
				const total = list.length; const pages = Math.ceil(total/CONTRACTS_PER_PAGE);
				if (this.contractListPage >= pages && pages > 0) this.contractListPage = pages - 1;
				const pgList = list.slice(this.contractListPage*CONTRACTS_PER_PAGE, (this.contractListPage+1)*CONTRACTS_PER_PAGE);
				container.innerHTML = '';
				if (total === 0) { container.innerHTML = `<div class="dark-card p-4 rounded text-center text-gray-400">Nenhum contrato encontrado neste per√≠odo.</div>`; this.domBuilder.renderPaginationControls(document.getElementById('paginationContainer'), 0, 0, 0); return; }
				const grid = this.domBuilder.el('div', { cls: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' });
				pgList.forEach(c => grid.append(this.domBuilder.createContractCard(c, this.getContractStatus(c))));
				container.append(grid);
				this.domBuilder.renderPaginationControls(document.getElementById('paginationContainer'), total, pages, this.contractListPage);
			}

			renderParcelasPage() {
				const contracts = this.getFilteredContracts(false);
				const container = document.getElementById('parcelasListContainer'); const search = (document.getElementById('parcelasSearchInput').value || '').toLowerCase();
				const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
				let list = [];
				contracts.forEach(c => {
					if (!c.clientName.toLowerCase().includes(search)) return;
					(c.parcels||[]).forEach((p, i) => {
						if (p.status === 'Pendente') {
							const due = new Date(p.dueDate); const diff = Math.ceil((due - hoje) / 86400000);
							const isVencida = due < hoje; const valCorr = isVencida ? this.correctionCalculator.calcularValorCorrigido(p.value, p.dueDate) : p.value;
							list.push({ contract: c, parcel: p, index: i, diffDays: diff, valorCorrigido: valCorr, isVencida });
						}
					});
				});
				if (this.currentParcelasSort === 'days-asc') list.sort((a, b) => a.diffDays - b.diffDays);
				else if (this.currentParcelasSort === 'value-desc') list.sort((a, b) => b.valorCorrigido - a.valorCorrigido);
				else if (this.currentParcelasSort === 'name-asc') list.sort((a, b) => a.contract.clientName.localeCompare(b.contract.clientName));
				container.innerHTML = '';
				if (list.length === 0) container.innerHTML = `<div class="col-span-3 text-center py-10"><i class="fas fa-check-circle fa-3x text-green-500 mb-2"></i><p>Tudo em dia!</p></div>`;
				else list.forEach(item => container.append(this.domBuilder.createParcelaCard(item)));
			}

			renderServicosPage() {
				const contracts = this.getFilteredContracts(false);
				const container = document.getElementById('servicosListContainer'); const search = (document.getElementById('servicosSearchInput').value || '').toLowerCase();
				const advFilter = document.getElementById('servicosAdvogadoFilter')?.value || 'Todos';
				container.innerHTML = '';
				let active = contracts.filter(c => {
					const matchAdv = (this.isUserAdmin && advFilter === 'Todos') || c.advogadoResponsavel === (this.isUserAdmin ? advFilter : this.currentUserDisplayName);
					const matchText = c.clientName.toLowerCase().includes(search);
					return matchAdv && matchText && c.serviceTypes && c.serviceTypes.length > 0;
				});
				if (this.currentServicosSort === 'name-asc') active.sort((a, b) => a.clientName.localeCompare(b.clientName));
				else if (this.currentServicosSort === 'adv-asc') active.sort((a, b) => a.advogadoResponsavel.localeCompare(b.advogadoResponsavel));
				let hasItems = false;
				active.forEach(c => {
					const total = (c.serviceTypes||[]).length;
					let prog = 0; (c.serviceTypes||[]).forEach(s => { if(s.status==='Conclu√≠do') prog+=1; else if(s.status==='50% Conclu√≠do') prog+=0.5; else if(s.status==='Em Andamento') prog+=0.25; });
					const sp = total > 0 ? (prog/total)*100 : 0;
					if(sp < 100) { container.append(this.domBuilder.createServicoCard(c, sp, ((c.parcels||[]).reduce((s,p)=>s+(p.valuePaid||0),0)/c.totalValue)*100 || 0)); hasItems = true; }
				});
				if (!hasItems) container.innerHTML = `<div class="text-center py-10 text-gray-500">Nenhum servi√ßo pendente.</div>`;
			}

			renderLixeiraPage() {
				const container = document.getElementById('lixeiraListContainer'); container.innerHTML = '';
				const deleted = this.getFilteredContracts(true).filter(c => c.isDeleted === true);
				if (deleted.length === 0) container.innerHTML = `<p class="text-center col-span-3 text-gray-500">Lixeira vazia.</p>`;
				deleted.forEach(c => {
					container.append(this.domBuilder.card(`<p class="font-bold text-white">${c.clientName}</p><p class="text-sm text-gray-400 mb-3">${(c.serviceTypes||[]).map(s=>s.name).join(', ')}</p><div class="border-t border-gray-700 pt-3 flex gap-2"><button onclick="window.App.restoreContract('${c.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm w-full">Restaurar</button>${this.isUserAdmin ? `<button onclick="window.App.deleteContractPermanently('${c.id}')" class="bg-red-700 text-white px-3 py-1 rounded text-sm w-full">Excluir</button>` : ''}</div>`, 'border-l-4 border-gray-600'));
				});
			}

			generateAndShowReport() {
				const m = parseInt(document.getElementById('reportMonth').value);
				const y = parseInt(document.getElementById('reportYear').value);
				const data = this.reportHandler.calculateMonthlyIncome(y, m, this.getFilteredContracts(true));
				let html = `<div class="grid grid-cols-2 gap-4 text-center mb-6"><div class="dark-card p-4 rounded">Total Parc.<br><b class="text-white text-xl">${Utils.formatCurrency(data.totalParcelas)}</b></div><div class="dark-card p-4 rounded">Total √äxito<br><b class="text-indigo-400 text-xl">${Utils.formatCurrency(data.totalExito)}</b></div></div><div class="bg-green-900/20 border border-green-700 p-4 text-center rounded mb-6"><h3 class="font-bold text-green-400 text-2xl">${Utils.formatCurrency(data.totalGeral)}</h3><p class="text-xs">RECEBIDO EM ${m + 1}/${y}</p></div>`;
				html += `<h4 class="text-green-400 font-bold text-xs uppercase border-b border-gray-700 pb-1 mb-2">Quem Pagou</h4>`;
				if (data.detailedPayments.length > 0) { html += `<div class="space-y-1 mb-6">`; data.detailedPayments.forEach(p => html += `<div class="flex justify-between bg-gray-800 p-2 rounded text-sm"><div><span class="text-white">${p.clientName}</span> <span class="text-xs text-gray-500">(${p.type})</span></div><div class="text-green-400 font-bold">${Utils.formatCurrency(p.value)}</div></div>`); html += `</div>`; } else html += `<p class="text-xs text-gray-500 italic mb-6">Nenhum recebimento.</p>`;
				const pendingTotal = data.pendingPayments.reduce((acc,curr)=>acc+curr.value,0);
				html += `<h4 class="text-red-400 font-bold text-xs uppercase border-b border-gray-700 pb-1 mb-2 flex justify-between"><span>Quem N√£o Pagou</span><span>Total: ${Utils.formatCurrency(pendingTotal)}</span></h4>`;
				if (data.pendingPayments.length > 0) { html += `<div class="space-y-1">`; data.pendingPayments.forEach(p => html += `<div class="flex justify-between bg-red-900/10 border border-red-900/30 p-2 rounded text-sm"><div><span class="text-white">${p.clientName}</span> <span class="text-xs text-red-300">Venc: ${Utils.formatDate(p.date)}</span></div><div class="text-red-400 font-bold">${Utils.formatCurrency(p.value)}</div></div>`); html += `</div>`; } else html += `<p class="text-xs text-gray-500 italic">Nenhuma pend√™ncia.</p>`;
				document.getElementById('reportResult').innerHTML = html; document.getElementById('reportResult').classList.remove('hidden'); document.getElementById('reportChartsContainer').classList.add('hidden');
			}

			exportReportPDF() {
				if (!this.currentAdvancedReportData) return;
				const { jsPDF } = window.jspdf; const doc = new jsPDF(); const d = this.currentAdvancedReportData;
				doc.setFontSize(18); doc.text("Relat√≥rio Financeiro", 14, 22); doc.setFontSize(11); doc.text(`Gerado em ${new Date().toLocaleDateString()}`, 14, 30);
				doc.autoTable({ startY: 40, head: [['Item', 'Valor']], body: [['Fatura√ß√£o Total', Utils.formatCurrency(d.totalGeral)], ['Novos Contratos', d.totalContratos], ['Total Parcelas', Utils.formatCurrency(d.totalParcelas)], ['Total √äxito', Utils.formatCurrency(d.totalExito)]], theme: 'grid', headStyles: { fillColor: [22, 163, 74] } });
				doc.setFontSize(14); doc.text("Detalhes: Quem Pagou", 14, doc.lastAutoTable.finalY + 15);
				const rowsPaid = d.detailedPayments.map(x => [x.clientName, x.type, Utils.formatDate(x.date), x.advogado, Utils.formatCurrency(x.value)]);
				doc.autoTable({ startY: doc.lastAutoTable.finalY + 20, head: [['Cliente', 'Tipo', 'Data', 'Adv', 'Valor']], body: rowsPaid, headStyles: { fillColor: [22, 163, 74] } });
				if (d.pendingPayments && d.pendingPayments.length > 0) {
					doc.addPage(); doc.setFontSize(14); doc.setTextColor(220, 38, 38); doc.text("Pend√™ncias: Quem N√ÉO Pagou", 14, 20); doc.setTextColor(0, 0, 0);
					const rowsPending = d.pendingPayments.map(x => [x.clientName, x.type, Utils.formatDate(x.date), x.advogado, Utils.formatCurrency(x.value)]);
					doc.autoTable({ startY: 25, head: [['Cliente', 'Parcela', 'Vencimento', 'Adv', 'Valor']], body: rowsPending, headStyles: { fillColor: [220, 38, 38] } });
				}
				doc.save('relatorio_completo.pdf');
			}

			renderAdvancedReportCharts(data) {
				const timelineCtx = document.getElementById('advReportTimelineChart').getContext('2d');
				const sortedMonths = Object.keys(data.byMonth).sort();
				const timelineLabels = sortedMonths.map(key => { const [year, month] = key.split('-'); return new Date(year, month - 1).toLocaleString('pt-BR', { month: 'short', year: '2-digit' }); });
				const timelineData = sortedMonths.map(key => data.byMonth[key]);
				this.analyticsHandler.renderChart('advReportTimelineChart', 'line', timelineLabels, timelineData, 'Fatura√ß√£o', '#4ade80');
				const byAdvCtx = document.getElementById('advReportByAdvogadoChart').getContext('2d');
				const advLabels = Object.keys(data.byAdvogado);
				const advData = Object.values(data.byAdvogado);
				this.analyticsHandler.renderPie('advReportByAdvogadoChart', advLabels, advData, 'Por Advogado');
				const newContractsCtx = document.getElementById('advReportNewContractsChart').getContext('2d');
				const sortedContractMonths = Object.keys(data.newContractsByMonth).sort();
				const contractLabels = sortedContractMonths.map(key => { const [year, month] = key.split('-'); return new Date(year, month - 1).toLocaleString('pt-BR', { month: 'short', year: '2-digit' }); });
				const contractData = sortedContractMonths.map(key => data.newContractsByMonth[key]);
				this.analyticsHandler.renderChart('advReportNewContractsChart', 'bar', contractLabels, contractData, 'Novos Contratos', '#8b5cf6');
			}

			renderAdvancedReportPage() { this.generateAdvancedReport(); } 
			generateAdvancedReport() {
				this.analyticsHandler.destroyPageCharts('page-relatorios');
				const s = new Date(document.getElementById('reportStartDate').value + 'T00:00:00');
				const e = new Date(document.getElementById('reportEndDate').value + 'T23:59:59');
				const data = this.reportHandler.calculateIncomeByDateRange(s, e, this.getFilteredContracts(true));
				this.currentAdvancedReportData = data;
				if (data.totalGeral === 0 && data.totalContratos === 0) { document.getElementById('advancedReportContainer').classList.add('hidden'); document.getElementById('advancedReportEmpty').classList.remove('hidden'); document.getElementById('exportPdfButton').disabled = true; }
				else {
					document.getElementById('advancedReportContainer').classList.remove('hidden'); document.getElementById('advancedReportEmpty').classList.add('hidden'); document.getElementById('exportPdfButton').disabled = false;
					document.getElementById('report-kpis').innerHTML = `<div class="dark-card p-4 rounded text-center">Fatura√ß√£o<br><b class="text-2xl text-green-400">${Utils.formatCurrency(data.totalGeral)}</b></div><div class="dark-card p-4 rounded text-center">Novos<br><b class="text-2xl text-blue-400">${data.totalContratos}</b></div><div class="dark-card p-4 rounded text-center">Pendentes<br><b class="text-2xl text-red-400">${Utils.formatCurrency(data.pendingPayments.reduce((a,b)=>a+b.value,0))}</b></div><div class="dark-card p-4 rounded text-center">√äxito<br><b class="text-2xl text-indigo-400">${Utils.formatCurrency(data.totalExito)}</b></div>`;
					this.renderAdvancedReportCharts(data);
				}
			}
			renderPerformancePage() {
				if (!this.isUserAdmin) return;
				this.analyticsHandler.destroyPageCharts('page-performance');
				const { contratosPorAdvogado, faturamentoPorAdvogado } = this.reportHandler.calculateAdminPerformanceData(this.getFilteredContracts(true));
				this.analyticsHandler.renderPie('adminChartContratos', Object.keys(contratosPorAdvogado), Object.values(contratosPorAdvogado), 'Contratos');
				this.analyticsHandler.renderChart('adminChartFaturamento', 'bar', Object.keys(faturamentoPorAdvogado), Object.values(faturamentoPorAdvogado), 'Fatura√ß√£o', '#4ade80');
				const tb1 = document.getElementById('adminTableFaturamento').querySelector('tbody'); tb1.innerHTML='';
				Object.entries(faturamentoPorAdvogado).sort(([,a],[,b])=>b-a).forEach(([l,v],i) => tb1.append(this.domBuilder.createRankingRow(i+1, l, Utils.formatCurrency(v))));
				const tb2 = document.getElementById('adminTableContratos').querySelector('tbody'); tb2.innerHTML='';
				Object.entries(contratosPorAdvogado).sort(([,a],[,b])=>b-a).forEach(([l,v],i) => tb2.append(this.domBuilder.createRankingRow(i+1, l, v)));
			}
			renderOficinaPage() {
				const list = document.getElementById('advogadoSettingsList'); if(!list) return;
				list.innerHTML = ''; const frag = document.createDocumentFragment();
				const arr = this.database.settings.advogados?.list || [];
				if(arr.length === 0) list.innerHTML = `<p class="text-sm text-gray-400 text-center p-2">Vazio.</p>`;
				else [...arr].sort().forEach(n => frag.append(this.domBuilder.createSettingListItem(n)));
				list.append(frag);
			}
			showPage(id) {
				if ((this.currentPageId==='page-relatorios'&&id!=='page-relatorios')||(this.currentPageId==='page-performance'&&id!=='page-performance')) this.analyticsHandler.destroyPageCharts(this.currentPageId);
				this.currentPageId = id;
				['page-dashboard', 'page-parcelas', 'page-servicos', 'page-lixeira', 'page-relatorios', 'page-performance', 'page-oficina'].forEach(p => document.getElementById(p)?.classList.add('hidden'));
				document.querySelectorAll('.sidebar-nav-item, .mobile-nav-item').forEach(e => e.classList.remove('active'));
				document.getElementById(id)?.classList.remove('hidden');
				const base = id.split('-')[1]; document.getElementById(`tab-${base}`)?.classList.add('active'); document.getElementById(`mobile-tab-${base}`)?.classList.add('active');
				const sb = document.getElementById('sidebar'); if(window.innerWidth<768 && !sb.classList.contains('hidden')) { sb.classList.add('hidden'); document.getElementById('modal-backdrop').style.display='none'; }
				this.render();
			}
			setupUIAccess() { const adm=this.isUserAdmin; ['advogadoFilter', 'servicosAdvogadoFilter'].forEach(id=>{const e=document.getElementById(id);if(e){e.disabled=!adm;e.value=adm?'Todos':this.currentUserDisplayName;}}); }
			getContractStatus(c) { const p=(c.parcels||[]).every(x=>x.status==='Paga'), s=(c.serviceTypes||[]).every(x=>x.status==='Conclu√≠do'); if(p&&s) return c.successFee&&!c.successFeePaymentDate?{statusText:'Aguardando √äxito',statusColor:'bg-indigo-900 text-indigo-300',borderColor:'border-indigo-500'}:{statusText:'Conclu√≠do',statusColor:'bg-gray-700 text-gray-300',borderColor:'border-gray-600'}; if(p) return {statusText:'Em Andamento',statusColor:'bg-blue-900 text-blue-300',borderColor:'border-blue-500'}; return {statusText:'Ativo',statusColor:'bg-yellow-900 text-yellow-300',borderColor:'border-yellow-500'}; }
			renderSortButtons() { /* Helper UI */ }
			renderAdvogadoFilters() { const all=new Set(this.database.settings.advogados?.list||[]); ['advogadoFilter','servicosAdvogadoFilter'].forEach(id=>{const s=document.getElementById(id);if(!s)return;const v=s.value;s.innerHTML='<option value="Todos">Todos</option>';[...all].sort().forEach(a=>s.add(new Option(a,a)));s.value=this.isUserAdmin?(v||'Todos'):this.currentUserDisplayName;s.disabled=!this.isUserAdmin;}); }
			populateAdvogadoSelectModal() { const s=document.getElementById('advogadoResponsavel');if(!s)return;s.innerHTML='<option>N√£o Informado</option>';const all=new Set(this.database.settings.advogados?.list||[]);[...all].sort().forEach(a=>s.add(new Option(a,a))); }
			changeContractPage(i) { this.contractListPage=i; this.renderContractList(); }
			resetAndRenderContractList() { this.contractListPage=0; this.renderContractList(); }
			
			// --- HANDLERS DE A√á√ÉO ---
			async handleDisplayNameSubmit(e) { e.preventDefault(); if(await this.authService.updateUserProfile(document.getElementById('inputDisplayName').value)) window.location.reload(); }
			async handleContractSubmit(e) {
				e.preventDefault(); const id=document.getElementById('contractId').value, spec=document.getElementById('contratoEspecial').checked, svcs=Array.from(document.querySelectorAll('#servicosContainer .service-tag')).map(t=>({name:Utils.sanitizeText(t.dataset.name),status:t.dataset.status,deadline:t.dataset.deadline}));
				if(!svcs.length){Utils.showToast('Adicione servi√ßos.','error');return;}
				const data={clientName:Utils.sanitizeText(document.getElementById('clienteNome').value),advogadoResponsavel:document.getElementById('advogadoResponsavel').value,serviceTypes:svcs,paymentType:document.getElementById('contratoTipoPagamento').value,observations:document.getElementById('contratoObservacoes').value,isSpecialContract:spec};
				if(this.isUserAdmin){
					let p=[],t=0;
					if(spec){ this.manualParcels.forEach((x,i)=>{t+=x.value;p.push({number:i+1,value:x.value,dueDate:new Date(x.dueDate+'T12:00:00').toISOString(),status:'Pendente',valuePaid:0});}); }
					else{ t=Utils.parseNumber(document.getElementById('valorTotal').value);const n=parseInt(document.getElementById('numParcelas').value)||1,start=document.getElementById('vencimentoPrimeiraParcela').value,paid=document.getElementById('contratoJaQuitado').checked;
						if(n>0&&t>0){let dt=new Date((start||new Date().toISOString().split('T')[0])+'T12:00:00');const v=t/n;for(let i=0;i<n;i++){const isP=paid&&n===1;p.push({number:i+1,value:v,dueDate:dt.toISOString(),status:isP?'Paga':'Pendente',valuePaid:isP?v:0,paymentDate:isP?new Date().toISOString():null});dt.setMonth(dt.getMonth()+1);}}
					}
					data.totalValue=t;data.parcels=p;data.successFee=document.getElementById('taxaExito').value;
				}
				if(!id){if(!this.isUserAdmin){data.parcels=[];data.totalValue=0;} data.isDeleted=false;data.createdAt=new Date().toISOString(); if(await this.firebaseService.addContract(data)) this.closeModal('modalContrato');}
				else{const old=this.database.contracts.find(c=>c.id===id); if(!this.isUserAdmin&&old){data.totalValue=old.totalValue;data.parcels=old.parcels;} data.createdAt=old?.createdAt; if(await this.firebaseService.updateContract(id,data)) this.closeModal('modalContrato');}
			}
			async handlePaymentSubmit(e) { e.preventDefault(); const id=document.getElementById('pagamentoContractId').value, idx=document.getElementById('pagamentoParcelIndex').value, c=this.database.contracts.find(x=>x.id===id), val=this.isUserAdmin?Utils.parseNumber(document.getElementById('pagamentoValor').value):(c?.parcels[idx]?.value||0); if(c&&val>0){const p=[...c.parcels]; p[idx]={...p[idx],status:'Paga',valuePaid:val,paymentDate:new Date(document.getElementById('pagamentoData').value+'T12:00:00').toISOString()}; await this.firebaseService.updateContractField(id,{parcels:p}); this.closeModal('modalPagamento');} }
			async handleExitoSubmit(e) { e.preventDefault(); const id=document.getElementById('exitoContractId').value, val=this.isUserAdmin?Utils.parseNumber(document.getElementById('exitoValorRecebido').value):0; if(await this.firebaseService.updateContractField(id,{successFeeValueReceived:val,successFeePaymentDate:new Date().toISOString()})) this.closeModal('modalExito'); }
			handleAddServiceTag() { const n=document.getElementById('contratoServicoInput'),d=document.getElementById('contratoPrazoInput'); if(n.value){this.createServiceTag(n.value,d.value,'Pendente');n.value='';d.value='';} }
			async updateServiceStatus(id, idx, st) { const c=this.database.contracts.find(x=>x.id===id); if(c){const s=[...c.serviceTypes];s[idx].status=st;await this.firebaseService.updateContractField(id,{serviceTypes:s});} }
			async sendNotification(u, d) { if(u&&u!==this.currentUserDisplayName) await this.firebaseService.sendNotification(Utils.sanitizeForFirestoreId(u), d); }
			checkAndNotifyOverdue(o, n) { /* Notifica√ß√£o di√°ria simplificada */ }
			async moveToLixeira(id) { if(await Utils.confirm('Mover para Lixeira?')) await this.firebaseService.updateContractField(id,{isDeleted:true}); }
			async restoreContract(id) { if(await Utils.confirm('Restaurar?')) await this.firebaseService.updateContractField(id,{isDeleted:false}); }
			async deleteContractPermanently(id) { if(this.isUserAdmin && await Utils.confirm('EXCLUIR PERMANENTEMENTE?')) await this.firebaseService.deleteContract(id); }
			async handleAddAdvogado(e) { e.preventDefault(); const n=document.getElementById('inputAdvogadoName').value; const l=this.database.settings.advogados?.list||[]; if(n&&!l.includes(n)) await this.firebaseService.saveSystemSettings('advogados',{list:[...l,n]}); document.getElementById('inputAdvogadoName').value=''; }
			async handleRemoveAdvogado(n) { if(await Utils.confirm('Remover?')) await this.firebaseService.saveSystemSettings('advogados',{list:(this.database.settings.advogados?.list||[]).filter(x=>x!==n)}); }
			handleAddManualParcel() { const v=Utils.parseNumber(document.getElementById('parcelaValorManual').value),d=document.getElementById('parcelaVencimentoManual').value; if(v>0&&d){this.manualParcels.push({value:v,dueDate:d}); this.renderManualParcelList(); document.getElementById('parcelaValorManual').value='';} }
			handleRemoveManualParcel(i) { this.manualParcels.splice(i,1); this.renderManualParcelList(); }
			renderManualParcelList() { const c=document.getElementById('manualParcelList'); c.innerHTML=''; this.manualParcels.forEach((p,i)=>c.append(this.domBuilder.createManualParcelListItem(p.value,p.dueDate,i))); }
			toggleSpecialContractFields(e) { document.getElementById('financial-fields-standard').style.display=e.target.checked?'none':'block'; document.getElementById('financial-fields-special').style.display=e.target.checked?'block':'none'; }
			openModal(id) { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); document.getElementById(id).style.display='flex'; document.getElementById('modal-backdrop').style.display='block'; this.openModalId=id; }
			closeModal(id) { document.getElementById(id).style.display='none'; if(this.openModalId===id)this.openModalId=null; if(!document.querySelector('.modal[style*="flex"]')) document.getElementById('modal-backdrop').style.display='none'; }
			
			// M√©todos "open" espec√≠ficos apenas preparam o form e chamam openModal
			openContractModal(id=null) { document.getElementById('formContrato').reset(); this.manualParcels=[]; document.getElementById('servicosContainer').innerHTML=''; this.populateAdvogadoSelectModal(); if(id){const c=this.database.contracts.find(x=>x.id===id); document.getElementById('contractId').value=id; document.getElementById('clienteNome').value=c.clientName; document.getElementById('advogadoResponsavel').value=c.advogadoResponsavel; (c.serviceTypes||[]).forEach(s=>this.createServiceTag(s.name,s.deadline,s.status)); if(this.isUserAdmin){document.getElementById('valorTotal').value=c.totalValue;}} this.openModal('modalContrato'); }
			openPaymentModal(id, idx) { const c=this.database.contracts.find(x=>x.id===id), p=c.parcels[idx]; document.getElementById('pagamentoContractId').value=id; document.getElementById('pagamentoParcelIndex').value=idx; document.getElementById('pagamentoInfo').textContent=`${c.clientName} - P.${p.number}`; document.getElementById('pagamentoValor').value=p.value; document.getElementById('pagamentoData').value = new Date().toISOString().split('T')[0]; this.openModal('modalPagamento'); }
			openClientHistoryModal(name) { const l=this.database.contracts.filter(c=>c.clientName===name); document.getElementById('clienteModalContent').innerHTML = l.map(c => `<div class="bg-gray-700 p-2 mb-2"><b>${c.clientName}</b> - ${Utils.formatCurrency(c.totalValue)}</div>`).join(''); this.openModal('modalCliente'); }
			openReportModal() { if(this.isUserAdmin) { const m=document.getElementById('reportMonth'); if(m.options.length===0){['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].forEach((x,i)=>m.add(new Option(x,i)));for(let i=new Date().getFullYear();i>=2020;i--)document.getElementById('reportYear').add(new Option(i,i));} this.openModal('modalRelatorio'); this.generateAndShowReport(); } }
			openExitoModal(id) { document.getElementById('exitoContractId').value=id; this.openModal('modalExito'); }
			createServiceTag(n,d,s) { this.domBuilder.createServiceTag(n,d,s); } // Chama do Builder
			
			renderNotificationDropdown() { const l=document.getElementById('notification-list'); l.innerHTML=''; this.database.notifications.forEach(n=>l.append(this.domBuilder.createNotificationItem(n))); document.getElementById('notification-badge').classList.toggle('hidden', this.database.notifications.filter(x=>!x.isRead).length===0); }
			async markNotificationsAsRead(ids) { await this.firebaseService.markNotificationsAsRead(this.currentSafeName, ids||this.database.notifications.filter(x=>!x.isRead).map(x=>x.id)); }
			closeNotificationDropdown() { document.getElementById('notification-dropdown').classList.add('hidden'); }
			showAnalyticsInModal() { document.getElementById('reportResult').classList.add('hidden'); document.getElementById('reportChartsContainer').classList.remove('hidden'); const c = this.getFilteredContracts(true); const d1 = this.reportHandler.getActualIncomeData(c); this.analyticsHandler.renderChart('actualIncomeChartModal', 'bar', d1.labels, d1.data, 'Fatura√ß√£o', '#4ade80'); const d2 = this.reportHandler.getProjectedIncomeData(c); this.analyticsHandler.renderChart('projectedIncomeChartModal', 'bar', d2.labels, d2.data, 'Proje√ß√£o', '#8b5cf6'); }
			exportReportCSV() {
				if(!this.isUserAdmin) return;
				const m = parseInt(document.getElementById('reportMonth').value); const y = parseInt(document.getElementById('reportYear').value);
				const d = this.reportHandler.calculateMonthlyIncome(y, m, this.getFilteredContracts(true));
				let rows = ["Tipo de Lista,Cliente,Descri√ß√£o,Data,Valor"];
				d.detailedPayments.forEach(p => rows.push(`"PAGO",${this._fCSV(p.clientName)},${p.type},${Utils.formatDate(p.date)},${p.value}`));
				d.pendingPayments.forEach(p => rows.push(`"PENDENTE",${this._fCSV(p.clientName)},${p.type},${Utils.formatDate(p.date)},${p.value}`));
				this._dlCSV(rows.join('\n'), `relatorio_${m+1}_${y}.csv`);
			}
			exportContractsCSV() {
				const r = ["ID,Cliente,Advogado,Valor Total,Status"];
				this.getFilteredContracts(false).forEach(c => r.push([c.id, this._fCSV(c.clientName), this._fCSV(c.advogadoResponsavel), c.totalValue, this.getContractStatus(c).statusText].join(',')));
				this._dlCSV(r.join('\n'), 'contratos.csv');
			}
			_fCSV(s) { if (s == null) return ''; let str = String(s); if (str.includes(',')) str = `"${str}"`; return str; }
			_dlCSV(c, n) { const b = new Blob(["\uFEFF" + c], { type: 'text/csv;charset=utf-8;' }); const l = document.createElement("a"); l.href = URL.createObjectURL(b); l.download = n; document.body.appendChild(l); l.click(); document.body.removeChild(l); }
			_setupModalAccessibility() { document.addEventListener('keydown', e=>{if(e.key==='Escape')this.closeModal(this.openModalId)}); }
		}

		document.addEventListener('DOMContentLoaded', () => {
			const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
			s.onload = () => { window.App = new App(); window.App.initialize(); };
			document.head.appendChild(s);
		});
	</script>
</body>
</html>
