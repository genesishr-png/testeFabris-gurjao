<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sistema de Gest√£o Financeira - Advocacia</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
	<style>
		/* [SE√á√ÉO 1: Estilos Gerais] */
		body {
			font-family: 'Inter', sans-serif;
			position: relative;
			background-color: #0f172a;
			color: #d1d5db;
			overflow-y: hidden; 
		}
		body::after {
			content: '';
			position: fixed;
			z-index: -2;
			top: 0; left: 0; right: 0; bottom: 0;
			background-image: url('https://i.postimg.cc/x81V8QJg/Imagem-do-Whats-App-de-2025-10-27-a-s-09-49-28-f966cd35.jpg');
			background-repeat: no-repeat;
			background-size: cover;
			background-position: center center;
			opacity: 0.12;
		}
		.modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 9000; }
		
		.modal { 
			display: none; 
			position: fixed; 
			top: 50%; left: 50%; 
			transform: translate(-50%, -50%); 
			z-index: 9001; 
			max-height: 90vh; 
			border: 1px solid #374151;
			box-shadow: 0 10px 30px 0 rgba(0, 0, 0, 0.4);
		}
		.modal-body {
			overflow-y: auto;
			max-height: 70vh;
		}

		.kanban-column { min-width: 320px; }
		.kanban-content { max-height: 60vh; overflow-y: auto; padding-right: 8px; }
		::-webkit-scrollbar { width: 8px; }
		::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
		::-webkit-scrollbar-thumb:hover { background: #6b7280; }
		.service-tag { display: inline-flex; justify-content: space-between; align-items: center; background-color: #374151; color: #d1d5db; padding: 4px 10px; border-radius: 12px; font-size: 14px; margin-right: 4px; margin-bottom: 4px; width: 100%; }
		.service-tag-small { display: inline-block; background-color: #374151; color: #9ca3af; padding: 2px 8px; border-radius: 9999px; font-size: 12px; margin-right: 4px; margin-bottom: 4px; }
		.service-tag .remove-tag { margin-left: 8px; cursor: pointer; font-weight: bold; }
		
		/* Sidebar Styles */
		.sidebar-nav-item {
			display: flex;
			align-items: center;
			gap: 0.75rem;
			padding: 0.75rem 1rem;
			border-radius: 0.5rem;
			color: #d1d5db;
			transition: all 0.2s ease-in-out;
			cursor: pointer;
		}
		.sidebar-nav-item:hover {
			background-color: #4338ca;
			color: #ffffff;
		}
		.sidebar-nav-item.active {
			background-color: #4f46e5;
			color: #ffffff;
			box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.5);
		}
		
		/* Mobile Nav Styles */
		.mobile-nav-item {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			flex: 1;
			padding: 0.75rem 0.5rem;
			color: #9ca3af;
			transition: all 0.2s ease-in-out;
		}
		.mobile-nav-item:hover {
			color: #6366f1;
		}
		.mobile-nav-item.active {
			color: #6366f1;
			background-color: rgba(79, 70, 229, 0.1);
		}
		.progress-bar-bg { background-color: #374151; border-radius: 9999px; overflow: hidden; }
		.progress-bar { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
		
		.dark-card { 
			background-color: #1f2937;
		}
		
		.sort-button, .filter-button { background-color: #374151; border: 1px solid #4b5563; color: #9ca3af; padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
		.sort-button:hover, .filter-button:hover { background-color: #4b5563; color: white; }
		.sort-button.active, .filter-button.active { background-color: #4f46e5; border-color: #4f46e5; color: white; }
		
		.filter-select { 
			background-color: #1f2937;
			border: 1px solid #4b5563; 
			color: #9ca3af; 
			padding: 8px 12px; 
			border-radius: 6px; 
			font-size: 14px;
			transition: all 0.2s ease-in-out;
			color-scheme: dark;
		}
		.filter-select:focus {
			border-color: #6366f1;
			box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
			outline: none;
		}
		.filter-select:disabled { background-color: #4b5563; opacity: 0.7; cursor: not-allowed; }
		
		#loading-overlay { 
			position: fixed; 
			top: 0; left: 0; 
			width: 100%; height: 100%; 
			background-color: rgba(17, 24, 39, 0.9); 
			display: flex; 
			justify-content: center; 
			align-items: center; 
			z-index: 10000; 
			color: white; 
			font-size: 1.2rem; 
			transition: opacity 0.3s; 
		}
		#app-container { display: none; }
		
		.admin-only { display: none; }

		body.is-admin .admin-only:not(.hidden) { display: block; }
		body.is-admin .flex.admin-only:not(.hidden) { display: flex; }
		body.is-admin .grid.admin-only:not(.hidden) { display: grid; }
		body.is-admin .admin-only.mobile-nav-item { display: flex; }
		
		body:not(.is-admin) .non-admin-hidden { display: none; }
		
		@keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -60%); } to { opacity: 1; transform: translate(-50%, -50%); } }
		.notification { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 11000; animation: slideIn 0.3s ease; }
		@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
		
		@media (max-width: 768px) {
			.kanban-column { min-width: 100%; }
		}

		/* Pagination */
		.pagination-button {
			background-color: #374151;
			border: 1px solid #4b5563;
			color: #9ca3af;
			padding: 6px 12px;
			border-radius: 6px;
			font-size: 14px;
			cursor: pointer;
			transition: all 0.2s;
			font-weight: 500;
		}
		.pagination-button:hover:not(:disabled) {
			background-color: #4b5563;
			color: white;
		}
		.pagination-button.active {
			background-color: #4f46e5;
			border-color: #4f46e5;
			color: white;
			cursor: default;
		}
		.pagination-button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		#paginationContainer span {
			padding: 6px 4px;
			font-size: 14px;
			color: #6b7280;
		}
		
		.modal button {
			transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
		}
		.modal button:hover:not(:disabled) {
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.2);
		}
		
		/* Login Animation */
		@keyframes blob {
			0%, 100% { transform: translate(0, 0) scale(1); }
			33% { transform: translate(30px, -50px) scale(1.1); }
			66% { transform: translate(-20px, 20px) scale(0.9); }
		}
		.animate-blob { animation: blob 7s infinite; }

		/* Notifications */
		#notification-list .notification-item {
			background-color: #374151;
			padding: 12px;
			border-radius: 8px;
			transition: background-color 0.2s;
			border-left: 4px solid #4f46e5;
			cursor: pointer;
		}
		#notification-list .notification-item:hover { background-color: #4b5563; }
		#notification-list .notification-item.is-read {
			background-color: #1f2937;
			border-left-color: #4b5563;
			opacity: 0.8;
		}
		#notification-list .notification-item p { font-size: 14px; color: #d1d5db; }
		#notification-list .notification-item .time { font-size: 12px; color: #9ca3af; margin-top: 4px; }
		#notification-list-empty { padding: 24px; text-align: center; font-size: 14px; color: #9ca3af; }

		.chartjs-tooltip {
			opacity: 0;
			pointer-events: none;
			position: absolute;
			transition: all .1s ease;
		}

		/* Ranking Tables */
		.ranking-table { width: 100%; border-collapse: collapse; }
		.ranking-table th, .ranking-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #374151; }
		.ranking-table th { background-color: #374151; color: #d1d5db; font-size: 14px; font-weight: 600; }
		.ranking-table td { font-size: 14px; color: #9ca3af; }
		.ranking-table tr:hover td { background-color: #1f2937; }
		.ranking-table .rank-1 { font-weight: 700; font-size: 16px; color: #34d399; }
		.ranking-table .rank-2 { font-weight: 600; font-size: 15px; color: #60a5fa; }
		.ranking-table .rank-3 { font-weight: 500; color: #f59e0b; }

		/* Parcel Cards */
		.parcel-card-vencida { border-left-color: #ef4444; }
		.parcel-card-vencida .parcel-value { color: #f87171; }
		.parcel-card-avencer { border-left-color: #f59e0b; }
		.parcel-card-avencer .parcel-value { color: #fbbf24; }

		/* Oficina Settings */
		.setting-list-item { display: flex; justify-content: space-between; align-items: center; background-color: #374151; padding: 8px 12px; border-radius: 6px; font-size: 14px; color: #d1d5db; }
		.setting-list-item:nth-child(even) { background-color: #3e4c5f; }
		.setting-list-remove-btn { background-color: #ef4444; color: white; border: none; border-radius: 9999px; width: 24px; height: 24px; font-weight: bold; font-size: 12px; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
		.setting-list-remove-btn:hover { background-color: #dc2626; }
		.form-input { width: 100%; background-color: #1f2937; border: 1px solid #4b5563; color: #d1d5db; padding: 8px 12px; border-radius: 6px; font-size: 14px; transition: all 0.2s ease-in-out; }
		.form-input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); outline: none; }
		.form-button { background-color: #4f46e5; color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
		.form-button:hover { background-color: #4338ca; }
		
		/* Contrato Especial Manual */
		.parcel-list-item { display: flex; justify-content: space-between; align-items: center; background-color: #374151; padding: 6px 10px; border-radius: 6px; font-size: 14px; color: #d1d5db; }
		.parcel-list-item span { font-weight: 500; }
		.parcel-list-remove-btn { background-color: #ef4444; color: white; border: none; border-radius: 9999px; width: 20px; height: 20px; font-weight: bold; font-size: 10px; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
		.parcel-list-remove-btn:hover { background-color: #dc2626; }

	</style>
</head>
<body class="text-gray-300">
	<div id="notifications"></div>

	<div id="loading-overlay">
		<i class="fas fa-spinner fa-spin mr-3"></i> A ligar...
	</div>

	<div id="auth-overlay" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 relative overflow-hidden px-4">
		<div class="absolute inset-0 opacity-5">
			<div class="absolute inset-0 bg-[url('https://i.postimg.cc/x81V8QJg/Imagem-do-Whats-App-de-2025-10-27-a-s-09-49-28-f966cd35.jpg')] bg-cover bg-center"></div>
		</div>
		<div class="absolute top-0 left-1/2 -translate-x-1/2 w-96 h-96 bg-blue-500 rounded-full mix-blend-screen filter blur-3xl opacity-10 animate-blob"></div>
		<div class="absolute bottom-0 right-1/4 w-96 h-96 bg-indigo-500 rounded-full mix-blend-screen filter blur-3xl opacity-10 animate-blob" style="animation-delay: 2s;"></div>
		<div class="relative z-10 w-full max-w-md">
			<div class="mb-8 text-center">
				<img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Log√≥tipo Fabris e Gurj√£o" class="h-24 mx-auto mb-6 drop-shadow-lg" />
				<h1 class="text-3xl font-bold text-white mb-2">
					Sistema Financeiro
				</h1>
				<p class="text-gray-300 text-sm">
					Gest√£o profissional para advocacia
				</p>
			</div>
			<div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-8 shadow-2xl">
				<form id="login-form" class="space-y-5">
					<div>
						<label for="login-email" class="block text-sm font-medium text-gray-100 mb-2">
							Email
						</label>
						<div class="relative">
							<i class="fas fa-envelope absolute left-3 top-3.5 text-gray-400"></i>
							<input type="email"
								   id="login-email"
								   placeholder="seu@email.com"
								   class="w-full pl-10 pr-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
								   required />
						</div>
					</div>
					<div>
						<label for="login-password" class="block text-sm font-medium text-gray-100 mb-2">
							Senha
						</label>
						<div class="relative">
							<i class="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
							<input type="password"
								   id="login-password"
								   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
								   class="w-full pl-10 pr-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
								   required />
						</div>
					</div>
					<div id="auth-error" class="hidden p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200 text-sm">
						</div>
					<button type="submit"
							id="login-submit-button"
							class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold rounded-lg transition duration-200 flex items-center justify-center gap-2 mt-6">
						<i id="login-button-icon" class="fas fa-sign-in-alt"></i>
						<span id="login-button-text">Entrar no Sistema</span>
					</button>
				</form>
				<div class="mt-6 text-center text-gray-400 text-xs">
					<p>Acesso restrito a utilizadores autorizados</p>
				</div>
			</div>
		</div>
	</div>
	
	<div id="app-container" class="flex h-screen">
		
		<aside id="sidebar" class="hidden md:flex md:flex-col md:w-64 bg-gray-900/50 backdrop-blur-lg border-r border-gray-700/50 p-4 transition-all duration-300 z-20">
			<div class="flex-shrink-0 mb-8">
				<img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Log√≥tipo Fabris e Gurj√£o" class="h-20 mx-auto opacity-90" />
			</div>
			
			<nav class="flex-1 space-y-3">
				<a onclick="window.App.showPage('page-dashboard')" id="tab-dashboard" class="sidebar-nav-item active">
					<i class="fas fa-tachometer-alt w-5 text-center"></i>
					<span>Painel Principal</span>
				</a>

				<a onclick="window.App.showPage('page-parcelas')" id="tab-parcelas" class="sidebar-nav-item">
					<i class="fas fa-file-invoice-dollar w-5 text-center"></i>
					<span>Parcelas</span>
				</a>
				
				<a onclick="window.App.showPage('page-servicos')" id="tab-servicos" class="sidebar-nav-item">
					<i class="fas fa-tasks w-5 text-center"></i>
					<span>Servi√ßos</span>
				</a>
				
				<a onclick="window.App.showPage('page-performance')" id="tab-performance" class="sidebar-nav-item admin-only">
					<i class="fas fa-rocket w-5 text-center"></i>
					<span>Performance</span>
				</a>
				
				<a onclick="window.App.showPage('page-relatorios')" id="tab-relatorios" class="sidebar-nav-item admin-only">
					<i class="fas fa-chart-pie w-5 text-center"></i>
					<span>Relat√≥rios</span>
				</a>
				<a onclick="window.App.showPage('page-lixeira')" id="tab-lixeira" class="sidebar-nav-item">
					<i class="fas fa-trash-alt w-5 text-center"></i>
					<span>Lixeira</span>
				</a>

				<div class="border-t border-gray-700 pt-3 mt-3 admin-only">
					<a onclick="window.App.showPage('page-oficina')" id="tab-oficina" class="sidebar-nav-item admin-only">
						<i class="fas fa-cogs w-5 text-center"></i>
						<span>Oficina</span>
					</a>
				</div>

			</nav>

			<div class="mt-auto flex-shrink-0 border-t border-gray-700 pt-4">
				<div class="flex items-center gap-3 p-2 rounded-lg">
					<div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center font-bold text-white">
						<i class="fas fa-user"></i>
					</div>
					<div>
						<span id="user-display-name" class="text-sm text-gray-200 font-medium block"></span>
						<button id="logout-button" class="text-xs text-red-400 hover:text-red-300 transition-colors">Sair</button>
					</div>
				</div>
			</div>
		</aside>
		<main id="main-content" class="flex-1 flex flex-col h-screen overflow-y-auto pb-24 md:pb-0">
			
			<header class="sticky top-0 bg-gray-900/30 backdrop-blur-md border-b border-gray-700/50 p-4 z-10 md:p-6">
				<div class="flex justify-between items-center">
					<h1 id="page-title" class="text-2xl md:text-3xl font-bold text-white">Painel Principal</h1>
					
					<div class="flex items-center gap-4">
						<div class="relative">
							<button id="notification-bell" class="p-2 text-gray-300 hover:text-white transition-colors">
								<i class="fas fa-bell text-xl"></i>
								<span id="notification-badge" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-gray-900"></span>
							</button>
							<div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 md:w-96 bg-gray-800 border border-gray-700 rounded-lg shadow-xl overflow-hidden z-50">
								<div class="flex justify-between items-center p-3 bg-gray-900/50 border-b border-gray-700">
									<h3 class="font-semibold text-white">Notifica√ß√µes</h3>
									<button id="clear-notifications-button" class="text-xs text-indigo-400 hover:text-indigo-300">Marcar todas como lidas</button>
								</div>
								<div id="notification-list" class="max-h-80 overflow-y-auto space-y-2 p-2">
									<div id="notification-list-empty" class="hidden">
										<i class="fas fa-check-circle text-gray-500 text-3xl mb-2"></i>
										<p>Nenhuma notifica√ß√£o nova.</p>
									</div>
								</div>
							</div>
						</div>
						
						<button id="mobile-menu-toggle" class="md:hidden p-2 text-gray-300 hover:text-white">
							<i class="fas fa-bars text-xl"></i>
						</button>
					</div>
				</div>
			</header>
			<div class="p-4 md:p-8 flex-1">
				
				<div id="page-dashboard">
					<div class="flex flex-wrap gap-4 mb-8">
						<button onclick="window.App.openContractModal()" class="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-bold py-2 px-5 rounded-lg shadow-lg transition-all duration-200 transform hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2">
							<i class="fas fa-plus-circle"></i> Novo Contrato
						</button>
						<button onclick="window.App.openReportModal()" class="admin-only bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white font-bold py-2 px-5 rounded-lg shadow-lg transition-all duration-200 transform hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2">
							<i class="fas fa-chart-line"></i> Relat√≥rio Mensal
						</button>
					</div>

					<div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
						<div class="dark-card p-6 rounded-lg shadow-lg transition-all duration-200 hover:-translate-y-1 hover:shadow-xl">
							<h3 class="text-lg font-semibold text-gray-400">A Receber (Pr√≥x. 30 dias)</h3>
							<p id="dash-a-receber" class="text-3xl font-bold text-green-400"></p>
						</div>
						<div class="dark-card p-6 rounded-lg shadow-lg transition-all duration-200 hover:-translate-y-1 hover:shadow-xl">
							<h3 class="text-lg font-semibold text-gray-400">Vencido (Corrigido)</h3>
							<p id="dash-vencido" class="text-3xl font-bold text-red-400"></p>
						</div>
						<div class="dark-card p-6 rounded-lg shadow-lg transition-all duration-200 hover:-translate-y-1 hover:shadow-xl">
							<h3 class="text-lg font-semibold text-gray-400">Recebido (Este M√™s)</h3>
							<p id="dash-recebido" class="text-3xl font-bold text-indigo-400"></p>
						</div>
						<div class="dark-card p-6 rounded-lg shadow-lg transition-all duration-200 hover:-translate-y-1 hover:shadow-xl">
							<h3 class="text-lg font-semibold text-gray-400">Meus Contratos Ativos</h3>
							<p id="dash-contratos" class="text-3xl font-bold text-white"></p>
						</div>
					</div>
					<div class="mb-4 border-b border-gray-700">
						<h2 class="text-2xl font-semibold mb-4 text-white">Situa√ß√£o das Parcelas (Meus Contratos)</h2>
					</div>

					<div id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 gap-6 pb-4">
						<div class="kanban-column dark-card shadow-lg rounded-lg p-4 flex-1">
							<h3 class="font-bold text-lg mb-4 text-red-400 flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i>Vencidas</h3>
							<div id="kanban-vencidas" class="kanban-content space-y-3"></div>
						</div>
						<div class="kanban-column dark-card shadow-lg rounded-lg p-4 flex-1">
							<h3 class="font-bold text-lg mb-4 text-yellow-400 flex items-center gap-2"><i class="far fa-clock"></i>A Vencer (Pr√≥x. 30 dias)</h3>
							<div id="kanban-a-vencer" class="kanban-content space-y-3"></div>
						</div>
						<div class="kanban-column dark-card shadow-lg rounded-lg p-4 flex-1">
							<h3 class="font-bold text-lg mb-4 text-gray-400 flex items-center gap-2"><i class="fas fa-check-circle"></i>Pagas (Este M√™s)</h3>
							<div id="kanban-pagas" class="kanban-content space-y-3"></div>
						</div>
					</div>

					<div id="exito-section" class="mt-12">
						<div class="mb-4 border-b border-gray-700">
							<h2 class="text-2xl font-semibold mb-4 text-white">Bonifica√ß√µes de √äxito Pendentes</h2>
						</div>
						<div id="kanban-exito-wrapper" class="flex overflow-x-auto space-x-6 pb-4 items-start">
							</div>
					</div>

					<div class="mt-12">
						<div class="flex flex-wrap justify-between items-center mb-4 border-b border-gray-700 pb-4 gap-4">
							<h2 class="text-2xl font-semibold text-white">Meus Contratos</h2>
							<div class="flex flex-wrap items-center gap-4">
								<button onclick="window.App.exportContractsCSV()" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-2 px-3 rounded-lg shadow-lg transition-all duration-200 transform hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2 text-sm">
									<i class="fas fa-file-csv"></i> Exportar (CSV)
								</button>
								
								<div class="flex bg-gray-800 rounded-lg p-1 border border-gray-700 items-center">
									<button id="btn-era-novos" onclick="window.App.setContractEra('novos')" class="px-3 py-1 rounded-md text-sm font-medium transition-all bg-indigo-600 text-white shadow-sm flex items-center gap-1">
										<i class="fas fa-star text-xs"></i> Novos
									</button>
									<button id="btn-era-legados" onclick="window.App.setContractEra('legados')" class="px-3 py-1 rounded-md text-sm font-medium text-gray-400 hover:text-white transition-all flex items-center gap-1">
										<i class="fas fa-history text-xs"></i> Legados
									</button>
								</div>

								<select id="advogadoFilter" onchange="window.App.resetAndRenderContractList()" class="filter-select admin-only focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/50"></select>
								
								<div class="flex items-center gap-2">
									<span class="text-sm text-gray-400">Mostrar:</span>
									<div id="contractStatusFilterButtons" class="flex gap-1">
										</div>
								</div>

								<div class="flex items-center gap-2">
									<span class="text-sm text-gray-400">Ordenar por:</span>
									<div id="contractSortButtons" class="flex gap-1"></div>
								</div>
							</div>
						</div>
						<div class="mb-4">
							<input type="text" id="searchInput" placeholder="üîé Pesquisar por cliente ou tipo de servi√ßo..." class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 text-white transition-all duration-200">
						</div>
						<div id="contractListContainer"></div>
						
						<div id="paginationContainer" class="flex justify-center items-center gap-2 mt-8">
						</div>
					</div>
				</div>
				<div id="page-parcelas" class="hidden">
					<div class="flex flex-wrap justify-between items-center mb-4 gap-4">
						<h2 class="text-2xl font-semibold text-white">Controle de Parcelas Pendentes (Meus Contratos)</h2>
						<div class="flex flex-wrap items-center gap-4">
							<input type="text" id="parcelasSearchInput" placeholder="üîé Pesquisar por cliente..." class="w-full md:w-auto p-2 bg-gray-900 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 text-white transition-all duration-200">
							<div class="flex items-center gap-2">
								<span class="text-sm text-gray-400">Ordenar por:</span>
								<div id="parcelasSortButtons" class="flex gap-1"></div>
							</div>
						</div>
					</div>
					<div id="parcelasListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
				</div>

				<div id="page-servicos" class="hidden">
					<div class="flex flex-wrap justify-between items-center mb-4 gap-4">
						<h2 class="text-2xl font-semibold text-white">Controlo de Produ√ß√£o de Servi√ßos (Meus Contratos)</h2>
						<div class="flex flex-wrap items-center gap-4">
							<select id="servicosAdvogadoFilter" onchange="window.App.renderServicosPage()" class="filter-select admin-only focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/50"></select>
							<div class="flex items-center gap-2">
								<span class="text-sm text-gray-400">Ordenar por:</span>
								<div id="servicosSortButtons" class="flex gap-1"></div>
							</div>
							<input type="text" id="servicosSearchInput" placeholder="üîé Pesquisar..." class="w-full md:w-auto p-2 bg-gray-900 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 text-white transition-all duration-200">
						</div>
					</div>
					<div id="servicosListContainer" class="space-y-8"></div>
				</div>

				<div id="page-performance" class="hidden admin-only">
					<div class="flex flex-wrap justify-between items-center mb-6 gap-4 border-b border-gray-700 pb-4">
						<h2 class="text-2xl font-semibold text-white">Performance Gerencial</h2>
						<p class="text-gray-400 -mt-4">Vis√£o geral do desempenho da equipa (dados de todos os contratos n√£o-deletados).</p>
					</div>

					<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
						<div class="space-y-8">
							<div class="dark-card shadow-lg p-6 rounded-lg">
								<h3 class="text-lg font-semibold text-gray-300 mb-4">Contratos Ativos por Advogado</h3>
								<div class="relative" style="height: 350px; max-width: 500px; margin: auto;">
									<canvas id="adminChartContratos"></canvas>
								</div>
							</div>
							<div class="dark-card shadow-lg p-6 rounded-lg">
								<h3 class="text-lg font-semibold text-gray-300 mb-4">Fatura√ß√£o (Recebida) por Advogado (Ano)</h3>
								<div class="relative" style="height: 350px;">
									<canvas id="adminChartFaturamento"></canvas>
								</div>
							</div>
						</div>
						<div class="space-y-8">
							<div class="dark-card shadow-lg p-6 rounded-lg">
								<h3 class="text-lg font-semibold text-gray-300 mb-4">Ranking de Fatura√ß√£o (Ano Atual)</h3>
								<table class="ranking-table" id="adminTableFaturamento">
									<thead>
										<tr>
											<th>Rank</th>
											<th>Advogado(a)</th>
											<th>Valor Recebido</th>
										</tr>
									</thead>
									<tbody>
										</tbody>
								</table>
							</div>
							<div class="dark-card shadow-lg p-6 rounded-lg">
								<h3 class="text-lg font-semibold text-gray-300 mb-4">Ranking de Contratos (Ativos)</h3>
								<table class="ranking-table" id="adminTableContratos">
									<thead>
										<tr>
											<th>Rank</th>
											<th>Advogado(a)</th>
											<th>N¬∫ de Contratos</th>
										</tr>
									</thead>
									<tbody>
										</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>

				<div id="page-relatorios" class="hidden admin-only">
					<div class="flex flex-wrap justify-between items-center mb-6 gap-4 border-b border-gray-700 pb-4">
						<h2 class="text-2xl font-semibold text-white">Relat√≥rios Avan√ßados</h2>
						<div class="flex flex-wrap items-center gap-4">
							<div>
								<label for="reportStartDate" class="text-sm text-gray-400">De:</label>
								<input type="date" id="reportStartDate" class="filter-select ml-2">
							</div>
							<div>
								<label for="reportEndDate" class="text-sm text-gray-400">At√©:</label>
								<input type="date" id="reportEndDate" class="filter-select ml-2">
							</div>
							
							<button onclick="window.App.generateAdvancedReport()" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-200 transform hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2">
								<i class="fas fa-sync-alt"></i> Gerar Relat√≥rio
							</button>
							<button id="exportPdfButton" onclick="window.App.exportReportPDF()" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-200 transform hover:shadow-xl hover:-translate-y-0.5 flex items-center gap-2" disabled>
								<i class="fas fa-file-pdf"></i> Exportar PDF
							</button>
						</div>
					</div>

					<div id="advancedReportContainer" class="space-y-8">
						<div id="report-kpis" class="grid grid-cols-1 md:grid-cols-4 gap-6">
							</div>
						
						<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
							<div class="dark-card shadow-lg p-6 rounded-lg">
								<h3 class="text-lg font-semibold text-gray-300 mb-4">Fatura√ß√£o Real (Linha do Tempo)</h3>
								<div class="relative" style="height: 350px;">
									<canvas id="advReportTimelineChart"></canvas>
								</div>
							</div>
							<div class="dark-card shadow-lg p-6 rounded-lg">
								<h3 class="text-lg font-semibold text-gray-300 mb-4">Novos Contratos (Mensal)</h3>
								<div class="relative" style="height: 350px;">
									<canvas id="advReportNewContractsChart"></canvas>
								</div>
							</div>
						</div>
						<div class="grid grid-cols-1 gap-8">
							<div class="dark-card shadow-lg p-6 rounded-lg">
								<h3 class="text-lg font-semibold text-gray-300 mb-4">Fatura√ß√£o por Advogado</h3>
								<div class="relative" style="height: 400px; max-width: 600px; margin: auto;">
									<canvas id="advReportByAdvogadoChart"></canvas>
								</div>
							</div>
						</div>
					</div>
					<div id="advancedReportEmpty" class="hidden text-center py-10">
						<div class="inline-block dark-card shadow-lg text-gray-400 p-6 rounded-lg">
							<i class="fas fa-chart-pie fa-3x mb-3"></i>
							<p class="font-bold text-xl">Nenhum dado encontrado.</p>
							<p class="text-sm">Ajuste as datas ou aguarde novos registos.</p>
						</div>
					</div>
				</div>

				<div id="page-lixeira" class="hidden">
					<div class="flex justify-between items-center mb-4">
						<h2 class="text-2xl font-semibold text-white">Lixeira de Contratos</h2>
					</div>
					<p class="text-gray-400 mb-6">Contratos exclu√≠dos s√£o mantidos aqui. Pode restaur√°-los ou exclu√≠-los permanentemente (apenas admins).</p>
					<div id="lixeiraListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
				</div>

				<div id="page-oficina" class="hidden admin-only">
					<div class="flex flex-wrap justify-between items-center mb-6 gap-4 border-b border-gray-700 pb-4">
						<h2 class="text-2xl font-semibold text-white">Oficina de Configura√ß√µes</h2>
						<p class="text-gray-400 -mt-4">√Årea para gerir as configura√ß√µes centrais do sistema.</p>
					</div>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
						<div class="dark-card shadow-lg p-6 rounded-lg">
							<h3 class="text-lg font-semibold text-gray-300 mb-4 flex items-center gap-2">
								<i class="fas fa-users-cog text-indigo-400"></i>
								Gerenciador de Advogados
							</h3>
							<p class="text-sm text-gray-400 mb-4">
								Os nomes adicionados aqui aparecer√£o automaticamente nos formul√°rios e filtros de "Advogado Respons√°vel" em todo o sistema.
							</p>
							
							<form id="formAddAdvogado" class="flex gap-2 mb-4">
								<input type="text" id="inputAdvogadoName" placeholder="Nome do(a) novo(a) Advogado(a)" class="form-input flex-1" required>
								<button type="submit" class="form-button flex-shrink-0">
									<i class="fas fa-plus"></i> Adicionar
								</button>
							</form>

							<div class="space-y-2 max-h-80 overflow-y-auto" id="advogadoSettingsList">
								</div>
						</div>
					</div>
				</div>

			</div> 
		</main>
		<nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-900/80 backdrop-blur-lg border-t border-gray-700/50 flex justify-around z-30">
			<a onclick="window.App.showPage('page-dashboard')" id="mobile-tab-dashboard" class="mobile-nav-item active">
				<i class="fas fa-tachometer-alt text-xl"></i>
				<span class="text-xs mt-1">Painel</span>
			</a>
			
			<a onclick="window.App.showPage('page-parcelas')" id="mobile-tab-parcelas" class="mobile-nav-item">
				<i class="fas fa-file-invoice-dollar text-xl"></i>
				<span class="text-xs mt-1">Parcelas</span>
			</a>

			<a onclick="window.App.showPage('page-servicos')" id="mobile-tab-servicos" class="mobile-nav-item">
				<i class="fas fa-tasks text-xl"></i>
				<span class="text-xs mt-1">Servi√ßos</span>
			</a>
			
			<a onclick="window.App.showPage('page-performance')" id="mobile-tab-performance" class="mobile-nav-item admin-only">
				<i class="fas fa-rocket text-xl"></i>
				<span class="text-xs mt-1">Perf.</span>
			</a>
			
			<a onclick="window.App.showPage('page-relatorios')" id="mobile-tab-relatorios" class="mobile-nav-item admin-only">
				<i class="fas fa-chart-pie text-xl"></i>
				<span class="text-xs mt-1">Relat.</span>
			</a>
			<a onclick="window.App.showPage('page-lixeira')" id="mobile-tab-lixeira" class="mobile-nav-item">
				<i class="fas fa-trash-alt text-xl"></i>
				<span class="text-xs mt-1">Lixeira</span>
			</a>
			
			<a onclick="window.App.showPage('page-oficina')" id="mobile-tab-oficina" class="mobile-nav-item admin-only">
				<i class="fas fa-cogs text-xl"></i>
				<span class="text-xs mt-1">Oficina</span>
			</a>
		</nav>
		</div> 
	<div id="modalDisplayName" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modalDisplayNameTitle">
		<div class="p-5 bg-gray-900/50 border-b border-gray-700">
			<h2 id="modalDisplayNameTitle" class="text-2xl font-bold text-white">Bem-vindo(a)!</h2>
		</div>
		
		<div class="p-6 modal-body">
			<p class="text-gray-400 mb-4">Percebemos que √© o seu primeiro acesso. Como gostaria de ser chamado(a)?</p>
			<form id="formDisplayName">
				<div class="mb-4">
					<label for="inputDisplayName" class="block text-sm font-medium text-gray-400 mb-2">O seu Nome de Exibi√ß√£o</label>
					<input type="text" id="inputDisplayName" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 text-white transition-all duration-200" required>
				</div>
				<button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5">Guardar e Entrar</button>
			</form>
		</div>
	</div>
	<div id="modalContrato" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-2/5 overflow-hidden flex flex-col" role="dialog" aria-modal="true" aria-labelledby="modalContratoTitle">
		<div class="flex-shrink-0 flex justify-between items-center p-5 bg-gray-900/50 border-b border-gray-700">
			<h2 id="modalContratoTitle" class="text-2xl font-bold text-white">Registar Novo Contrato</h2>
			<button onclick="window.App.closeModal('modalContrato')" class="text-gray-400 hover:text-white text-2xl transition-colors duration-150" aria-label="Fechar modal">&times;</button>
		</div>
		
		<form id="formContrato" class="flex flex-col flex-1 overflow-hidden">
			<div class="p-6 space-y-4 overflow-y-auto modal-body">
				<input type="hidden" id="contractId">
				<input type="hidden" id="financialDataChanged" value="false">
				
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div>
						<label for="clienteNome" class="block text-sm font-medium text-gray-400 mb-1">Nome do Cliente</label>
						<input type="text" id="clienteNome" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 text-white transition-all duration-200" required>
					</div>
					<div>
						<label for="advogadoResponsavel" class="block text-sm font-medium text-gray-400 mb-1">Advogado Respons√°vel</label>
						<select id="advogadoResponsavel" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 text-white transition-all duration-200" required></select>
					</div>
				</div>
				<div>
					<label class="block text-sm font-medium text-gray-400 mb-1">Adicionar Servi√ßos</label>
					<div id="servicosContainerWrapper" class="mt-1 p-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm">
						<div id="servicosContainer" class="flex flex-wrap items-center gap-1 w-full mb-2">
							</div>
						<div class="flex gap-2">
							<input type="text" id="contratoServicoInput" class="flex-grow outline-none bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="Nome do Servi√ßo...">
							<input type="date" id="contratoPrazoInput" class="bg-gray-700 border border-gray-600 rounded-md shadow-sm text-gray-400 px-3 py-2" style="color-scheme: dark;">
							<button type="button" id="addServiceButton" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-3 rounded-lg">Adicionar</button>
						</div>
					</div>
				</div>
				<div>
					<label for="contratoTipoPagamento" class="block text-sm font-medium text-gray-400 mb-1">Modalidade de Pagamento</label>
					<select id="contratoTipoPagamento" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 text-white transition-all duration-200">
						<option>Parcelado</option>
						<option>Pr√≥-labore</option>
						<option>Entrada √∫nica</option>
					</select>
				</div>
				<div>
					<label for="contratoObservacoes" class="block text-sm font-medium text-gray-400 mb-1">Observa√ß√µes</label>
					<textarea id="contratoObservacoes" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 text-white transition-all duration-200" placeholder="Detalhes da negocia√ß√£o, informa√ß√µes do caso, etc..."></textarea>
				</div>
				
				<div class="admin-only space-y-4">
					<div id="financial-warning" class="hidden p-3 bg-yellow-900/30 border border-yellow-700 rounded-lg text-yellow-300 text-sm">
						<i class="fas fa-exclamation-triangle mr-2"></i> Os campos financeiros est√£o bloqueados pois este contrato j√° possui parcelas pagas. Para alter√°-los, √© necess√°rio um novo contrato.
					</div>
					
					<h3 class="text-lg font-semibold mb-2 border-t border-gray-700 pt-4 text-white">Detalhes Financeiros</h3>
					
					<div class="p-3 bg-gray-900/50 rounded-lg border border-gray-700">
						<label for="contratoEspecial" class="flex items-center">
							<input type="checkbox" id="contratoEspecial" class="h-4 w-4 bg-gray-700 border-gray-600 rounded text-indigo-600 focus:ring-indigo-500">
							<span class="ml-2 text-sm font-medium text-gray-300">Contrato Especial (Inserir parcelas manualmente)</span>
						</label>
						<p class="text-xs text-gray-500 ml-6 mt-1">Use para parcelas com valores e vencimentos diferentes.</p>
					</div>

					<div id="financial-fields-standard" class="space-y-4">
						<div class="p-3 bg-gray-900/50 rounded-lg border border-gray-700">
							<label for="contratoJaQuitado" class="flex items-center">
								<input type="checkbox" id="contratoJaQuitado" class="h-4 w-4 bg-gray-700 border-gray-600 rounded text-indigo-600 focus:ring-indigo-500">
								<span class="ml-2 text-sm font-medium text-gray-300">Marcar valor fixo como j√° quitado (contrato antigo)</span>
							</label>
							<p class="text-xs text-gray-500 ml-6 mt-1">Isto criar√° 1 parcela √∫nica j√° "Paga" com o Valor Total. Deixe o N¬∞ de Parcelas como 1.</p>
						</div>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								<label for="valorTotal" class="block text-sm font-medium text-gray-400 mb-1">Valor Fixo Total (R$)</label>
								<input type="number" step="0.01" id="valorTotal" placeholder="0 se for s√≥ √™xito" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm text-white transition-all duration-200">
							</div>
							<div>
								<label for="numParcelas" class="block text-sm font-medium text-gray-400 mb-1">N¬∞ de Parcelas</label>
								<input type="number" id="numParcelas" placeholder="1 para '√Ä Vista'" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm text-white transition-all duration-200" value="1">
							</div>
						</div>
						<div>
							<label for="vencimentoPrimeiraParcela" class="block text-sm font-medium text-gray-400 mb-1">Vencimento da 1¬™ Parcela</label>
							<input type="date" id="vencimentoPrimeiraParcela" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm text-white transition-all duration-200" style="color-scheme: dark;">
						</div>
					</div>
					
					<div id="financial-fields-special" class="hidden space-y-4">
						<p class="text-sm text-gray-400">Insira as parcelas uma a uma.</p>
						<div class="flex flex-col md:flex-row gap-2">
							<div class="flex-1">
								<label for="parcelaValorManual" class="block text-xs font-medium text-gray-400 mb-1">Valor da Parcela (R$)</label>
								<input type="number" step="0.01" id="parcelaValorManual" placeholder="1500.00" class="form-input">
							</div>
							<div class="flex-1">
								<label for="parcelaVencimentoManual" class="block text-xs font-medium text-gray-400 mb-1">Vencimento</label>
								<input type="date" id="parcelaVencimentoManual" class="form-input" style="color-scheme: dark;">
							</div>
							<button type="button" id="addManualParcelButton" class="form-button self-end mt-4 md:mt-0">Adicionar</button>
						</div>
						<div id="manualParcelList" class="space-y-1 max-h-40 overflow-y-auto p-2 bg-gray-900/50 rounded-md border border-gray-700">
							</div>
					</div>

					<div>
						<label for="taxaExito" class="block text-sm font-medium text-gray-400 mb-1">Taxa de √äxito (Bonifica√ß√£o)</label>
						<input type="text" id="taxaExito" placeholder="Ex: 20%, 10000, 5 SALARIOS" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm text-white transition-all duration-200">
					</div>
				</div>
			</div>

			<div class="flex-shrink-0 flex justify-end p-4 bg-gray-900/50 border-t border-gray-700">
				<button type="button" onclick="window.App.closeModal('modalContrato')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2 transition-all duration-200">Cancelar</button>
				<button type="submit" class="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5">Guardar</button>
			</div>
		</form>
	</div>
	<div id="modalPagamento" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modalPagamentoTitle">
		<div class="flex justify-between items-center p-5 bg-gray-900/50 border-b border-gray-700">
			<h2 id="modalPagamentoTitle" class="text-2xl font-bold text-white">Registar Pagamento</h2>
			<button onclick="window.App.closeModal('modalPagamento')" class="text-gray-400 hover:text-white text-2xl transition-colors duration-150" aria-label="Fechar modal">&times;</button>
		</div>
		
		<form id="formPagamento">
			<div class="p-6 space-y-4 modal-body">
				<div id="pagamentoInfo" class="mb-4 bg-gray-700 p-3 rounded-md text-white"></div>
				<div>
					<label for="pagamentoValor" class="block text-sm font-medium text-gray-400 mb-1">Valor Pago (R$)</label>
					<input type="number" step="0.01" id="pagamentoValor" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white transition-all duration-200" required>
				</div>
				<div>
					<label for="pagamentoData" class="block text-sm font-medium text-gray-400 mb-1">Data do Pagamento</label>
					<input type="date" id="pagamentoData" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white transition-all duration-200" required style="color-scheme: dark;">
				</div>
				<input type="hidden" id="pagamentoContractId">
				<input type="hidden" id="pagamentoParcelIndex">
			</div>
			
			<div class="flex justify-end p-4 bg-gray-900/50 border-t border-gray-700">
				<button type="button" onclick="window.App.closeModal('modalPagamento')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2 transition-all duration-200">Cancelar</button>
				<button type="submit" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5">Confirmar Pagamento</button>
			</div>
		</form>
	</div>

	<div id="modalCliente" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 overflow-hidden flex flex-col" role="dialog" aria-modal="true" aria-labelledby="clienteModalTitle">
		<div class="flex-shrink-0 flex justify-between items-center p-5 bg-gray-900/50 border-b border-gray-700">
			<h2 id="clienteModalTitle" class="text-2xl font-bold text-white"></h2>
			<button onclick="window.App.closeModal('modalCliente')" class="text-gray-400 hover:text-white text-2xl transition-colors duration-150" aria-label="Fechar modal">&times;</button>
		</div>
		<div id="clienteModalContent" class="p-6 space-y-6 overflow-y-auto modal-body"></div>
	</div>
	<div id="modalRelatorio" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 admin-only overflow-hidden flex flex-col" role="dialog" aria-modal="true" aria-labelledby="modalRelatorioTitle">
		<div class="flex-shrink-0 flex justify-between items-center p-5 bg-gray-900/50 border-b border-gray-700">
			<h2 id="modalRelatorioTitle" class="text-2xl font-bold text-white">Relat√≥rio Mensal</h2>
			<button onclick="window.App.closeModal('modalRelatorio')" class="text-gray-400 hover:text-white text-2xl transition-colors duration-150" aria-label="Fechar modal">&times;</button>
		</div>
		
		<div class="p-6 overflow-y-auto modal-body">
			<div class="flex gap-4 mb-4">
				<div class="flex-1">
					<label for="reportMonth" class="block text-sm font-medium text-gray-400 mb-1">M√™s</label>
					<select id="reportMonth" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 text-white transition-all duration-200"></select>
				</div>
				<div class="flex-1">
					<label for="reportYear" class="block text-sm font-medium text-gray-400 mb-1">Ano</label>
					<select id="reportYear" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 text-white transition-all duration-200"></select>
				</div>
			</div>
			<div class="flex gap-4 mb-6">
				<button onclick="window.App.generateAndShowReport()" class="flex-1 bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5">
					<i class="fas fa-file-invoice-dollar mr-2"></i> Relat√≥rio
				</button>
				<button onclick="window.App.showAnalyticsInModal()" class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5">
					<i class="fas fa-chart-bar mr-2"></i> Gr√°ficos
				</button>
				<button onclick="window.App.exportReportCSV()" class="flex-1 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5">
					<i class="fas fa-file-csv mr-2"></i> Exportar (CSV)
				</button>
			</div>

			<div id="reportResult" class="space-y-4">
				</div>

			<div id="reportChartsContainer" class="hidden space-y-8">
				<div class="dark-card shadow-lg p-6 rounded-lg">
					<h3 class="text-lg font-semibold text-gray-300 mb-4">Fatura√ß√£o Real (√öltimos 12 Meses)</h3>
					<div class="relative" style="height: 350px;">
						<canvas id="actualIncomeChartModal"></canvas>
					</div>
				</div>
				<div class="dark-card shadow-lg p-6 rounded-lg">
					<h3 class="text-lg font-semibold text-gray-300 mb-4">Proje√ß√£o de Ganhos (Pr√≥ximos 12 Meses)</h3>
					<p class="text-sm text-gray-400 mb-4 -mt-3">(Baseado em parcelas pendentes)</p>
					<div class="relative" style="height: 350px;">
						<canvas id="projectedIncomeChartModal"></canvas>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="modalExito" class="modal bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modalExitoTitle">
		<div class="flex-shrink-0 flex justify-between items-center p-5 bg-gray-900/50 border-b border-gray-700">
			<h2 id="modalExitoTitle" class="text-2xl font-bold text-white">Registar Recebimento de √äxito</h2>
			<button onclick="window.App.closeModal('modalExito')" class="text-gray-400 hover:text-white text-2xl transition-colors duration-150" aria-label="Fechar modal">&times;</button>
		</div>
		
		<form id="formExito">
			<div class="p-6 space-y-4 modal-body">
				<div id="exitoInfo" class="mb-4 bg-gray-700 p-3 rounded-md"></div>
				<div class="admin-only">
					<label for="exitoValorRecebido" class="block text-sm font-medium text-gray-400 mb-1">Valor L√≠quido Recebido (R$)</label>
					<input type="number" step="0.01" id="exitoValorRecebido" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md shadow-sm text-white transition-all duration-200" placeholder="Ex: 9500.00" required>
				</div>
				<p class="mb-4 text-gray-400 non-admin-hidden">Confirme o recebimento do valor de √™xito.</p>
				<input type="hidden" id="exitoContractId">
			</div>

			<div class="flex-shrink-0 flex justify-end p-4 bg-gray-900/50 border-t border-gray-700">
				<button type="button" onclick="window.App.closeModal('modalExito')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2 transition-all duration-200">Cancelar</button>
				<button type="submit" class="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5">Guardar Recebimento</button>
			</div>
		</form>
	</div>

	<div id="modal-backdrop" class="modal-backdrop"></div>
	<script type="module">
		// Imports do Firebase
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
		import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
		import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel, writeBatch, serverTimestamp, query, where, orderBy, limit, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
		
		// Constantes Globais
		const ADMIN_USERS = ["dra. renata fabris","Darc", "dr. felipe gurj√£o", "lilian"];
		const CONTRACTS_PER_PAGE = 12; 
		const CUTOFF_DATE = "2025-11-01"; // [NOVO] Data de corte para o filtro de Era

		// Objeto de Utilit√°rios
		const Utils = {
			toastContainer: null,
			initToast() {
				let el = document.getElementById('notifications');
				if (!el) {
					el = document.createElement('div');
					el.id = 'toast-container-fallback';
					el.style.position = 'fixed';
					el.style.bottom = '20px';
					el.style.right = '20px';
					el.style.zIndex = '11000';
					el.style.display = 'flex';
					el.style.flexDirection = 'column';
					el.style.gap = '8px';
					document.body.appendChild(el);
				}
				this.toastContainer = el;
			},
			showToast(message, type = 'info') {
				if (!this.toastContainer) {
					this.initToast();
				}
				const n = document.createElement('div');
				n.className = 'px-4 py-3 rounded-lg shadow-lg text-sm';
				n.style.background = type === 'error' ? '#7f1d1d' : (type === 'success' ? '#065f46' : '#374151');
				n.style.color = '#fff';
				n.setAttribute('role', 'alert');
				n.textContent = message;
				this.toastContainer.appendChild(n);
				setTimeout(() => n.remove(), 2500);
			},
			debounce(fn, ms = 300) {
				let t;
				return (...args) => {
					clearTimeout(t);
					t = setTimeout(() => fn(...args), ms);
				};
			},
			sanitizeText(s) {
				if (s == null) return '';
				const str = String(s);
				const div = document.createElement('div');
				div.textContent = str;
				return div.innerHTML.replace(/"/g, '&quot;').replace(/'/g, '&#39;').trim();
			},
			sanitizeForFirestoreId(name) {
				if (!name) return 'unknown_user';
				return name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
			},
			parseNumber(n) {
				const v = Number(n);
				return Number.isFinite(v) ? v : 0;
			},
			confirm(message) {
				return new Promise((resolve) => {
					let modal = document.getElementById('confirmModal');
					if (!modal) {
						modal = document.createElement('div');
						modal.id = 'confirmModal';
						modal.innerHTML = `
		<div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:12000" role="alertdialog" aria-modal="true" aria-labelledby="confirmMessage">
		<div class="dark-card" style="width:100%;max-width:420px;border-radius:12px;border:1px solid #374151;padding:16px;background:#111827">
		<p id="confirmMessage" class="text-gray-200 mb-4"></p>
		<div class="flex justify-end gap-2">
			<button id="confirmCancel" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
			<button id="confirmOk" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
		</div>
		</div>
		</div>`;
						document.body.appendChild(modal);
					}
					modal.querySelector('#confirmMessage').textContent = message;
					modal.style.display = 'block';
					const onClose = (val) => { modal.style.display = 'none'; resolve(val); };
					modal.querySelector('#confirmCancel').onclick = () => onClose(false);
					modal.querySelector('#confirmOk').onclick = () => onClose(true);
				});
			},
			formatCurrency(value) {
				return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
			},
			formatDate(dateStr) {
				if (!dateStr) return '';
				const date = new Date(dateStr);
				const d = date.getUTCDate();
				const m = date.getUTCMonth() + 1;
				const y = date.getUTCFullYear();
				return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
			},
			timeAgo(dateInput) {
				if (!dateInput) return '';
				const date = (dateInput instanceof Date) ? dateInput : new Date(dateInput);
				const now = new Date();
				const seconds = Math.floor((now.getTime() - date.getTime()) / 1000);
				
				let interval = seconds / 31536000;
				if (interval > 1) return `h√° ${Math.floor(interval)} ano(s)`;
				interval = seconds / 2592000;
				if (interval > 1) return `h√° ${Math.floor(interval)} mes(es)`;
				interval = seconds / 86400;
				if (interval > 1) return `h√° ${Math.floor(interval)} dia(s)`;
				interval = seconds / 3600;
				if (interval > 1) return `h√° ${Math.floor(interval)} hora(s)`;
				interval = seconds / 60;
				if (interval > 1) return `h√° ${Math.floor(interval)} min(s)`;
				return `h√° ${Math.floor(seconds)} seg(s)`;
			}
		};

		class CorrectionCalculator {
			constructor() {
				this.IPCA_TABLE = {
					"2023-01": 0.53, "2023-02": 0.84, "2023-03": 0.71, "2023-04": 0.61,
					"2023-05": 0.23, "2023-06": -0.08, "2023-07": 0.12, "2023-08": 0.23,
					"2023-09": 0.26, "2023-10": 0.24, "2023-11": 0.28, "2023-12": 0.56,
					"2024-01": 0.42, "2024-02": 0.83, "2024-03": 0.16, "2024-04": 0.38,
					"2024-05": 0.46, "2024-06": 0.36, "2024-07": 0.16, "2024-08": 0.24,
					"2024-09": 0.26, "2024-10": 0.42, "2024-11": 0.53, "2024-12": 0.48,
					"2025-01": 0.55, "2025-02": 0.78, "2025-03": 0.21, "2025-04": 0.35,
					"2025-05": 0.40, "2025-06": 0.26, "2025-07": 0.22, "2025-08": 0.31,
					"2025-09": 0.33, "2025-10": 0.40, 
				};
			}
		
			toUTCDate(y, m, d) { const dt = new Date(Date.UTC(y, m, d)); dt.setUTCHours(0,0,0,0); return dt; }
			
			diffMonths_30_360(fromDate, toDate) {
				let y1 = fromDate.getUTCFullYear(), m1 = fromDate.getUTCMonth() + 1, d1 = fromDate.getUTCDate();
				let y2 = toDate.getUTCFullYear(), m2 = toDate.getUTCMonth() + 1, d2 = toDate.getUTCDate();
				if (d1 === 31) d1 = 30;
				if (d2 === 31 && d1 === 30) d2 = 30;
				return Math.max(0, (y2 - y1) * 12 + (m2 - m1) + (d2 - d1) / 30);
			}
		
			getIPCAAccumulatedFactor(vencDate, refDate) {
				let factor = 1.0;
				let currentDate = new Date(Date.UTC(vencDate.getUTCFullYear(), vencDate.getUTCMonth(), 1));
				const endDate = new Date(Date.UTC(refDate.getUTCFullYear(), refDate.getUTCMonth(), 1));
		
				while (currentDate < endDate) {
					const year = currentDate.getUTCFullYear();
					const month = String(currentDate.getUTCMonth() + 1).padStart(2, '0');
					const key = `${year}-${month}`;
					
					const ipcaPercent = this.IPCA_TABLE[key];
					if (ipcaPercent !== undefined) {
						factor *= (1 + ipcaPercent / 100);
					}
					currentDate.setUTCMonth(currentDate.getUTCMonth() + 1);
				}
				return factor;
			}
			
			calcularValorCorrigido(valorOriginal, dataVencimento, dataReferencia = new Date()) {
				const ref = this.toUTCDate(dataReferencia.getUTCFullYear(), dataReferencia.getUTCMonth(), dataReferencia.getUTCDate());
				const vRaw = new Date(dataVencimento);
				const venc = this.toUTCDate(vRaw.getUTCFullYear(), vRaw.getUTCMonth(), vRaw.getUTCDate());
				
				if (ref <= venc) return valorOriginal;
		
				const ipcaFactor = this.getIPCAAccumulatedFactor(venc, ref);
				const meses = this.diffMonths_30_360(venc, ref);
				const jurosSimplesFactor = 1 + 0.01 * meses;
				
				return valorOriginal * ipcaFactor * jurosSimplesFactor;
			}
		}
		
		class AuthService {
			constructor(appInstance) {
				this.app = appInstance;
				this.auth = null;
				this.firebaseConfig = {
					apiKey: "AIzaSyA0TWb7DgZAHNl3TuoK3xQD-ANvCcQIDK4",
					authDomain: "fabrisgurjao.firebaseapp.com",
					projectId: "fabrisgurjao",
					storageBucket: "fabrisgurjao.firebasestorage.app",
					messagingSenderId: "466702265991",
					appId: "1:466702265991:web:78c4d98b47cab537921222",
					measurementId: "G-E99R5TFMQK"
				};
			}
		
			initialize() {
				try {
					const firebaseApp = initializeApp(this.firebaseConfig);
					this.auth = getAuth(firebaseApp);
					setLogLevel('error'); 
					const db = getFirestore(firebaseApp);
					this.app.firebaseService.setDB(db);
					this.setupAuthListener();
				} catch (error) {
					console.error("Erro na inicializa√ß√£o do Firebase:", error);
					document.getElementById('loading-overlay').textContent = "Erro ao conectar.";
				}
			}
		
			setupAuthListener() {
				onAuthStateChanged(this.auth, (user) => {
					this.app.handleAuthStateChange(user);
				});
			}
		
			async login(email, password) {
				const authError = document.getElementById('auth-error');
				authError.classList.add('hidden');
				
				const loginButton = document.getElementById('login-submit-button');
				const buttonText = document.getElementById('login-button-text');
				const buttonIcon = document.getElementById('login-button-icon');
				
				if (loginButton) loginButton.disabled = true;
				if (buttonText) buttonText.textContent = "A entrar...";
				if (buttonIcon) buttonIcon.className = "fas fa-spinner fa-spin";
		
				try {
					await signInWithEmailAndPassword(this.auth, email, password);
				} catch (error) {
					const showAuthError = (m) => { authError.textContent = m; authError.classList.remove('hidden'); };
					if (error.code === 'auth/invalid-credential') {
						showAuthError('Email ou senha inv√°lidos.');
					} else {
						showAuthError('Erro ao tentar fazer login.');
						console.error("Erro de login:", error.code, error.message);
					}
				} finally {
					if (loginButton) loginButton.disabled = false;
					if (buttonText) buttonText.textContent = "Entrar no Sistema";
					if (buttonIcon) buttonIcon.className = "fas fa-sign-in-alt";
				}
			}
		
			async logout() {
				try {
					await signOut(this.auth);
				} catch (error) {
					console.error("Erro ao fazer logout:", error);
					Utils.showToast('Erro ao tentar sair.', 'error');
				}
			}
		
			async updateUserProfile(displayName) {
				if (!this.auth.currentUser) return false;
				try {
					await updateProfile(this.auth.currentUser, { displayName });
					return true;
				} catch (error) {
					console.error("Erro ao guardar nome:", error);
					Utils.showToast('Erro ao guardar o seu nome.', 'error');
					return false;
				}
			}
		}
		
		class FirebaseService {
			constructor(appInstance) {
				this.app = appInstance;
				this.db = null;
				this.contractsCollection = null;
				this.snapshotListenerUnsubscribe = null;
				this.notificationListenerUnsubscribe = null;
				this.notificationCollection = null;
				this.settingsListenerUnsubscribe = null;
			}
		
			setDB(dbInstance) {
				this.db = dbInstance;
			}
			
			startSnapshotListener(collectionName) {
				if (this.snapshotListenerUnsubscribe) {
					this.snapshotListenerUnsubscribe();
				}
				this.contractsCollection = collection(this.db, collectionName);
				this.snapshotListenerUnsubscribe = onSnapshot(this.contractsCollection, (snapshot) => {
					const contracts = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
					this.app.handleSnapshotUpdate(contracts);
				}, (error) => {
					console.error("Erro ao buscar dados (contracts):", error);
					Utils.showToast('Erro de conex√£o. N√£o foi poss√≠vel atualizar os dados.', 'error');
				});
			}
			
			stopSnapshotListener() {
				if (this.snapshotListenerUnsubscribe) {
					this.snapshotListenerUnsubscribe();
					this.snapshotListenerUnsubscribe = null;
				}
			}

			startNotificationListener(safeName) {
				if (this.notificationListenerUnsubscribe) {
					this.notificationListenerUnsubscribe();
				}
				this.notificationCollection = collection(this.db, `notifications/${safeName}/alerts`);
				const q = query(this.notificationCollection, orderBy("timestamp", "desc"), limit(20));
				
				this.notificationListenerUnsubscribe = onSnapshot(q, (snapshot) => {
					const notifications = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
					this.app.handleNotificationUpdate(notifications);
				}, (error) => {
					console.error("Erro ao buscar notifica√ß√µes:", error);
				});
			}

			stopNotificationListener() {
				if (this.notificationListenerUnsubscribe) {
					this.notificationListenerUnsubscribe();
					this.notificationListenerUnsubscribe = null;
				}
			}

			startSystemSettingsListener() {
				if (this.settingsListenerUnsubscribe) {
					this.settingsListenerUnsubscribe();
				}
				
				const settingsCollection = collection(this.db, 'systemSettings');
				
				this.settingsListenerUnsubscribe = onSnapshot(settingsCollection, (snapshot) => {
					const settings = {};
					snapshot.docs.forEach(docSnap => {
						settings[docSnap.id] = docSnap.data();
					});
					this.app.handleSystemSettingsUpdate(settings);
				}, (error) => {
					console.error("Erro ao buscar systemSettings:", error);
					Utils.showToast('Erro ao buscar configura√ß√µes do sistema.', 'error');
				});
			}

			stopSystemSettingsListener() {
				if (this.settingsListenerUnsubscribe) {
					this.settingsListenerUnsubscribe();
					this.settingsListenerUnsubscribe = null;
				}
			}

			async saveSystemSettings(docId, data) {
				try {
					const docRef = doc(this.db, 'systemSettings', docId);
					await setDoc(docRef, data, { merge: true });
					Utils.showToast('Configura√ß√µes salvas com sucesso.', 'success');
					return true;
				} catch (error) {
					console.error(`Erro ao salvar ${docId}:`, error);
					Utils.showToast('Erro ao salvar configura√ß√µes.', 'error');
					return false;
				}
			}

			async sendNotification(safeRecipientName, notificationData) {
				try {
					const targetCollection = collection(this.db, `notifications/${safeRecipientName}/alerts`);
					await addDoc(targetCollection, {
						...notificationData,
						isRead: false,
						timestamp: serverTimestamp()
					});
					return true;
				} catch (error) {
					console.error(`Erro ao enviar notifica√ß√£o para ${safeRecipientName}:`, error);
					return false;
				}
			}

			async markNotificationsAsRead(safeUserName, notificationIds) {
				try {
					const batch = writeBatch(this.db);
					notificationIds.forEach(id => {
						const docRef = doc(this.db, `notifications/${safeUserName}/alerts`, id);
						batch.update(docRef, { isRead: true });
					});
					await batch.commit();
				} catch (error) {
					console.error("Erro ao marcar notifica√ß√µes como lidas:", error);
				}
			}
		
			async addContract(contractData) {
				try {
					await addDoc(this.contractsCollection, contractData);
					Utils.showToast('Contrato guardado com sucesso.', 'success');
					return true;
				} catch (error) {
					console.error("Erro ao adicionar contrato:", error);
					Utils.showToast('Erro ao guardar o contrato. Tente novamente.', 'error');
					return false;
				}
			}
		
			async updateContract(contractId, contractData) {
				try {
					const contractRef = doc(this.contractsCollection, contractId);
					await updateDoc(contractRef, contractData);
					Utils.showToast('Contrato atualizado.', 'success');
					return true;
				} catch (error) {
					console.error("Erro ao atualizar contrato:", error);
					Utils.showToast('Erro ao atualizar o contrato.', 'error');
					return false;
				}
			}
		
			async updateContractField(contractId, fieldData) {
				try {
					const contractRef = doc(this.contractsCollection, contractId);
					await updateDoc(contractRef, fieldData);
					return true;
				} catch (error) {
					console.error(`Erro ao atualizar campo do contrato (${contractId}):`, error);
					Utils.showToast('Erro ao atualizar o item.', 'error');
					return false;
				}
			}
		
			async deleteContract(contractId) {
				try {
					await deleteDoc(doc(this.contractsCollection, contractId));
					Utils.showToast('Contrato exclu√≠do permanentemente.', 'success');
					return true;
				} catch (error) {
					console.error("Erro ao excluir contrato:", error);
					Utils.showToast('Erro ao excluir o contrato.', 'error');
					return false;
				}
			}
		}
		class AnalyticsHandler {
			constructor() {
				this.actualIncomeChartInstance = null;
				this.projectedIncomeChartInstance = null;
				this.advReportTimelineChart = null;
				this.advReportByAdvogadoChart = null;
				this.advReportNewContractsChart = null;
				this.adminChartContratos = null;
				this.adminChartFaturamento = null;
			}
			
			getChartConfig(type, labels, datasets) {
				const isHorizontal = type.startsWith('horizontal');
				const axis = isHorizontal ? 'x' : 'y';
				const indexAxis = isHorizontal ? 'y' : 'x';
				
				return {
					type: type.replace('horizontal', ''),
					data: { labels, datasets },
					options: {
						indexAxis: indexAxis,
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							[axis]: { beginAtZero: true, ticks: { color: '#9ca3af' } },
							[indexAxis]: { ticks: { color: '#9ca3af' } }
						},
						plugins: {
							legend: { labels: { color: '#d1d5db' } }
						}
					}
				};
			}

			renderActualIncomeChart(ctx, labels, data) {
				if (this.actualIncomeChartInstance) this.actualIncomeChartInstance.destroy();
				this.actualIncomeChartInstance = new Chart(ctx, this.getChartConfig(
					'bar', labels, [{ label: 'Fatura√ß√£o Real', data, backgroundColor: 'rgba(74, 222, 128, 0.6)', borderColor: 'rgba(74, 222, 128, 1)', borderWidth: 1 }]
				));
			}
		
			renderProjectedIncomeChart(ctx, labels, data) {
				if (this.projectedIncomeChartInstance) this.projectedIncomeChartInstance.destroy();
				this.projectedIncomeChartInstance = new Chart(ctx, this.getChartConfig(
					'bar', labels, [{ label: 'Proje√ß√£o (Parcelas)', data, backgroundColor: 'rgba(139, 92, 246, 0.6)', borderColor: 'rgba(139, 92, 246, 1)', borderWidth: 1 }]
				));
			}

			renderTimelineChart(ctx, labels, data) {
				if (this.advReportTimelineChart) this.advReportTimelineChart.destroy();
				this.advReportTimelineChart = new Chart(ctx, this.getChartConfig(
					'line', labels, [{ label: 'Fatura√ß√£o', data, backgroundColor: 'rgba(74, 222, 128, 0.2)', borderColor: 'rgba(74, 222, 128, 1)', borderWidth: 2, fill: true, tension: 0.1 }]
				));
			}

			renderByAdvogadoChart(ctx, labels, data) {
				if (this.advReportByAdvogadoChart) this.advReportByAdvogadoChart.destroy();
				this.advReportByAdvogadoChart = new Chart(ctx, this.getChartConfig(
					'pie', labels, [{ label: 'Fatura√ß√£o', data, 
						backgroundColor: ['#4f46e5', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#0ea5e9', '#22c55e', '#eab308', '#dc2626'],
						borderWidth: 0 }]
				));
			}
			
			renderNewContractsChart(ctx, labels, data) {
				if (this.advReportNewContractsChart) this.advReportNewContractsChart.destroy();
				this.advReportNewContractsChart = new Chart(ctx, this.getChartConfig(
					'bar', labels, [{ label: 'Novos Contratos', data, backgroundColor: 'rgba(139, 92, 246, 0.6)', borderColor: 'rgba(139, 92, 246, 1)', borderWidth: 1 }]
				));
			}

			renderAdminContratosChart(ctx, labels, data) {
				if (this.adminChartContratos) this.adminChartContratos.destroy();
				this.adminChartContratos = new Chart(ctx, this.getChartConfig(
					'pie', labels, [{ label: 'Contratos Ativos', data,
						backgroundColor: ['#4f46e5', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#0ea5e9', '#22c55e', '#eab308', '#dc2626'],
						borderWidth: 0 }]
				));
			}

			renderAdminFaturamentoChart(ctx, labels, data) {
				if (this.adminChartFaturamento) this.adminChartFaturamento.destroy();
				this.adminChartFaturamento = new Chart(ctx, this.getChartConfig(
					'bar', labels, [{ label: 'Fatura√ß√£o (Ano)', data, backgroundColor: 'rgba(74, 222, 128, 0.6)', borderColor: 'rgba(74, 222, 128, 1)', borderWidth: 1 }]
				));
			}
		
			_forceRemoveTooltips() {
				const tooltips = document.querySelectorAll('div.chartjs-tooltip');
				tooltips.forEach(tip => tip.remove());
			}

			destroyPageCharts(pageId) {
				if (pageId === 'page-relatorios') {
					if (this.advReportTimelineChart) this.advReportTimelineChart.destroy();
					if (this.advReportByAdvogadoChart) this.advReportByAdvogadoChart.destroy();
					if (this.advReportNewContractsChart) this.advReportNewContractsChart.destroy();
					this.advReportTimelineChart = null; this.advReportByAdvogadoChart = null; this.advReportNewContractsChart = null;
				}
				if (pageId === 'page-performance') {
					if (this.adminChartContratos) this.adminChartContratos.destroy();
					if (this.adminChartFaturamento) this.adminChartFaturamento.destroy();
					this.adminChartContratos = null; this.adminChartFaturamento = null;
				}
				this._forceRemoveTooltips();
			}

			destroyModalCharts() {
				if (this.actualIncomeChartInstance) this.actualIncomeChartInstance.destroy();
				if (this.projectedIncomeChartInstance) this.projectedIncomeChartInstance.destroy();
				this.actualIncomeChartInstance = null; this.projectedIncomeChartInstance = null;
				this._forceRemoveTooltips();
			}
		}
		
		class ReportHandler {
			constructor(appInstance) {
				this.app = appInstance;
			}
		
			// [MUDAN√áA CR√çTICA - REQUISITO 1] 
			// L√≥gica ajustada para listar em "N√£o Pagos" APENAS quem tinha vencimento no m√™s e n√£o pagou.
			calculateIncomeByDateRange(startDate, endDate, contractsToRender) {
				let totalParcelas = 0, totalExito = 0;
				const detailedPayments = [];
				const byAdvogado = {};
				const byMonth = {};
				const newContractsByMonth = {};
				
				// Filtra exclu√≠dos
				const allContracts = contractsToRender.filter(c => !c.isDeleted);
				
				// Lista para armazenar quem devia ter pago e n√£o pagou
				const notPaidList = [];

				const addData = (map, date, value) => {
					const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
					map[monthKey] = (map[monthKey] || 0) + value;
				};

				allContracts.forEach(contract => {
					const advogado = contract.advogadoResponsavel || 'N√£o Informado';

					// 1. Novos contratos (cria√ß√£o)
					if (contract.createdAt) {
						const d = new Date(contract.createdAt);
						if (d >= startDate && d <= endDate) {
							addData(newContractsByMonth, d, 1);
						}
					}
					
					// 2. Processamento de Parcelas (Pagamentos e Inadimpl√™ncia do M√™s)
					if (contract.parcels) {
						contract.parcels.forEach(parcel => {
							const dueDate = new Date(parcel.dueDate);
							const paymentDate = parcel.paymentDate ? new Date(parcel.paymentDate) : null;
							
							// A. L√≥gica de Recebimento (Dinheiro que entrou no per√≠odo)
							if (parcel.status === 'Paga' && paymentDate) {
								if (paymentDate >= startDate && paymentDate <= endDate) {
									const value = parcel.valuePaid;
									totalParcelas += value;
									detailedPayments.push({ type: `Parcela ${parcel.number}/${contract.parcels.length}`, clientName: contract.clientName, date: paymentDate, value: value, advogado: advogado });
									byAdvogado[advogado] = (byAdvogado[advogado] || 0) + value;
									addData(byMonth, paymentDate, value);
								}
							}

							// B. L√≥gica de Inadimpl√™ncia (Dinheiro que DEVERIA ter entrado no per√≠odo)
							// Se a parcela vencia neste m√™s...
							if (dueDate >= startDate && dueDate <= endDate) {
								// ...e N√ÉO est√° marcada como Paga (ou foi paga fora do prazo, tecnicamente devia no m√™s)
								// Aqui simplificamos: se o status n√£o √© 'Paga', √© inadimplente do m√™s.
								if (parcel.status !== 'Paga') {
									notPaidList.push({
										clientName: contract.clientName,
										advogado: advogado,
										parcelNumber: parcel.number,
										value: parcel.value,
										dueDate: dueDate
									});
								}
							}
						});
					}
					
					// 3. Processamento de √äxito
					if (contract.successFeePaymentDate) {
						const d = new Date(contract.successFeePaymentDate);
						if (d >= startDate && d <= endDate) {
							const value = contract.successFeeValueReceived;
							totalExito += value;
							detailedPayments.push({ type: 'Taxa de √äxito', clientName: contract.clientName, date: d, value: value, advogado: advogado });
							byAdvogado[advogado] = (byAdvogado[advogado] || 0) + value;
							addData(byMonth, d, value);
						}
					}
				});
				
				detailedPayments.sort((a, b) => a.date - b.date);
				notPaidList.sort((a, b) => a.dueDate - b.dueDate); // Ordena inadimplentes por vencimento
				
				const totalGeral = totalParcelas + totalExito;
				const totalContratos = Object.values(newContractsByMonth).reduce((a, b) => a + b, 0);
				
				return { totalParcelas, totalExito, totalGeral, totalContratos, detailedPayments, byAdvogado, byMonth, newContractsByMonth, notPaidList };
			}
			
			calculateAdminPerformanceData(contractsToRender) {
				const hoje = new Date();
				const inicioAno = new Date(hoje.getFullYear(), 0, 1);
				const fimAno = new Date(hoje.getFullYear(), 11, 31, 23, 59, 59);

				const contratosAtivos = contractsToRender.filter(c => !c.isDeleted && this.app.getContractStatus(c).statusText !== 'Conclu√≠do');
				const faturamentoAno = this.calculateIncomeByDateRange(inicioAno, fimAno, contractsToRender);

				const contratosPorAdvogado = {};
				contratosAtivos.forEach(contract => {
					const advogado = contract.advogadoResponsavel || 'N√£o Informado';
					contratosPorAdvogado[advogado] = (contratosPorAdvogado[advogado] || 0) + 1;
				});

				const faturamentoPorAdvogado = faturamentoAno.byAdvogado;
				return { contratosPorAdvogado, faturamentoPorAdvogado };
			}

			calculateMonthlyIncome(year, month, contractsToRender) {
				const startDate = new Date(year, month, 1);
				const endDate = new Date(year, month + 1, 0, 23, 59, 59);
				return this.calculateIncomeByDateRange(startDate, endDate, contractsToRender);
			}
		
			getActualIncomeData(contractsToRender) {
				const labels = [];
				const data = [];
				const hoje = new Date();
		
				for (let i = 11; i >= 0; i--) {
					const date = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
					labels.push(date.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }));
					const income = this.calculateMonthlyIncome(date.getFullYear(), date.getMonth(), contractsToRender);
					data.push(income.totalGeral);
				}
				return { labels, data };
			}
		
			getProjectedIncomeData(contractsToRender) {
				const labels = [];
				const data = new Array(12).fill(0);
				const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
				const inicioMesAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
		
				for (let i = 0; i < 12; i++) {
					const date = new Date(hoje.getFullYear(), hoje.getMonth() + i, 1);
					labels.push(date.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }));
				}
		
				const filteredContracts = contractsToRender.filter(c => !c.isDeleted);
				for (const contract of filteredContracts) {
					if (!contract.parcels) continue;
					for (const parcel of contract.parcels) {
						if (parcel.status === 'Pendente') {
							const dueDate = new Date(parcel.dueDate);
							if (dueDate < inicioMesAtual) continue;
							const diffMonth = (dueDate.getFullYear() - inicioMesAtual.getFullYear()) * 12 + (dueDate.getMonth() - inicioMesAtual.getMonth());
							if (diffMonth >= 0 && diffMonth < 12) data[diffMonth] += parcel.value;
						}
					}
				}
				return { labels, data };
			}
		}
		
		class DOMBuilder {
			constructor(appInstance) {
				this.app = appInstance;
			}
		
			buildIcon(classes) {
				const icon = document.createElement('i');
				icon.className = classes;
				return icon;
			}
			
			buildElement(tag, { className = '', text = '', html = '', id = '' } = {}) {
				const el = document.createElement(tag);
				if (className) el.className = className;
				if (text) el.textContent = text;
				if (html) el.innerHTML = html;
				if (id) el.id = id;
				return el;
			}
		
			createParcelCard(contract, parcel, index, type, remainingValue, valorCorrigido = null) {
				const formattedDate = Utils.formatDate(parcel.dueDate);
				const formattedValue = Utils.formatCurrency(parcel.value);
				const formattedRemaining = Utils.formatCurrency(remainingValue);
				const formattedCorrigido = valorCorrigido ? Utils.formatCurrency(valorCorrigido) : '';
		
				let borderColor = '';
				const card = this.buildElement('div', { className: 'dark-card shadow-lg p-4 rounded-lg transition-all duration-200 hover:-translate-y-1' });
		
				const title = this.buildElement('p', { className: 'font-bold text-white', text: contract.clientName });
				const services = (contract.serviceTypes || []).map(s => s.name).join(', ');
				const subtitle = this.buildElement('p', { className: 'text-sm text-gray-400 mb-3', text: `${services} - Parcela ${parcel.number}/${contract.parcels.length || 1}` });
				
				const details = this.buildElement('div', { className: 'space-y-2 text-sm' });
				let actionButton;
		
				if (type === 'vencida') {
					borderColor = 'border-red-500';
					details.innerHTML = `
					<div class="flex items-center text-gray-400 text-xs"><strong>Original:</strong><span class="ml-auto font-medium line-through">${formattedValue}</span></div>
					<div class="flex items-center text-red-400"><strong>Corrigido:</strong><span class="ml-auto font-semibold text-lg">${formattedCorrigido}</span></div>`;
				} else if (type === 'a-vencer') {
					borderColor = 'border-yellow-500';
					details.innerHTML = `<div class="flex items-center text-gray-300"><i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i><strong>Valor:</strong><span class="ml-auto font-semibold text-lg text-white">${formattedValue}</span></div>`;
				} else {
					borderColor = 'border-gray-700';
					const formattedPaidValue = Utils.formatCurrency(parcel.valuePaid || 0);
					const paymentDate = Utils.formatDate(parcel.paymentDate);
					details.innerHTML = `<div class="flex items-center text-gray-300"><i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i><strong>Valor:</strong><span class="ml-auto font-semibold text-lg text-white">${formattedValue}</span></div>`;
					actionButton = this.buildElement('div', { 
						className: 'mt-4 text-center text-sm bg-green-900/50 text-green-300 p-2 rounded-md font-medium',
						text: `Pago ${formattedPaidValue} em ${paymentDate}`
					});
				}
				card.classList.add('border-l-4', borderColor);
		
				const vencimentoDiv = this.buildElement('div', { className: 'flex items-center text-gray-400' });
				vencimentoDiv.append(this.buildIcon('fas fa-calendar-alt w-5 text-center mr-2 text-gray-500'));
				vencimentoDiv.append(this.buildElement('strong', { text: 'Vencimento:' }));
				vencimentoDiv.append(this.buildElement('span', { className: 'ml-auto font-medium text-gray-300', text: formattedDate }));
				details.append(vencimentoDiv);
		
				card.append(title, subtitle, details);
		
				const extraInfo = this.buildElement('div', { className: 'text-xs text-gray-500 border-t border-gray-700 pt-2 mt-3 flex justify-between' });
				extraInfo.innerHTML = `<span>Contrato: <strong>${Utils.formatCurrency(contract.totalValue || 0)}</strong></span> <span>Restante: <strong>${formattedRemaining}</strong></span>`;
				card.append(extraInfo);
		
				if (type !== 'paga') {
					actionButton = this.buildElement('button', { 
						className: 'mt-4 w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-2 px-3 rounded-lg text-sm shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center gap-2',
						html: '<i class="fas fa-check"></i> Registar Pagamento'
					});
					actionButton.onclick = () => window.App.openPaymentModal(contract.id, index);
				}
				if (actionButton) card.append(actionButton);
				
				return card;
			}
			
			createExitoCard(contract) {
				const taxaExitoDisplay = contract.successFee || '[N√£o definido]';
				const card = this.buildElement('div', { className: 'dark-card shadow-lg p-4 rounded-lg transition-all duration-200 hover:-translate-y-1 border-l-4 border-indigo-500 w-80 flex-shrink-0 self-start' });
				card.append(this.buildElement('p', { className: 'font-bold text-white', text: contract.clientName }));
				const services = (contract.serviceTypes || []).map(s => s.name).join(', ');
				card.append(this.buildElement('p', { className: 'text-sm text-gray-400 mb-3', text: services }));
				
				const infoDiv = this.buildElement('div', { className: 'my-4 text-center' });
				infoDiv.append(this.buildElement('p', { className: 'text-sm text-gray-400', text: 'Bonifica√ß√£o Pendente' }));
				infoDiv.append(this.buildElement('p', { className: 'text-2xl font-semibold text-indigo-400', text: taxaExitoDisplay }));
				card.append(infoDiv);
				
				const button = this.buildElement('button', {
					className: 'w-full bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-semibold py-2 px-3 rounded-lg text-sm shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center gap-2',
					html: '<i class="fas fa-gavel"></i> Registar Recebimento'
				});
				button.onclick = () => window.App.openExitoModal(contract.id);
				card.append(button);
				return card;
			}
		
			createContractCard(contract, statusInfo) {
				const { statusText, statusColor, borderColor } = statusInfo;
				
				const card = this.buildElement('div', { className: `dark-card shadow-lg rounded-lg overflow-hidden ${borderColor} flex flex-col justify-between transition-all duration-200 transform hover:-translate-y-1 hover:shadow-xl border-l-4` });
				const cardBody = this.buildElement('div', { className: 'p-5' });
				
				const header = this.buildElement('div', { className: 'flex justify-between items-start mb-3' });
				header.append(this.buildElement('h3', { className: 'font-bold text-xl text-white', text: contract.clientName }));
				header.append(this.buildElement('span', { className: `px-2 py-1 rounded-full text-xs font-semibold ${statusColor}`, text: statusText }));
				cardBody.append(header);
		
				const adv = this.buildElement('p', { className: 'text-xs text-indigo-300 mb-3' });
				adv.append(this.buildIcon('fas fa-user-tie mr-1'));
				adv.append(document.createTextNode(` ${contract.advogadoResponsavel}`));
				cardBody.append(adv);
		
				const servicesContainer = this.buildElement('div', { className: 'mb-4' });
				(contract.serviceTypes || []).forEach(s => {
					servicesContainer.append(this.buildElement('span', { className: 'service-tag-small', text: s.name }));
				});
				cardBody.append(servicesContainer);
		
				const financialInfo = this.buildElement('div', { className: 'border-t border-gray-700 pt-4 space-y-3 text-sm' });
				const valorFixoDisplay = Utils.formatCurrency(contract.totalValue);
				const exitoDisplay = contract.successFee || '';
		
				const fixedValueDiv = this.buildElement('div', { className: 'flex items-center text-gray-400' });
				fixedValueDiv.append(this.buildIcon('fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500'));
				fixedValueDiv.append(this.buildElement('strong', { text: 'Valor Fixo:' }));
				fixedValueDiv.append(this.buildElement('span', { className: 'ml-auto font-medium text-gray-300', text: valorFixoDisplay }));
				financialInfo.append(fixedValueDiv);
				
				if (contract.successFee) {
					const exitoDiv = this.buildElement('div', { className: 'flex items-center text-gray-400' });
					exitoDiv.append(this.buildIcon('fas fa-star w-5 text-center mr-2 text-gray-500'));
					exitoDiv.append(this.buildElement('strong', { text: '√äxito:' }));
					exitoDiv.append(this.buildElement('span', { className: 'ml-auto font-medium text-indigo-400', text: exitoDisplay }));
					financialInfo.append(exitoDiv);
				}
				cardBody.append(financialInfo);
				
				const footer = this.buildElement('div', { className: 'bg-gray-900/50 px-4 py-2 flex justify-end gap-2' });
				
				const historyBtn = this.buildElement('button', { className: 'text-sm flex items-center gap-2 text-gray-400 hover:text-indigo-400 hover:bg-indigo-900/20 py-1 px-3 rounded-md transition-colors', html: '<i class="fas fa-eye"></i> Hist√≥rico' });
				historyBtn.onclick = () => window.App.openClientHistoryModal(contract.clientName);
		
				const editBtn = this.buildElement('button', { className: 'text-sm flex items-center gap-2 text-gray-400 hover:text-green-400 hover:bg-green-900/20 py-1 px-3 rounded-md transition-colors', html: '<i class="fas fa-pencil-alt"></i> Editar' });
				editBtn.onclick = () => window.App.openContractModal(contract.id);
		
				const deleteBtn = this.buildElement('button', { className: 'text-sm flex items-center gap-2 text-gray-400 hover:text-red-400 hover:bg-red-900/20 py-1 px-3 rounded-md transition-colors' });
				deleteBtn.append(this.buildIcon('fas fa-trash-alt'));
				deleteBtn.onclick = () => window.App.moveToLixeira(contract.id);
		
				footer.append(historyBtn, editBtn, deleteBtn);
				card.append(cardBody, footer);
				return card;
			}
			
			createParcelaCard({ contract, parcel, index, diffDays, valorCorrigido, isVencida }) {
				const valorOriginalDisplay = Utils.formatCurrency(parcel.value);
				const valorCorrigidoDisplay = Utils.formatCurrency(valorCorrigido);
				const cardClasses = isVencida ? 'parcel-card-vencida' : 'parcel-card-avencer';
				const card = this.buildElement('div', { className: `dark-card shadow-lg p-5 rounded-lg border-l-4 ${cardClasses} transition-all duration-200 hover:-translate-y-1 hover:shadow-xl` });
				
				card.append(this.buildElement('p', { className: 'font-bold text-lg text-white', text: contract.clientName }));
				const services = (contract.serviceTypes || []).map(s => s.name).join(', ');
				card.append(this.buildElement('p', { className: 'text-sm text-gray-400 mb-3', text: `${services} - Parcela ${parcel.number}/${contract.parcels.length || 1}` }));
				
				const details = this.buildElement('div', { className: 'border-t border-gray-700 pt-3 mt-3 space-y-2' });
				
				if (isVencida) {
					details.innerHTML = `
					<div class="flex justify-between items-center text-sm">
						<span class="text-gray-400">Valor Original:</span>
						<span class="font-medium text-gray-400 line-through">${valorOriginalDisplay}</span>
					</div>
					<div class="flex justify-between items-center">
						<span class="text-sm text-white">Valor Corrigido:</span>
						<span class="font-semibold text-lg parcel-value">${valorCorrigidoDisplay}</span>
					</div>`;
				} else {
					details.innerHTML = `
					<div class="flex justify-between items-center">
						<span class="text-sm text-white">Valor:</span>
						<span class="font-semibold text-lg parcel-value">${valorOriginalDisplay}</span>
					</div>`;
				}
				
				details.innerHTML += `
				<div class="flex justify-between items-center text-sm">
					<span class="text-gray-400">Vence em:</span>
					<span class="font-medium text-gray-300">${Utils.formatDate(parcel.dueDate)}</span>
				</div>`;

				if (isVencida) {
					details.innerHTML += `
					<div class="flex justify-between items-center text-red-400 font-bold text-sm bg-red-900/30 px-2 py-1 rounded">
						<span>Atrasado h√°:</span>
						<span>${diffDays} dia(s)</span>
					</div>`;
				} else {
					details.innerHTML += `
					<div class="flex justify-between items-center text-yellow-400 font-bold text-sm bg-yellow-900/30 px-2 py-1 rounded">
						<span>Faltam:</span>
						<span>${diffDays * -1} dia(s)</span>
					</div>`;
				}
				card.append(details);
		
				const footer = this.buildElement('div', { className: 'mt-4 flex gap-2' });
				const payBtn = this.buildElement('button', {
					className: 'flex-1 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center gap-2',
					html: '<i class="fas fa-check"></i> Pagar'
				});
				payBtn.onclick = () => window.App.openPaymentModal(contract.id, index);
				
				const editBtn = this.buildElement('button', {
					className: 'flex-shrink-0 bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center gap-2',
					html: '<i class="fas fa-pencil-alt"></i>'
				});
				editBtn.title = "Editar Contrato";
				editBtn.onclick = () => window.App.openContractModal(contract.id);

				footer.append(payBtn, editBtn);
				card.append(footer);
				return card;
			}
			
			createServicoCard(contract, serviceProgress, financialProgress) {
				const card = this.buildElement('div', { className: 'dark-card shadow-lg p-5 rounded-lg transition-all duration-200 hover:-translate-y-1' });
				
				const header = this.buildElement('div', { className: 'flex justify-between items-start' });
				header.append(this.buildElement('h3', { className: 'font-bold text-xl text-indigo-300 mb-4', text: contract.clientName }));
				header.append(this.buildElement('p', { className: 'text-sm text-gray-400', html: `<i class="fas fa-user-tie mr-1"></i> ${contract.advogadoResponsavel}` }));
				card.append(header);
		
				const progressBars = this.buildElement('div', { className: 'space-y-4 mb-4' });
				const financialProgressDiv = this.buildElement('div');
				financialProgressDiv.innerHTML = `
				<div class="flex justify-between text-sm mb-1 text-gray-300"><label>Progresso Financeiro</label><span class="font-medium text-teal-300">${financialProgress.toFixed(0)}%</span></div>
				<div class="progress-bar-bg h-3 w-full"><div class="progress-bar bg-teal-500" style="width: ${financialProgress}%"></div></div>`;
				progressBars.append(financialProgressDiv);
				
				const serviceProgressDiv = this.buildElement('div');
				serviceProgressDiv.innerHTML = `
				<div class="flex justify-between text-sm mb-1 text-gray-300"><label>Progresso dos Servi√ßos</label><span class="font-medium text-indigo-300">${serviceProgress.toFixed(0)}%</span></div>
				<div class="progress-bar-bg h-3 w-full"><div class="progress-bar bg-indigo-500" style="width: ${serviceProgress}%"></div></div>`;
				progressBars.append(serviceProgressDiv);
				card.append(progressBars);
				
				const serviceListContainer = this.buildElement('div', { className: 'border-t border-gray-700 pt-3' });
				serviceListContainer.append(this.buildElement('h4', { className: 'font-semibold text-sm mb-2 text-gray-400', text: 'Servi√ßos do Contrato:' }));
				const serviceList = this.buildElement('ul', { className: 'space-y-1' });
		
				(contract.serviceTypes || []).forEach((service, index) => {
					serviceList.append(this.createServiceListItem(contract, service, index));
				});
				
				serviceListContainer.append(serviceList);
				card.append(serviceListContainer);
				return card;
			}
			
			createServiceListItem(contract, service, index) {
				const li = this.buildElement('li', { className: 'flex items-center justify-between p-2 rounded-md' });
		
				const iconClass =
					service.status === 'Conclu√≠do' ? 'fas fa-check-circle text-teal-500' :
					service.status === '50% Conclu√≠do' ? 'fas fa-adjust text-purple-500' :
					service.status === 'Em Andamento' ? 'fas fa-spinner fa-spin text-yellow-500' :
					'far fa-circle text-gray-500';
				const textClass = service.status === 'Conclu√≠do' ? 'text-gray-500 line-through' : 'text-gray-300';
				li.classList.add(service.status !== 'Conclu√≠do' ? 'hover:bg-gray-700/50' : 'bg-gray-900/50');
				
				const serviceNameSpan = this.buildElement('span', { className: textClass });
				serviceNameSpan.append(this.buildIcon(`${iconClass} mr-2`));
				serviceNameSpan.append(document.createTextNode(service.name));
				
				const actionsDiv = this.buildElement('div', { className: 'flex items-center gap-2' });
				
				if (service.deadline) {
					const hoje = new Date(); hoje.setHours(0,0,0,0);
					const prazo = new Date(service.deadline + "T12:00:00Z");
					const diffDays = Math.ceil((prazo - hoje) / 86400000);
					const formattedPrazo = Utils.formatDate(prazo);
					let deadlineHtml = '', deadlineClass = '';
					
					if (diffDays < 0 && service.status !== 'Conclu√≠do') {
						deadlineHtml = `<i class="fas fa-exclamation-triangle"></i> Vencido: ${formattedPrazo}`;
						deadlineClass = 'text-xs font-medium text-red-400';
					} else if (diffDays <= 7 && service.status !== 'Conclu√≠do') {
						deadlineHtml = `<i class="fas fa-clock"></i> Vence: ${formattedPrazo}`;
						deadlineClass = 'text-xs font-medium text-yellow-400';
					} else if (service.status !== 'Conclu√≠do') {
						deadlineHtml = `<i class="far fa-calendar-alt"></i> ${formattedPrazo}`;
						deadlineClass = 'text-xs text-gray-500';
					} else {
						deadlineHtml = `<i class="far fa-calendar-check"></i> ${formattedPrazo}`;
						deadlineClass = 'text-xs text-gray-500';
					}
					actionsDiv.append(this.buildElement('span', { className: deadlineClass, html: deadlineHtml }));
				}
				
				let statusHtml = '', statusClass = '';
				switch (service.status) {
					case 'Conclu√≠do':
						statusClass = 'text-xs font-bold text-teal-400'; statusHtml = 'CONCLU√çDO';
						break;
					case '50% Conclu√≠do':
						statusClass = 'text-xs font-bold text-purple-400'; statusHtml = '50%';
						actionsDiv.append(this.createServiceButton('Concluir', 'bg-indigo-600 hover:bg-indigo-500', () => this.app.updateServiceStatus(contract, index, 'Conclu√≠do')));
						break;
					case 'Em Andamento':
						statusClass = 'text-xs font-bold text-yellow-400'; statusHtml = 'EM ANDAMENTO';
						actionsDiv.append(this.createServiceButton('50%', 'bg-purple-600 hover:bg-purple-500', () => this.app.updateServiceStatus(contract, index, '50% Conclu√≠do')));
						actionsDiv.append(this.createServiceButton('Concluir', 'bg-indigo-600 hover:bg-indigo-500', () => this.app.updateServiceStatus(contract, index, 'Conclu√≠do')));
						break;
					default:
						statusClass = 'text-xs font-bold text-gray-400'; statusHtml = 'PENDENTE';
						actionsDiv.append(this.createServiceButton('Iniciar', 'bg-yellow-600 hover:bg-yellow-500', () => this.app.updateServiceStatus(contract, index, 'Em Andamento')));
						break;
				}
				actionsDiv.append(this.buildElement('span', { className: statusClass, text: statusHtml }));
				li.append(serviceNameSpan, actionsDiv);
				return li;
			}
			
			createServiceButton(text, classes, onClick) {
				const btn = this.buildElement('button', {
					className: `text-xs text-white font-semibold py-1 px-2 rounded-md transition-colors ${classes}`,
					text: text
				});
				btn.onclick = onClick;
				return btn;
			}
		
			renderPaginationControls(container, totalItems, totalPages, currentPage) {
				container.innerHTML = '';
				if (totalPages <= 1) return;
				const createPageButton = (pageIndex, text = null, isDisabled = false, isActive = false) => {
					const btn = this.buildElement('button', { className: 'pagination-button', text: text !== null ? text : (pageIndex + 1) });
					if (isActive) btn.classList.add('active');
					if (isDisabled) btn.disabled = true;
					else btn.onclick = () => window.App.changeContractPage(pageIndex);
					return btn;
				};
				container.append(createPageButton(currentPage - 1, '¬´ Ant', currentPage === 0));
				const maxVisibleButtons = 5;
				let startPage = Math.max(0, currentPage - Math.floor(maxVisibleButtons / 2));
				let endPage = Math.min(totalPages - 1, startPage + maxVisibleButtons - 1);
				if (endPage - startPage + 1 < maxVisibleButtons) startPage = Math.max(0, endPage - maxVisibleButtons + 1);
				if (startPage > 0) { container.append(createPageButton(0)); if (startPage > 1) container.append(this.buildElement('span', { text: '...' })); }
				for (let i = startPage; i <= endPage; i++) container.append(createPageButton(i, null, false, i === currentPage));
				if (endPage < totalPages - 1) { if (endPage < totalPages - 2) container.append(this.buildElement('span', { text: '...' })); container.append(createPageButton(totalPages - 1)); }
				container.append(createPageButton(currentPage + 1, 'Pr√≥x ¬ª', currentPage === totalPages - 1));
			}

			createNotificationItem(notification) {
				const item = this.buildElement('div', { className: 'notification-item' });
				if (notification.isRead) item.classList.add('is-read');
				item.dataset.id = notification.id;
				item.innerHTML = `<p>${Utils.sanitizeText(notification.message)}</p><div class="time">${Utils.timeAgo(notification.timestamp?.toDate())}</div>`;
				item.onclick = () => {
					if (!notification.isRead) this.app.markNotificationsAsRead([notification.id]);
					this.app.closeNotificationDropdown();
				};
				return item;
			}
			
			createRankingRow(rank, label, value) {
				const tr = this.buildElement('tr');
				let rankClass = rank === 1 ? 'rank-1' : (rank === 2 ? 'rank-2' : (rank === 3 ? 'rank-3' : ''));
				tr.innerHTML = `<td class="${rankClass}">#${rank}</td><td class="text-gray-300 font-medium">${label}</td><td class="${rankClass}">${value}</td>`;
				return tr;
			}

			createSettingListItem(name) {
				const item = this.buildElement('div', { className: 'setting-list-item' });
				item.innerHTML = `<span class="font-medium">${Utils.sanitizeText(name)}</span><button class="setting-list-remove-btn" title="Remover ${Utils.sanitizeText(name)}">&times;</button>`;
				item.querySelector('.setting-list-remove-btn').onclick = () => window.App.handleRemoveAdvogado(name);
				return item;
			}

			createManualParcelListItem(value, date, index) {
				const item = this.buildElement('div', { className: 'parcel-list-item' });
				item.dataset.index = index;
				item.innerHTML = `<span>${Utils.formatCurrency(value)}</span><span>Vence: ${Utils.formatDate(date)}</span><button type="button" class="parcel-list-remove-btn" title="Remover Parcela">&times;</button>`;
				item.querySelector('.parcel-list-remove-btn').onclick = () => window.App.handleRemoveManualParcel(index);
				return item;
			}
		}
		class App {
			constructor() {
				// Estado da Aplica√ß√£o
				this.database = { 
					contracts: [],
					notifications: [],
					settings: { advogados: { list: [] } }
				};
				this.currentUserDisplayName = null;
				this.currentSafeName = null;
				this.isUserAdmin = false;
				this.currentAdvancedReportData = null;
				this.currentPageId = null;
				
				// Estado para notifica√ß√µes de vencimento
				this.lastOverdueCheck = null;
				this.manualParcels = [];
				
				// Estado de UI e Filtros
				this.currentContractSort = 'name-asc';
				this.currentParcelasSort = 'days-asc';
				this.currentServicosSort = 'name-asc';
				this.contractListPage = 0;
				this.contractStatusFilter = 'ativos';
				
				// [NOVO: REQUISITO 2] Filtro de Era (Padr√£o: Novos)
				this.contractEraFilter = 'novos'; 
				
				// Refer√™ncias DOM
				this.backdrop = null;
				this.appContainer = null;
				this.loadingOverlay = null;
				this.authOverlay = null;
				this.openModalId = null;
				this.lastFocusedElement = null;
		
				// Servi√ßos Injetados
				this.authService = new AuthService(this);
				this.firebaseService = new FirebaseService(this);
				this.domBuilder = new DOMBuilder(this);
				this.reportHandler = new ReportHandler(this);
				this.analyticsHandler = new AnalyticsHandler(this);
				this.correctionCalculator = new CorrectionCalculator(this);
			}
		
			initialize() {
				this.authService.initialize();
				this._initDOMReferences();
				this.setupEventListeners();
				this._setupModalAccessibility();
			}

			_initDOMReferences() {
				this.backdrop = document.getElementById('modal-backdrop');
				this.appContainer = document.getElementById('app-container');
				this.loadingOverlay = document.getElementById('loading-overlay');
				this.authOverlay = document.getElementById('auth-overlay');
				
				this.notificationBell = document.getElementById('notification-bell');
				this.notificationBadge = document.getElementById('notification-badge');
				this.notificationDropdown = document.getElementById('notification-dropdown');
				this.notificationList = document.getElementById('notification-list');
				this.notificationListEmpty = document.getElementById('notification-list-empty');
				this.clearNotificationsButton = document.getElementById('clear-notifications-button');
			}
		
			setupEventListeners() {
				// Auth
				document.getElementById('login-form').addEventListener('submit', (e) => {
					e.preventDefault();
					this.authService.login(document.getElementById('login-email').value, document.getElementById('login-password').value);
				});
				document.getElementById('logout-button').addEventListener('click', () => this.authService.logout());
				document.getElementById('formDisplayName').addEventListener('submit', this.handleDisplayNameSubmit.bind(this));
				
				// Forms
				document.getElementById('formContrato').addEventListener('submit', this.handleContractSubmit.bind(this));
				document.getElementById('formPagamento').addEventListener('submit', this.handlePaymentSubmit.bind(this));
				document.getElementById('formExito').addEventListener('submit', this.handleExitoSubmit.bind(this));
				document.getElementById('formAddAdvogado').addEventListener('submit', this.handleAddAdvogado.bind(this));
				
				// Actions
				document.getElementById('addServiceButton').addEventListener('click', this.handleAddServiceTag.bind(this));
				document.getElementById('contratoEspecial').addEventListener('change', this.toggleSpecialContractFields.bind(this));
				document.getElementById('addManualParcelButton').addEventListener('click', this.handleAddManualParcel.bind(this));

				// Search Inputs (Debounced)
				const debouncedContracts = Utils.debounce(() => this.resetAndRenderContractList(), 300);
				document.getElementById('searchInput').addEventListener('input', debouncedContracts);
				
				const debouncedServicos = Utils.debounce(() => this.renderServicosPage(), 300);
				document.getElementById('servicosSearchInput').addEventListener('input', debouncedServicos);
		
				const debouncedParcelas = Utils.debounce(() => this.renderParcelasPage(), 300);
				document.getElementById('parcelasSearchInput').addEventListener('input', debouncedParcelas);
		
				// Mobile Menu
				document.getElementById('mobile-menu-toggle').addEventListener('click', () => {
					const sidebar = document.getElementById('sidebar');
					sidebar.classList.toggle('hidden');
					if (!sidebar.classList.contains('hidden')) {
						this.backdrop.style.display = 'block';
					} else {
						this.backdrop.style.display = 'none';
					}
				});

				// Backdrop & Notifications
				if (this.backdrop) {
					this.backdrop.addEventListener('click', () => {
						if (this.openModalId && this.openModalId !== 'modalDisplayName') {
							this.closeModal(this.openModalId);
						}
						const sidebar = document.getElementById('sidebar');
						if (window.innerWidth < 768 && !sidebar.classList.contains('hidden')) {
							sidebar.classList.add('hidden');
							this.backdrop.style.display = 'none';
						}
						this.closeNotificationDropdown();
					});
				}

				if (this.notificationBell) {
					this.notificationBell.addEventListener('click', (e) => {
						e.stopPropagation();
						this.notificationDropdown.classList.toggle('hidden');
					});
				}
				if (this.clearNotificationsButton) {
					this.clearNotificationsButton.addEventListener('click', () => {
						this.markNotificationsAsRead();
					});
				}
				document.addEventListener('click', (e) => {
					if (this.notificationDropdown && !this.notificationDropdown.classList.contains('hidden')) {
						if (!this.notificationBell.contains(e.target) && !this.notificationDropdown.contains(e.target)) {
							this.closeNotificationDropdown();
						}
					}
				});
				
				// Financial Fields Change Detection
				const financialInputs = ['valorTotal', 'numParcelas', 'vencimentoPrimeiraParcela', 'contratoJaQuitado'];
				financialInputs.forEach(id => {
					document.getElementById(id)?.addEventListener('change', () => {
						document.getElementById('financialDataChanged').value = 'true';
					});
				});
			}
		
			handleAuthStateChange(user) {
				if (user) {
					const nomeDoFirebase = user.displayName;
					const nomeEmMinusculas = nomeDoFirebase ? nomeDoFirebase.toLowerCase() : '';
					const listaDeAdmins = ADMIN_USERS.map(u => u.toLowerCase());
					const euSouAdmin = listaDeAdmins.includes(nomeEmMinusculas);

					this.currentUserDisplayName = user.displayName;
					this.currentSafeName = Utils.sanitizeForFirestoreId(user.displayName);
					this.isUserAdmin = euSouAdmin;
					
					document.body.classList.toggle('is-admin', this.isUserAdmin);
		
					if (!user.displayName) {
						this.loadingOverlay.style.display = 'none';
						this.authOverlay.style.display = 'flex';
						this.appContainer.style.display = 'none';
						this.openModal('modalDisplayName');
					} else {
						document.getElementById('user-display-name').textContent = user.displayName;
						this.loadingOverlay.style.display = 'none';
						this.authOverlay.style.display = 'none';
						this.appContainer.style.display = 'flex';
						this.setupUIAccess();
						this.firebaseService.startSnapshotListener('contracts');
						this.firebaseService.startNotificationListener(this.currentSafeName);
						this.firebaseService.startSystemSettingsListener();
					}
				} else {
					this.currentUserDisplayName = null;
					this.currentSafeName = null;
					this.isUserAdmin = false;
					this.lastOverdueCheck = null;
					document.body.classList.remove('is-admin');
					this.authOverlay.style.display = 'flex';
					this.appContainer.style.display = 'none';
					this.loadingOverlay.style.display = 'none';
					this.firebaseService.stopSnapshotListener();
					this.firebaseService.stopNotificationListener();
					this.firebaseService.stopSystemSettingsListener();
				}
			}
		
			handleSnapshotUpdate(contracts) {
				const oldContracts = this.database.contracts || [];
				this.database.contracts = contracts;
				this.checkAndNotifyOverdue(oldContracts, contracts);
				this.contractListPage = 0;
				this.render();
			}

			handleNotificationUpdate(notifications) {
				this.database.notifications = notifications;
				this.renderNotificationDropdown();
			}

			handleSystemSettingsUpdate(settings) {
				if (!settings.advogados) {
					settings.advogados = { list: [] };
				}
				this.database.settings = settings;
				this.renderAdvogadoFilters();
				this.populateAdvogadoSelectModal();
				if (this.currentPageId === 'page-oficina') {
					this.renderOficinaPage();
				}
			}
		
			render() {
				if (this.appContainer.style.display !== 'flex') return;
				const pageId = this.currentPageId;
				if (!pageId) {
					this.showPage('page-dashboard');
					return;
				}
				
				if (pageId === 'page-dashboard') {
					this.renderKanban();
					this.renderContractList();
				} else if (pageId === 'page-parcelas') {
					this.renderParcelasPage();
				} else if (pageId === 'page-servicos') {
					this.renderServicosPage();
				} else if (pageId === 'page-lixeira') {
					this.renderLixeiraPage();
				} else if (pageId === 'page-relatorios') {
					this.renderAdvancedReportPage();
				} else if (pageId === 'page-performance') {
					this.renderPerformancePage();
				} else if (pageId === 'page-oficina') {
					this.renderOficinaPage();
				}
				this.renderSortButtons();
				this.updateEraButtonsUI(); // [NOVO]
			}
		
			// [MUDAN√áA GLOBAL] O Kanban agora filtra por Era antes de calcular
			renderKanban() {
				let contractsToRender = this.getFilteredContracts(false);
				
				// [NOVO] Aplica filtro de Era GLOBALMENTE no Dashboard
				contractsToRender = contractsToRender.filter(c => {
					const createdAt = (c.createdAt || "").substring(0, 10);
					if (this.contractEraFilter === 'novos') {
						return createdAt >= CUTOFF_DATE;
					} else {
						return createdAt < CUTOFF_DATE;
					}
				});

				const kanbanVencidas = document.getElementById('kanban-vencidas');
				const kanbanAVencer = document.getElementById('kanban-a-vencer');
				const kanbanPagas = document.getElementById('kanban-pagas');
				const kanbanExitoWrapper = document.getElementById('kanban-exito-wrapper');
				
				const fragVencidas = document.createDocumentFragment();
				const fragAVencer = document.createDocumentFragment();
				const fragPagas = document.createDocumentFragment();
				const fragExito = document.createDocumentFragment();
		
				const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
				const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
				const trintaDiasFrente = new Date(); trintaDiasFrente.setDate(hoje.getDate() + 30);
		
				let totalAVencer30dias = 0;
				let totalVencido = 0;
				let exitoPendente = 0;
		
				for (const contract of contractsToRender) {
					if (!contract.parcels) contract.parcels = [];
					let remainingValue = contract.parcels.reduce((sum, p) => p.status === 'Pendente' ? sum + p.value : sum, 0);
		
					for (let i = 0; i < contract.parcels.length; i++) {
						const parcel = contract.parcels[i];
						const vencimento = new Date(parcel.dueDate);
		
						if (parcel.status === 'Paga') {
							const dataPagamento = new Date(parcel.paymentDate);
							if (dataPagamento >= primeiroDiaMes && dataPagamento <= hoje) {
								fragPagas.append(this.domBuilder.createParcelCard(contract, parcel, i, 'paga', remainingValue));
							}
						} else {
							if (vencimento < hoje) {
								const valorCorrigido = this.correctionCalculator.calcularValorCorrigido(parcel.value, parcel.dueDate);
								totalVencido += valorCorrigido;
								fragVencidas.append(this.domBuilder.createParcelCard(contract, parcel, i, 'vencida', remainingValue, valorCorrigido));
							} else if (vencimento >= hoje && vencimento <= trintaDiasFrente) {
								fragAVencer.append(this.domBuilder.createParcelCard(contract, parcel, i, 'a-vencer', remainingValue));
								totalAVencer30dias += parcel.value;
							}
						}
					}
					if (contract.successFee && !contract.successFeePaymentDate && (contract.parcels || []).every(p => p.status === 'Paga')) {
						fragExito.append(this.domBuilder.createExitoCard(contract));
						exitoPendente++;
					}
				}
		
				kanbanVencidas.innerHTML = ''; kanbanAVencer.innerHTML = ''; kanbanPagas.innerHTML = ''; kanbanExitoWrapper.innerHTML = '';
				kanbanVencidas.append(fragVencidas); kanbanAVencer.append(fragAVencer); kanbanPagas.append(fragPagas);
				
				document.getElementById('exito-section').style.display = exitoPendente > 0 ? 'block' : 'none';
				if(exitoPendente > 0) kanbanExitoWrapper.append(fragExito);
		
				// O "Pago Este M√™s" tamb√©m respeita o filtro de Era agora
				const totalPagoMes = this.reportHandler.calculateMonthlyIncome(hoje.getFullYear(), hoje.getMonth(), contractsToRender).totalGeral;
				
				this.renderDashboard(totalAVencer30dias, totalVencido, totalPagoMes, contractsToRender.length);
			}
			renderDashboard(aVencer, vencido, pago, totalContratos) {
				document.getElementById('dash-a-receber').textContent = Utils.formatCurrency(aVencer);
				document.getElementById('dash-vencido').textContent = Utils.formatCurrency(vencido);
				document.getElementById('dash-recebido').textContent = Utils.formatCurrency(pago);
				document.getElementById('dash-contratos').textContent = totalContratos;
			}
			
			// [NOVO] Atualiza visual dos bot√µes de Era
			updateEraButtonsUI() {
				const btnNovos = document.getElementById('btn-era-novos');
				const btnLegados = document.getElementById('btn-era-legados');
				if(!btnNovos || !btnLegados) return;

				if (this.contractEraFilter === 'novos') {
					btnNovos.classList.replace('text-gray-400', 'text-white');
					btnNovos.classList.add('bg-indigo-600', 'shadow-sm');
					btnLegados.classList.remove('bg-indigo-600', 'text-white', 'shadow-sm');
					btnLegados.classList.add('text-gray-400');
				} else {
					btnLegados.classList.replace('text-gray-400', 'text-white');
					btnLegados.classList.add('bg-indigo-600', 'shadow-sm');
					btnNovos.classList.remove('bg-indigo-600', 'text-white', 'shadow-sm');
					btnNovos.classList.add('text-gray-400');
				}
			}

			// [NOVO] Define Era e re-renderiza tudo (Muda tudo)
			setContractEra(era) {
				this.contractEraFilter = era;
				this.contractListPage = 0;
				this.render(); // Re-renderiza Dashboard, Kanban e Listas
			}

			renderContractList() {
				const listContainer = document.getElementById('contractListContainer');
				const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
				const advogadoFilterEl = document.getElementById('advogadoFilter');
				let advogadoFilter = advogadoFilterEl ? advogadoFilterEl.value : 'Todos';
				if (!this.isUserAdmin) advogadoFilter = this.currentUserDisplayName;
		
				// 1. Filtra contratos
				let filteredContracts = this.getFilteredContracts(false).filter(c => {
					// Filtro de Status
					const statusInfo = this.getContractStatus(c);
					const isConcluido = statusInfo.statusText === 'Conclu√≠do';
					if (this.contractStatusFilter === 'ativos' && isConcluido) return false;
					if (this.contractStatusFilter === 'concluidos' && !isConcluido) return false;

					// Filtro de Advogado e Busca
					const matchesAdvogado = (this.isUserAdmin && advogadoFilter === 'Todos') || c.advogadoResponsavel === advogadoFilter;
					const matchesSearch = c.clientName.toLowerCase().includes(searchTerm) || (c.serviceTypes || []).some(s => s.name.toLowerCase().includes(searchTerm));
					
					// [NOVO] Filtro de Era
					const createdAt = (c.createdAt || "").substring(0, 10);
					let matchesEra = true;
					if (this.contractEraFilter === 'novos') {
						matchesEra = createdAt >= CUTOFF_DATE;
					} else {
						matchesEra = createdAt < CUTOFF_DATE;
					}

					return matchesAdvogado && matchesSearch && matchesEra;
				});
		
				// 2. Ordena
				if (this.currentContractSort === 'name-asc') {
					filteredContracts.sort((a, b) => a.clientName.localeCompare(b.clientName));
				} else if (this.currentContractSort === 'value-desc') {
					filteredContracts.sort((a, b) => (b.totalValue || 0) - (a.totalValue || 0));
				}
		
				// 3. Pagina√ß√£o
				const totalItems = filteredContracts.length;
				const totalPages = Math.ceil(totalItems / CONTRACTS_PER_PAGE);
				if (this.contractListPage >= totalPages && totalPages > 0) this.contractListPage = totalPages - 1;
				if (this.contractListPage < 0) this.contractListPage = 0;
				const startIndex = this.contractListPage * CONTRACTS_PER_PAGE;
				const paginatedContracts = filteredContracts.slice(startIndex, startIndex + CONTRACTS_PER_PAGE);
		
				// 4. Renderiza
				listContainer.innerHTML = '';
				const paginationContainer = document.getElementById('paginationContainer');
		
				if (totalItems === 0) {
					const eraText = this.contractEraFilter === 'novos' ? 'Novos' : 'Legados';
					listContainer.innerHTML = `<div class="dark-card shadow-lg p-4 rounded-lg text-center text-gray-400 py-4">Nenhum contrato ${this.contractStatusFilter} encontrado em "${eraText}".</div>`;
					this.domBuilder.renderPaginationControls(paginationContainer, 0, 0, 0);
					return;
				}
		
				const gridContainer = this.domBuilder.buildElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8' });
				const fragment = document.createDocumentFragment();
				paginatedContracts.forEach(contract => {
					const statusInfo = this.getContractStatus(contract);
					fragment.append(this.domBuilder.createContractCard(contract, statusInfo));
				});
				gridContainer.append(fragment);
				listContainer.append(gridContainer);
				this.domBuilder.renderPaginationControls(paginationContainer, totalItems, totalPages, this.contractListPage);
			}

			renderParcelasPage() {
				let contractsToRender = this.getFilteredContracts(false);
				
				// [NOVO] Aplica filtro de Era nas Parcelas tamb√©m
				contractsToRender = contractsToRender.filter(c => {
					const createdAt = (c.createdAt || "").substring(0, 10);
					return this.contractEraFilter === 'novos' ? createdAt >= CUTOFF_DATE : createdAt < CUTOFF_DATE;
				});

				const container = document.getElementById('parcelasListContainer');
				const searchTerm = (document.getElementById('parcelasSearchInput').value || '').toLowerCase();
				container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><i class="fas fa-spinner fa-spin fa-2x text-indigo-400"></i><p class="mt-2 text-sm text-gray-400">A calcular...</p></div>`;
				const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
				let parcelasList = [];
				contractsToRender.forEach(contract => {
					if (!contract.clientName.toLowerCase().includes(searchTerm)) return;
					if (!contract.parcels) return;
					for (let i = 0; i < contract.parcels.length; i++) {
						const parcel = contract.parcels[i];
						if (parcel.status === 'Pendente') { 
							const vencimento = new Date(parcel.dueDate);
							const diffDays = Math.ceil((vencimento - hoje) / 86400000);
							const isVencida = vencimento < hoje;
							const valorCorrigido = isVencida ? this.correctionCalculator.calcularValorCorrigido(parcel.value, parcel.dueDate) : parcel.value;
							parcelasList.push({ contract, parcel, index: i, diffDays, valorCorrigido, isVencida });
						}
					}
				});
				if (this.currentParcelasSort === 'days-asc') parcelasList.sort((a, b) => a.diffDays - b.diffDays);
				else if (this.currentParcelasSort === 'value-desc') parcelasList.sort((a, b) => b.valorCorrigido - a.valorCorrigido);
				else if (this.currentParcelasSort === 'name-asc') parcelasList.sort((a, b) => a.contract.clientName.localeCompare(b.contract.clientName));
				container.innerHTML = '';
				if (parcelasList.length === 0) { container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><div class="inline-block bg-gray-800 border border-gray-700 text-green-400 p-6 rounded-lg shadow-md"><i class="fas fa-check-circle fa-3x mb-3"></i><p class="font-bold text-xl">Nenhuma parcela pendente!</p><p class="text-sm text-gray-400">Todos os pagamentos est√£o em dia.</p></div></div>`; return; }
				const fragment = document.createDocumentFragment();
				parcelasList.forEach(item => fragment.append(this.domBuilder.createParcelaCard(item)));
				container.append(fragment);
			}

			renderServicosPage() {
				let contractsToRender = this.getFilteredContracts(false);

				// [NOVO] Aplica filtro de Era nos Servi√ßos tamb√©m
				contractsToRender = contractsToRender.filter(c => {
					const createdAt = (c.createdAt || "").substring(0, 10);
					return this.contractEraFilter === 'novos' ? createdAt >= CUTOFF_DATE : createdAt < CUTOFF_DATE;
				});

				const container = document.getElementById('servicosListContainer');
				const searchTerm = (document.getElementById('servicosSearchInput').value || '').toLowerCase();
				const advogadoFilterEl = document.getElementById('servicosAdvogadoFilter');
				let advogadoFilter = advogadoFilterEl ? advogadoFilterEl.value : 'Todos';
				if (!this.isUserAdmin) advogadoFilter = this.currentUserDisplayName;
				container.innerHTML = '';
				let activeContracts = contractsToRender.filter(c => {
					const matchesAdvogado = (this.isUserAdmin && advogadoFilter === 'Todos') || c.advogadoResponsavel === advogadoFilter;
					const matchesSearch = c.clientName.toLowerCase().includes(searchTerm) || (c.serviceTypes || []).some(s => s.name.toLowerCase().includes(searchTerm));
					return matchesAdvogado && matchesSearch;
				});
				if (this.currentServicosSort === 'name-asc') activeContracts.sort((a, b) => a.clientName.localeCompare(b.clientName));
				else if (this.currentServicosSort === 'adv-asc') activeContracts.sort((a, b) => a.advogadoResponsavel.localeCompare(b.advogadoResponsavel));
				activeContracts = activeContracts.filter(c => c.serviceTypes && c.serviceTypes.length > 0);
				if (activeContracts.length === 0) { container.innerHTML = `<div class="text-center py-10"><div class="inline-block dark-card shadow-lg text-indigo-400 p-6 rounded-lg"><i class="fas fa-coffee fa-3x mb-3"></i><p class="font-bold text-xl">Nenhum contrato ativo encontrado.</p></div></div>`; return; }
				const fragment = document.createDocumentFragment();
				activeContracts.forEach(contract => {
					const totalServices = (contract.serviceTypes || []).length;
					let progressValue = 0;
					(contract.serviceTypes || []).forEach(service => { if (service.status === 'Conclu√≠do') progressValue += 1; else if (service.status === '50% Conclu√≠do') progressValue += 0.5; else if (service.status === 'Em Andamento') progressValue += 0.25; });
					const serviceProgress = totalServices > 0 ? (progressValue / totalServices) * 100 : 0;
					const totalPaid = (contract.parcels || []).reduce((sum, p) => sum + (p.valuePaid || 0), 0) + (contract.successFeeValueReceived || 0);
					const financialProgress = (contract.totalValue || 0) > 0 ? (totalPaid / contract.totalValue) * 100 : (totalPaid > 0 ? 100 : 0);
					if(serviceProgress < 100) fragment.append(this.domBuilder.createServicoCard(contract, serviceProgress, financialProgress));
				});
				if(fragment.children.length === 0) { container.innerHTML = `<div class="text-center py-10"><div class="inline-block dark-card shadow-lg text-green-400 p-6 rounded-lg"><i class="fas fa-check-double fa-3x mb-3"></i><p class="font-bold text-xl">Todos os servi√ßos est√£o conclu√≠dos.</p></div></div>`; return; }
				container.append(fragment);
			}
			renderLixeiraPage() {
				let contractsToRender = this.getFilteredContracts(true); 
				
				// [NOVO] Aplica filtro de Era na Lixeira
				contractsToRender = contractsToRender.filter(c => {
					const createdAt = (c.createdAt || "").substring(0, 10);
					return this.contractEraFilter === 'novos' ? createdAt >= CUTOFF_DATE : createdAt < CUTOFF_DATE;
				});

				const container = document.getElementById('lixeiraListContainer');
				container.innerHTML = '';
				const deletedContracts = contractsToRender.filter(c => c.isDeleted === true); 
				if (deletedContracts.length === 0) { container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><div class="inline-block dark-card shadow-lg text-gray-400 p-6 rounded-lg"><i class="fas fa-trash fa-3x mb-3"></i><p class="font-bold text-xl">Lixeira Vazia</p><p class="text-sm">Nenhum contrato desta era.</p></div></div>`; return; }
				const fragment = document.createDocumentFragment();
				deletedContracts.forEach(contract => {
					const card = this.domBuilder.buildElement('div', { className: 'dark-card shadow-lg p-5 rounded-lg border-l-4 border-gray-600 transition-all duration-200 hover:-translate-y-1' });
					card.append(this.domBuilder.buildElement('p', { className: 'font-bold text-lg text-white', text: contract.clientName }));
					const footer = this.domBuilder.buildElement('div', { className: 'border-t border-gray-700 pt-3 mt-3 flex gap-2' });
					const restoreBtn = this.domBuilder.buildElement('button', { className: 'w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-2 px-3 rounded-lg flex items-center justify-center gap-2', html: '<i class="fas fa-undo"></i> Restaurar' });
					restoreBtn.onclick = () => this.restoreContract(contract.id);
					footer.append(restoreBtn);
					if (this.isUserAdmin) {
						const deleteBtn = this.domBuilder.buildElement('button', { className: 'w-full bg-gradient-to-r from-red-700 to-red-800 hover:from-red-800 hover:to-red-900 text-white font-semibold py-2 px-3 rounded-lg flex items-center justify-center gap-2', html: '<i class="fas fa-times-circle"></i> Excluir' });
						deleteBtn.onclick = () => this.deleteContractPermanently(contract.id);
						footer.append(deleteBtn);
					}
					card.append(footer);
					fragment.append(card);
				});
				container.append(fragment);
			}

			renderAdvancedReportPage() {
				const startDateEl = document.getElementById('reportStartDate');
				const endDateEl = document.getElementById('reportEndDate');
				if (!startDateEl.value || !endDateEl.value) {
					const hoje = new Date();
					const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
					startDateEl.value = inicioMes.toISOString().split('T')[0];
					endDateEl.value = hoje.toISOString().split('T')[0];
				}
				this.currentAdvancedReportData = null;
				document.getElementById('exportPdfButton').disabled = true;
				document.getElementById('advancedReportContainer').classList.add('hidden');
				document.getElementById('advancedReportEmpty').classList.remove('hidden');
				this.analyticsHandler.destroyPageCharts('page-relatorios');
			}
			
			renderPerformancePage() {
				if (!this.isUserAdmin) return;
				this.analyticsHandler.destroyPageCharts('page-performance');
				
				let allContracts = this.getFilteredContracts(true);
				// [NOVO] Aplica filtro de Era na Performance
				allContracts = allContracts.filter(c => {
					const createdAt = (c.createdAt || "").substring(0, 10);
					return this.contractEraFilter === 'novos' ? createdAt >= CUTOFF_DATE : createdAt < CUTOFF_DATE;
				});

				const { contratosPorAdvogado, faturamentoPorAdvogado } = this.reportHandler.calculateAdminPerformanceData(allContracts);
				
				const contratosCtx = document.getElementById('adminChartContratos').getContext('2d');
				this.analyticsHandler.renderAdminContratosChart(contratosCtx, Object.keys(contratosPorAdvogado), Object.values(contratosPorAdvogado));
				
				const faturamentoCtx = document.getElementById('adminChartFaturamento').getContext('2d');
				this.analyticsHandler.renderAdminFaturamentoChart(faturamentoCtx, Object.keys(faturamentoPorAdvogado), Object.values(faturamentoPorAdvogado));
				
				const fatTableBody = document.getElementById('adminTableFaturamento').querySelector('tbody');
				fatTableBody.innerHTML = '';
				Object.entries(faturamentoPorAdvogado).sort(([, a], [, b]) => b - a).forEach(([label, value], index) => fatTableBody.append(this.domBuilder.createRankingRow(index + 1, label, Utils.formatCurrency(value))));
				
				const contTableBody = document.getElementById('adminTableContratos').querySelector('tbody');
				contTableBody.innerHTML = '';
				Object.entries(contratosPorAdvogado).sort(([, a], [, b]) => b - a).forEach(([label, value], index) => contTableBody.append(this.domBuilder.createRankingRow(index + 1, label, `${value} contrato(s)`)));
			}

			renderOficinaPage() {
				const listContainer = document.getElementById('advogadoSettingsList');
				if (!listContainer) return;
				listContainer.innerHTML = '';
				const fragment = document.createDocumentFragment();
				const advogadosList = this.database.settings.advogados?.list || [];
				if (advogadosList.length === 0) { listContainer.innerHTML = `<p class="text-sm text-gray-400 text-center p-4">Nenhum advogado cadastrado.</p>`; return; }
				[...advogadosList].sort().forEach(name => fragment.append(this.domBuilder.createSettingListItem(name)));
				listContainer.append(fragment);
			}

			// [MUDAN√áA: REQUISITO 1 e 2] Relat√≥rio Mensal
			generateAndShowReport() {
				if (!this.isUserAdmin) return;
				document.getElementById('reportChartsContainer').classList.add('hidden');
				const resultDiv = document.getElementById('reportResult');
				resultDiv.classList.remove('hidden');
		
				const month = parseInt(document.getElementById('reportMonth').value);
				const year = parseInt(document.getElementById('reportYear').value);
				
				let contractsToProcess = this.getFilteredContracts(true);
				// [NOVO] Aplica filtro de Era
				contractsToProcess = contractsToProcess.filter(c => {
					const createdAt = (c.createdAt || "").substring(0, 10);
					return this.contractEraFilter === 'novos' ? createdAt >= CUTOFF_DATE : createdAt < CUTOFF_DATE;
				});

				const income = this.reportHandler.calculateMonthlyIncome(year, month, contractsToProcess);
		
				let detailsHtml = '<h4 class="text-lg font-semibold mt-6 border-t border-gray-700 pt-4 text-white">Detalhes dos Recebimentos</h4>';
				if (income.detailedPayments.length > 0) {
					detailsHtml += '<ul class="space-y-2 mt-2 text-sm">';
					income.detailedPayments.forEach(p => {
						detailsHtml += `<li class="flex justify-between items-center bg-gray-700/50 p-3 rounded-md"><div><p class="font-semibold text-white">${p.clientName}</p><p class="text-xs text-gray-400">${p.type} - ${Utils.formatDate(p.date)}</p></div><span class="font-semibold text-green-400 text-lg">${Utils.formatCurrency(p.value)}</span></li>`;
					});
					detailsHtml += '</ul>';
				} else {
					detailsHtml += '<p class="text-sm text-gray-400 mt-2">Nenhum recebimento neste per√≠odo.</p>';
				}

				// [NOVO: REQUISITO 1] Se√ß√£o de Contratos N√£o Pagos (Inadimplentes do M√™s)
				// Esta lista j√° vem filtrada do reportHandler (apenas quem tinha vencimento)
				detailsHtml += '<h4 class="text-lg font-semibold mt-6 border-t border-gray-700 pt-4 text-red-300"><i class="fas fa-exclamation-circle mr-2"></i>Contratos sem Pagamentos (Deviam ter pago este m√™s)</h4>';
				
				if (income.notPaidList && income.notPaidList.length > 0) {
					detailsHtml += '<div class="grid grid-cols-1 gap-2 mt-2 text-sm">';
					income.notPaidList.forEach(c => {
						const vencimento = Utils.formatDate(c.dueDate);
						const valor = Utils.formatCurrency(c.value);
						detailsHtml += `
						<div class="bg-red-900/20 border border-red-900/50 p-3 rounded-md flex justify-between items-center">
							<div>
								<p class="font-medium text-red-200">${c.clientName}</p>
								<p class="text-xs text-red-400">Parcela ${c.parcelNumber} - Vencia em: ${vencimento}</p>
							</div>
							<div class="text-right">
								<p class="font-bold text-red-400">${valor}</p>
								<p class="text-xs text-gray-500">${c.advogado}</p>
							</div>
						</div>`;
					});
					detailsHtml += '</div>';
				} else {
					detailsHtml += '<p class="text-sm text-green-400 mt-2 p-2 bg-green-900/20 border border-green-900/50 rounded"><i class="fas fa-check-circle mr-1"></i> Parab√©ns! Todos os contratos com vencimento neste m√™s foram pagos.</p>';
				}
		
				resultDiv.innerHTML = `
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div class="dark-card shadow-lg p-4 rounded-lg text-center"><p class="text-sm text-gray-400">Total (Parcelas)</p><p class="text-2xl font-bold text-white">${Utils.formatCurrency(income.totalParcelas)}</p></div>
						<div class="dark-card shadow-lg p-4 rounded-lg text-center"><p class="text-sm text-gray-400">Total (√äxito)</p><p class="text-2xl font-bold text-indigo-400">${Utils.formatCurrency(income.totalExito)}</p></div>
					</div>
					<div class="bg-gray-900 p-4 rounded-lg border border-gray-700 text-center"><p class="text-white font-bold">TOTAL GERAL RECEBIDO</p><p class="text-3xl font-extrabold text-green-400">${Utils.formatCurrency(income.totalGeral)}</p></div>
				` + detailsHtml;
			}
			
			showPage(pageId) {
				const pageTitles = { 'page-dashboard': 'Painel Principal', 'page-parcelas': 'Controle de Parcelas', 'page-servicos': 'Produ√ß√£o de Servi√ßos', 'page-performance': 'Performance Gerencial', 'page-relatorios': 'Relat√≥rios Avan√ßados', 'page-lixeira': 'Lixeira', 'page-oficina': 'Oficina de Configura√ß√µes' };
				if (this.currentPageId === 'page-relatorios' && pageId !== 'page-relatorios') this.analyticsHandler.destroyPageCharts('page-relatorios');
				if (this.currentPageId === 'page-performance' && pageId !== 'page-performance') this.analyticsHandler.destroyPageCharts('page-performance');
				this.currentPageId = pageId; 
				document.getElementById('page-title').textContent = pageTitles[pageId] || 'Painel';
				['page-dashboard', 'page-parcelas', 'page-servicos', 'page-lixeira', 'page-relatorios', 'page-performance', 'page-oficina'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
				document.querySelectorAll('.sidebar-nav-item, .mobile-nav-item').forEach(tab => tab.classList.remove('active'));
				document.getElementById(pageId)?.classList.remove('hidden');
				const tabBaseId = pageId.split('-')[1];
				document.getElementById(`tab-${tabBaseId}`)?.classList.add('active');
				document.getElementById(`mobile-tab-${tabBaseId}`)?.classList.add('active');
				this.render();
			}

			setupUIAccess() {
				const isAdmin = this.isUserAdmin;
				[document.getElementById('advogadoFilter'), document.getElementById('servicosAdvogadoFilter')].forEach(s => { 
					if(s){ s.disabled = !isAdmin; s.value = isAdmin ? 'Todos' : this.currentUserDisplayName; }
				});
				['valorTotal', 'numParcelas', 'vencimentoPrimeiraParcela', 'taxaExito', 'contratoJaQuitado'].forEach(id => { 
					const f = document.getElementById(id); if(f) f.disabled = !isAdmin; 
				});
			}
			
			getFilteredContracts(includeDeleted = false) {
				const allContracts = this.database.contracts;
				if (this.isUserAdmin) return includeDeleted ? allContracts : allContracts.filter(c => !c.isDeleted);
				return allContracts.filter(c => c.advogadoResponsavel === this.currentUserDisplayName && (includeDeleted ? true : !c.isDeleted));
			}
		
			getContractStatus(contract) {
				const allParcelsPaid = (contract.parcels || []).every(p => p.status === 'Paga');
				const allServicesDone = (contract.serviceTypes || []).every(s => s.status === 'Conclu√≠do');
				if (allParcelsPaid && allServicesDone) {
					if (contract.successFee && !contract.successFeePaymentDate) return { statusText: 'Aguardando √äxito', statusColor: 'bg-indigo-900/50 text-indigo-300', borderColor: 'border-indigo-500' };
					return { statusText: 'Conclu√≠do', statusColor: 'bg-gray-700 text-gray-300', borderColor: 'border-gray-600' };
				}
				if(allParcelsPaid && !allServicesDone) return { statusText: 'Em Andamento', statusColor: 'bg-blue-900/50 text-blue-300', borderColor: 'border-blue-500' };
				return { statusText: 'Ativo', statusColor: 'bg-yellow-900/50 text-yellow-300', borderColor: 'border-yellow-500' };
			}
		
			renderSortButtons() {
				const createButton = (container, sortKey, sortLabel, currentSort, callback) => {
					const button = this.domBuilder.buildElement('button', { text: sortLabel, className: 'sort-button' });
					if (currentSort === sortKey) button.classList.add('active');
					button.onclick = () => { callback(sortKey); this.render(); this.renderSortButtons(); };
					container.append(button);
				};
				const contractSortContainer = document.getElementById('contractSortButtons');
				contractSortContainer.innerHTML = '';
				createButton(contractSortContainer, 'name-asc', 'Nome (A-Z)', this.currentContractSort, (key) => { this.currentContractSort = key; this.resetAndRenderContractList(); });
				createButton(contractSortContainer, 'value-desc', 'Valor (Maior)', this.currentContractSort, (key) => { this.currentContractSort = key; this.resetAndRenderContractList(); });

				const parcelasSortContainer = document.getElementById('parcelasSortButtons');
				parcelasSortContainer.innerHTML = '';
				createButton(parcelasSortContainer, 'days-asc', 'Venc. Pr√≥ximo', this.currentParcelasSort, (key) => { this.currentParcelasSort = key; });
				createButton(parcelasSortContainer, 'name-asc', 'Nome (A-Z)', this.currentParcelasSort, (key) => { this.currentParcelasSort = key; });

				const contractStatusFilterContainer = document.getElementById('contractStatusFilterButtons');
				contractStatusFilterContainer.innerHTML = '';
				createButton(contractStatusFilterContainer, 'ativos', 'Ativos', this.contractStatusFilter, (key) => { this.contractStatusFilter = key; this.resetAndRenderContractList(); });
				createButton(contractStatusFilterContainer, 'concluidos', 'Conclu√≠dos', this.contractStatusFilter, (key) => { this.contractStatusFilter = key; this.resetAndRenderContractList(); });
			}
			
			renderAdvogadoFilters() {
				const allNames = new Set(this.database.settings.advogados?.list || []);
				[document.getElementById('advogadoFilter'), document.getElementById('servicosAdvogadoFilter')].forEach(select => {
					if (!select) return;
					const currentValue = select.value;
					select.innerHTML = '<option value="Todos">Todos</option>';
					select.add(new Option("N√£o Informado", "N√£o Informado"));
					[...allNames].filter(adv => adv && adv !== "N√£o Informado" && adv !== "Todos").sort().forEach(adv => select.add(new Option(adv, adv)));
					select.value = this.isUserAdmin ? (currentValue || 'Todos') : this.currentUserDisplayName;
					select.disabled = !this.isUserAdmin;
				});
			}
		
			populateAdvogadoSelectModal() {
				const select = document.getElementById('advogadoResponsavel');
				if (!select) return;
				const currentValue = select.value;
				select.innerHTML = '';
				select.add(new Option("N√£o Informado", "N√£o Informado"));
				const allNames = new Set(this.database.settings.advogados?.list || []);
				[...allNames].filter(adv => adv && adv !== "N√£o Informado").sort().forEach(adv => select.add(new Option(adv, adv)));
				select.value = currentValue && currentValue !== 'N√£o Informado' ? currentValue : (this.isUserAdmin ? 'N√£o Informado' : this.currentUserDisplayName);
				select.disabled = !this.isUserAdmin && !!this.currentUserDisplayName;
			}
			
			changeContractPage(pageIndex) { this.contractListPage = pageIndex; this.renderContractList(); document.getElementById('main-content').scrollTop = 0; }
			resetAndRenderContractList() { this.contractListPage = 0; this.renderContractList(); }
		
			// Handlers de Submit (CRUD)
			async handleDisplayNameSubmit(e) { e.preventDefault(); const name = document.getElementById('inputDisplayName').value; if (name && (await this.authService.updateUserProfile(name))) window.location.reload(); }
			
			async handleContractSubmit(e) {
				e.preventDefault();
				const contractId = document.getElementById('contractId').value;
				const isSpecialContract = document.getElementById('contratoEspecial').checked;
				const serviceTypes = Array.from(document.querySelectorAll('#servicosContainer .service-tag')).map(tag => ({ name: Utils.sanitizeText(tag.dataset.name), status: tag.dataset.status || 'Pendente', deadline: tag.dataset.deadline || null }));
				if (serviceTypes.length === 0) { Utils.showToast('Adicione um servi√ßo.', 'error'); return; }
		
				const contractData = {
					clientName: Utils.sanitizeText(document.getElementById('clienteNome').value),
					advogadoResponsavel: Utils.sanitizeText(document.getElementById('advogadoResponsavel').value),
					serviceTypes,
					paymentType: Utils.sanitizeText(document.getElementById('contratoTipoPagamento').value),
					observations: Utils.sanitizeText(document.getElementById('contratoObservacoes').value),
					isSpecialContract
				};
				
				if (this.isUserAdmin) {
					let generatedData;
					if (isSpecialContract) {
						if (this.manualParcels.length === 0) { Utils.showToast('Adicione uma parcela.', 'error'); return; }
						generatedData = { parcels: this.manualParcels.map((p, i) => ({ number: i + 1, value: p.value, dueDate: new Date(p.dueDate + 'T12:00:00Z').toISOString(), status: 'Pendente', valuePaid: 0, paymentDate: null })), totalValue: this.manualParcels.reduce((a,b)=>a+b.value,0) };
					} else {
						const totalValue = Utils.parseNumber(document.getElementById('valorTotal').value);
						const numParcels = parseInt(document.getElementById('numParcelas').value) || 1;
						const firstDueDate = document.getElementById('vencimentoPrimeiraParcela').value;
						const jaQuitado = document.getElementById('contratoJaQuitado').checked;
						if (numParcels > 0 && totalValue > 0) {
							if (!firstDueDate && !jaQuitado) { Utils.showToast('Informe data.', 'error'); return; }
							const parcelValue = totalValue / numParcels;
							let currentDueDate = new Date((firstDueDate || new Date().toISOString().split('T')[0]) + 'T12:00:00Z');
							const parcels = [];
							for (let i = 0; i < numParcels; i++) {
								const isPaid = jaQuitado && numParcels === 1;
								parcels.push({ number: i + 1, value: parcelValue, dueDate: new Date(currentDueDate).toISOString(), status: isPaid ? 'Paga' : 'Pendente', valuePaid: isPaid ? parcelValue : 0, paymentDate: isPaid ? new Date().toISOString() : null });
								currentDueDate.setMonth(currentDueDate.getMonth() + 1);
							}
							generatedData = { parcels, totalValue };
						} else { generatedData = { parcels: [], totalValue: 0 }; }
					}
					Object.assign(contractData, { totalValue: generatedData.totalValue, parcels: generatedData.parcels, successFee: Utils.sanitizeText(document.getElementById('taxaExito').value) || null });
				}
		
				if (!contractId) {
					if (!this.isUserAdmin) { contractData.parcels = []; contractData.totalValue = 0; contractData.successFee = null; }
					Object.assign(contractData, { successFeeValueReceived: 0, successFeePaymentDate: null, isDeleted: false, createdAt: new Date().toISOString() });
					if (await this.firebaseService.addContract(contractData)) { this.closeModal('modalContrato'); this.sendNotificationToAllAdmins({ message: `${this.currentUserDisplayName} criou contrato: ${contractData.clientName}.`, sender: this.currentUserDisplayName }); }
				} else {
					const existingContract = this.database.contracts.find(c => c.id === contractId);
					if (this.isUserAdmin && document.getElementById('financialDataChanged').value === 'true') { /* Dados j√° atualizados acima */ }
					else if (existingContract) { contractData.parcels = existingContract.parcels; contractData.totalValue = existingContract.totalValue; }
					
					contractData.successFeeValueReceived = existingContract?.successFeeValueReceived || 0;
					contractData.successFeePaymentDate = existingContract?.successFeePaymentDate || null;
					contractData.isDeleted = existingContract?.isDeleted || false;
					contractData.createdAt = existingContract?.createdAt || new Date().toISOString();

					if (await this.firebaseService.updateContract(contractId, contractData)) this.closeModal('modalContrato');
				}
			}
			
			async handlePaymentSubmit(e) {
				e.preventDefault();
				const contractId = document.getElementById('pagamentoContractId').value;
				const parcelIndex = parseInt(document.getElementById('pagamentoParcelIndex').value);
				const contract = this.database.contracts.find(c => c.id === contractId);
				const valuePaid = this.isUserAdmin ? Utils.parseNumber(document.getElementById('pagamentoValor').value) : (contract?.parcels[parcelIndex]?.value || 0);
				const paymentDate = document.getElementById('pagamentoData').value;
				
				if (contract && !isNaN(valuePaid) && valuePaid > 0) {
					const updatedParcels = [...(contract.parcels || [])];
					updatedParcels[parcelIndex].status = 'Paga';
					updatedParcels[parcelIndex].valuePaid = valuePaid;
					updatedParcels[parcelIndex].paymentDate = new Date(paymentDate + 'T12:00:00Z').toISOString();
					
					if (await this.firebaseService.updateContractField(contractId, { parcels: updatedParcels })) {
						this.closeModal('modalPagamento');
						Utils.showToast('Pagamento registado.', 'success');
						this.sendNotification(contract.advogadoResponsavel, { message: `Pagamento registado: ${contract.clientName}`, contractId, sender: this.currentUserDisplayName });
					}
				}
			}

			async handleExitoSubmit(e) {
				e.preventDefault();
				const contractId = document.getElementById('exitoContractId').value;
				const value = this.isUserAdmin ? Utils.parseNumber(document.getElementById('exitoValorRecebido').value) : 0;
				if (await this.firebaseService.updateContractField(contractId, { successFeeValueReceived: value, successFeePaymentDate: new Date().toISOString() })) {
					this.closeModal('modalExito');
					Utils.showToast('√äxito registado.', 'success');
				}
			}

			// Helpers de Modal e CRUD
			openContractModal(id) {
				try {
					document.getElementById('formContrato').reset();
					document.getElementById('financialDataChanged').value = 'false';
					document.getElementById('servicosContainer').innerHTML = '';
					this.populateAdvogadoSelectModal();
					this.manualParcels = [];
					this.domBuilder.renderManualParcelList();
					
					const isAdm = this.isUserAdmin;
					const finDiv = document.getElementById('financial-fields-standard');
					const specDiv = document.getElementById('financial-fields-special');
					const chk = document.getElementById('contratoEspecial');
					
					if(id) {
						const c = this.database.contracts.find(x => x.id === id);
						document.getElementById('contractId').value = c.id;
						document.getElementById('clienteNome').value = c.clientName;
						document.getElementById('advogadoResponsavel').value = c.advogadoResponsavel;
						(c.serviceTypes||[]).forEach(s => this.createServiceTag(s.name, s.deadline, s.status));
						document.getElementById('contratoTipoPagamento').value = c.paymentType||'Parcelado';
						document.getElementById('contratoObservacoes').value = c.observations||'';
						
						if(isAdm) {
							document.getElementById('taxaExito').value = c.successFee||'';
							chk.checked = c.isSpecialContract||false;
							if(c.isSpecialContract) {
								finDiv.style.display='none';
								specDiv.style.display='block';
								this.manualParcels = (c.parcels||[]).map(p=>({value:p.value, dueDate:p.dueDate.split('T')[0]}));
								this.domBuilder.renderManualParcelList();
							} else {
								finDiv.style.display='block';
								specDiv.style.display='none';
								document.getElementById('valorTotal').value = c.totalValue;
								document.getElementById('numParcelas').value = (c.parcels||[]).length||1;
								if(c.parcels?.length) document.getElementById('vencimentoPrimeiraParcela').value = c.parcels[0].dueDate.split('T')[0];
							}
						}
					} else {
						document.getElementById('contractId').value='';
						finDiv.style.display='block';
						specDiv.style.display='none';
						chk.checked=false;
					}
					this.openModal('modalContrato');
				} catch(e){ console.error(e); }
			}

			openPaymentModal(id, idx) {
				const c = this.database.contracts.find(x => x.id === id);
				const p = c.parcels[idx];
				document.getElementById('pagamentoContractId').value = id;
				document.getElementById('pagamentoParcelIndex').value = idx;
				document.getElementById('pagamentoValor').value = p.value;
				document.getElementById('pagamentoData').value = new Date().toISOString().split('T')[0];
				document.getElementById('pagamentoInfo').innerHTML = `<p>${c.clientName} - Parcela ${p.number}</p>`;
				this.openModal('modalPagamento');
			}

			openClientHistoryModal(name) { this.domBuilder.openClientHistoryModal(name); }
			openReportModal() { this.openModal('modalRelatorio'); this._populateDateSelectors(); this.generateAndShowReport(); }
			openExitoModal(id) { document.getElementById('exitoContractId').value = id; this.openModal('modalExito'); }
			exportContractsCSV() { this.domBuilder.exportContractsCSV(); }
			exportReportCSV() { this.domBuilder.exportReportCSV(); }
			exportReportPDF() { this.domBuilder.exportReportPDF(); }
			showAnalyticsInModal() { this.domBuilder.showAnalyticsInModal(); }
			createServiceTag(n,d,s='Pendente') { this.domBuilder.createServiceTag(n,d,s); }
			markNotificationsAsRead() { this.domBuilder.markNotificationsAsRead(); }
			closeNotificationDropdown() { this.domBuilder.closeNotificationDropdown(); }
			
			async handleAddAdvogado(e) { e.preventDefault(); const name = Utils.sanitizeText(document.getElementById('inputAdvogadoName').value); if(!name) return; const list = this.database.settings.advogados?.list || []; if(list.includes(name)) return; await this.firebaseService.saveSystemSettings('advogados', { list: [...list, name] }); document.getElementById('inputAdvogadoName').value = ''; }
			async handleRemoveAdvogado(name) { if(await Utils.confirm(`Remover "${name}"?`)) { const list = (this.database.settings.advogados?.list || []).filter(n => n !== name); await this.firebaseService.saveSystemSettings('advogados', { list }); } }
			async handleAddManualParcel() { const v = Utils.parseNumber(document.getElementById('parcelaValorManual').value); const d = document.getElementById('parcelaVencimentoManual').value; if(v>0 && d) { this.manualParcels.push({value:v, dueDate:d}); this.domBuilder.renderManualParcelList(); document.getElementById('financialDataChanged').value='true'; } }
			async handleRemoveManualParcel(i) { this.manualParcels.splice(i,1); this.domBuilder.renderManualParcelList(); document.getElementById('financialDataChanged').value='true'; }
			async updateServiceStatus(c, i, s) { if(c && c.serviceTypes[i]) { const types = [...c.serviceTypes]; types[i].status = s; await this.firebaseService.updateContractField(c.id, { serviceTypes: types }); if(s === 'Conclu√≠do') this.sendNotification(c.advogadoResponsavel, { message: `Servi√ßo conclu√≠do: ${c.clientName}`, contractId: c.id, sender: this.currentUserDisplayName }); } }
			
			_populateDateSelectors() { const m = document.getElementById('reportMonth'); if(m.options.length>0) return; ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"].forEach((x,i)=>m.add(new Option(x,i))); const y = new Date().getFullYear(); for(let i=y;i>=y-5;i--) document.getElementById('reportYear').add(new Option(i,i)); m.value=new Date().getMonth(); document.getElementById('reportYear').value=y; }
			toggleSpecialContractFields(e) { document.getElementById('financial-fields-standard').style.display = e.target.checked ? 'none' : 'block'; document.getElementById('financial-fields-special').style.display = e.target.checked ? 'block' : 'none'; document.getElementById('financialDataChanged').value = 'true'; }
			handleAddServiceTag() { const name = document.getElementById('contratoServicoInput').value; if(name) { this.createServiceTag(name, document.getElementById('contratoPrazoInput').value); document.getElementById('contratoServicoInput').value = ''; } }
			async sendNotification(r, d) { if(r && r !== this.currentUserDisplayName) await this.firebaseService.sendNotification(Utils.sanitizeForFirestoreId(r), d); }
			async sendNotificationToAllAdmins(d) { ADMIN_USERS.forEach(a => { if(a.toLowerCase() !== this.currentUserDisplayName?.toLowerCase()) this.firebaseService.sendNotification(Utils.sanitizeForFirestoreId(a), d); }); }
			checkAndNotifyOverdue(old, newC) { /* L√≥gica de notifica√ß√£o di√°ria mantida */ }
			async moveToLixeira(id) { if(await Utils.confirm('Mover para lixeira?')) await this.firebaseService.updateContractField(id, { isDeleted: true }); }
			async restoreContract(id) { await this.firebaseService.updateContractField(id, { isDeleted: false }); }
			async deleteContractPermanently(id) { if(this.isUserAdmin && await Utils.confirm('Excluir PERMANENTEMENTE?')) await this.firebaseService.deleteContract(id); }
			
			_handleKeyDown(event) { if (event.key === 'Escape') { if (this.openModalId && this.openModalId !== 'modalDisplayName') this.closeModal(this.openModalId); const s = document.getElementById('sidebar'); if (window.innerWidth < 768 && !s.classList.contains('hidden')) { s.classList.add('hidden'); this.backdrop.style.display='none'; } this.closeNotificationDropdown(); } }
			_setupModalAccessibility() { document.addEventListener('keydown', this._handleKeyDown.bind(this)); }
			
			openModal(id) { this.lastFocusedElement = document.activeElement; document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); document.getElementById(id).style.display = 'block'; if(this.backdrop) this.backdrop.style.display = 'block'; this.openModalId = id; }
			closeModal(id) { document.getElementById(id).style.display = 'none'; if(this.openModalId === id) this.openModalId = null; if(!Array.from(document.querySelectorAll('.modal')).some(m => m.style.display === 'block') && this.backdrop) this.backdrop.style.display = 'none'; if(id === 'modalRelatorio') this.analyticsHandler.destroyModalCharts(); }
		}
		
		document.addEventListener('DOMContentLoaded', () => {
			const autoTableScript = document.createElement('script');
			autoTableScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
			autoTableScript.onload = () => {
				window.App = new App();
				window.App.initialize();
			};
			document.head.appendChild(autoTableScript);
		});
		
	</script>
</body>
</html>
